<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>atom tutorial</title>
    <url>/2014/08/27/atom-tutorial/</url>
    <content><![CDATA[<h2 id="how-to-use-atom"><a href="#how-to-use-atom" class="headerlink" title="how to use atom"></a>how to use atom</h2><p><a href="http://flight-manual.atom.io/using-atom/sections/atom-packages/" target="_blank" rel="noopener">atom-flight-manual</a></p>
<p>在编辑器中，<code>Command Palette</code> 中输入 <code>init script</code>，由于这个输入框里使用的是 <code>Fuzy matching</code>, 你输入到 s 的时候，估计 <code>Application: Open Your Init Script</code> 已经排在第一位了，当它是第一位的时候，直接回车键就可以了…… 在 <code>init script</code> 文件里拷贝粘贴以下代码：<br><a id="more"></a><br><figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># move cursor across the ending symbols...</span></span><br><span class="line">EndingSymbolRegex = <span class="regexp">/\s*[)&#125;&gt;\]/</span><span class="string">'";:=-]/</span></span><br><span class="line"><span class="string">atom.commands.add '</span>atom-text-editor<span class="string">', '</span>custom:jump-over-symbol<span class="string">': (event) -&gt;</span></span><br><span class="line"><span class="string">  editor = atom.workspace.getActiveTextEditor()</span></span><br><span class="line"><span class="string">  cursorMoved = false</span></span><br><span class="line"><span class="string">  for cursor in editor.getCursors()</span></span><br><span class="line"><span class="string">    range = cursor.getCurrentWordBufferRange(wordRegex: EndingSymbolRegex)</span></span><br><span class="line"><span class="string">    unless range.isEmpty()</span></span><br><span class="line"><span class="string">      cursor.setBufferPosition(range.end)</span></span><br><span class="line"><span class="string">      cursorMoved = true</span></span><br><span class="line"><span class="string">  event.abortKeyBinding() unless cursorMoved</span></span><br></pre></td></tr></table></figure></p>
<p>然后用 呼出 <code>Command Palette</code>，在里面输入 <code>keymap</code>，你应该能看到<code>Application: Open Your keymap</code> 已经排在第一位了，当它是第一位的时候，直接回车键 ⏎ …… 在 Keymap 文件里拷贝粘贴以下代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;enter&quot;: &quot;custom:jump-over-symbol&quot;</span><br></pre></td></tr></table></figure>
<p>现在，用呼出 Command Palette，在里面输入 reload，你应该能看到 <code>Window: Reload</code>,启动加载生效。</p>
<h2 id="atom-Snippets"><a href="#atom-Snippets" class="headerlink" title="atom Snippets"></a>atom Snippets</h2><p>编写自己的 snippets 按照格式，可以把代码片段很快输入。<br>打开setting-&gt;install 可以添加 snippets 和 packages<br>例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// apm是atom提供的一个安装工具</span><br><span class="line">apm install atom-yii2 //网上找的的一个yii2的snippets，还有laravel的，php的</span><br></pre></td></tr></table></figure>
<p>可以在atom官方网站或者github中找到</p>
<h2 id="atom-packages"><a href="#atom-packages" class="headerlink" title="atom packages"></a>atom packages</h2><p>GOOGLE 下面的词汇，会得到一些常用的包</p>
<blockquote>
<p>favorite atom packages<br>most popular atom packages<br>must have packages for developer</p>
</blockquote>
]]></content>
  </entry>
  <entry>
    <title>hexo tutorial</title>
    <url>/2014/08/17/hexo-tutorial/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h1 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h1><h2 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br><span class="line">$ hexo new article</span><br><span class="line">$ hexo new page tags</span><br><span class="line">$ hexo new page tags</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h2 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h2 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h2 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">//安装nvm,nvm是一个nodejs的版本管理器</span><br><span class="line">curl https://raw.github.com/creationix/nvm/master/install.sh | sh</span><br><span class="line">//安装nodejs 4以上的稳定版，官方有两个版本，目前是4.4.5稳定版本，这里自带的也会安装npm对应的版本</span><br><span class="line">nvm install 4</span><br><span class="line"></span><br><span class="line">//如果已经安装，直接安装hexo客户端</span><br><span class="line">npm install -g hexo-cli</span><br><span class="line">//有时候上面的安装命令不成功，是因为npm的源请求不到，这里安装一个国内的淘宝源</span><br><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br><span class="line">//安装完成之后,cnpm 就可以使用了</span><br><span class="line">cnpm install -g hexo-cli</span><br></pre></td></tr></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo new <span class="string">"postName"</span> <span class="comment">#新建文章</span></span><br><span class="line">hexo new page <span class="string">"pageName"</span> <span class="comment">#新建页面</span></span><br><span class="line">hexo new draft <span class="string">"postname"</span> <span class="comment">#草稿</span></span><br><span class="line"> hexo generate <span class="comment">#生成静态页面至public目录</span></span><br><span class="line">hexo server <span class="comment">#开启预览访问端口（默认端口4000，'ctrl + c'关闭server）</span></span><br><span class="line">hexo deploy <span class="comment">#将.deploy目录部署到GitHub</span></span><br><span class="line">hexo <span class="built_in">help</span>  <span class="comment"># 查看帮助</span></span><br><span class="line">hexo version  <span class="comment">#查看Hexo的版本</span></span><br><span class="line">hexo publish [layout] postname <span class="comment"># 从草稿中发布</span></span><br><span class="line"></span><br><span class="line">//git</span><br><span class="line">npm install hexo-deployer-git --save</span><br><span class="line"></span><br><span class="line">hexo deploy -g  <span class="comment">#生成加部署</span></span><br><span class="line">hexo server -g  <span class="comment">#生成加预览</span></span><br></pre></td></tr></table></figure>
<h2 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h2><table>
<thead>
<tr>
<th>Layout</th>
<th>Path</th>
</tr>
</thead>
<tbody>
<tr>
<td>post</td>
<td>source/_posts</td>
</tr>
<tr>
<td>page</td>
<td>source</td>
</tr>
<tr>
<td>draft</td>
<td>source/_draft</td>
</tr>
</tbody>
</table>
<h2 id="Scaffolds-脚手架-更改默认的生成模板"><a href="#Scaffolds-脚手架-更改默认的生成模板" class="headerlink" title="Scaffolds(脚手架)更改默认的生成模板"></a>Scaffolds(脚手架)更改默认的生成模板</h2><blockquote>
<p>是根据scaffolds中的模板来创建的，其中参数可以用下面的：</p>
</blockquote>
<table>
<thead>
<tr>
<th>Placeholder</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>layout</td>
<td>Layout</td>
</tr>
<tr>
<td>title</td>
<td>Title</td>
</tr>
<tr>
<td>date</td>
<td>File created date</td>
</tr>
</tbody>
</table>
<h2 id="重新部署"><a href="#重新部署" class="headerlink" title="重新部署"></a>重新部署</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo generate</span><br><span class="line">hexo deploy</span><br></pre></td></tr></table></figure>
<p>部署配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line"><span class="built_in">type</span>: git</span><br><span class="line">repository: git@github.com:changyuan/changyuan.github.io.git</span><br><span class="line">branch: master</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在本地生成==ssh-keygen -t rsa -C “<a href="mailto:admin@example.com" target="_blank" rel="noopener">admin@example.com</a>“== ，然后把是生成的公钥复制到==Settings-&gt;Deploy keys中==</p>
</blockquote>
<h2 id="本地调试"><a href="#本地调试" class="headerlink" title="本地调试"></a>本地调试</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo g <span class="comment">#生成</span></span><br><span class="line">hexo s <span class="comment">#启动本地服务，进行文章预览调试</span></span><br><span class="line"><span class="comment">#简化为</span></span><br><span class="line">hexo s -g</span><br></pre></td></tr></table></figure>
<h2 id="命令简写"><a href="#命令简写" class="headerlink" title="命令简写"></a>命令简写</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo n == hexo new</span><br><span class="line">hexo g == hexo generate</span><br><span class="line">hexo s == hexo server</span><br><span class="line">hexo d == hexo deploy</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个静态的web网站就被部署到了github，检查一下分支是gh-pages。gh-pages是github为了web项目特别设置的分支。</p>
</blockquote>
<h2 id="Tag-Plugins-引用块"><a href="#Tag-Plugins-引用块" class="headerlink" title="Tag Plugins 引用块"></a>Tag Plugins 引用块</h2><h3 id="Block-Quote"><a href="#Block-Quote" class="headerlink" title="Block Quote"></a>Block Quote</h3><blockquote><p>Do not just seek happiness for yourself. Seek happiness for all. Through kindness. Through mercy. 这是引用的话。 </p>
<footer><strong>作者</strong><cite>作品</cite></footer></blockquote>

--------------------------------------------------------------------------------

<blockquote><p>Every interaction is both precious and an opportunity to delight. </p>
<footer><strong>Seth Godin <http: 2009 sethgodin.typepad.com seths_blog 07 welcome-to-island-marketing.html> Welcome to Island Marketing</http:></strong></footer></blockquote>
<h3 id="Code-Block"><a href="#Code-Block" class="headerlink" title="Code Block"></a>Code Block</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alert </span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[rectangle setX: <span class="number">10</span> y: <span class="number">10</span> width: <span class="number">20</span> height: <span class="number">20</span>]; </span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Array.map</span></figcaption><table><tr><td class="code"><pre><span class="line">array.map(callback[, thisArg]) </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>_.compact <http: underscorejs.org #compact> Underscore.js</http:></span></figcaption><table><tr><td class="code"><pre><span class="line">_ .compact([0, 1, false, 2, &apos;&apos;, 3]); =&gt; [1, 2, 3] </span><br></pre></td></tr></table></figure>
<ul>
<li><a href="http://blog.fens.me/hexo-blog-github/" target="_blank" rel="noopener">参考1</a></li>
<li><a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">参考2</a></li>
</ul>
]]></content>
      <categories>
        <category>日志</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>next</tag>
      </tags>
  </entry>
  <entry>
    <title>git-cheatsheet</title>
    <url>/2014/09/02/git-cheatsheet/</url>
    <content><![CDATA[<p><img src="http://www.ruanyifeng.com/blogimg/asset/2015/bg2015120901.png" alt="GIT"></p>
<ul>
<li>Workspace：工作区</li>
<li>Index / Stage：暂存区</li>
<li>Repository：仓库区（或本地仓库）</li>
<li>Remote：远程仓库<a id="more"></a>
</li>
</ul>
<h3 id="新建代码库"><a href="#新建代码库" class="headerlink" title="新建代码库"></a>新建代码库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在当前目录新建一个Git代码库</span></span><br><span class="line">$ git init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个目录，将其初始化为Git代码库</span></span><br><span class="line">$ git init [project-name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载一个项目和它的整个代码历史</span></span><br><span class="line">$ git <span class="built_in">clone</span> [url]</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>Git的设置文件为.gitconfig，它可以在用户主目录下（全局配置），也可以在项目目录下（项目配置）。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 显示当前的Git配置</span></span><br><span class="line">$ git config --list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑Git配置文件</span></span><br><span class="line">$ git config -e [--global]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置提交代码时的用户信息</span></span><br><span class="line">$ git config [--global] user.name <span class="string">"[name]"</span></span><br><span class="line">$ git config [--global] user.email <span class="string">"[email address]"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="增加-删除文件"><a href="#增加-删除文件" class="headerlink" title="增加/删除文件"></a>增加/删除文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加指定文件到暂存区</span></span><br><span class="line">$ git add [file1] [file2] ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加指定目录到暂存区，包括子目录</span></span><br><span class="line">$ git add [dir]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加当前目录的所有文件到暂存区</span></span><br><span class="line">$ git add .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加每个变化前，都会要求确认</span></span><br><span class="line"><span class="comment"># 对于同一个文件的多处变化，可以实现分次提交</span></span><br><span class="line">$ git add -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除工作区文件，并且将这次删除放入暂存区</span></span><br><span class="line">$ git rm [file1] [file2] ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止追踪指定文件，但该文件会保留在工作区</span></span><br><span class="line">$ git rm --cached [file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改名文件，并且将这个改名放入暂存区</span></span><br><span class="line">$ git mv [file-original] [file-renamed]</span><br></pre></td></tr></table></figure>
<h3 id="代码提交"><a href="#代码提交" class="headerlink" title="代码提交"></a>代码提交</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 提交暂存区到仓库区</span><br><span class="line">$ git commit -m [message]</span><br><span class="line"></span><br><span class="line"># 提交暂存区的指定文件到仓库区</span><br><span class="line">$ git commit [file1] [file2] ... -m [message]</span><br><span class="line"></span><br><span class="line"># 提交工作区自上次commit之后的变化，直接到仓库区</span><br><span class="line">$ git commit -a</span><br><span class="line"></span><br><span class="line"># 提交时显示所有diff信息</span><br><span class="line">$ git commit -v</span><br><span class="line"></span><br><span class="line"># 使用一次新的commit，替代上一次提交</span><br><span class="line"># 如果代码没有任何新变化，则用来改写上一次commit的提交信息</span><br><span class="line">$ git commit --amend -m [message]</span><br><span class="line"></span><br><span class="line"># 重做上一次commit，并包括指定文件的新变化</span><br><span class="line">$ git commit --amend [file1] [file2] ...</span><br></pre></td></tr></table></figure>
<h3 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 列出所有本地分支</span><br><span class="line">$ git branch</span><br><span class="line"></span><br><span class="line"># 列出所有远程分支</span><br><span class="line">$ git branch -r</span><br><span class="line"></span><br><span class="line"># 列出所有本地分支和远程分支</span><br><span class="line">$ git branch -a</span><br><span class="line"></span><br><span class="line"># 新建一个分支，但依然停留在当前分支</span><br><span class="line">$ git branch [branch-name]</span><br><span class="line"></span><br><span class="line"># 新建一个分支，并切换到该分支</span><br><span class="line">$ git checkout -b [branch]</span><br><span class="line"></span><br><span class="line"># 新建一个分支，指向指定commit</span><br><span class="line">$ git branch [branch] [commit]</span><br><span class="line"></span><br><span class="line"># 新建一个分支，与指定的远程分支建立追踪关系</span><br><span class="line">$ git branch --track [branch] [remote-branch]</span><br><span class="line"></span><br><span class="line"># 切换到指定分支，并更新工作区</span><br><span class="line">$ git checkout [branch-name]</span><br><span class="line"></span><br><span class="line"># 切换到上一个分支</span><br><span class="line">$ git checkout -</span><br><span class="line"></span><br><span class="line"># 建立追踪关系，在现有分支与指定的远程分支之间</span><br><span class="line">$ git branch --set-upstream [branch] [remote-branch]</span><br><span class="line"></span><br><span class="line"># 合并指定分支到当前分支</span><br><span class="line">$ git merge [branch]</span><br><span class="line"></span><br><span class="line"># 选择一个commit，合并进当前分支</span><br><span class="line">$ git cherry-pick [commit]</span><br><span class="line"></span><br><span class="line"># 删除分支</span><br><span class="line">$ git branch -d [branch-name]</span><br><span class="line"></span><br><span class="line"># 删除远程分支</span><br><span class="line">$ git push origin --delete [branch-name]</span><br><span class="line">$ git branch -dr [remote/branch]</span><br></pre></td></tr></table></figure>
<h3 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 列出所有tag</span><br><span class="line">$ git tag</span><br><span class="line"></span><br><span class="line"># 新建一个tag在当前commit</span><br><span class="line">$ git tag [tag]</span><br><span class="line"></span><br><span class="line"># 新建一个tag在指定commit</span><br><span class="line">$ git tag [tag] [commit]</span><br><span class="line"></span><br><span class="line"># 删除本地tag</span><br><span class="line">$ git tag -d [tag]</span><br><span class="line"></span><br><span class="line"># 删除远程tag</span><br><span class="line">$ git push origin :refs/tags/[tagName]</span><br><span class="line"></span><br><span class="line"># 查看tag信息</span><br><span class="line">$ git show [tag]</span><br><span class="line"></span><br><span class="line"># 提交指定tag</span><br><span class="line">$ git push [remote] [tag]</span><br><span class="line"></span><br><span class="line"># 提交所有tag</span><br><span class="line">$ git push [remote] --tags</span><br><span class="line"></span><br><span class="line"># 新建一个分支，指向某个tag</span><br><span class="line">$ git checkout -b [branch] [tag]</span><br></pre></td></tr></table></figure>
<h3 id="查看信息"><a href="#查看信息" class="headerlink" title="查看信息"></a>查看信息</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">	</span><br><span class="line"># 显示有变更的文件</span><br><span class="line">$ git status</span><br><span class="line"></span><br><span class="line"># 显示当前分支的版本历史</span><br><span class="line">$ git log</span><br><span class="line"></span><br><span class="line"># 显示commit历史，以及每次commit发生变更的文件</span><br><span class="line">$ git log --stat</span><br><span class="line"></span><br><span class="line"># 搜索提交历史，根据关键词</span><br><span class="line">$ git log -S [keyword]</span><br><span class="line"></span><br><span class="line"># 显示某个commit之后的所有变动，每个commit占据一行</span><br><span class="line">$ git log [tag] HEAD --pretty=format:%s</span><br><span class="line"></span><br><span class="line"># 显示某个commit之后的所有变动，其&quot;提交说明&quot;必须符合搜索条件</span><br><span class="line">$ git log [tag] HEAD --grep feature</span><br><span class="line"></span><br><span class="line"># 显示某个文件的版本历史，包括文件改名</span><br><span class="line">$ git log --follow [file]</span><br><span class="line">$ git whatchanged [file]</span><br><span class="line"></span><br><span class="line"># 显示指定文件相关的每一次diff</span><br><span class="line">$ git log -p [file]</span><br><span class="line"></span><br><span class="line"># 显示过去5次提交</span><br><span class="line">$ git log -5 --pretty --oneline</span><br><span class="line"></span><br><span class="line"># 显示所有提交过的用户，按提交次数排序</span><br><span class="line">$ git shortlog -sn</span><br><span class="line"></span><br><span class="line"># 显示指定文件是什么人在什么时间修改过</span><br><span class="line">$ git blame [file]</span><br><span class="line"></span><br><span class="line"># 显示暂存区和工作区的差异</span><br><span class="line">$ git diff</span><br><span class="line"></span><br><span class="line"># 显示暂存区和上一个commit的差异</span><br><span class="line">$ git diff --cached [file]</span><br><span class="line"></span><br><span class="line"># 显示工作区与当前分支最新commit之间的差异</span><br><span class="line">$ git diff HEAD</span><br><span class="line"></span><br><span class="line"># 显示两次提交之间的差异</span><br><span class="line">$ git diff [first-branch]...[second-branch]</span><br><span class="line"></span><br><span class="line"># 显示今天你写了多少行代码</span><br><span class="line">$ git diff --shortstat &quot;@&#123;0 day ago&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 显示某次提交的元数据和内容变化</span><br><span class="line">$ git show [commit]</span><br><span class="line"></span><br><span class="line"># 显示某次提交发生变化的文件</span><br><span class="line">$ git show --name-only [commit]</span><br><span class="line"></span><br><span class="line"># 显示某次提交时，某个文件的内容</span><br><span class="line">$ git show [commit]:[filename]</span><br><span class="line"></span><br><span class="line"># 显示当前分支的最近几次提交</span><br><span class="line">$ git reflog</span><br></pre></td></tr></table></figure>
<h3 id="远程同步"><a href="#远程同步" class="headerlink" title="远程同步"></a>远程同步</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 下载远程仓库的所有变动</span><br><span class="line">$ git fetch [remote]</span><br><span class="line"></span><br><span class="line"># 显示所有远程仓库</span><br><span class="line">$ git remote -v</span><br><span class="line"></span><br><span class="line"># 显示某个远程仓库的信息</span><br><span class="line">$ git remote show [remote]</span><br><span class="line"></span><br><span class="line"># 增加一个新的远程仓库，并命名</span><br><span class="line">$ git remote add [shortname] [url]</span><br><span class="line"></span><br><span class="line"># 取回远程仓库的变化，并与本地分支合并</span><br><span class="line">$ git pull [remote] [branch]</span><br><span class="line"></span><br><span class="line"># 上传本地指定分支到远程仓库</span><br><span class="line">$ git push [remote] [branch]</span><br><span class="line"></span><br><span class="line"># 强行推送当前分支到远程仓库，即使有冲突</span><br><span class="line">$ git push [remote] --force</span><br><span class="line"></span><br><span class="line"># 推送所有分支到远程仓库</span><br><span class="line">$ git push [remote] --all</span><br></pre></td></tr></table></figure>
<h3 id="撤销"><a href="#撤销" class="headerlink" title="撤销"></a>撤销</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 恢复暂存区的指定文件到工作区</span><br><span class="line">$ git checkout [file]</span><br><span class="line"></span><br><span class="line"># 恢复某个commit的指定文件到暂存区和工作区</span><br><span class="line">$ git checkout [commit] [file]</span><br><span class="line"></span><br><span class="line"># 恢复暂存区的所有文件到工作区</span><br><span class="line">$ git checkout .</span><br><span class="line"></span><br><span class="line"># 恢复暂存区的所有的php文件到工作区</span><br><span class="line">git checkout *.php</span><br><span class="line"></span><br><span class="line"># 重置暂存区的指定文件，与上一次commit保持一致，但工作区不变</span><br><span class="line">$ git reset [file]</span><br><span class="line"></span><br><span class="line"># 重置暂存区与工作区，与上一次commit保持一致</span><br><span class="line">$ git reset --hard</span><br><span class="line"></span><br><span class="line"># 重置当前分支的指针为指定commit，同时重置暂存区，但工作区不变</span><br><span class="line">$ git reset [commit]</span><br><span class="line"></span><br><span class="line"># 重置当前分支的HEAD为指定commit，同时重置暂存区和工作区，与指定commit一致</span><br><span class="line">$ git reset --hard [commit]</span><br><span class="line"></span><br><span class="line"># 重置当前HEAD为指定commit，但保持暂存区和工作区不变</span><br><span class="line">$ git reset --keep [commit]</span><br><span class="line"></span><br><span class="line"># 新建一个commit，用来撤销指定commit</span><br><span class="line"># 后者的所有变化都将被前者抵消，并且应用到当前分支</span><br><span class="line">$ git revert [commit]</span><br><span class="line"></span><br><span class="line"># 暂时将未提交的变化移除，稍后再移入</span><br><span class="line">$ git stash</span><br><span class="line">$ git stash pop</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#生成一个可供发布的压缩包</span><br><span class="line">git archive</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Git-Basics"><a href="#Git-Basics" class="headerlink" title="Git Basics"></a>Git Basics</h3><ul>
<li>git init Initialize a repository</li>
<li>git status Show status of working tree</li>
<li>git add file.txt Start tracking file.txt</li>
<li>git add main.txt Stage modified file main.txt</li>
<li>git diff Show what’s changed but not yet staged</li>
<li>git commit Commit changes</li>
<li>git commit -a Stage files and commit</li>
<li>git mv main.txt file.txt Rename main.txt to file.txt</li>
<li>git fetch develop Pull data from remote ‘develop’ without merging</li>
<li>git pull origin develop Fetch and merge branch ‘develop’ from origin</li>
<li>git clone url Create local copy of remote repository at ‘url’</li>
</ul>
<h3 id="Branching"><a href="#Branching" class="headerlink" title="Branching"></a>Branching</h3><ul>
<li>git branch Show current branches</li>
<li>git push origin master Push master branch to origin server</li>
<li>git branch -v Show last commit on all branches</li>
<li>git checkout master Switch to branch ‘master’</li>
<li>git branch feature1 Create new branch called ‘feature1’</li>
<li>git checkout -b feature2 Create branch ‘feature2’ and switch to it</li>
<li>git branch -d mybranch Delete branch ‘mybranch’</li>
<li>git branch –merged Show branches already merged into current branch</li>
<li>git branch –no-merged Show branches not yet merged into current branch</li>
<li>git branch -D fix Force delete branch ‘fix’ that is not yet merged</li>
<li>git push origin feature1 Push local branch ‘feature1’ to origin</li>
<li>git push staging develop:master Push develop branch to remote staging master</li>
<li>git checkout -b fix1 origin/fix1 Create local branch ‘fix1’ based off origin branch</li>
<li>git checkout –track origin/fix2 Create tracking branch ‘fix2’ based off origin</li>
<li>git push origin :fix2 Delete remote branch ‘fix2’ from origin</li>
</ul>
<p><code>`</code></p>
<h3 id="Merging-Rebasing"><a href="#Merging-Rebasing" class="headerlink" title="Merging / Rebasing"></a>Merging / Rebasing</h3><ul>
<li>git mergetool Use graphical merge tool</li>
<li>git commit Finalize merge after resolving conflicts</li>
<li>git merge feature1 Merge branch ‘feature1’ with current branch</li>
<li>git add file.txt Mark file.txt as resolved after merge</li>
<li>git rebase develop Rebase changes made on current branch over develop</li>
<li>git rebase master develop Rebase master onto develop without checking it out</li>
<li>git rebase –onto master 1a 1b Rebase master onto branch 1b made from branch 1a<h3 id="Remotes"><a href="#Remotes" class="headerlink" title="Remotes"></a>Remotes</h3></li>
<li>git remote Show remote servers you have configured</li>
<li>git remote -v Show remote servers with URL displayed</li>
<li>git remote add myurl url Add remote server ‘url’ with shortname ‘myurl’</li>
<li>git remote rename server1 server2 Rename remote ‘server1’ to ‘server2’</li>
<li>git remote rm server1 Remove remote ‘server1’</li>
<li>git remote show origin Show info about remote origin<h3 id="Commit-Logs"><a href="#Commit-Logs" class="headerlink" title="Commit Logs"></a>Commit Logs</h3></li>
<li>git log Show commit logs</li>
<li>git log -p -2 Show last two commits with diffs</li>
<li>git log –stat Show commit logs with stats</li>
<li>git log –pretty=oneline Show commit logs one per line</li>
<li>git log –graph Show commit logs with ascii graph</li>
<li>git log –since=1.week Show commit log for the last week</li>
<li>git blame -L 10,15 file.rb Show prev commits for each lines 10-15 of file.rb<h3 id="Undo-Change-History"><a href="#Undo-Change-History" class="headerlink" title="Undo / Change History"></a>Undo / Change History</h3></li>
<li>git rm –cached main.txt Remove main.txt from staging but keep in working</li>
<li>git commit –amend Replace last commit with whats in staging</li>
<li>git checkout – file.txt Discard changes to file.txt</li>
<li>git reset HEAD file.txt Unstage file.txt</li>
<li>git commit –amend Modify last commit message</li>
<li>git rebase -i HEAD~3 Make changes to the last 3 commits<h3 id="Using-Tags"><a href="#Using-Tags" class="headerlink" title="Using Tags"></a>Using Tags</h3></li>
<li>git tag Show available tags</li>
<li>git tag -a v3.0 Create annotated tag ‘v3.0’</li>
<li>git show v3.0 Show info for tag v3.0</li>
<li>git tag -s v3.0 Create signed tag v3.0</li>
<li>git tag v2.1-lw Create lightweight tag v2.1</li>
<li>git tag -v v3.0 Verify signed tag v3.0</li>
<li>git tag -a v2.2 8feb Tag previous commit ‘8feb’ as v2.2</li>
<li>git push origin v2.2 Push tag v2.2 to origin</li>
<li>git push origin –tags Push all local tags to origin<h3 id="Using-Stashes"><a href="#Using-Stashes" class="headerlink" title="Using Stashes"></a>Using Stashes</h3></li>
<li>git stash Stash changes without committing</li>
<li>git stash list Show stores stashes</li>
<li>git stash apply Reapply most recent stash</li>
<li>git stash apply stash@2 Reapply stash 2</li>
<li>git stash apply –index Reapply stashed changes along with staged changes</li>
<li>git stash drop stash@{2} Drop stash 2</li>
<li>git stash pop Apply most recent stash and drop from stack</li>
<li>git stash branch mybranch Create branch ‘mybranch’ from stash</li>
<li>git stash clear Delete all stashes</li>
<li>git diff –staged Show what’s staged but not yet committed</li>
<li>git diff –check Check for whitespace errors before committing</li>
</ul>
<h3 id="Using-Bisect"><a href="#Using-Bisect" class="headerlink" title="Using Bisect"></a>Using Bisect</h3><ul>
<li>git bisect start Start binary search of commits to find bad commit</li>
<li>git bisect bad Mark current commit as broken during bisect</li>
<li>git bisect good v2.2 Mark v2.2 as last known good commit during bisect</li>
<li>git bisect good Mark current commit as good during bisect</li>
<li>git bisect reset Reset HEAD when finished with bisect</li>
<li>git bisect run test.sh Run ‘test.sh’ on each commit during bisect</li>
</ul>
<p><a href="http://www.ruanyifeng.com/blog/2015/12/git-workflow.html" target="_blank" rel="noopener">参考</a><br><a href="https://www.shortcutfoo.com/app/dojos/git/cheatsheet" target="_blank" rel="noopener">参考</a></p>
]]></content>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTPS 升级指南</title>
    <url>/2014/11/23/https/</url>
    <content><![CDATA[<p>上一篇文章我介绍了 <a href="http://www.ruanyifeng.com/blog/2016/08/http.html" target="_blank" rel="noopener">HTTP/2 协议</a> ，它只有在 HTTPS 环境才会生效。</p>
<p>为了升级到 HTTP/2 协议，必须先启用 HTTPS。如果你不了解 HTTPS 协议（学名 TLS 协议），可以参考我以前的文章。</p>
<blockquote>
<ul>
<li><a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html" target="_blank" rel="noopener">《HTTPS 协议概述》</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html" target="_blank" rel="noopener">《图解 HTTPS 协议》</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2011/02/seven_myths_about_https.html" target="_blank" rel="noopener">《HTTPS 协议的七个误解》</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/09/ssl-latency.html" target="_blank" rel="noopener">《HTTPS 协议的延迟有多大？》</a></li>
</ul>
</blockquote>
<a id="more"></a>
<p>本文介绍如何将一个 HTTP 网站升级到 HTTPS 。</p>
<p><img src="http://www.ruanyifeng.com/blogimg/asset/2016/bg2016082601.png" alt></p>
<h2 id="一、获取证书"><a href="#一、获取证书" class="headerlink" title="一、获取证书"></a>一、获取证书</h2><p>升级到HTTPS协议的第一步，就是要获得一张证书。</p>
<p>证书是一个二进制文件，里面包含经过认证的网站公钥和一些元数据，要从经销商购买。</p>
<blockquote>
<ul>
<li><a href="https://www.gogetssl.com/" target="_blank" rel="noopener">GoGetSSL</a></li>
<li><a href="https://www.ssls.com/" target="_blank" rel="noopener">SSLs.com</a></li>
<li><a href="https://sslmate.com/" target="_blank" rel="noopener">SSLmate.com</a></li>
</ul>
</blockquote>
<p>证书有很多类型，首先分为三种认证级别。</p>
<p><img src="http://www.ruanyifeng.com/blogimg/asset/2016/bg2016082602.png" alt></p>
<blockquote>
<ul>
<li><strong>域名认证</strong>（Domain Validation）：最低级别认证，可以确认申请人拥有这个域名。对于这种证书，浏览器会在地址栏显示一把锁。</li>
<li><strong>公司认证</strong>（Company Validation）：确认域名所有人是哪一家公司，证书里面会包含公司信息。</li>
<li><strong>扩展认证</strong>（Extended Validation）：最高级别的认证，浏览器地址栏会显示公司名。</li>
</ul>
</blockquote>
<p>还分为三种覆盖范围。</p>
<blockquote>
<ul>
<li><strong>单域名证书</strong>：只能用于单一域名，<code>foo.com</code>的证书不能用于<code>www.foo.com</code></li>
<li><strong>通配符证书</strong>：可以用于某个域名及其所有一级子域名，比如<code>*.foo.com</code>的证书可以用于<code>foo.com</code>，也可以用于<code>www.foo.com</code></li>
<li><strong>多域名证书</strong>：可以用于多个域名，比如<code>foo.com</code>和<code>bar.com</code></li>
</ul>
</blockquote>
<p>认证级别越高、覆盖范围越广的证书，价格越贵。</p>
<p>还有一个免费证书的选择。为了推广HTTPS协议，电子前哨基金会EFF成立了 <a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let’s Encrypt</a>，提供免费证书（<a href="https://www.digitalocean.com/community/tags/let-s-encrypt?type=tutorials" target="_blank" rel="noopener">教程</a>和<a href="https://certbot.eff.org/" target="_blank" rel="noopener">工具</a>）。</p>
<p>拿到证书以后，可以用<a href="https://tools.keycdn.com/ssl" target="_blank" rel="noopener">SSL Certificate Check</a>检查一下，信息是否正确。</p>
<h2 id="二、安装证书"><a href="#二、安装证书" class="headerlink" title="二、安装证书"></a>二、安装证书</h2><p>证书可以放在<code>/etc/ssl</code>目录（Linux 系统），然后根据你使用的Web服务器进行配置。</p>
<blockquote>
<ul>
<li><a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/" target="_blank" rel="noopener">证书配置文件生成器</a>，by Mozilla</li>
<li><a href="https://github.com/SSLMate/tlsconfigguide/tree/master/templates" target="_blank" rel="noopener">配置文件模板</a>，by SSLMate</li>
</ul>
</blockquote>
<p>如果使用 Let’s Encrypt 证书，请使用自动安装工具<a href="https://certbot.eff.org/" target="_blank" rel="noopener">Certbot</a>。</p>
<p>安装成功后，使用 <a href="https://www.ssllabs.com/ssltest/analyze.html" target="_blank" rel="noopener">SSL Labs Server Test</a> 检查一下证书是否生效。</p>
<h2 id="三、修改链接"><a href="#三、修改链接" class="headerlink" title="三、修改链接"></a>三、修改链接</h2><p>下一步，网页加载的 HTTP 资源，全部改成 HTTPS 链接。因为加密网页内有非加密的资源，浏览器是不会加载的。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://foo.com/jquery.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面这行加载命令，有两种改法。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 改法一 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://foo.com/jquery.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 改法二 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"//foo.com/jquery.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中，改法二会根据当前网页的协议，加载相同协议的外部资源，更灵活一些。</p>
<p>另外，如果页面头部用到了<code>rel=&quot;canonical&quot;</code>，也要改成HTTPS网址。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"canonical"</span> <span class="attr">href</span>=<span class="string">"https://foo.com/bar.html"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="四、301重定向"><a href="#四、301重定向" class="headerlink" title="四、301重定向"></a>四、301重定向</h2><p>下一步，修改 Web 服务器的配置文件，使用 301 重定向，将 HTTP 协议的访问导向 HTTPS 协议。</p>
<p><a href="https://serverfault.com/questions/67316/in-nginx-how-can-i-rewrite-all-http-requests-to-https-while-maintaining-sub-dom" target="_blank" rel="noopener">Nginx 的写法</a>。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name domain.com www.domain.com;</span><br><span class="line">  return 301 https://domain.com$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://httpd.apache.org/docs/2.4/rewrite/remapping.html#canonicalhost" target="_blank" rel="noopener">Apache 的写法</a>（<code>.htaccess</code>文件）。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">RewriteEngine On</span><br><span class="line">RewriteCond %&#123;HTTPS&#125; off</span><br><span class="line">RewriteRule (.*) https://%&#123;HTTP_HOST&#125;%&#123;REQUEST_URI&#125; [R=301,L]</span><br></pre></td></tr></table></figure>
<h2 id="五、安全措施"><a href="#五、安全措施" class="headerlink" title="五、安全措施"></a>五、安全措施</h2><p>以下措施可以进一步保证通信安全。</p>
<h3 id="5-1-HTTP-Strict-Transport-Security-HSTS"><a href="#5-1-HTTP-Strict-Transport-Security-HSTS" class="headerlink" title="5.1 HTTP Strict Transport Security (HSTS)"></a>5.1 HTTP Strict Transport Security (HSTS)</h3><p>访问网站时，用户很少直接在地址栏输入<code>https://</code>，总是通过点击链接，或者3xx重定向，从HTTP页面进入HTTPS页面。攻击者完全可以在用户发出HTTP请求时，劫持并篡改该请求。</p>
<p>另一种情况是恶意网站使用自签名证书，冒充另一个网站，这时浏览器会给出警告，但是许多用户会忽略警告继续访问。</p>
<p>“HTTP严格传输安全”（简称 HSTS）的作用，就是强制浏览器只能发出HTTPS请求，并阻止用户接受不安全的证书。</p>
<p>它在网站的响应头里面，加入一个强制性声明。以下例子摘自<a href="https://zh.wikipedia.org/wiki/HTTP%E4%B8%A5%E6%A0%BC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8" target="_blank" rel="noopener">维基百科</a>。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Strict-Transport-Security</span>: max-age=31536000; includeSubDomains</span><br></pre></td></tr></table></figure>
<p>上面这段头信息有两个作用。</p>
<blockquote>
<p>（1）在接下来的一年（即31536000秒）中，浏览器只要向<code>example.com</code>或其子域名发送HTTP请求时，必须采用HTTPS来发起连接。用户点击超链接或在地址栏输入<code>http://www.example.com/</code>，浏览器应当自动将<code>http</code>转写成<code>https</code>，然后直接向<code>https://www.example.com/</code>发送请求。</p>
<p>（2）在接下来的一年中，如果<code>example.com</code>服务器发送的证书无效，用户不能忽略浏览器警告，将无法继续访问该网站。</p>
</blockquote>
<p>HSTS 很大程度上解决了 SSL 剥离攻击。只要浏览器曾经与服务器建立过一次安全连接，之后浏览器会强制使用<code>HTTPS</code>，即使链接被换成了<code>HTTP</code>。</p>
<p>该方法的主要不足是，用户首次访问网站发出HTTP请求时，是不受HSTS保护的。</p>
<h3 id="5-2-Cookie"><a href="#5-2-Cookie" class="headerlink" title="5.2 Cookie"></a>5.2 Cookie</h3><p>另一个需要注意的地方是，确保浏览器只在使用 HTTPS 时，才发送Cookie。</p>
<p>网站响应头里面，<code>Set-Cookie</code>字段加上<code>Secure</code>标志即可。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Set-Cookie</span>: LSID=DQAAAK…Eaem_vYg; Secure</span><br></pre></td></tr></table></figure>
<h2 id="六、参考链接"><a href="#六、参考链接" class="headerlink" title="六、参考链接"></a>六、参考链接</h2><ul>
<li><a href="https://docs.google.com/document/d/1oRXJUIttqQxuxmjj2tgYjj096IKw4Zcw6eAoIKWZ2oQ/edit#" target="_blank" rel="noopener">How To Migrate To HTTPS</a>, by Chris Palmer</li>
<li><a href="https://www.keycdn.com/blog/http-to-https/" target="_blank" rel="noopener">Complete Guide – How to Migrate from HTTP to HTTPS</a>, by KeyCDN</li>
<li><a href="http://smallbiztrends.com/2015/04/changing-from-http-to-https.html" target="_blank" rel="noopener">What You Need to Know About Changing From Http to Https</a>, by Matt Mansfield</li>
</ul>
<p>（完）</p>
]]></content>
  </entry>
  <entry>
    <title>如何学英语？</title>
    <url>/2014/12/15/learn-english/</url>
    <content><![CDATA[<h1 id="信心来源于理性"><a href="#信心来源于理性" class="headerlink" title="信心来源于理性"></a>信心来源于理性</h1><p>像学自己的母语一样可以学会的，只要不断坚持。很多人学得好的仅仅是身边人学会了，<em>他也行</em> 的启示。</p>
<ul>
<li>大脑是可塑的；</li>
<li>并且它自始至终都是可塑的；</li>
<li>甚至它还会重新组织自己（Reorganizing），通过恰当的训练，它能用另外一个区域习得已被毁坏区域的能力……<a id="more"></a>
</li>
</ul>
<blockquote>
<p>如下面这个小女孩，他受伤的右臂，就是要限制他的左臂。英语也是，如果你要学习这个，首先要限制一下自己的母语，这样你学起来更快，否则大脑会走”捷径”。 <img src="/images/figure05.png" alt="小女孩"></p>
</blockquote>
<p>为什么成年后学习第二语言显得更为困难？ 成年之后，第二语言学习显得更为困难的原因并不在于关键期论所说的”此后大脑不再可塑”，而实际上在于这是第二语言所使用的脑图要与已经形成强大势力的母语脑图竞争—-当然越来越难.然而，恰恰是这样的认识给了人们希望。目前，有很多教育学家开始提倡”浸泡式学习”，有一定的依据，也有相当的效果。所谓”浸泡式学习”，就是在特定的时间、特定的环境里，强迫学生只使用第二语言，禁止使用母语，进而刺激大脑加速构建新的脑图。风靡全球的罗赛塔石碑语言学习软体（<a href="http://www.rosettastone.com/" target="_blank" rel="noopener">Rosetta Stone</a>）就是基于这个原理开发出来的。</p>
<ul>
<li>什么时候开始学都不晚；</li>
<li>只要方法得当，并加以时日，一定能学好。</li>
<li>甚至，第二语言也可能超越母语成为主导语言。</li>
</ul>
<p>罗伯特•莫顿教授发现了这个现象，为这类现象取了个名字叫做”自证预言”（Self-fulfilling prophecy）。</p>
<blockquote>
<p>当人们相信某件事情会发生（事实上那件事情原本并不见得一定会发生），那么此事最终真的会发生。</p>
</blockquote>
<p>而莫顿教授用银行挤兑的例子说明自证预言的作用机理：</p>
<blockquote>
<p>一家银行本来运作得好好的，但不知怎么就开始有谣言说这家银行要倒闭了。流言越穿越广，越来越多的人开始信以为真，开始有人跑到银行把自己的存款提走；进而恐慌开始蔓延，并且变得真实，更多的人冲进银行提走自己的存款……最终，挤兑发生了，银行真的倒闭了。</p>
</blockquote>
<p>很多人宁愿”学一辈子”，却坚持”一辈子不用”的原因就在于害怕犯错。儿时犯错往往招致惩罚，成年之后，就算没有来自他人的惩罚，还有因为犯错而导致自己自卑和尴尬，所以，很多人是”不惜一切代价”避免出错的。然而， <strong>要知道知识的习得过程离不开试错，没有试错，就不可能有全面而真实的进步</strong> 。</p>
<p>潜移默化的教育最有效。当你看到身边的人做成功了，对你启发就大了。反过来，如果要影响身边的人，首先自己去开始做。</p>
<p>我们应该做的是，用最快的速度完成对”马拉松”的适应，而后哪怕每天”马拉松”也不觉得异常，甚至应该早忘记当初的痛苦，而去专注于语言的主要功用：用英语获取信息，用英语交流……反正，用就是了。（海量阅读）</p>
<hr>
<h1 id="口语"><a href="#口语" class="headerlink" title="口语"></a>口语</h1><h2 id="你的问题也许不在于你不会说，而在于你没什么话可说。"><a href="#你的问题也许不在于你不会说，而在于你没什么话可说。" class="headerlink" title="你的问题也许不在于你不会说，而在于你没什么话可说。"></a>你的问题也许不在于你不会说，而在于你没什么话可说。</h2><p>如果遇到你要说的场合，提前”预演”，准本自己需要说什么。如此这般之后，到了现场，基本上能够做到”自如”应对。 在相当长一段时间里，我以为自己”发现”了一条真正的捷径，后来才发现”我并不孤独”。在国内，卖得最好的口语教材，实际上是北京外国语大学的专业教材，作者是北外教授吴桢福老师：一共三本，《英语初级口语》、《英语中级口语》、《英语高级口语》，多年来多次再版，印数均超过100万本。如果读者有机会，不妨去书店翻翻这套教材──你会发现其中的大多数课文话题，实际上也许都是从TOEFL作文题脱胎而来的。</p>
<h2 id="制作自己的口语书"><a href="#制作自己的口语书" class="headerlink" title="制作自己的口语书"></a>制作自己的口语书</h2><p>准备一个笔记本，随身携带。每天花十分钟到半个小时，把自己想要表达的内容用中文记录下来。坚持一段时间之后，每天再多花点时间把那些你要说的话用英文表达出来，并记录下来。</p>
<blockquote>
<p>实际上你必须表达的话并不多…… 这些内容中的绝大多数其实你完全有能力用英文表达（最多查查词典就可以了）。</p>
</blockquote>
<h3 id="一定要用本子记录"><a href="#一定要用本子记录" class="headerlink" title="一定要用本子记录"></a>一定要用本子记录</h3><p>找个本子把自己要说的话记录下来，不仅仅是为了将来翻译成英文。记录下来有很多好处，起码，可以让自己重新审视一下自己所说过的话，避免自己的表达实际上是思维混乱的产物。</p>
<h3 id="根本不知道该如何用英文说怎么办-记录下来，以后”某个时候”会有答案"><a href="#根本不知道该如何用英文说怎么办-记录下来，以后”某个时候”会有答案" class="headerlink" title="根本不知道该如何用英文说怎么办,记录下来，以后”某个时候”会有答案"></a>根本不知道该如何用英文说怎么办,记录下来，以后”某个时候”会有答案</h3><h3 id="学会”换一种说法”"><a href="#学会”换一种说法”" class="headerlink" title="学会”换一种说法”"></a>学会”换一种说法”</h3><p>例如:</p>
<blockquote>
<p>Whoever is a girl does not want to be loved, and whoever is a boy does not want to be royal to his lover.</p>
</blockquote>
<p>所以，”父母们之所以选择男女分校，很可能的原因之一是因为他们害怕自己的孩子早恋。”这句话，我愣是用英文说不出来。但，我还是先把这句话中能说明白的部分记在本子上：</p>
<blockquote>
<p>One of the reasons why many parents want to send their children to separate school is that they are worried about 早恋.</p>
</blockquote>
<p>大概几个星期之后，有一天我在读一篇文章，读到一个词，”undernutrition”（营养不良），脑子里闪过的念头是这个词头”under”究竟都有哪些意思呢？于是动手去查词典。哦，它基本上有两个意思：</p>
<blockquote>
<p>在……之下，比如underground； ……不足、不良，比如，undernutrition，比如underage drinking……</p>
</blockquote>
<p>读到”underage drinking”（未成年人饮酒）的那一瞬间，我突然想到，实际上，我可以不用”早恋”这个词就能把我要说的说明白。其实，中国的父母害怕的并不是所谓的”早恋”，如若一切发生在思维之中，他们很可能其实是并不关心的，就算因”早恋”发生了行动，拉拉手、亲亲嘴，他们也很可能不会太过紧张；然而，他们真的害怕自己的孩子发生”underage sexual behaviors”……</p>
<p>One of the reasons why many parents want to send their children to separate school is that they are worried about possible underage sexual behaviors.</p>
<h3 id="使用平实的、朴素的、没有修辞的中文"><a href="#使用平实的、朴素的、没有修辞的中文" class="headerlink" title="使用平实的、朴素的、没有修辞的中文"></a>使用平实的、朴素的、没有修辞的中文</h3><p>我说主张的口语习得方法不过是”把自己想说的先写下来，然后不断练、不断改”而已。绝大多数最终拥有良好写作能力的人基本上都是靠自己，多读、多写、多改、多练、多观察、多思考、多讨论、多积累……而这些要多做的事情中几乎没有哪一样是哪一个老师能在其中起主导作用的，几乎全都是（只能）靠自己。</p>
<blockquote>
<p>自己给自己改作文 帮别人改作文</p>
</blockquote>
<p>自己给自己批改作文，有个很重要的诀窍：不要写完马上改，而是隔天再修改。你当时那么写（即便是错的）就是因为你认为那么写是对的。这种惯性在刚写完的时候最大，表现最强。所以，写完之后马上修改很可能事倍功半。隔一天就不一样了，很多错误在你眼里几乎是跳出来的，并伴随着惊讶”哎呀！我怎么会犯这种低级错误呢？！”相信我，这其实就是你真正进步的痕迹──因为产生深刻记忆的最有效手段无非两种：重复、惊讶。帮别人改作文是提高自己能力的最快手段之一。也许你会说，”我自己都不会呢，哪儿有能力帮别人改啊？”这不是问题，你试试就知道了，挑错比写文章容易多了，尤其是别人的错，更容易被你找出来。有趣的现象在于，批改者往往比被批改者收获更多。</p>
<h1 id="更重要的是思考能力"><a href="#更重要的是思考能力" class="headerlink" title="更重要的是思考能力"></a>更重要的是思考能力</h1><p>语言最终是用来表达思想的。所以，思考方式格外重要。大多数人不懂得如何正确思考，乃至于所要表达的东西漏洞百出却又不自知。这个问题导致的更多麻烦，很多的时候被一些英语老师归咎于”东西方文化差异”，这是和稀泥的一种说法—-事实上，这跟文化没多大关系，而是思考能力问题。关于文化差异，首先需要的是尊重，其次需要的是理解。而思考能力差异，则是另外一回事，所表达的内容千疮百孔，无论如何都只能怪思考能力差，而与文化差异毫无关系。</p>
<p>不能”只学英语”，这就好像用计算机绘图，只学”Photoshop”是不够的，要有足够的色彩、手绘基本训练，才能够自由创作一样。有几本书，建议所有想获得正确思考能力，进而表达清晰的人阅读。</p>
<ul>
<li>Thought and Knowledge: An Introduction to Critical Thinking 4th edition, by Diane F. Halpern</li>
<li>Thinking and Deciding, 4th edition, by Jonathan Baron</li>
<li>Argumentation: The Study of Effective Reasoning by Zarefsky David (Audiobook)</li>
<li>Craft of Research, by Wayne C. Booth, Gregory G. Colomb, Joseph M. Williams</li>
<li><p>Good Reasoning Matters!: A Constructive Approach to Critical Thinking 3rd edition, by Leo A. Groarke, Christopher W. Tindale 另外，还有三本关于文风（Style）的书籍也一定要看：</p>
</li>
<li><p>A Plain English Handbook (1998), from Security and Exchange Commission, Prefaced by Warren E. Buffett (<a href="http://www.plainlanguage.gov" target="_blank" rel="noopener">http://www.plainlanguage.gov</a>)</p>
</li>
<li><p>On Writing: A Memoir of The Craft by Stephen King (with audiobook) Style: Toward Clarity and Grace by Joseph M. Williams 另外，还有一个TTC (The Teaching Company)的视频教程，是我所见过最好的写作课程：</p>
</li>
<li>Building Great Sentences。</li>
</ul>
<h1 id="秘密武器–-复述"><a href="#秘密武器–-复述" class="headerlink" title="秘密武器– 复述"></a>秘密武器– 复述</h1><p>这还真的并不是那么”显而易见”的事实。ETS在设计并举办TOEFL考试几十年之后才”恍然大悟”地在新托福考试中大面积添加了”复述能力”的考 量：TOEFL作文部分中有综合测试，要求考生先读一篇文章，然后再听一篇与刚刚读过的文章相关的讲座，而后复述讲座内容以及讲座内容是如何与阅读文章内 容相联系的；口语部分中有先听再说，先读再说，听与读之后再说—-无一不是在考量考生的”复述能力”。</p>
<h1 id="模式识别（pattern-recognition-朗读"><a href="#模式识别（pattern-recognition-朗读" class="headerlink" title="模式识别（pattern recognition) 朗读"></a>模式识别（pattern recognition) 朗读</h1><p>模式识别可以在不知不觉中运用正确的词汇，通过肢体表情等等。</p>
<h2 id="语音"><a href="#语音" class="headerlink" title="语音"></a>语音</h2><ol>
<li>发音很重要，但显然不是最重要的</li>
<li>我们完全有能力大幅度改善发音</li>
<li>最大的障碍：害怕被嘲弄</li>
<li>多听多听再多听，去听正常的语速资料不需要听得懂，只需要有语言刺激就可以了，大概半年时间。<br><a href="http://edition.cnn.com/audio/radio/radio.html" target="_blank" rel="noopener">cnn radio</a><br>正如之前所提到的那样，至少要坚持六个月，我个人建议每天的输入时间不要低于四个小时——只要开始做，就会发现其实并不难，因为“哪怕听不懂都无所谓”。听得多了，听得久了，早晚有一天想听不懂都不太容易。当然，即便是最初的时候，为了效果更佳，可以有意识地渐渐提高文本难度，并且最好配合精读。这期间几乎所有的人都会感觉没什么进步，但是，这种“感觉”是不靠谱的——事实上，我们的感觉几乎总是极不靠谱。看看下面的两条直线哪个更长？</li>
</ol>
]]></content>
      <tags>
        <tag>english</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTP 协议入门</title>
    <url>/2014/11/23/http/</url>
    <content><![CDATA[<p>HTTP协议是互联网的基础协议，也是网页开发的必备知识，最新版本 HTTP/2 更是让它成为技术热点。</p>
<p>本文介绍HTTP协议的历史演变和设计思路。</p>
<p><img src="http://www.ruanyifeng.com/blogimg/asset/2016/bg2016081901.jpg" alt><br><a id="more"></a></p>
<h2 id="一、HTTP-0-9"><a href="#一、HTTP-0-9" class="headerlink" title="一、HTTP/0.9"></a>一、HTTP/0.9</h2><p>HTTP是基于 TCP/IP 协议的<a href="http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html" target="_blank" rel="noopener"><strong>应用层协议</strong></a>。它不涉及数据包（packet）传输，主要规定了客户端和服务器之间的通信格式，默认使用80端口。</p>
<p>最早版本是1991年发布的0.9版。该版本极其简单，只有一个命令<code>GET</code>。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET /index.html</span><br></pre></td></tr></table></figure>
<p>上面命令表示，TCP连接（connection）建立后，客户端向服务器请求（request）网页<code>index.html</code>。</p>
<p>协议规定，服务器只能回应HTML格式的字符串，不能回应别的格式。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>服务器发送完毕，就关闭TCP连接。</p>
<h2 id="二、HTTP-1-0"><a href="#二、HTTP-1-0" class="headerlink" title="二、HTTP/1.0"></a>二、HTTP/1.0</h2><h3 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h3><p>1996年5月，HTTP/1.0 版本发布，内容大大增加。</p>
<p>首先，任何格式的内容都可以发送。这使得互联网不仅可以传输文字，还能传输图像、视频、二进制文件。这为互联网的大发展奠定了基础。</p>
<p>其次，除了<code>GET</code>命令，还引入了<code>POST</code>命令和<code>HEAD</code>命令，丰富了浏览器与服务器的互动手段。</p>
<p>再次，HTTP请求和回应的格式也变了。除了数据部分，每次通信都必须包括头信息（HTTP header），用来描述一些元数据。</p>
<p>其他的新增功能还包括状态码（status code）、多字符集支持、多部分发送（multi-part type）、权限（authorization）、缓存（cache）、内容编码（content encoding）等。</p>
<h3 id="2-2-请求格式"><a href="#2-2-请求格式" class="headerlink" title="2.2 请求格式"></a>2.2 请求格式</h3><p>下面是一个1.0版的HTTP请求的例子。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> HTTP/1.0</span><br><span class="line"><span class="attribute">Host</span>: kamranahmed.info</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5)</span><br><span class="line"><span class="attribute">Accept</span>: */*</span><br></pre></td></tr></table></figure>
<p>可以看到，这个格式与0.9版有很大变化。</p>
<p>第一行是请求命令，必须在尾部添加协议版本（<code>HTTP/1.0</code>）。后面就是多行头信息，描述客户端的情况。</p>
<h3 id="2-3-回应格式"><a href="#2-3-回应格式" class="headerlink" title="2.3 回应格式"></a>2.3 回应格式</h3><p>服务器的回应如下。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">HTTP/1.0 <span class="number">200</span> OK </span><br><span class="line"><span class="attribute">Content-Type</span>: text/plain</span><br><span class="line"><span class="attribute">Content-Length</span>: 137582</span><br><span class="line"><span class="attribute">Expires</span>: Thu, 05 Dec 1997 16:00:00 GMT</span><br><span class="line"><span class="attribute">Last-Modified</span>: Wed, 5 August 1996 15:55:28 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache 0.84</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;body&gt;Hello World&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>回应的格式是<code>头信息 + 一个空行（</code>\r\n<code>） + 数据</code>。其中，第一行是<code>协议版本 + 状态码（status code） + 状态描述</code>。</p>
<h3 id="2-4-Content-Type-字段"><a href="#2-4-Content-Type-字段" class="headerlink" title="2.4 Content-Type 字段"></a>2.4 Content-Type 字段</h3><p>关于字符的编码，1.0版规定，头信息必须是 ASCII 码，后面的数据可以是任何格式。因此，服务器回应的时候，必须告诉客户端，数据是什么格式，这就是<code>Content-Type</code>字段的作用。</p>
<p>下面是一些常见的<code>Content-Type</code>字段的值。</p>
<blockquote>
<ul>
<li>text/plain</li>
<li>text/html</li>
<li>text/css</li>
<li>image/jpeg</li>
<li>image/png</li>
<li>image/svg+xml</li>
<li>audio/mp4</li>
<li>video/mp4</li>
<li>application/javascript</li>
<li>application/pdf</li>
<li>application/zip</li>
<li>application/atom+xml</li>
</ul>
</blockquote>
<p>这些数据类型总称为<code>MIME type</code>，包含一级类型和二级类型，之间用斜杠分隔。</p>
<p>除了预定义的类型，厂商也可以自定义类型。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">application/vnd.debian.binary-package</span></span><br></pre></td></tr></table></figure>
<p>上面的类型表明，发送的是Debian系统的二进制数据包。</p>
<p><code>MIME type</code>还可以在尾部使用分号，添加参数。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=utf-8</span><br></pre></td></tr></table></figure>
<p>上面的类型表明，发送的是网页，而且编码是UTF-8。</p>
<p><code>MIME type</code>不仅用在HTTP协议，还可以用在其他地方，比如HTML网页。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 等同于 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-5-Content-Encoding-字段"><a href="#2-5-Content-Encoding-字段" class="headerlink" title="2.5 Content-Encoding 字段"></a>2.5 Content-Encoding 字段</h3><p>由于发送的数据可以是任何格式，因此可以把数据压缩后再发送。<code>Content-Encoding</code>字段说明数据的压缩方法。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Encoding</span>: gzip</span><br><span class="line"><span class="attribute">Content-Encoding</span>: compress</span><br><span class="line"><span class="attribute">Content-Encoding</span>: deflate</span><br></pre></td></tr></table></figure>
<p>客户端在请求时，用<code>Accept-Encoding</code>字段说明自己可以接受哪些压缩方法。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br></pre></td></tr></table></figure>
<h3 id="2-6-缺点"><a href="#2-6-缺点" class="headerlink" title="2.6 缺点"></a>2.6 缺点</h3><p>HTTP/1.0 版的主要缺点是，每个TCP连接只能发送一个请求。发送数据完毕，连接就关闭，如果还要请求其他资源，就必须再新建一个连接。</p>
<p>TCP连接的新建成本很高，因为需要客户端和浏览器三次握手，并且开始时发送速率较慢（slow start）。所以，HTTP 1.0版本的性能比较差。随着网页加载的外部资源越来越多，这个问题就愈发突出了。</p>
<p>为了解决这个问题，有些浏览器在请求时，用了一个非标准的<code>Connection</code>字段。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br></pre></td></tr></table></figure>
<p>这个字段要求服务器不要关闭TCP连接，以便其他请求复用。服务器同样回应这个字段。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br></pre></td></tr></table></figure>
<p>一个可以复用的TCP连接就建立了，直到客户端或服务器主动关闭连接。但是，这不是标准字段，不同实现的行为可能不一致，因此不是根本的解决办法。</p>
<h2 id="三、HTTP-1-1"><a href="#三、HTTP-1-1" class="headerlink" title="三、HTTP/1.1"></a>三、HTTP/1.1</h2><p>1997年1月，HTTP/1.1 版本发布，只比 1.0 版本晚了半年。它进一步完善了 HTTP 协议，一直用到了20年后的今天，直到现在还是最流行的版本。</p>
<h3 id="3-1-持久连接"><a href="#3-1-持久连接" class="headerlink" title="3.1 持久连接"></a>3.1 持久连接</h3><p>1.1 版的最大变化，就是引入了持久连接（persistent connection），即TCP连接默认不关闭，可以被多个请求复用，不用声明<code>Connection: keep-alive</code>。</p>
<p>客户端和服务器发现对方一段时间没有活动，就可以主动关闭连接。不过，规范的做法是，客户端在最后一个请求时，发送<code>Connection: close</code>，明确要求服务器关闭TCP连接。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure>
<p>目前，对于同一个域名，大多数浏览器允许同时建立6个持久连接。</p>
<h3 id="3-2-管道机制"><a href="#3-2-管道机制" class="headerlink" title="3.2 管道机制"></a>3.2 管道机制</h3><p>1.1 版还引入了管道机制（pipelining），即在同一个TCP连接里面，客户端可以同时发送多个请求。这样就进一步改进了HTTP协议的效率。</p>
<p>举例来说，客户端需要请求两个资源。以前的做法是，在同一个TCP连接里面，先发送A请求，然后等待服务器做出回应，收到后再发出B请求。管道机制则是允许浏览器同时发出A请求和B请求，但是服务器还是按照顺序，先回应A请求，完成后再回应B请求。</p>
<h3 id="3-3-Content-Length-字段"><a href="#3-3-Content-Length-字段" class="headerlink" title="3.3 Content-Length 字段"></a>3.3 Content-Length 字段</h3><p>一个TCP连接现在可以传送多个回应，势必就要有一种机制，区分数据包是属于哪一个回应的。这就是<code>Content-length</code>字段的作用，声明本次回应的数据长度。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Length</span>: 3495</span><br></pre></td></tr></table></figure>
<p>上面代码告诉浏览器，本次回应的长度是3495个字节，后面的字节就属于下一个回应了。</p>
<p>在1.0版中，<code>Content-Length</code>字段不是必需的，因为浏览器发现服务器关闭了TCP连接，就表明收到的数据包已经全了。</p>
<h3 id="3-4-分块传输编码"><a href="#3-4-分块传输编码" class="headerlink" title="3.4 分块传输编码"></a>3.4 分块传输编码</h3><p>使用<code>Content-Length</code>字段的前提条件是，服务器发送回应之前，必须知道回应的数据长度。</p>
<p>对于一些很耗时的动态操作来说，这意味着，服务器要等到所有操作完成，才能发送数据，显然这样的效率不高。更好的处理方法是，产生一块数据，就发送一块，采用“流模式”（stream）取代“缓存模式”（buffer）。</p>
<p>因此，1.1版规定可以不使用<code>Content-Length</code>字段，而使用<a href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93%E7%BC%96%E7%A0%81" target="_blank" rel="noopener">“分块传输编码”</a>（chunked transfer encoding）。只要请求或回应的头信息有<code>Transfer-Encoding</code>字段，就表明回应将由数量未定的数据块组成。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Transfer-Encoding</span>: chunked</span><br></pre></td></tr></table></figure>
<p>每个非空的数据块之前，会有一个16进制的数值，表示这个块的长度。最后是一个大小为0的块，就表示本次回应的数据发送完了。下面是一个例子。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span>: text/plain</span><br><span class="line"><span class="attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="attribute">25</span></span><br><span class="line">This is the data in the first chunk</span><br><span class="line"></span><br><span class="line"><span class="attribute">1C</span></span><br><span class="line">and this is the second one</span><br><span class="line"></span><br><span class="line"><span class="attribute">3</span></span><br><span class="line"><span class="attribute">con</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">8</span></span><br><span class="line"><span class="attribute">sequence</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">0</span></span><br></pre></td></tr></table></figure>
<h3 id="3-5-其他功能"><a href="#3-5-其他功能" class="headerlink" title="3.5 其他功能"></a>3.5 其他功能</h3><p>1.1版还新增了许多动词方法：<code>PUT</code>、<code>PATCH</code>、<code>HEAD</code>、 <code>OPTIONS</code>、<code>DELETE</code>。</p>
<p>另外，客户端的请求新增了<code>Host</code>字段，用来指定服务器的域名。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Host</span>: www.example.com</span><br></pre></td></tr></table></figure>
<p>有了<code>Host</code>字段，就可以将请求发往同一台服务器上的不同网站，为虚拟主机的兴起打下了基础。</p>
<h3 id="3-6-缺点"><a href="#3-6-缺点" class="headerlink" title="3.6 缺点"></a>3.6 缺点</h3><p>虽然1.1版允许复用TCP连接，但是同一个TCP连接里面，所有的数据通信是按次序进行的。服务器只有处理完一个回应，才会进行下一个回应。要是前面的回应特别慢，后面就会有许多请求排队等着。这称为<a href="https://zh.wikipedia.org/wiki/%E9%98%9F%E5%A4%B4%E9%98%BB%E5%A1%9E" target="_blank" rel="noopener">“队头堵塞”</a>（Head-of-line blocking）。</p>
<p>为了避免这个问题，只有两种方法：一是减少请求数，二是同时多开持久连接。这导致了很多的网页优化技巧，比如合并脚本和样式表、将图片嵌入CSS代码、域名分片（domain sharding）等等。如果HTTP协议设计得更好一些，这些额外的工作是可以避免的。</p>
<h2 id="四、SPDY-协议"><a href="#四、SPDY-协议" class="headerlink" title="四、SPDY 协议"></a>四、SPDY 协议</h2><p>2009年，谷歌公开了自行研发的 SPDY 协议，主要解决 HTTP/1.1 效率不高的问题。 </p>
<p>这个协议在Chrome浏览器上证明可行以后，就被当作 HTTP/2 的基础，主要特性都在 HTTP/2 之中得到继承。</p>
<h2 id="五、HTTP-2"><a href="#五、HTTP-2" class="headerlink" title="五、HTTP/2"></a>五、HTTP/2</h2><p>2015年，HTTP/2 发布。它不叫 HTTP/2.0，是因为标准委员会不打算再发布子版本了，下一个新版本将是 HTTP/3。</p>
<h3 id="5-1-二进制协议"><a href="#5-1-二进制协议" class="headerlink" title="5.1 二进制协议"></a>5.1 二进制协议</h3><p>HTTP/1.1 版的头信息肯定是文本（ASCII编码），数据体可以是文本，也可以是二进制。HTTP/2 则是一个彻底的二进制协议，头信息和数据体都是二进制，并且统称为“帧”（frame）：头信息帧和数据帧。</p>
<p>二进制协议的一个好处是，可以定义额外的帧。HTTP/2 定义了近十种帧，为将来的高级应用打好了基础。如果使用文本实现这种功能，解析数据将会变得非常麻烦，二进制解析则方便得多。</p>
<h3 id="5-2-多工"><a href="#5-2-多工" class="headerlink" title="5.2 多工"></a>5.2 多工</h3><p>HTTP/2 复用TCP连接，在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，而且不用按照顺序一一对应，这样就避免了“队头堵塞”。</p>
<p>举例来说，在一个TCP连接里面，服务器同时收到了A请求和B请求，于是先回应A请求，结果发现处理过程非常耗时，于是就发送A请求已经处理好的部分， 接着回应B请求，完成后，再发送A请求剩下的部分。</p>
<p>这样双向的、实时的通信，就叫做多工（Multiplexing）。</p>
<h3 id="5-3-数据流"><a href="#5-3-数据流" class="headerlink" title="5.3 数据流"></a>5.3 数据流</h3><p>因为 HTTP/2 的数据包是不按顺序发送的，同一个连接里面连续的数据包，可能属于不同的回应。因此，必须要对数据包做标记，指出它属于哪个回应。</p>
<p>HTTP/2 将每个请求或回应的所有数据包，称为一个数据流（stream）。每个数据流都有一个独一无二的编号。数据包发送的时候，都必须标记数据流ID，用来区分它属于哪个数据流。另外还规定，客户端发出的数据流，ID一律为奇数，服务器发出的，ID为偶数。</p>
<p>数据流发送到一半的时候，客户端和服务器都可以发送信号（<code>RST_STREAM</code>帧），取消这个数据流。1.1版取消数据流的唯一方法，就是关闭TCP连接。这就是说，HTTP/2 可以取消某一次请求，同时保证TCP连接还打开着，可以被其他请求使用。</p>
<p>客户端还可以指定数据流的优先级。优先级越高，服务器就会越早回应。</p>
<h3 id="5-4-头信息压缩"><a href="#5-4-头信息压缩" class="headerlink" title="5.4 头信息压缩"></a>5.4 头信息压缩</h3><p>HTTP 协议不带有状态，每次请求都必须附上所有信息。所以，请求的很多字段都是重复的，比如<code>Cookie</code>和<code>User Agent</code>，一模一样的内容，每次请求都必须附带，这会浪费很多带宽，也影响速度。</p>
<p>HTTP/2 对这一点做了优化，引入了头信息压缩机制（header compression）。一方面，头信息使用<code>gzip</code>或<code>compress</code>压缩后再发送；另一方面，客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，以后就不发送同样字段了，只发送索引号，这样就提高速度了。</p>
<h3 id="5-5-服务器推送"><a href="#5-5-服务器推送" class="headerlink" title="5.5 服务器推送"></a>5.5 服务器推送</h3><p>HTTP/2 允许服务器未经请求，主动向客户端发送资源，这叫做服务器推送（server push）。</p>
<p>常见场景是客户端请求一个网页，这个网页里面包含很多静态资源。正常情况下，客户端必须收到网页后，解析HTML源码，发现有静态资源，再发出静态资源请求。其实，服务器可以预期到客户端请求网页后，很可能会再请求静态资源，所以就主动把这些静态资源随着网页一起发给客户端了。</p>
<h3 id="六、参考链接"><a href="#六、参考链接" class="headerlink" title="六、参考链接"></a>六、参考链接</h3><ul>
<li><a href="http://kamranahmed.info/blog/2016/08/13/http-in-depth/" target="_blank" rel="noopener">Journey to HTTP/2</a>, by Kamran Ahmed</li>
<li><a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol" target="_blank" rel="noopener">HTTP</a>, by Wikipedia</li>
<li><a href="https://http2.github.io/http2-spec/" target="_blank" rel="noopener">HTTP/2 Specification</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>快速学习方法论</title>
    <url>/2014/12/14/fast-learning-way/</url>
    <content><![CDATA[<h1 id="快速技能习得"><a href="#快速技能习得" class="headerlink" title="快速技能习得"></a>快速技能习得</h1><h2 id="分解步骤"><a href="#分解步骤" class="headerlink" title="分解步骤"></a>分解步骤</h2><blockquote>
<p>把技能做最大程度的细分，分成若干个小步骤</p>
</blockquote>
<blockquote>
<h2 id="充分学习"><a href="#充分学习" class="headerlink" title="充分学习"></a>充分学习</h2></blockquote>
<blockquote>
<p>对每个小步骤进行充分的学习，以便能够灵活的练习，并在联系中自我纠正</p>
</blockquote>
<blockquote>
<h2 id="克服困难"><a href="#克服困难" class="headerlink" title="克服困难"></a>克服困难</h2></blockquote>
<blockquote>
<p>克服联系中出现的生理，心理，或者情绪上的障碍</p>
</blockquote>
<blockquote>
<h2 id="集中练习"><a href="#集中练习" class="headerlink" title="集中练习"></a>集中练习</h2></blockquote>
<blockquote>
<p>至少用20个小时集中练习最重要的小步骤</p>
</blockquote>
<p>选择一项技能，摸索出来最好的办法，腾出时间练习，知道掌握位置 <a id="more"></a></p>
<h1 id="快速技能习得的10个方法"><a href="#快速技能习得的10个方法" class="headerlink" title="快速技能习得的10个方法"></a>快速技能习得的10个方法</h1><ol>
<li>选择方向</li>
<li>集中精力</li>
<li>制定目标</li>
<li>分解技能</li>
<li>获得工具</li>
<li>扫除障碍</li>
<li>腾出时间</li>
<li>及时反馈</li>
<li>计时训练</li>
<li>数量速度</li>
</ol>
<blockquote>
<p><a href="http://www.bilibili.com/video/av1911047/" target="_blank" rel="noopener">TED演讲视频</a></p>
</blockquote>
]]></content>
      <tags>
        <tag>方法论</tag>
      </tags>
  </entry>
  <entry>
    <title>learning</title>
    <url>/2014/08/08/learn-if-alive/</url>
    <content><![CDATA[<p><strong>学习是一种生活方式</strong>，否则为什么会有的人就是停不下来呢？学习不需要坚持、不需要毅力、不需要信念，不需要各种”不得已而为之的概念”，它只不过是一种选择，一个一旦真选了就再也不可逆的选择。仅此而已。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">while (alive) &#123;</span><br><span class="line">    learn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>日志</category>
      </categories>
      <tags>
        <tag>learn</tag>
      </tags>
  </entry>
  <entry>
    <title>linux-aliases</title>
    <url>/2014/12/22/linux-aliases/</url>
    <content><![CDATA[<h4 id="linux别名设置"><a href="#linux别名设置" class="headerlink" title="linux别名设置"></a>linux别名设置</h4><p>Terminal 输入 <code>alias</code> 之后可以查看已经有的别名设置</p>
<p>如果要设置自己的别名如下：<a id="more"></a><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">alias</span> d=<span class="string">'date'</span> <span class="comment">#起别名</span></span><br><span class="line"><span class="built_in">unalias</span> d  <span class="comment">#删除别名</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> ..=<span class="string">"cd .."</span></span><br><span class="line"><span class="built_in">alias</span> ...=<span class="string">"cd ../.."</span>  </span><br><span class="line"><span class="built_in">alias</span> ....=<span class="string">"cd ../../.."</span></span><br><span class="line"><span class="built_in">alias</span> .....=<span class="string">"cd ../../../.."</span></span><br><span class="line"><span class="built_in">alias</span> ~=<span class="string">"cd ~"</span> <span class="comment"># `cd` is probably faster to type though</span></span><br><span class="line"><span class="built_in">alias</span> -- -=<span class="string">"cd -"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> d=<span class="string">"cd ~/Documents/Dropbox"</span></span><br><span class="line"><span class="built_in">alias</span> dl=<span class="string">"cd ~/Downloads"</span></span><br><span class="line"><span class="built_in">alias</span> dt=<span class="string">"cd ~/Desktop"</span></span><br><span class="line"><span class="built_in">alias</span> p=<span class="string">"cd ~/projects"</span></span><br><span class="line"><span class="built_in">alias</span> g=<span class="string">"git"</span></span><br><span class="line"><span class="built_in">alias</span> h=<span class="string">"history"</span></span><br><span class="line"><span class="built_in">alias</span> j=<span class="string">"jobs"</span></span><br><span class="line">……</span><br></pre></td></tr></table></figure></p>
<p>网络上很多人整理了常用的操作</p>
<h4 id="Mac-OS-操作如下："><a href="#Mac-OS-操作如下：" class="headerlink" title="Mac OS 操作如下："></a>Mac OS 操作如下：</h4><ol>
<li>cd ~</li>
<li>curl -O <a href="https://raw.githubusercontent.com/donnemartin/dev-setup/master/.bash_profile" target="_blank" rel="noopener">https://raw.githubusercontent.com/donnemartin/dev-setup/master/.bash_profile</a></li>
<li>curl -O <a href="https://raw.githubusercontent.com/donnemartin/dev-setup/master/.bash_prompt" target="_blank" rel="noopener">https://raw.githubusercontent.com/donnemartin/dev-setup/master/.bash_prompt</a></li>
<li>curl -O <a href="https://raw.githubusercontent.com/donnemartin/dev-setup/master/.aliases" target="_blank" rel="noopener">https://raw.githubusercontent.com/donnemartin/dev-setup/master/.aliases</a></li>
<li>source .bash_profile<br><a href="https://github.com/donnemartin/dev-setup" target="_blank" rel="noopener">参考文件</a></li>
</ol>
<h4 id="对应linux-各个版本不一样-vim-bashrc-文件添加："><a href="#对应linux-各个版本不一样-vim-bashrc-文件添加：" class="headerlink" title="对应linux 各个版本不一样 vim ~/.bashrc 文件添加："></a>对应linux 各个版本不一样 <code>vim ~/.bashrc</code> 文件添加：</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> [ -f ~/.aliases ]; <span class="keyword">then</span></span><br><span class="line">   	. ~/.aliases</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<ol>
<li>cd ~</li>
<li>curl -O <a href="https://raw.githubusercontent.com/donnemartin/dev-setup/master/.aliases" target="_blank" rel="noopener">https://raw.githubusercontent.com/donnemartin/dev-setup/master/.aliases</a></li>
<li>source .bashrc</li>
</ol>
<h5 id="对于ubuntu-已经包含了-bash-aliases-文件"><a href="#对于ubuntu-已经包含了-bash-aliases-文件" class="headerlink" title="对于ubuntu 已经包含了 .bash_aliases 文件"></a>对于ubuntu 已经包含了 <code>.bash_aliases</code> 文件</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> [ -f ~/.bash_aliases ]; <span class="keyword">then</span></span><br><span class="line">    . ~/.bash_aliases</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>只需要往 <code>.bash_aliases</code> 文件中写自己的别名就可以了</p>
]]></content>
  </entry>
  <entry>
    <title>门面模式(command pattern)</title>
    <url>/2015/09/29/command-pattern/</url>
    <content><![CDATA[<p>命令模式就是将一组对象的相似行为，进行了抽象，<strong>将调用者与被调用者之间进行解耦，提高了应用的灵活性</strong>。命令模式将调用的目标对象的一些异构性给封装起来，通过统一的方式来为调用者提供服务。</p>
<h2 id="CommandInterface-php"><a href="#CommandInterface-php" class="headerlink" title="CommandInterface.php"></a>CommandInterface.php</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Command</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CommandInterface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CommandInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在命令模式中这是最重要的方法,</span></span><br><span class="line"><span class="comment">     * Receiver在构造函数中传入.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="HelloCommand-php"><a href="#HelloCommand-php" class="headerlink" title="HelloCommand.php"></a>HelloCommand.php</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Command</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这是一个调用Receiver的print方法的命令实现类，</span></span><br><span class="line"><span class="comment"> * 但是对于调用者而言，只知道调用命令类的execute方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloCommand</span> <span class="keyword">implements</span> <span class="title">CommandInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Receiver</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $output;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每一个具体的命令基于不同的Receiver</span></span><br><span class="line"><span class="comment">     * 它们可以是一个、多个，甚至完全没有Receiver</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Receiver $console</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Receiver $console)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;output = $console;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行并输出 "Hello World"</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 没有Receiver的时候完全通过命令类来实现功能</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;output-&gt;write(<span class="string">'Hello World'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Receiver-php"><a href="#Receiver-php" class="headerlink" title="Receiver.php"></a>Receiver.php</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Command</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Receiver类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Receiver</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $str</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($str)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Invoker-php"><a href="#Invoker-php" class="headerlink" title="Invoker.php"></a>Invoker.php</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Command</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invoker类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Invoker</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> CommandInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $command;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在调用者中我们通常可以找到这种订阅命令的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> CommandInterface $cmd</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setCommand</span><span class="params">(CommandInterface $cmd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;command = $cmd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;command-&gt;execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试代码-Tests-CommandTest-php"><a href="#测试代码-Tests-CommandTest-php" class="headerlink" title="测试代码  Tests/CommandTest.php"></a>测试代码  Tests/CommandTest.php</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace DesignPatterns\Behavioral\Command\Tests;</span><br><span class="line"></span><br><span class="line">use DesignPatterns\Behavioral\Command\Invoker;</span><br><span class="line">use DesignPatterns\Behavioral\Command\Receiver;</span><br><span class="line">use DesignPatterns\Behavioral\Command\HelloCommand;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * CommandTest在命令模式中扮演客户端角色</span><br><span class="line"> */</span><br><span class="line">class CommandTest extends \PHPUnit_Framework_TestCase</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @var Invoker</span><br><span class="line">     */</span><br><span class="line">    protected $invoker;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @var Receiver</span><br><span class="line">     */</span><br><span class="line">    protected $receiver;</span><br><span class="line"></span><br><span class="line">    protected function setUp()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;invoker = new Invoker();</span><br><span class="line">        $this-&gt;receiver = new Receiver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function testInvocation()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;invoker-&gt;setCommand(new HelloCommand($this-&gt;receiver));</span><br><span class="line">        $this-&gt;expectOutputString(&apos;Hello World&apos;);</span><br><span class="line">        $this-&gt;invoker-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>design pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>批判性思维(critical thinking)</title>
    <url>/2015/06/22/critical-thinking/</url>
    <content><![CDATA[<p><a href="http://www.criticalthinking.org/" target="_blank" rel="noopener">批判性思维</a><br><a href="https://book.douban.com/subject/2591434/" target="_blank" rel="noopener">critical thinking</a></p>
]]></content>
  </entry>
  <entry>
    <title>门面模式(facade pattern)</title>
    <url>/2015/09/22/facade-pattern/</url>
    <content><![CDATA[<p>门面模式（Facade）或 外观模式,定义了一个高层接口，这个接口使得子系统更加容易使用：引入门面角色之后，用户只需要直接与门面角色交互，<em>用户与子系统之间的复杂关系由门面角色来实现</em>，从而降低了系统的耦合度。Laravel 中门面模式的使用也很广泛，<strong>基本上每个服务容器中注册的服务提供者类</strong>都对应一个门面类。(接口封装场景)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// OsInterface.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Structural</span>\<span class="title">Facade</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OsInterface接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OsInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * halt the OS</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">halt</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// BiosInterface.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Structural</span>\<span class="title">Facade</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BiosInterface接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">BiosInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * execute the BIOS</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * wait for halt</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">waitForKeyPress</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * launches the OS</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> OsInterface $os</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">launch</span><span class="params">(OsInterface $os)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * power down BIOS</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">powerDown</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//实现</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Structural</span>\<span class="title">Facade</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 门面类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Facade</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> OsInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $os;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> BiosInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $bios;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This is the perfect time to use a dependency injection container</span></span><br><span class="line"><span class="comment">     * to create an instance of this class</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> BiosInterface $bios</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> OsInterface   $os</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BiosInterface $bios, OsInterface $os)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bios = $bios;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;os = $os;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * turn on the system</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">turnOn</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bios-&gt;execute();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bios-&gt;waitForKeyPress();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bios-&gt;launch(<span class="keyword">$this</span>-&gt;os);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * turn off the system</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">turnOff</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;os-&gt;halt();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bios-&gt;powerDown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Structural</span>\<span class="title">Facade</span>\<span class="title">Tests</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Structural</span>\<span class="title">Facade</span>\<span class="title">Facade</span> <span class="title">as</span> <span class="title">Computer</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Structural</span>\<span class="title">Facade</span>\<span class="title">OsInterface</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FacadeTest用于测试门面模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FacadeTest</span> <span class="keyword">extends</span> \<span class="title">PHPUnit_Framework_TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getComputer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $bios = <span class="keyword">$this</span>-&gt;getMockBuilder(<span class="string">'DesignPatterns\Structural\Facade\BiosInterface'</span>)</span><br><span class="line">                -&gt;setMethods(<span class="keyword">array</span>(<span class="string">'launch'</span>, <span class="string">'execute'</span>, <span class="string">'waitForKeyPress'</span>))</span><br><span class="line">                -&gt;disableAutoload()</span><br><span class="line">                -&gt;getMock();</span><br><span class="line">        $os = <span class="keyword">$this</span>-&gt;getMockBuilder(<span class="string">'DesignPatterns\Structural\Facade\OsInterface'</span>)</span><br><span class="line">                -&gt;setMethods(<span class="keyword">array</span>(<span class="string">'getName'</span>))</span><br><span class="line">                -&gt;disableAutoload()</span><br><span class="line">                -&gt;getMock();</span><br><span class="line">        $bios-&gt;expects(<span class="keyword">$this</span>-&gt;once())</span><br><span class="line">                -&gt;method(<span class="string">'launch'</span>)</span><br><span class="line">                -&gt;with($os);</span><br><span class="line">        $os-&gt;expects(<span class="keyword">$this</span>-&gt;once())</span><br><span class="line">                -&gt;method(<span class="string">'getName'</span>)</span><br><span class="line">                -&gt;will(<span class="keyword">$this</span>-&gt;returnValue(<span class="string">'Linux'</span>));</span><br><span class="line"></span><br><span class="line">        $facade = <span class="keyword">new</span> Computer($bios, $os);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="keyword">array</span>($facade, $os));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@dataProvider</span> getComputer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testComputerOn</span><span class="params">(Computer $facade, OsInterface $os)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// interface is simpler :</span></span><br><span class="line">        $facade-&gt;turnOn();</span><br><span class="line">        <span class="comment">// but I can access to lower component</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'Linux'</span>, $os-&gt;getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>design pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>如何高效生成趋势有序的全局唯一ID？</title>
    <url>/2015/12/04/gen-id-way/</url>
    <content><![CDATA[<h1 id="生成一个记录标识的需求，例如："><a href="#生成一个记录标识的需求，例如：" class="headerlink" title="生成一个记录标识的需求，例如："></a>生成一个记录标识的需求，例如：</h1><ol>
<li>消息标识：message-id</li>
<li>订单标识：order-id</li>
<li>帖子标识：tiezi-id</li>
</ol>
<p>这个记录标识往往就是数据库中的唯一主键，数据库上会建立聚集索引（<code>cluster index</code>），即在物理存储上以这个字段排序。</p>
<a id="more"></a>
<p>这个记录标识上的查询，往往又有分页或者排序的业务需求，例如：</p>
<ul>
<li>拉取最新的一页消息：selectmessage-id/ order by time/ limit 100</li>
<li>拉取最新的一页订单：selectorder-id/ order by time/ limit 100</li>
<li>拉取最新的一页帖子：selecttiezi-id/ order by time/ limit 100<br>所以往往要有一个time字段，并且在time字段上建立普通索引（non-cluster index）。</li>
</ul>
<p>我们都知道普通索引存储的是实际记录的指针，其访问效率会比聚集索引慢，如果记录标识在生成时能够基本按照时间有序，则可以省去这个time字段的索引查询：<br><code>select message-id/ (order by message-id)/limit 100</code><br>再次强调，能这么做的前提是，message-id的生成基本是趋势时间递增的。</p>
<p>两大核心需求：</p>
<ol>
<li>全局唯一</li>
<li>趋势有序</li>
</ol>
<h2 id="常见方法、不足、优化"><a href="#常见方法、不足、优化" class="headerlink" title="常见方法、不足、优化"></a>常见方法、不足、优化</h2><h3 id="1-用数据库的-auto-increment"><a href="#1-用数据库的-auto-increment" class="headerlink" title="1.用数据库的 auto_increment"></a>1.用数据库的 auto_increment</h3><h4 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h4><ol>
<li>简单，使用数据库已有的功能</li>
<li>能够保证唯一性</li>
<li>能够保证递增性</li>
<li>步长固定</li>
</ol>
<h4 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h4><ol>
<li>可用性难以保证：数据库常见架构是一主多从+读写分离，生成自增ID是写请求，主库挂了就玩不转了</li>
<li>扩展性差，性能有上限：因为写入是单点，数据库主库的写性能决定ID的生成性能上限，并且难以扩展</li>
</ol>
<h4 id="改进方法："><a href="#改进方法：" class="headerlink" title="改进方法："></a><strong>改进方法</strong>：</h4><ol>
<li>增加主库，避免写入单点</li>
<li>数据水平切分，保证各主库生成的ID不重复</li>
</ol>
<p><img src="/images/technology/gen-id.png" alt="pic"></p>
<p>如上图所述，由1个写库变成3个写库，每个写库设置不同的auto_increment初始值，以及相同的增长步长，以保证每个数据库生成的ID是不同的（上图中库0生成0,3,6,9…，库1生成1,4,7,10，库2生成2,5,8,11…）, 改进后的架构保证了可用性。</p>
<p><strong>缺点是</strong>：</p>
<ol>
<li>丧失了ID生成的“绝对递增性”：先访问库0生成0,3，再访问库1生成1，可能导致在非常短的时间内，ID生成不是绝对递增的（这个问题不大，我们的目标是趋势递增，不是绝对递增）</li>
<li>数据库的写压力依然很大，每次生成ID都要访问数据库<br>为了解决上述两个问题，引出了第二个常见的方案</li>
</ol>
<h3 id="单点批量ID生成服务"><a href="#单点批量ID生成服务" class="headerlink" title="单点批量ID生成服务"></a>单点批量ID生成服务</h3><p>分布式系统之所以难，很重要的原因之一是“没有一个全局时钟，难以保证绝对的时序”，要想保证绝对的时序，还是只能使用单点服务，用本地时钟保证“绝对时序”。数据库写压力大，是因为每次生成ID都访问了数据库，可以使用批量的方式降低数据库写压力。</p>
<p><img src="/images/technology/gen-id2.png" alt="pic"></p>
<p>如上图所述，数据库使用双master保证可用性，数据库中只存储当前ID的最大值，例如0。ID生成服务假设每次批量拉取6个ID，服务访问数据库，将当前ID的最大值修改为5，这样应用访问ID生成服务索要ID，ID生成服务不需要每次访问数据库，就能依次派发0,1,2,3,4,5这些ID了，当ID发完后，再将ID的最大值修改为11，就能再次派发6,7,8,9,10,11这些ID了，于是数据库的压力就降低到原来的1/6了。</p>
<h4 id="优点：-1"><a href="#优点：-1" class="headerlink" title="优点："></a>优点：</h4><ol>
<li>保证了ID生成的绝对递增有序</li>
<li>大大的降低了数据库的压力，ID生成可以做到每秒生成几万几十万个</li>
</ol>
<h4 id="缺点：-1"><a href="#缺点：-1" class="headerlink" title="缺点："></a>缺点：</h4><ol>
<li>服务仍然是单点</li>
<li>如果服务挂了，服务重启起来之后，继续生成ID可能会不连续，中间出现空洞（服务内存是保存着0,1,2,3,4,5，数据库中max-id是5，分配到3时，服务重启了，下次会从6开始分配，4和5就成了空洞，不过这个问题也不大）</li>
<li>虽然每秒可以生成几万几十万个ID，但毕竟还是有性能上限，无法进行水平扩展</li>
</ol>
<h4 id="改进方法：-1"><a href="#改进方法：-1" class="headerlink" title="改进方法："></a><strong>改进方法</strong>：</h4><p><strong> 单点服务的常用高可用优化方案是“备用服务”，也叫“影子服务”，</strong> 所以我们能用以下方法优化上述缺点（1）：</p>
<p><img src="/images/technology/gen-id3.png" alt="pic"><br>如上图，对外提供的服务是主服务，有一个影子服务时刻处于备用状态，当主服务挂了的时候影子服务顶上。这个切换的过程对调用方是透明的，可以自动完成，常用的技术是vip+keepalived，具体就不在这里展开。</p>
<h3 id="uuid"><a href="#uuid" class="headerlink" title="uuid"></a>uuid</h3><p>上述方案来生成ID，虽然性能大增，但由于是单点系统，总还是存在性能上限的。同时，上述两种方案，不管是数据库还是服务来生成ID，业务方Application都需要进行一次远程调用，比较耗时。有没有一种本地生成ID的方法，即高性能，又时延低呢？</p>
<p>uuid是一种常见的方案：<code>string ID = GenUUID();</code></p>
<h4 id="优点：-2"><a href="#优点：-2" class="headerlink" title="优点："></a>优点：</h4><ol>
<li>本地生成ID，不需要进行远程调用，时延低</li>
<li>扩展性好，基本可以认为没有性能上限</li>
</ol>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com_create_guid()</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">guid</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (function_exists(<span class="string">'com_create_guid'</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> com_create_guid();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        mt_srand((double)microtime()*<span class="number">10000</span>);<span class="comment">//optional for php 4.2.0 and up.</span></span><br><span class="line">        $charid = strtoupper(md5(uniqid(rand(), <span class="keyword">true</span>)));</span><br><span class="line">        $hyphen = chr(<span class="number">45</span>);<span class="comment">// "-"</span></span><br><span class="line">        $uuid = chr(<span class="number">123</span>)<span class="comment">// "&#123;"</span></span><br><span class="line">                .substr($charid, <span class="number">0</span>, <span class="number">8</span>).$hyphen</span><br><span class="line">                .substr($charid, <span class="number">8</span>, <span class="number">4</span>).$hyphen</span><br><span class="line">                .substr($charid,<span class="number">12</span>, <span class="number">4</span>).$hyphen</span><br><span class="line">                .substr($charid,<span class="number">16</span>, <span class="number">4</span>).$hyphen</span><br><span class="line">                .substr($charid,<span class="number">20</span>,<span class="number">12</span>)</span><br><span class="line">                .chr(<span class="number">125</span>);<span class="comment">// "&#125;"</span></span><br><span class="line">        <span class="keyword">return</span> $uuid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> guid();</span><br></pre></td></tr></table></figure>
<h4 id="缺点：-2"><a href="#缺点：-2" class="headerlink" title="缺点："></a>缺点：</h4><ol>
<li>无法保证趋势递增</li>
<li>uuid过长，往往用字符串表示，作为主键建立索引查询效率低，常见优化方案为“转化为两个uint64整数存储”或者“折半存储”（折半后不能保证唯一性）</li>
</ol>
<h3 id="取当前毫秒数"><a href="#取当前毫秒数" class="headerlink" title="取当前毫秒数"></a>取当前毫秒数</h3><p>uuid是一个本地算法，生成性能高，但无法保证趋势递增，且作为字符串ID检索效率低，有没有一种能保证递增的本地算法呢？<br>取当前毫秒数是一种常见方案：<code>uint64 ID = GenTimeMS();</code></p>
<h4 id="优点：-3"><a href="#优点：-3" class="headerlink" title="优点："></a>优点：</h4><ol>
<li>本地生成ID，不需要进行远程调用，时延低</li>
<li>生成的ID趋势递增</li>
<li>生成的ID是整数，建立索引后查询效率高</li>
</ol>
<h4 id="缺点：-3"><a href="#缺点：-3" class="headerlink" title="缺点："></a>缺点：</h4><p>（1）如果并发量超过1000，会生成重复的ID, 当然，使用微秒可以降低冲突概率，但每秒最多只能生成1000000个ID，再多的话就一定会冲突了，所以使用微秒并不从根本上解决问题。</p>
<h3 id="类snowflake算法-snowflake"><a href="#类snowflake算法-snowflake" class="headerlink" title="类snowflake算法 snowflake"></a>类snowflake算法 <a href="https://github.com/twitter/snowflake" target="_blank" rel="noopener">snowflake</a></h3><p>snowflake是twitter开源的分布式ID生成算法.</p>
<p>0—0000000000 0000000000 0000000000 0000000000 0 — 00000 —00000 —000000000000</p>
<p><img src="/images/technology/snowflake-64bit.jpg" alt="pic"></p>
<p>“41bit的时间戳可以支持该算法使用年限：(时间差的毫秒数)”, (1L &lt;&lt; 41) / (3600L <em> 24 </em> 365 * 1000.0)，其中1L为长整形，位移41位为 ： 2199023255552 /31536000000=69.73057000101471<br>“10bit的工作机器id数量：{0}”, (1L &lt;&lt; 10) - 1  为： 1023<br>“12bit序列id数量：{0}”, (1L &lt;&lt; 12) - 1 为：4095</p>
<p>一个long型的ID，使用其中<code>41bit</code>作为毫秒数，<code>10bit</code>作为机器编号，<code>12bit</code>作为毫秒内序列号。这个算法<strong>单机每秒</strong>内理论上最多可以生成<code>1000 * (2^12-1) 或 1000 * ((1 &lt;&lt; 12)- 1)</code>，也就是4096000个ID。</p>
<p>借鉴snowflake的思想，结合各公司的业务逻辑和并发量，可以实现自己的分布式ID生成算法。</p>
<p>举例，假设某公司ID生成器服务的需求如下：</p>
<ol>
<li>单机高峰并发量小于1W，预计未来5年单机高峰并发量小于10W</li>
<li>有2个机房，预计未来5年机房数量小于4个</li>
<li>每个机房机器数小于100台</li>
<li>目前有5个业务线有ID生成需求，预计未来业务线数量小于10个</li>
</ol>
<p>分析过程如下：</p>
<ol>
<li>高位取从2016年1月1日到现在的毫秒数（假设系统ID生成器服务在这个时间之后上线），假设系统至少运行10年，那至少需要 <code>10年*365天*24小时*3600秒*1000毫秒=320*10^9</code>，差不多预留39bit给毫秒</li>
<li>每秒的单机高峰并发量小于10W，即平均每毫秒的单机高峰并发量小于100，差不多预留7bit给每毫秒内序列号</li>
<li>5年内机房数小于4个，预留2bit给机房标识</li>
<li>每个机房小于100台机器，预留7bit给每个机房内的服务器标识</li>
<li>业务线小于10个，预留4bit给业务线标识</li>
</ol>
<h4 id="优点：-4"><a href="#优点：-4" class="headerlink" title="优点："></a>优点：</h4><p>这样设计的64bit标识，可以保证：</p>
<ol>
<li>每个业务线、每个机房、每个机器生成的ID都是不同的</li>
<li>同一个机器，每个毫秒内生成的ID都是不同的</li>
<li>同一个机器，同一个毫秒内，以序列号区区分保证生成的ID是不同的</li>
<li>将毫秒数放在最高位，保证生成的ID是趋势递增的</li>
</ol>
<h4 id="缺点：-4"><a href="#缺点：-4" class="headerlink" title="缺点："></a>缺点：</h4><p>（1）由于“没有一个全局时钟”，每台服务器分配的ID是绝对递增的，但从全局看，生成的ID只是趋势递增的（有些服务器的时间早，有些服务器的时间晚）<br>最后一个容易忽略的问题：<br>生成的ID，例如<code>message-id/ order-id/ tiezi-id</code>，在数据量大时往往需要分库分表，这些ID经常作为取模分库分表的依据，为了分库分表后数据均匀，ID生成往往有“取模随机性”的需求，所以我们通常把<strong>每秒内的序列号放在ID的最末位</strong>，保证生成的ID是随机的。<br>又如果，我们在跨毫秒时，序列号总是归0，<strong>会使得序列号为0的ID比较多，导致生成的ID取模后不均匀</strong>。解决方法是，<strong>序列号不是每次都归0，而是归一个0到9的随机数</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snowflake</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//工作机器id的bit段拆分为前5个bit标记workerid，后5个bit标记datacenterid</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> WorkerIdBits = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> DatacenterIdBits = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">//序列号bit数</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> SequenceBits = <span class="number">12</span>;</span><br><span class="line">    <span class="comment">//最大编号限制</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">long</span> MaxWorkerId = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; WorkerIdBits);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">long</span> MaxDatacenterId = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; DatacenterIdBits);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">long</span> SequenceMask = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; SequenceBits);</span><br><span class="line">    <span class="comment">//位左运算移动量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">int</span> WorkerIdShift = SequenceBits;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">int</span> DatacenterIdShift = SequenceBits + WorkerIdBits;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">int</span> TimestampLeftShift = SequenceBits + WorkerIdBits + DatacenterIdBits;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//序列号记录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> _sequence = <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">//时间戳记录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> _lastTimestamp = -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> WorkerId &#123; get; <span class="keyword">protected</span> set; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> DatacenterId &#123; get; <span class="keyword">protected</span> set; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Snowflake</span><span class="params">(<span class="keyword">long</span> workerId, <span class="keyword">long</span> datacenterId, <span class="keyword">long</span> sequence = <span class="number">0</span>L)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        WorkerId = workerId;</span><br><span class="line">        DatacenterId = datacenterId;</span><br><span class="line">        _sequence = sequence;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// sanity check for workerId</span></span><br><span class="line">        <span class="keyword">if</span> (workerId &gt; MaxWorkerId || workerId &lt; <span class="number">0</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException( String.Format(<span class="string">"worker Id can't be greater than &#123;0&#125; or less than 0"</span>, MaxWorkerId) );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (datacenterId &gt; MaxDatacenterId || datacenterId &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException( String.Format(<span class="string">"datacenter Id can't be greater than &#123;0&#125; or less than 0"</span>, MaxDatacenterId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">    <span class="comment">/// 格林时间戳</span></span><br><span class="line">    <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">    <span class="comment">/// &lt;returns&gt;&lt;/returns&gt;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">TimeGen</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DateTime Jan1st1970 = <span class="keyword">new</span> DateTime(<span class="number">1970</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, DateTimeKind.Utc);<span class="comment">//</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">long</span>)(DateTime.UtcNow - Jan1st1970).TotalMilliseconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    readonly object _lock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> virtual <span class="keyword">long</span> <span class="title">NextId</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        lock (_lock)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> timestamp = TimeGen();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (timestamp &lt; _lastTimestamp)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidSystemClock(String.Format(</span><br><span class="line">                    <span class="string">"发现最新时间戳少&#123;0&#125;毫秒的异常"</span>, _lastTimestamp - timestamp));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_lastTimestamp == timestamp)</span><br><span class="line">            &#123;</span><br><span class="line">                _sequence = (_sequence + <span class="number">1</span>) &amp; SequenceMask;</span><br><span class="line">                <span class="keyword">if</span> (_sequence == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//序列号超过限制，重新取时间戳</span></span><br><span class="line">                    timestamp = TilNextMillis(_lastTimestamp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                _sequence = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _lastTimestamp = timestamp;</span><br><span class="line">            <span class="comment">//snowflake算法</span></span><br><span class="line">            <span class="keyword">var</span> id = (timestamp &lt;&lt; TimestampLeftShift) |</span><br><span class="line">                     (DatacenterId &lt;&lt; DatacenterIdShift) |</span><br><span class="line">                     (WorkerId &lt;&lt; WorkerIdShift) | _sequence;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// &lt;summary&gt;</span></span><br><span class="line">    <span class="comment">/// 重新取时间戳</span></span><br><span class="line">    <span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> virtual <span class="keyword">long</span> <span class="title">TilNextMillis</span><span class="params">(<span class="keyword">long</span> lastTimestamp)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> timestamp = TimeGen();</span><br><span class="line">        <span class="keyword">while</span> (timestamp &lt;= lastTimestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//新的时间戳要大于旧的时间戳，才算作有效时间戳</span></span><br><span class="line">            timestamp = TimeGen();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>依赖注入(dependency injection pattern)</title>
    <url>/2015/09/28/dependency-injection-pattern/</url>
    <content><![CDATA[<p>依赖注入模式需要在调用者外部完成容器创建以及容器中接口与实现类的运行时绑定工作，在 Laravel 中该容器就是服务容器，而接口与实现类的运行时绑定则在服务提供者中完成。此外，除了在调用者的构造函数中进行依赖注入外，还可以通过在调用者的方法中进行依赖注入。</p>
<p><a href="https://en.wikipedia.org/wiki/Dependency_injection" target="_blank" rel="noopener">三种常见注入方式：</a></p>
<ol>
<li>构造注入</li>
<li>setter注入</li>
<li>接口注入</li>
</ol>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Shape</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCircum</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getArea</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//矩形</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> <span class="keyword">implements</span> <span class="title">Shape</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $width, $height;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($width, $height)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;width = $width;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;height = $height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCircum</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;width + <span class="keyword">$this</span>-&gt;height) * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getArea</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;width * <span class="keyword">$this</span>-&gt;height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="keyword">implements</span> <span class="title">Shape</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $radii;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($radii)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;radii = $radii;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCircum</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement getCircum() method.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * M_PI * <span class="keyword">$this</span>-&gt;radii;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getArea</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement getArea() method.</span></span><br><span class="line">        <span class="keyword">return</span> M_PI * pow(<span class="keyword">$this</span>-&gt;radii, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="构造注入"><a href="#构造注入" class="headerlink" title="构造注入"></a>构造注入</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DependencyInjection</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $shape;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Shape $shape)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;shape = $shape;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用示例：</span></span><br><span class="line"></span><br><span class="line">$rectangle = <span class="keyword">new</span> Rectangle(<span class="number">4</span>, <span class="number">2</span>);</span><br><span class="line">$r_di = <span class="keyword">new</span> DependencyInjection($rectangle);</span><br><span class="line"><span class="keyword">echo</span> $r_di-&gt;shape-&gt;getCircum();</span><br><span class="line"><span class="keyword">echo</span> $r_di-&gt;shape-&gt;getArea();</span><br><span class="line"></span><br><span class="line">$circle = <span class="keyword">new</span> Circle(<span class="number">3</span>);</span><br><span class="line">$c_di = <span class="keyword">new</span> DependencyInjection($circle);</span><br><span class="line"><span class="keyword">echo</span> $c_di-&gt;shape-&gt;getCircum();</span><br><span class="line"><span class="keyword">echo</span> $c_di-&gt;shape-&gt;getArea();</span><br></pre></td></tr></table></figure>
<h2 id="setter-注入"><a href="#setter-注入" class="headerlink" title="setter 注入"></a>setter 注入</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DependencyInjectionSetter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $shape;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setter</span><span class="params">(Shape $shape)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;shape = $shape;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用示例：</span></span><br><span class="line"></span><br><span class="line">$rectangle = <span class="keyword">new</span> Rectangle(<span class="number">4</span>, <span class="number">2</span>);</span><br><span class="line">$setter_di = <span class="keyword">new</span> DependencyInjectionSetter();</span><br><span class="line">$setter_di-&gt;setter($rectangle);</span><br><span class="line"><span class="keyword">echo</span> $setter_di-&gt;shape-&gt;getCircum();</span><br></pre></td></tr></table></figure>
<h2 id="interface-注入"><a href="#interface-注入" class="headerlink" title="interface 注入"></a>interface 注入</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ServiceSetter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setService</span><span class="params">(Shape $shape)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceClient</span> <span class="keyword">implements</span> <span class="title">ServiceSetter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $shape;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setService</span><span class="params">(Shape $shape)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement setService() method.</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;shape = $shape;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用示例：</span></span><br><span class="line"></span><br><span class="line">$sc = <span class="keyword">new</span> ServiceClient();</span><br><span class="line">$sc-&gt;setService($rectangle);</span><br><span class="line"><span class="keyword">echo</span> $sc-&gt;shape-&gt;getArea();</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>design pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>汉字转拼音（mysql）</title>
    <url>/2014/08/29/zh-cn-to-pinyin/</url>
    <content><![CDATA[<h3 id="创建mysql函数"><a href="#创建mysql函数" class="headerlink" title="创建mysql函数"></a>创建mysql函数</h3><a id="more"></a>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">CREATE FUNCTION `f_to_pinyin`(NAME VARCHAR(255) CHARSET gbk) RETURNS varchar(255) CHARSET gbk</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE mycode INT;</span><br><span class="line">    DECLARE tmp_lcode VARCHAR(2) CHARSET gbk;</span><br><span class="line">    DECLARE lcode INT;</span><br><span class="line">    DECLARE tmp_rcode VARCHAR(2) CHARSET gbk;</span><br><span class="line">    DECLARE rcode INT;</span><br><span class="line">    DECLARE mypy VARCHAR(255) CHARSET gbk DEFAULT &apos;&apos;;</span><br><span class="line">    DECLARE lp INT;</span><br><span class="line">    SET mycode = 0;</span><br><span class="line">    SET lp = 1;</span><br><span class="line">    SET NAME = HEX(NAME);</span><br><span class="line">    WHILE lp &lt; LENGTH(NAME) DO</span><br><span class="line">        SET tmp_lcode = SUBSTRING(NAME, lp, 2);</span><br><span class="line">        SET lcode = CAST(ASCII(UNHEX(tmp_lcode)) AS UNSIGNED); </span><br><span class="line">        SET tmp_rcode = SUBSTRING(NAME, lp + 2, 2);</span><br><span class="line">        SET rcode = CAST(ASCII(UNHEX(tmp_rcode)) AS UNSIGNED); </span><br><span class="line">        IF lcode &gt; 128 THEN</span><br><span class="line">            SET mycode =65536 - lcode * 256 - rcode ;</span><br><span class="line">            SELECT CONCAT(mypy,py) INTO mypy FROM pinyin WHERE `code` &gt;= ABS(mycode) ORDER BY `code` ASC LIMIT 1;</span><br><span class="line">            SET lp = lp + 4;</span><br><span class="line">        ELSE</span><br><span class="line">            SET mypy = CONCAT(mypy,CHAR(CAST(ASCII(UNHEX(SUBSTRING(NAME, lp, 2))) AS UNSIGNED)));</span><br><span class="line">            SET lp = lp + 2;</span><br><span class="line">        END IF;</span><br><span class="line">    END WHILE;</span><br><span class="line">    RETURN LOWER(mypy);</span><br><span class="line">END</span><br></pre></td></tr></table></figure>
<h3 id="创建拼音ascii码"><a href="#创建拼音ascii码" class="headerlink" title="创建拼音ascii码"></a>创建拼音ascii码</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">CREATE TABLE `pinyin` (</span><br><span class="line">  `code` int(11) NOT NULL,</span><br><span class="line">  `py` varchar(10) CHARACTER SET gbk NOT NULL,</span><br><span class="line">  PRIMARY KEY (`code`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10254&apos;, &apos;zuo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10256&apos;, &apos;zun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10260&apos;, &apos;zui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10262&apos;, &apos;zuan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10270&apos;, &apos;zu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10274&apos;, &apos;zou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10281&apos;, &apos;zong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10296&apos;, &apos;zi&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10307&apos;, &apos;zhuo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10309&apos;, &apos;zhun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10315&apos;, &apos;zhui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10322&apos;, &apos;zhuang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10328&apos;, &apos;zhuan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10329&apos;, &apos;zhuai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10331&apos;, &apos;zhua&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10519&apos;, &apos;zhu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10533&apos;, &apos;zhou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10544&apos;, &apos;zhong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10587&apos;, &apos;zhi&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10764&apos;, &apos;zheng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10780&apos;, &apos;zhen&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10790&apos;, &apos;zhe&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10800&apos;, &apos;zhao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10815&apos;, &apos;zhang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10832&apos;, &apos;zhan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;10838&apos;, &apos;zhai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11014&apos;, &apos;zha&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11018&apos;, &apos;zeng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11019&apos;, &apos;zen&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11020&apos;, &apos;zei&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11024&apos;, &apos;ze&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11038&apos;, &apos;zao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11041&apos;, &apos;zang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11045&apos;, &apos;zan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11052&apos;, &apos;zai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11055&apos;, &apos;za&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11067&apos;, &apos;yun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11077&apos;, &apos;yue&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11097&apos;, &apos;yuan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11303&apos;, &apos;yu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11324&apos;, &apos;you&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11339&apos;, &apos;yong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11340&apos;, &apos;yo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11358&apos;, &apos;ying&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11536&apos;, &apos;yin&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11589&apos;, &apos;yi&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11604&apos;, &apos;ye&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11781&apos;, &apos;yao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11798&apos;, &apos;yang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11831&apos;, &apos;yan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11847&apos;, &apos;ya&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11861&apos;, &apos;xun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;11867&apos;, &apos;xue&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12039&apos;, &apos;xuan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12058&apos;, &apos;xu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12067&apos;, &apos;xiu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12074&apos;, &apos;xiong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12089&apos;, &apos;xing&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12099&apos;, &apos;xin&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12120&apos;, &apos;xie&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12300&apos;, &apos;xiao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12320&apos;, &apos;xiang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12346&apos;, &apos;xian&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12359&apos;, &apos;xia&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12556&apos;, &apos;xi&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12585&apos;, &apos;wu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12594&apos;, &apos;wo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12597&apos;, &apos;weng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12607&apos;, &apos;wen&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12802&apos;, &apos;wei&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12812&apos;, &apos;wang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12829&apos;, &apos;wan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12831&apos;, &apos;wai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12838&apos;, &apos;wa&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12849&apos;, &apos;tuo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12852&apos;, &apos;tun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12858&apos;, &apos;tui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12860&apos;, &apos;tuan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12871&apos;, &apos;tu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12875&apos;, &apos;tou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;12888&apos;, &apos;tong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13060&apos;, &apos;ting&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13063&apos;, &apos;tie&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13068&apos;, &apos;tiao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13076&apos;, &apos;tian&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13091&apos;, &apos;ti&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13095&apos;, &apos;teng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13096&apos;, &apos;te&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13107&apos;, &apos;tao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13120&apos;, &apos;tang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13138&apos;, &apos;tan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13147&apos;, &apos;tai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13318&apos;, &apos;ta&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13326&apos;, &apos;suo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13329&apos;, &apos;sun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13340&apos;, &apos;sui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13343&apos;, &apos;suan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13356&apos;, &apos;su&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13359&apos;, &apos;sou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13367&apos;, &apos;song&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13383&apos;, &apos;si&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13387&apos;, &apos;shuo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13391&apos;, &apos;shun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13395&apos;, &apos;shui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13398&apos;, &apos;shuang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13400&apos;, &apos;shuan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13404&apos;, &apos;shuai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13406&apos;, &apos;shua&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13601&apos;, &apos;shu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13611&apos;, &apos;shou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13658&apos;, &apos;shi&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13831&apos;, &apos;sheng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13847&apos;, &apos;shen&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13859&apos;, &apos;she&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13870&apos;, &apos;shao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13878&apos;, &apos;shang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13894&apos;, &apos;shan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13896&apos;, &apos;shai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13905&apos;, &apos;sha&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13906&apos;, &apos;seng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13907&apos;, &apos;sen&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13910&apos;, &apos;se&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13914&apos;, &apos;sao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;13917&apos;, &apos;sang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14083&apos;, &apos;san&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14087&apos;, &apos;sai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14090&apos;, &apos;sa&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14092&apos;, &apos;ruo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14094&apos;, &apos;run&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14097&apos;, &apos;rui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14099&apos;, &apos;ruan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14109&apos;, &apos;ru&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14112&apos;, &apos;rou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14122&apos;, &apos;rong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14123&apos;, &apos;ri&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14125&apos;, &apos;reng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14135&apos;, &apos;ren&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14137&apos;, &apos;re&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14140&apos;, &apos;rao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14145&apos;, &apos;rang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14149&apos;, &apos;ran&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14151&apos;, &apos;qun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14159&apos;, &apos;que&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14170&apos;, &apos;quan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14345&apos;, &apos;qu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14353&apos;, &apos;qiu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14355&apos;, &apos;qiong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14368&apos;, &apos;qing&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14379&apos;, &apos;qin&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14384&apos;, &apos;qie&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14399&apos;, &apos;qiao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14407&apos;, &apos;qiang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14429&apos;, &apos;qian&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14594&apos;, &apos;qia&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14630&apos;, &apos;qi&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14645&apos;, &apos;pu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14654&apos;, &apos;po&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14663&apos;, &apos;ping&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14668&apos;, &apos;pin&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14670&apos;, &apos;pie&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14674&apos;, &apos;piao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14678&apos;, &apos;pian&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14857&apos;, &apos;pi&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14871&apos;, &apos;peng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14873&apos;, &apos;pen&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14882&apos;, &apos;pei&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14889&apos;, &apos;pao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14894&apos;, &apos;pang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14902&apos;, &apos;pan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14908&apos;, &apos;pai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14914&apos;, &apos;pa&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14921&apos;, &apos;ou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14922&apos;, &apos;o&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14926&apos;, &apos;nuo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14928&apos;, &apos;nue&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14929&apos;, &apos;nuan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14930&apos;, &apos;nv&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14933&apos;, &apos;nu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14937&apos;, &apos;nong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;14941&apos;, &apos;niu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15109&apos;, &apos;ning&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15110&apos;, &apos;nin&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15117&apos;, &apos;nie&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15119&apos;, &apos;niao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15121&apos;, &apos;niang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15128&apos;, &apos;nian&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15139&apos;, &apos;ni&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15140&apos;, &apos;neng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15141&apos;, &apos;nen&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15143&apos;, &apos;nei&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15144&apos;, &apos;ne&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15149&apos;, &apos;nao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15150&apos;, &apos;nang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15153&apos;, &apos;nan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15158&apos;, &apos;nai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15165&apos;, &apos;na&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15180&apos;, &apos;mu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15183&apos;, &apos;mou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15362&apos;, &apos;mo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15363&apos;, &apos;miu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15369&apos;, &apos;ming&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15375&apos;, &apos;min&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15377&apos;, &apos;mie&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15385&apos;, &apos;miao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15394&apos;, &apos;mian&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15408&apos;, &apos;mi&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15416&apos;, &apos;meng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15419&apos;, &apos;men&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15435&apos;, &apos;mei&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15436&apos;, &apos;me&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15448&apos;, &apos;mao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15454&apos;, &apos;mang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15625&apos;, &apos;man&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15631&apos;, &apos;mai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15640&apos;, &apos;ma&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15652&apos;, &apos;luo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15659&apos;, &apos;lun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15661&apos;, &apos;lue&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15667&apos;, &apos;luan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15681&apos;, &apos;lv&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15701&apos;, &apos;lu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15707&apos;, &apos;lou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15878&apos;, &apos;long&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15889&apos;, &apos;liu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15903&apos;, &apos;ling&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15915&apos;, &apos;lin&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15920&apos;, &apos;lie&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15933&apos;, &apos;liao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15944&apos;, &apos;liang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15958&apos;, &apos;lian&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;15959&apos;, &apos;lia&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16155&apos;, &apos;li&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16158&apos;, &apos;leng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16169&apos;, &apos;lei&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16171&apos;, &apos;le&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16180&apos;, &apos;lao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16187&apos;, &apos;lang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16202&apos;, &apos;lan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16205&apos;, &apos;lai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16212&apos;, &apos;la&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16216&apos;, &apos;kuo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16220&apos;, &apos;kun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16393&apos;, &apos;kui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16401&apos;, &apos;kuang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16403&apos;, &apos;kuan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16407&apos;, &apos;kuai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16412&apos;, &apos;kua&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16419&apos;, &apos;ku&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16423&apos;, &apos;kou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16427&apos;, &apos;kong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16429&apos;, &apos;keng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16433&apos;, &apos;ken&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16448&apos;, &apos;ke&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16452&apos;, &apos;kao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16459&apos;, &apos;kang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16465&apos;, &apos;kan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16470&apos;, &apos;kai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16474&apos;, &apos;ka&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16647&apos;, &apos;jun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16657&apos;, &apos;jue&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16664&apos;, &apos;juan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16689&apos;, &apos;ju&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16706&apos;, &apos;jiu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16708&apos;, &apos;jiong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16733&apos;, &apos;jing&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16915&apos;, &apos;jin&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16942&apos;, &apos;jie&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16970&apos;, &apos;jiao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;16983&apos;, &apos;jiang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17185&apos;, &apos;jian&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17202&apos;, &apos;jia&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17417&apos;, &apos;ji&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17427&apos;, &apos;huo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17433&apos;, &apos;hun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17454&apos;, &apos;hui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17468&apos;, &apos;huang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17482&apos;, &apos;huan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17487&apos;, &apos;huai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17496&apos;, &apos;hua&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17676&apos;, &apos;hu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17683&apos;, &apos;hou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17692&apos;, &apos;hong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17697&apos;, &apos;heng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17701&apos;, &apos;hen&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17703&apos;, &apos;hei&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17721&apos;, &apos;he&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17730&apos;, &apos;hao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17733&apos;, &apos;hang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17752&apos;, &apos;han&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17759&apos;, &apos;hai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17922&apos;, &apos;ha&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17928&apos;, &apos;guo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17931&apos;, &apos;gun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17947&apos;, &apos;gui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17950&apos;, &apos;guang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17961&apos;, &apos;guan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17964&apos;, &apos;guai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17970&apos;, &apos;gua&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17988&apos;, &apos;gu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;17997&apos;, &apos;gou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18012&apos;, &apos;gong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18181&apos;, &apos;geng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18183&apos;, &apos;gen&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18184&apos;, &apos;gei&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18201&apos;, &apos;ge&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18211&apos;, &apos;gao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18220&apos;, &apos;gang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18231&apos;, &apos;gan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18237&apos;, &apos;gai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18239&apos;, &apos;ga&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18446&apos;, &apos;fu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18447&apos;, &apos;fou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18448&apos;, &apos;fo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18463&apos;, &apos;feng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18478&apos;, &apos;fen&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18490&apos;, &apos;fei&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18501&apos;, &apos;fang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18518&apos;, &apos;fan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18526&apos;, &apos;fa&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18696&apos;, &apos;er&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18697&apos;, &apos;en&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18710&apos;, &apos;e&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18722&apos;, &apos;duo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18731&apos;, &apos;dun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18735&apos;, &apos;dui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18741&apos;, &apos;duan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18756&apos;, &apos;du&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18763&apos;, &apos;dou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18773&apos;, &apos;dong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18774&apos;, &apos;diu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18783&apos;, &apos;ding&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18952&apos;, &apos;die&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18961&apos;, &apos;diao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18977&apos;, &apos;dian&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;18996&apos;, &apos;di&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19003&apos;, &apos;deng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19006&apos;, &apos;de&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19018&apos;, &apos;dao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19023&apos;, &apos;dang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19038&apos;, &apos;dan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19212&apos;, &apos;dai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19218&apos;, &apos;da&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19224&apos;, &apos;cuo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19227&apos;, &apos;cun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19235&apos;, &apos;cui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19238&apos;, &apos;cuan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19242&apos;, &apos;cu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19243&apos;, &apos;cou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19249&apos;, &apos;cong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19261&apos;, &apos;ci&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19263&apos;, &apos;chuo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19270&apos;, &apos;chun&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19275&apos;, &apos;chui&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19281&apos;, &apos;chuang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19288&apos;, &apos;chuan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19289&apos;, &apos;chuai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19467&apos;, &apos;chu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19479&apos;, &apos;chou&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19484&apos;, &apos;chong&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19500&apos;, &apos;chi&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19515&apos;, &apos;cheng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19525&apos;, &apos;chen&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19531&apos;, &apos;che&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19540&apos;, &apos;chao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19715&apos;, &apos;chang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19725&apos;, &apos;chan&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19728&apos;, &apos;chai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19739&apos;, &apos;cha&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19741&apos;, &apos;ceng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19746&apos;, &apos;ce&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19751&apos;, &apos;cao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19756&apos;, &apos;cang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19763&apos;, &apos;can&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19774&apos;, &apos;cai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19775&apos;, &apos;ca&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19784&apos;, &apos;bu&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19805&apos;, &apos;bo&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19976&apos;, &apos;bing&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19982&apos;, &apos;bin&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19986&apos;, &apos;bie&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;19990&apos;, &apos;biao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20002&apos;, &apos;bian&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20026&apos;, &apos;bi&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20032&apos;, &apos;beng&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20036&apos;, &apos;ben&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20051&apos;, &apos;bei&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20230&apos;, &apos;bao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20242&apos;, &apos;bang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20257&apos;, &apos;ban&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20265&apos;, &apos;bai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20283&apos;, &apos;ba&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20292&apos;, &apos;ao&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20295&apos;, &apos;ang&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20304&apos;, &apos;an&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20317&apos;, &apos;ai&apos;);</span><br><span class="line">INSERT INTO `pinyin` VALUES (&apos;20319&apos;, &apos;a&apos;);</span><br></pre></td></tr></table></figure>
<h3 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select f_to_pinyin(&quot;测试&quot;);</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>如何快乐的去工作</title>
    <url>/2015/10/15/how-to-happy-work/</url>
    <content><![CDATA[<h2 id="如何快乐的去工作"><a href="#如何快乐的去工作" class="headerlink" title="如何快乐的去工作"></a>如何快乐的去工作</h2><h3 id="简化工作的高效法则"><a href="#简化工作的高效法则" class="headerlink" title="简化工作的高效法则"></a>简化工作的高效法则</h3><p>我们创造了那么多条条框框，中间部门和协调人员，对每个员工进行问责制，之后考核量化kpi，有增加了很多了复杂度。当我责怪一个人的时候，而不是责怪清晰度、问责制、衡量方法的时候，我们在无效之后有增加了很多。<a id="more"></a></p>
<p><strong>我们创造的组织，应该让人们觉得合作得益于个人。</strong> 把界限划分、中间部门取消掉，和所有复杂的中间结构。不要强求清晰度，选择模糊（go for fuzziness）。我们要的不适“速度”，而是（how） 怎样去合作，而不是去做很多可量化的事情，而是去想怎么让自己的组织得益于个人。</p>
<h3 id="改善工作的快乐之道"><a href="#改善工作的快乐之道" class="headerlink" title="改善工作的快乐之道"></a>改善工作的快乐之道</h3><p>是否感觉快乐是，90％是我们的大脑如何理解这个世界的，改变我们关于快乐和成功的定义准则，只有10%是外界影响的，其他的要靠我们自己的行为去改变。</p>
<p>很多学校和社会的组织告诉你，只要你努力了我就会成功，我成功了我就会更快乐。当你成功了之后，比如说你取得很好的成绩，接下来你必须取得更好的成绩；有了一份好工作，你必须下次有个更好的工作，这样才能使你一直保持更快乐。其实这个是错误，落后的观念。如果快乐在成功的相反面，你永远不会得到快乐。我们的大脑在经历这快乐优势论的过程，当大脑出现积极表现，会使你的智商提高、创造力提高、精力也提高了，多巴胺的分泌增加了。多巴胺不仅会让你的感到快乐，同时还可以打开大脑中所有的学习中心，让你另一种方式来适应这个世界。</p>
<p>怎样找到一种方法是我们的大脑更积极，我们会更努力、更快速、更聪明。</p>
<blockquote>
<p><strong>记日记</strong>－记录过去24小时值得你感恩、成功的事情，大脑过一遍你会更积极</p>
<p><strong>锻炼</strong>－像锻炼身体一样去锻炼大脑</p>
<p><strong>冥想</strong> —克服注意力不集中的问题，专心去处理好一件事情，减少大脑的疲劳</p>
<p><strong>善举</strong>－赞美身边的人，给自己的sns上的朋友发一些赞美的邮件等小的善举</p>
</blockquote>
<p> 积极心理学，积极去的去学习去做一件好的良性循环的事情，持续21天，就会初步养成积极的心里反应，这或许是一场革命。</p>
<h3 id="工作和生活如何平衡（balance）"><a href="#工作和生活如何平衡（balance）" class="headerlink" title="工作和生活如何平衡（balance）"></a>工作和生活如何平衡（balance）</h3><p>生活的含义很丰富，在工作和生活中找到平衡点，试图用旅行、运动、以及瑜伽，做50个俯卧撑等来放松自己，但是试问自己，真的有效吗？其实我们忽略了一点：知性生活、精神生活、情感生活，才是这个快节奏的社会中让我们慢下来的方法。寻找平衡点不需要我嘛颠覆原来的生活，和周围的人相处的温暖（comfortable）就好。苦苦寻找的其实就在不经意处。</p>
<h3 id="舒缓工作焦虑症的9个TIps（9-ways-to-feel-less-anxiou"><a href="#舒缓工作焦虑症的9个TIps（9-ways-to-feel-less-anxiou" class="headerlink" title="舒缓工作焦虑症的9个TIps（9 ways to feel less anxiou"></a>舒缓工作焦虑症的9个TIps（9 ways to feel less anxiou</h3><h3 id="at-work）"><a href="#at-work）" class="headerlink" title="at work）"></a>at work）</h3><ol>
<li>深呼吸，并承认自己的焦虑（take a deep breath and acknowledge that you’re anxious）</li>
<li>别喝咖啡，喝点茶，能让你放松(instead of coffee,caffeine-free chamomile tea,it’s relaxing)</li>
<li>午餐时看自己喜欢的节目(whatch a show you like during lunch break )</li>
<li>把自己看做一个气球，以七秒为周期进行呼吸转换，这样能消除杂念 (visualize filling up a balloon,exhale in 7-second intervals ，it clears your mind)</li>
<li>工作间隙抽出十分钟来进行放松(take ten minutes to yourself during your work day)</li>
<li>和朋友聊天，聊一些和工作无关的事情（talk with a friend,something unrelated to work)</li>
<li>别吃糖果，吃点自然食物，比如杏仁儿(instead of sugary treats,try natural energy snacks like almonds !)</li>
<li>整理桌面(get rid of your clutter)</li>
<li>重要的是晚上好好睡一觉(make sure to get a good night’s sleep)</li>
</ol>
]]></content>
      <tags>
        <tag>work</tag>
      </tags>
  </entry>
  <entry>
    <title>gulp tutorial</title>
    <url>/2016/07/15/gulp-tutorial/</url>
    <content><![CDATA[<h3 id="安装nodejs"><a href="#安装nodejs" class="headerlink" title="安装nodejs"></a>安装nodejs</h3><p>之前已经安装nodejs,npm 了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//安装中文镜像源文件</span><br><span class="line">npm install cnpm -g --registry=https://registry.npm.taobao.org</span><br><span class="line">npm uninstall xxx</span><br><span class="line">//查看已经安装的插件</span><br><span class="line">npm list</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="安装gulp-新建package-json文件"><a href="#安装gulp-新建package-json文件" class="headerlink" title="安装gulp,新建package.json文件"></a>安装gulp,新建package.json文件</h3><p>全局安装 <code>cnpm install gulp -g</code> ,之后  <code>cnpm init</code> 初始化, <code>cnpm install gulp --save-dev</code><br>我们全局安装了gulp，项目也安装了gulp，全局安装gulp是为了执行gulp任务，这句本地安装gulp则是为了调用gulp插件的功能。<br>查看 <code>package.json</code> 帮助文档，命令提示符执行 <code>cnpm help package.json</code>。</p>
<h3 id="安装gulp插件-运行demo"><a href="#安装gulp插件-运行demo" class="headerlink" title="安装gulp插件,运行demo"></a>安装gulp插件,运行demo</h3><p>gulpfile.js是gulp项目的配置文件，是位于项目根目录的普通js文件（其实将gulpfile.js放入其他文件夹下亦可）,下面是一个demo：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//导入工具包 require('node_modules里对应模块')</span></span><br><span class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>), <span class="comment">//本地安装gulp所用到的地方</span></span><br><span class="line">  less = <span class="built_in">require</span>(<span class="string">'gulp-less'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个testLess任务（自定义任务名称）</span></span><br><span class="line">gulp.task(<span class="string">'testLess'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  gulp.src(<span class="string">'src/less/index.less'</span>) <span class="comment">//该任务针对的文件</span></span><br><span class="line">      .pipe(less()) <span class="comment">//该任务调用的模块</span></span><br><span class="line">      .pipe(gulp.dest(<span class="string">'src/css'</span>)); <span class="comment">//将会在src/css下生成index.css</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'default'</span>,[<span class="string">'testLess'</span>, <span class="string">'elseTask'</span>]); <span class="comment">//定义默认任务 elseTask为其他任务，该示例没有定义elseTask任务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//gulp.task(name[, deps], fn) 定义任务  name：任务名称 deps：依赖任务名称 fn：回调函数</span></span><br><span class="line"><span class="comment">//gulp.src(globs[, options]) 执行任务处理的文件  globs：处理的文件路径(字符串或者字符串数组)</span></span><br><span class="line"><span class="comment">//gulp.dest(path[, options]) 处理完后文件生成路径</span></span><br></pre></td></tr></table></figure>
<p>运行 <code>gulp testLess</code>、 <code>gulp default</code> or  <code>gulp</code></p>
<h3 id="gulp-和-laravel-的使用"><a href="#gulp-和-laravel-的使用" class="headerlink" title="gulp 和 laravel 的使用"></a>gulp 和 laravel 的使用</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g gulp</span><br><span class="line">gulp -v</span><br></pre></td></tr></table></figure>
<p>laravel 包文件中包含 package.json 文件， <code>npm install</code> 安装包含的glup和laravel-elixir</p>
<h4 id="Elixir-使用"><a href="#Elixir-使用" class="headerlink" title="Elixir 使用"></a>Elixir 使用</h4><p>包含 <code>gulpfile.js</code>文件<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">elixir(<span class="function"><span class="keyword">function</span>(<span class="params">mix</span>) </span>&#123;</span><br><span class="line">    mix.less(<span class="string">'app.less'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>mix.less 任务可以用于编译Less文件，在本例中该文件名为 app.less ，这个文件位于 resources/assets/less 目录下，其内容如下</p>
<p><a href="http://www.tuicool.com/articles/YRV7Fz" target="_blank" rel="noopener">Laravel Elixir</a></p>
]]></content>
  </entry>
  <entry>
    <title>工厂模式(factory pattern)</title>
    <url>/2015/09/27/factory-pattern/</url>
    <content><![CDATA[<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Shape</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCircum</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getArea</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//矩形</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> <span class="keyword">implements</span> <span class="title">Shape</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $width, $height;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($width, $height)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;width = $width;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;height = $height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCircum</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;width + <span class="keyword">$this</span>-&gt;height) * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getArea</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;width * <span class="keyword">$this</span>-&gt;height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="keyword">implements</span> <span class="title">Shape</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $radii;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($radii)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;radii = $radii;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCircum</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement getCircum() method.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * M_PI * <span class="keyword">$this</span>-&gt;radii;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getArea</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement getArea() method.</span></span><br><span class="line">        <span class="keyword">return</span> M_PI * pow(<span class="keyword">$this</span>-&gt;radii, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建工厂</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Factory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//判断穿过来的参数个数</span></span><br><span class="line">        <span class="keyword">switch</span> (func_num_args()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Circle(func_get_arg(<span class="number">0</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Rectangle(func_get_arg(<span class="number">0</span>), func_get_arg(<span class="number">1</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$rectangle = Factory::create(<span class="number">4</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">echo</span> $rectangle-&gt;getCircum().<span class="string">" "</span>;</span><br><span class="line"><span class="keyword">echo</span> $rectangle-&gt;getArea().<span class="string">" "</span>;</span><br><span class="line"></span><br><span class="line">$circle = Factory::create(<span class="number">3</span>);</span><br><span class="line"><span class="keyword">echo</span> $circle-&gt;getCircum().<span class="string">" "</span>;</span><br><span class="line"><span class="keyword">echo</span> $circle-&gt;getArea();</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>design pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>怎样会来事？</title>
    <url>/2015/06/21/hui-lai-shi/</url>
    <content><![CDATA[<h2 id="何为会来事？"><a href="#何为会来事？" class="headerlink" title="何为会来事？"></a>何为会来事？</h2><p>创造双赢局面甚至创造多赢局面。那种总是能够看透那些不明显的利益取向，进而创造出来多赢的局面来。<br>1.即便你完全不会来事，只能独来独往，现在的这个世界也会给你一条还算不错的的路。<br>2.只要认真面对，在任何环境里，都能知道办法创造多赢的局面。<a id="more"></a><br>3.我知道不会来事确实很吃亏……<br>4.善于创造多赢局面，好多研究一下，好好实践。<br>5.全无恶意，是坦荡的根本</p>
<h3 id="社交"><a href="#社交" class="headerlink" title="社交"></a>社交</h3><p>所谓的”面子“获取一切，想得美。其实应该自己本身是有价值的。看看幼儿园的小朋友交换玩具就知道了，多的和少的，甚至没有的，他都会有分别心的，那个是好好朋友那个不是。<br>所有的人都喜欢甚至偏爱一种交换–公平交换</p>
<blockquote>
<ul>
<li>所谓的友谊其实是一种某种意义上的一种“交换关系”。培养自己的交换价值，你才能赢取更多。</li>
<li>不是因为他们要好才各自变得优秀，而是因为他们都很优秀才会非常要好。</li>
<li>面对求人，或者求己的情况，要承认自己能力有限，是保持心理健康的前提。</li>
<li>而一个人的能力越是渺小，他的欲望就会显得越发强烈。</li>
<li>针对个体来说，比人脉更重要的是他拥有的资源。</li>
</ul>
</blockquote>
<p>那么总结起来，可以概括：<br>1.专心做自己可以提升自己的事情，学习并拥有更多、更好的技能，成为一个其他人都值得交往的人。<br>2.学会独善其身，以不给他人制造麻烦为美德，用自己的独立赢得尊重。</p>
<h3 id="其实自己在工作生活的认真思考，好好分享出来，本身就会赢得更多。而不是总是关注那些离自己很远的事情，形而无用的东西。"><a href="#其实自己在工作生活的认真思考，好好分享出来，本身就会赢得更多。而不是总是关注那些离自己很远的事情，形而无用的东西。" class="headerlink" title="其实自己在工作生活的认真思考，好好分享出来，本身就会赢得更多。而不是总是关注那些离自己很远的事情，形而无用的东西。"></a>其实自己在工作生活的认真思考，好好分享出来，本身就会赢得更多。而不是总是关注那些离自己很远的事情，形而无用的东西。</h3>]]></content>
  </entry>
  <entry>
    <title>成长记</title>
    <url>/2015/06/22/grown-up/</url>
    <content><![CDATA[<h1 id="给你90天，成为不一样的自己"><a href="#给你90天，成为不一样的自己" class="headerlink" title="给你90天，成为不一样的自己"></a>给你90天，成为不一样的自己</h1><p>为了改变我的三分钟热度性格，我曾给自己提出一个要求，就是以”22天习惯养成”为基础。只不过，我要求自己，如果真正开始一件事就至少要坚持90天以上，而一旦坚持了90天，接下来的继续也就十分容易了。它对我的确受益匪浅，我想把它也分享给已在职场的你。如果你的确认真坚持了，I AM SURE U WILL FIND A DIFFERENT U.<br><a id="more"></a></p>
<h2 id="不赖床，比你往常订好闹钟的时间往前调至少20分钟"><a href="#不赖床，比你往常订好闹钟的时间往前调至少20分钟" class="headerlink" title="不赖床，比你往常订好闹钟的时间往前调至少20分钟"></a>不赖床，比你往常订好闹钟的时间往前调至少20分钟</h2><h2 id="上班第一件事：先梳理工作"><a href="#上班第一件事：先梳理工作" class="headerlink" title="上班第一件事：先梳理工作"></a>上班第一件事：先梳理工作</h2><h2 id="忽略别人的缺点，吸纳他的优点"><a href="#忽略别人的缺点，吸纳他的优点" class="headerlink" title="忽略别人的缺点，吸纳他的优点"></a>忽略别人的缺点，吸纳他的优点</h2><h2 id="远离爱抱怨的同事和朋友，不说同事或者老板闲话"><a href="#远离爱抱怨的同事和朋友，不说同事或者老板闲话" class="headerlink" title="远离爱抱怨的同事和朋友，不说同事或者老板闲话"></a>远离爱抱怨的同事和朋友，不说同事或者老板闲话</h2><h2 id="每月重列购物清单，作为自己的奖励"><a href="#每月重列购物清单，作为自己的奖励" class="headerlink" title="每月重列购物清单，作为自己的奖励"></a>每月重列购物清单，作为自己的奖励</h2><h2 id="戒掉你的微信朋友圈和其他社交网络"><a href="#戒掉你的微信朋友圈和其他社交网络" class="headerlink" title="戒掉你的微信朋友圈和其他社交网络"></a>戒掉你的微信朋友圈和其他社交网络</h2><p>可以改成每天午间吃完饭或者晚上睡觉前查看一下一天的更新。 如果不是很忙的时候，你可以选择浏览职业相关的论坛或者网页学点东西。 我最近比较迷恋知乎，自从开始看知乎以后，觉得知识面上升了不少，推荐你也试试。</p>
<h2 id="健身，一辈子的习惯"><a href="#健身，一辈子的习惯" class="headerlink" title="健身，一辈子的习惯"></a>健身，一辈子的习惯</h2><p>可能每次挥汗如雨的时候，你都有种放弃的感觉，但之后身心都会特别轻松。 相信我，健身带来的改变不只是身体上的，更多的是精神！！！</p>
<h2 id="保持阅读习惯"><a href="#保持阅读习惯" class="headerlink" title="保持阅读习惯"></a>保持阅读习惯</h2><p>每个月至少买四本书，有时间的话，每周看一本，实在觉得时间不够，两周读一本。 读书给你变化是潜移默化的，它也能带来内心的平静。 为了多读书，我的方法是：先看拿到手的书有多少页，将其拆分，用总页数除以7，得到的数就是你每天必须要读的页数。（我想你的时间应该比我多一些，因为我每天侍候完孩子的吃喝拉撒睡就得11点了）； 记住，如果你用我的这个方法，这个必读页数就是每天必须完成的。 如果你有大把时间可以将它一口气读完，当然最好； 如果没有完整时间，这个方法能迫使你放弃那些没时间读书的借口。</p>
<h2 id="做事给自己设置deadline"><a href="#做事给自己设置deadline" class="headerlink" title="做事给自己设置deadline"></a>做事给自己设置deadline</h2><h2 id="总结，练习"><a href="#总结，练习" class="headerlink" title="总结，练习"></a>总结，练习</h2><blockquote>
<p>当回忆自己前几个月，或者前几年都做过什么，常常想不起来，记录自己的event-time-log 是一个好习惯，而且更能感知时间</p>
</blockquote>
<h2 id="投资你自己"><a href="#投资你自己" class="headerlink" title="投资你自己"></a>投资你自己</h2><p>多去接触比自己优秀的圈子，或者自己想去发展的方向，你会得到不一样的收获。</p>
<h2 id="打造数据自己的完整作品"><a href="#打造数据自己的完整作品" class="headerlink" title="打造数据自己的完整作品"></a>打造数据自己的完整作品</h2><h2 id="TEFCAS"><a href="#TEFCAS" class="headerlink" title="TEFCAS"></a>TEFCAS</h2><p>T—-尝试 E—-行动 F—-反馈，确认核实 C—-检查 A—-调整 S—-成功 <a href="http://www.jianshu.com/p/e9054cb333e8" target="_blank" rel="noopener">思维导图</a></p>
<h1 id="要去学一门技术。那么："><a href="#要去学一门技术。那么：" class="headerlink" title="要去学一门技术。那么："></a>要去学一门技术。那么：</h1><ol>
<li>How：去找专家的 “实作方法” 课、”实作方法” 书，快速地跟着 TA 做。（请先一模一样地跟着做，不要自作聪明地改，也不要去问为什么。）</li>
<li>What：接着把 “成果” 做一点小修改，看看会不会有效果。</li>
<li>Why：把东西改得有效果了以后，再去查 Why。</li>
</ol>
<p>五天都重复这样的循环，你就会了，至少能掌握这门学问的 60%。我保证，就这么简单。 前提是：在前三个小时里，你能按捺住你的好奇心，别问 Why 与 What。否则你学五个月都学不出来。</p>
<p>人很犯贱，做事情前都要先问为什么，否则就不想做。然后知道为什么后，就会开始想 What to do 。而这就是 “最惨的地方”。 初学东西时绝对不要用大脑，诀窍是 <code>“用肌肉学习”。</code></p>
<p>如果你一开始用大脑学，<code>就掉入了一个大陷阱</code>，这也是很多人学东西学不起来的原因。 <code>人的肌肉都是有记忆的，只要重复去做，就会记住</code>。 只要一件事情，重复练五次，肌肉就会带着这件事的记忆。所以 “为什么” 不要问太多遍，先做就对了，也不要一边做一边改成自己想要的。 也就是说在初学阶段绝对不能让 “大脑” 介入你的学习训练过程。</p>
<p>可以去学习那些西方的寓言小故事可以很有趣的，如:<a href="http://sivers.org/horses" target="_blank" rel="noopener">塞翁失马</a></p>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>Markdown</title>
    <url>/2015/03/15/markdown/</url>
    <content><![CDATA[<h2 id="markdown-在-sublime-text-3-中使用"><a href="#markdown-在-sublime-text-3-中使用" class="headerlink" title="markdown 在 sublime text 3 中使用"></a>markdown 在 sublime text 3 中使用</h2><p>作为Windows/Mac/Linux下强大的文本编辑器，st提供了对Markdown语言的支持。通过设置可实现markdown预览和转换功能。而本文介绍的Markdown Preview支持Mathjax语法和目录自动生成。(Windows下）,<br>打开st，按下组合键Control + `，出现控制台，输入<br><a id="more"></a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">import  urllib.request,os;pf=<span class="string">'Package Control.sublime-package'</span>;ipp=sublime.installed_packages_path();urllib.request.install_opener(urllib.request.build_opener(urllib.request.ProxyHandler()));open(os.path.join(ipp,pf),<span class="string">'wb'</span>).write(urllib.request.urlopen(<span class="string">'http://sublime.wbond.net/'</span>+pf.replace(<span class="string">' '</span>,<span class="string">'%20'</span>)).<span class="built_in">read</span>())</span><br></pre></td></tr></table></figure>
<p>当看到代码最后一行提示的时候说明安装成功，此时重启st，可在Preferences -&gt; Package Settings看到Package Control。<br>安装markdown preview<br>按下键Ctrl+Shift+p调出命令面板，找到Package Control: install Pakage这一项。搜索markdown preview，点击安装。</p>
<p>使用<br>Markdown Preview较常用的功能是preview in browser和Export HTML in Sublime Text，前者可以在浏览器看到预览效果，后者可将markdown保存为html文件。</p>
<p>preview in browser据称是实时的，但是实践上还是需要在st保存，然后浏览器刷新才能看到新的效果，好在markdown写得多的话也不需要每敲一行看一次效果。</p>
<p>快捷键</p>
<p>新版本默认快捷键为 <em> ctrl+shift+m </em></p>
<p>旧版本下面配置：<br>st支持自定义快捷键，markdown preview默认没有快捷键，我们可以自己为preview in browser设置快捷键。方法是在Preferences -&gt; Key Bindings User打开的文件的中括号中添加以下代码(可在Key Bindings Default找到格式)：</p>
<blockquote>
<p>{ “keys”: [“alt+m”], “command”: “markdown_preview”, “args”: { “target”: “browser”} }</p>
</blockquote>
<p>“alt+m”可设置为自己喜欢的按键。</p>
<p>设置语法高亮和mathjax支持<br>在Preferences -&gt;Package Settings-&gt;Markdown Preview-&gt;Setting Default中的第31行和36行找到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&quot;enable_mathjax&quot;: false,</span><br><span class="line">&quot;enable_highlight&quot;: false,</span><br></pre></td></tr></table></figure>
<p>将 两个false改为true即可。<br>语法高亮跟编辑器的主题有关，可以在Preferences -&gt;Color Scheme找自己喜欢的主题。<br>关于目录生成，只要文章是按照markdown语法写作的。在需要生成目录的地方写<br>[TOC]<br>即可。</p>
<h2 id="markdown-语法参考"><a href="#markdown-语法参考" class="headerlink" title="markdown 语法参考"></a>markdown 语法参考</h2><p>@changyuan</p>
<p>Emphasis, aka italics, with <em>asterisks</em> or <em>underscores</em>.<br>Strong emphasis, aka bold, with <strong>asterisks</strong> or <strong>underscores</strong>.<br>Combined emphasis with <strong>asterisks and <em>underscores</em></strong>.<br>Strikethrough uses two tildes. <del>Scratch this.</del></p>
<p><a href="https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet" target="_blank" rel="noopener">参考1</a><br><a href="https://guides.github.com/features/mastering-markdown/" target="_blank" rel="noopener">参考2</a></p>
<h2 id="emoji表情参考"><a href="#emoji表情参考" class="headerlink" title="emoji表情参考"></a>emoji表情参考</h2><p>:smile::thumbsup::thumbsup:<br><del>emo</del><br><a href="http://www.emoji-cheat-sheet.com/" target="_blank" rel="noopener">emoji表情参考</a></p>
]]></content>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>mac 常见环境安装配置</title>
    <url>/2015/07/29/mac-web/</url>
    <content><![CDATA[<h2 id="Homebrew"><a href="#Homebrew" class="headerlink" title="Homebrew"></a>Homebrew</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">//install</span><br><span class="line">ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></span><br><span class="line"></span><br><span class="line">//use</span><br><span class="line">brew search /apache*/</span><br><span class="line">brew install wget</span><br><span class="line">brew uninstall wget</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="http://brew.sh/" target="_blank" rel="noopener">官网</a></p>
</blockquote>
<a id="more"></a>
<h2 id="zsh-bash"><a href="#zsh-bash" class="headerlink" title="zsh bash"></a>zsh bash</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>"</span></span><br></pre></td></tr></table></figure>
<p>｀cat /etc/shells｀ 查看所有的sh<br><code>chsh -s /bin/bash</code>  或者 <code>chsh -s /bin/zsh</code></p>
<p><a href="http://ohmyz.sh/" target="_blank" rel="noopener">zsh</a></p>
<h2 id="apache"><a href="#apache" class="headerlink" title="apache"></a>apache</h2><p>mac自带一个版本，如果安装新的<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install apache</span><br></pre></td></tr></table></figure></p>
<h2 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h2><p>自动安装依赖<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install nginx</span><br><span class="line"></span><br><span class="line">sudo nginx</span><br><span class="line">nginx -s reload|reopen|stop|quit</span><br><span class="line">nginx -t</span><br></pre></td></tr></table></figure></p>
<p>默认启用的8080端口，可以更改配置文件来设置端口。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /usr/<span class="built_in">local</span>/etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure></p>
<p>默认访问目录：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/Cellar/nginx/<span class="variable">$version</span>/html</span><br></pre></td></tr></table></figure></p>
<h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install mysql</span><br></pre></td></tr></table></figure>
<p>安装完成之后：<br>We’ve installed your MySQL database without a root password. To secure it run:<br>    <code>mysql_secure_installation</code><br>To connect run:<br>    <code>mysql -uroot</code><br>To have launchd start mysql now and restart at login:<br>  <code>brew services start mysql</code><br>Or, if you don’t want/need a background service you can just run:<br>  <code>mysql.server start</code></p>
<p>在5.7版本之后，其自动初始化数据库，用｀mysql.erver start｀ 启动 ，<code>mysql -uroot</code> 链接使用.<br>在之前的需要初始化数据库。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql_install_db --verbose --user=<span class="string">'whoami'</span> --basedir=<span class="string">"<span class="variable">$(brew --prefix mysql)</span>"</span> --datadir=/usr/<span class="built_in">local</span>/var/mysql --tmpdir=/tmp</span><br></pre></td></tr></table></figure></p>
<p><code>mysqladmin -u root password &#39;password&#39;</code></p>
<h2 id="php"><a href="#php" class="headerlink" title="php"></a>php</h2><blockquote>
<p><a href="https://github.com/Homebrew/homebrew-php" target="_blank" rel="noopener">参考</a><br>安装完成之后：</p>
</blockquote>
<p>To enable PHP in Apache add the following to httpd.conf and restart Apache:<br>    <code>LoadModule php5_module    /usr/local/opt/php56/libexec/apache2/libphp5.so</code></p>
<p>The php.ini file can be found in:<br>    <code>/usr/local/etc/php/5.6/php.ini</code></p>
<p>✩✩✩✩ Extensions ✩✩✩✩</p>
<p>If you are having issues with custom extension compiling, ensure that<br>you are using the brew version, by placing /usr/local/bin before /usr/sbin in your PATH:</p>
<pre><code>PATH=&quot;/usr/local/bin:$PATH&quot;
</code></pre><p>PHP56 Extensions will always be compiled against this PHP. Please install them<br>using –without-homebrew-php to enable compiling against system PHP.</p>
<p>✩✩✩✩ PHP CLI ✩✩✩✩</p>
<p>If you wish to swap the PHP you use on the command line, you should add the following to ~/.bashrc,<br>~/.zshrc, ~/.profile or your shell’s equivalent configuration file:</p>
<pre><code>export PATH=&quot;$(brew --prefix homebrew/php/php56)/bin:$PATH&quot;
</code></pre><p>✩✩✩✩ FPM ✩✩✩✩</p>
<p>加入launchctl启动控制<br>To launch php-fpm on startup:<br>    mkdir -p ~/Library/LaunchAgents<br>    cp /usr/local/opt/php56/homebrew.mxcl.php56.plist ~/Library/LaunchAgents/<br>    launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.php56.plist</p>
<p>The control script is located at /usr/local/opt/php56/sbin/php56-fpm</p>
<p>OS X 10.8 and newer come with php-fpm pre-installed, to ensure you are using the brew version you need to make sure /usr/local/sbin is before /usr/sbin in your PATH:</p>
<p>  PATH=”/usr/local/sbin:$PATH”</p>
<p>You may also need to edit the plist to use the correct “UserName”.</p>
<p>Please note that the plist was called ‘homebrew-php.josegonzalez.php56.plist’ in old versions<br>of this formula.</p>
<p>To have launchd start homebrew/php/php56 now and restart at login:<br>  brew services start homebrew/php/php56<br>  brew services restart homebrew/php/php56</p>
<p>DocumentRoot is /usr/local/var/www.</p>
<p>The default ports have been set in /usr/local/etc/httpd/httpd.conf to 8080 and in<br>/usr/local/etc/httpd/extra/httpd-ssl.conf to 8443 so that httpd can run without sudo.</p>
<p>To have launchd start httpd now and restart at login:<br>  brew services start httpd<br>Or, if you don’t want/need a background service you can just run:<br>  apachectl start</p>
<p>To enable PHP in Apache add the following to httpd.conf and restart Apache:<br>    LoadModule php7_module <a href="mailto:/usr/local/opt/php@7.1" target="_blank" rel="noopener">/usr/local/opt/php@7.1</a>/lib/httpd/modules/libphp7.so</p>
<pre><code>&lt;FilesMatch \.php$&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;
</code></pre><p>Finally, check DirectoryIndex includes index.php<br>    DirectoryIndex index.php index.html</p>
<p>The php.ini and php-fpm.ini file can be found in:<br>    /usr/local/etc/php/7.1/</p>
<p><a href="mailto:php@7.1" target="_blank" rel="noopener">php@7.1</a> is keg-only, which means it was not symlinked into /usr/local,<br>because this is an alternate version of another formula.</p>
<p>If you need to have <a href="mailto:php@7.1" target="_blank" rel="noopener">php@7.1</a> first in your PATH run:<br>  echo ‘export PATH=”<a href="mailto:/usr/local/opt/php@7.1" target="_blank" rel="noopener">/usr/local/opt/php@7.1</a>/bin:$PATH”‘ &gt;&gt; ~/.bash_profile<br>  echo ‘export PATH=”<a href="mailto:/usr/local/opt/php@7.1" target="_blank" rel="noopener">/usr/local/opt/php@7.1</a>/sbin:$PATH”‘ &gt;&gt; ~/.bash_profile</p>
<p>For compilers to find <a href="mailto:php@7.1" target="_blank" rel="noopener">php@7.1</a> you may need to set:<br>  export LDFLAGS=”<a href="mailto:-L/usr/local/opt/php@7.1" target="_blank" rel="noopener">-L/usr/local/opt/php@7.1</a>/lib”<br>  export CPPFLAGS=”<a href="mailto:-I/usr/local/opt/php@7.1" target="_blank" rel="noopener">-I/usr/local/opt/php@7.1</a>/include”</p>
<p>To have launchd start <a href="mailto:php@7.1" target="_blank" rel="noopener">php@7.1</a> now and restart at login:<br>  brew services start <a href="mailto:php@7.1" target="_blank" rel="noopener">php@7.1</a><br>Or, if you don’t want/need a background service you can just run:<br>  php-fpm<br>==&gt; Summary</p>
<h2 id="mac-的一些工具"><a href="#mac-的一些工具" class="headerlink" title="mac 的一些工具"></a>mac 的一些工具</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">//自己的环境变量</span><br><span class="line">curl -O https://raw.githubusercontent.com/donnemartin/dev-setup/master/.bash_profile</span><br><span class="line">// 一些颜色设置，并不好用（可选）</span><br><span class="line"><span class="comment"># curl -O https://raw.githubusercontent.com/donnemartin/dev-setup/master/.bash_prompt</span></span><br><span class="line">//unix的自定义别名</span><br><span class="line">curl -O https://raw.githubusercontent.com/donnemartin/dev-setup/master/.aliases</span><br></pre></td></tr></table></figure>
<p>一些工具替换产品</p>
<blockquote>
<ul>
<li>Terminal → <a href="https://www.iterm2.com/" target="_blank" rel="noopener">iTerm</a></li>
<li>Finder → <a href="http://totalfinder.binaryage.com/" target="_blank" rel="noopener">TotalFinder</a> / <a href="http://www.cocoatech.com/pathfinder/" target="_blank" rel="noopener">Path Finder</a></li>
<li>Spotlight → <a href="https://qsapp.com/" target="_blank" rel="noopener">QuickSilver</a> / <a href="https://www.alfredapp.com/" target="_blank" rel="noopener">Alfred</a></li>
</ul>
</blockquote>
<p><a href="https://github.com/0nn0/terminal-mac-cheatsheet" target="_blank" rel="noopener">Terminal cheatsheet</a></p>
<h2 id="xcode"><a href="#xcode" class="headerlink" title="xcode"></a>xcode</h2><p>xcode-select –install</p>
<h2 id="rvm"><a href="#rvm" class="headerlink" title="rvm"></a>rvm</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -sSL https://get.rvm.io | bash -s stable</span><br><span class="line">rvm install 2.3.1</span><br><span class="line">rvm use 2.3.1</span><br></pre></td></tr></table></figure>
<h2 id="nvm"><a href="#nvm" class="headerlink" title="nvm"></a>nvm</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install nvm</span><br><span class="line">nvm install 4</span><br><span class="line">nvm use 4</span><br></pre></td></tr></table></figure>
<h2 id="atom"><a href="#atom" class="headerlink" title="atom"></a>atom</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew cask install atom</span><br></pre></td></tr></table></figure>
<h2 id="mac自启动目录"><a href="#mac自启动目录" class="headerlink" title="mac自启动目录"></a>mac自启动目录</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~/Library/LaunchAgents</span><br></pre></td></tr></table></figure>
<h2 id="brew-使用方法"><a href="#brew-使用方法" class="headerlink" title="brew 使用方法"></a>brew 使用方法</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew update                        　　#更新brew可安装包，建议每次执行一下</span><br><span class="line">brew search php55                    #搜索php5.5</span><br><span class="line">brew tap josegonzalez/php        #安装扩展&lt;gihhub_user/repo&gt;   ,可以获得更多的资源</span><br><span class="line">brew tap                                  #查看安装的扩展列表</span><br><span class="line">brew install php55                    #安装php5.5</span><br><span class="line">brew remove  php55                 #卸载php5.5</span><br><span class="line">brew upgrade php55                 #升级php5.5</span><br><span class="line">brew options php55                  #查看php5.5安装选项</span><br><span class="line">brew info    php55                    #查看php5.5相关信息</span><br><span class="line">brew home    php55                  #访问php5.5官方网站</span><br><span class="line">brew services list                      #查看系统通过 brew 安装的服务</span><br><span class="line">brew services cleanup               #清除已卸载无用的启动配置文件</span><br><span class="line">brew services restart php55       #重启php-fpm</span><br></pre></td></tr></table></figure>
<h3 id="由于homebrew上面的东西-很多要么被墙-要么死慢-需要换brew源-分为两部分"><a href="#由于homebrew上面的东西-很多要么被墙-要么死慢-需要换brew源-分为两部分" class="headerlink" title="由于homebrew上面的东西 很多要么被墙,要么死慢,需要换brew源(分为两部分)"></a>由于homebrew上面的东西 很多要么被墙,要么死慢,需要换brew源(分为两部分)</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">替换homebrew默认源</span><br><span class="line">　　cd &quot;$(brew --repo)&quot; 　　//这个命令会进入到相应目录,可以pwd查看下</span><br><span class="line">　　cd &quot;$(brew --repo)&quot; git remote set-url origin git://mirrors.ustc.edu.cn/brew.git</span><br><span class="line">Homebrew Bottles源(二进制代码包)</span><br><span class="line">　　echo &apos;export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles&apos; &gt;&gt; ~/.bash_profile </span><br><span class="line">　　source ~/.bash_profile</span><br><span class="line">更新</span><br><span class="line">　　brew update</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>nodejs 基础</title>
    <url>/2015/11/14/nodejs/</url>
    <content><![CDATA[<p>Node.js 是单进程单线程应用程序，但是通过事件和回调支持并发，所以性能非常高。Node.js 的每一个 API 都是异步的，并作为一个独立线程运行，使用异步函数调用，并处理并发。Node.js 基本上所有的事件机制都是用设计模式中观察者模式实现。Node.js 单线程类似进入一个while(true)的事件循环，直到没有事件观察者退出，每个异步事件都生成一个事件观察者，如果有事件发生就调用该回调函数。<br><a id="more"></a></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#mac</span></span><br><span class="line">   brew install nvm</span><br><span class="line"><span class="comment">#linux</span></span><br><span class="line">   curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.29.0/install.sh | bash</span><br><span class="line"><span class="comment"># 查看远程版本</span></span><br><span class="line">   nvm ls-remote </span><br><span class="line">nvm install v7.1.0</span><br><span class="line">nvm use v7.1.0</span><br><span class="line"></span><br><span class="line">nvm list</span><br><span class="line"><span class="comment"># 注册一个cnpm</span></span><br><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br><span class="line"><span class="comment"># 切换源</span></span><br><span class="line">npm config get registry</span><br><span class="line">npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<h3 id="阻塞代码实例"><a href="#阻塞代码实例" class="headerlink" title="阻塞代码实例"></a>阻塞代码实例</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data = fs.readFileSync(<span class="string">'input.txt'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(data.toString());</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"程序执行结束!"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="非阻塞代码实例"><a href="#非阻塞代码实例" class="headerlink" title="非阻塞代码实例"></a>非阻塞代码实例</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"></span><br><span class="line">fs.readFile(<span class="string">'input.txt'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.error(err);</span><br><span class="line">    <span class="built_in">console</span>.log(data.toString());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"程序执行结束!"</span>);</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>观察者模式(observer pattern)</title>
    <url>/2015/09/22/observer-pattern/</url>
    <content><![CDATA[<p>观察者模式有时也被称<strong>作发布/订阅模式</strong>，该模式用于为对象实现发布/订阅功能：一旦<strong>主体对象</strong>状态发生改变，与之关联的<strong>观察者对象</strong>会收到通知，并进行相应操作。</p>
<p>将一个系统分割成一个一些类相互协作的类有一个不好的副作用，那就是需要维护相关对象间的一致性。我们不希望为了维持一致性而使各类紧密耦合，这样会给维护、扩展和重用都带来不便。观察者就是解决这类的耦合关系的。</p>
<p><strong>消息队列系统、事件</strong>都使用了观察者模式。</p>
<p>PHP 为观察者模式定义了两个接口：<code>SplSubject</code> 和 <code>SplObserver</code>。<code>SplSubject</code> 可以看做<strong>主体对象</strong>的抽象，<code>SplObserver</code> 可以看做<strong>观察者对象</strong>的抽象，要实现观察者模式，只需<strong>让主体对象实现 SplSubject</strong> ，<strong>观察者对象实现 SplObserver</strong>，并实现相应方法即可。</p>
<h2 id="示例1"><a href="#示例1" class="headerlink" title="示例1"></a>示例1</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//下面两个接口，在php已经有了，直接implements即可，</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IObserver</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onChanged</span><span class="params">( $sender, $args )</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IObservable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">addObserver</span><span class="params">( $observer )</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserList</span> <span class="keyword">implements</span> <span class="title">IObservable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_observers = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addCustomer</span><span class="params">( $name )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>( <span class="keyword">$this</span>-&gt;_observers <span class="keyword">as</span> $obs )</span><br><span class="line">            $obs-&gt;onChanged( <span class="keyword">$this</span>, $name );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addObserver</span><span class="params">( $observer )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_observers []= $observer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserListLogger</span> <span class="keyword">implements</span> <span class="title">IObserver</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onChanged</span><span class="params">( $sender, $args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>( <span class="string">"'$args' added to user list\n"</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ul = <span class="keyword">new</span> UserList();</span><br><span class="line">$ul-&gt;addObserver( <span class="keyword">new</span> UserListLogger());</span><br><span class="line">$ul-&gt;addCustomer( <span class="string">"Jack"</span> );</span><br></pre></td></tr></table></figure>
<h2 id="示例2"><a href="#示例2" class="headerlink" title="示例2"></a>示例2</h2><p>使用了php中的 SplSubject,SplObserver 主体对象和观察者对象类<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// User.php 被观察主体对象</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Observer</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 观察者模式 : 被观察对象 (主体对象)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 主体对象维护观察者列表并发送通知</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> \<span class="title">SplSubject</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * user data</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $data = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * observers</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \SplObjectStorage</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $observers;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;observers = <span class="keyword">new</span> \SplObjectStorage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 附加观察者</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \SplObserver $observer</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">attach</span><span class="params">(\SplObserver $observer)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;observers-&gt;attach($observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消观察者</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \SplObserver $observer</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detach</span><span class="params">(\SplObserver $observer)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;observers-&gt;detach($observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通知观察者方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">notify</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> \SplObserver $observer */</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;observers <span class="keyword">as</span> $observer) &#123;</span><br><span class="line">            $observer-&gt;update(<span class="keyword">$this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed  $value</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span><span class="params">($name, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[$name] = $value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知观察者用户被改变</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserObserver.php  // 观察者</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Observer</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UserObserver 类（观察者对象）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserObserver</span> <span class="keyword">implements</span> \<span class="title">SplObserver</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 观察者要实现的唯一方法</span></span><br><span class="line"><span class="comment">     * 也是被 Subject 调用的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \SplSubject $subject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(\SplSubject $subject)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> get_class($subject) . <span class="string">' has been updated'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Observer</span>\<span class="title">Tests</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Observer</span>\<span class="title">UserObserver</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Observer</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ObserverTest 测试观察者模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObserverTest</span> <span class="keyword">extends</span> \<span class="title">PHPUnit_Framework_TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $observer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;observer = <span class="keyword">new</span> UserObserver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testNotify</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;expectOutputString(<span class="string">'DesignPatterns\Behavioral\Observer\User has been updated'</span>);</span><br><span class="line">        $subject = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line">        $subject-&gt;attach(<span class="keyword">$this</span>-&gt;observer);</span><br><span class="line">        $subject-&gt;property = <span class="number">123</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试订阅</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testAttachDetach</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $subject = <span class="keyword">new</span> User();</span><br><span class="line">        $reflection = <span class="keyword">new</span> \ReflectionProperty($subject, <span class="string">'observers'</span>);</span><br><span class="line"></span><br><span class="line">        $reflection-&gt;setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> \SplObjectStorage $observers */</span></span><br><span class="line">        $observers = $reflection-&gt;getValue($subject);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertInstanceOf(<span class="string">'SplObjectStorage'</span>, $observers);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertFalse($observers-&gt;contains(<span class="keyword">$this</span>-&gt;observer));</span><br><span class="line"></span><br><span class="line">        $subject-&gt;attach(<span class="keyword">$this</span>-&gt;observer);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($observers-&gt;contains(<span class="keyword">$this</span>-&gt;observer));</span><br><span class="line"></span><br><span class="line">        $subject-&gt;detach(<span class="keyword">$this</span>-&gt;observer);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertFalse($observers-&gt;contains(<span class="keyword">$this</span>-&gt;observer));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试 update() 调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testUpdateCalling</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $subject = <span class="keyword">new</span> User();</span><br><span class="line">        $observer = <span class="keyword">$this</span>-&gt;getMock(<span class="string">'SplObserver'</span>);</span><br><span class="line">        $subject-&gt;attach($observer);</span><br><span class="line"></span><br><span class="line">        $observer-&gt;expects(<span class="keyword">$this</span>-&gt;once())</span><br><span class="line">            -&gt;method(<span class="string">'update'</span>)</span><br><span class="line">            -&gt;with($subject);</span><br><span class="line"></span><br><span class="line">        $subject-&gt;notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="官方demo"><a href="#官方demo" class="headerlink" title="官方demo"></a>官方demo</h2><p>使用了<code>SplObjectStorage</code> 这个对象，这个对象本身有attach ,detach 的方法，如果不用，可以参考第二个<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObserver1</span> <span class="keyword">implements</span> <span class="title">SplObserver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(SplSubject $subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span> . <span class="string">' - '</span> . $subject-&gt;getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObserver2</span> <span class="keyword">implements</span> <span class="title">SplObserver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(SplSubject $subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span> . <span class="string">' - '</span> . $subject-&gt;getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySubject</span> <span class="keyword">implements</span> <span class="title">SplSubject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_observers;</span><br><span class="line">    <span class="keyword">private</span> $_name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_observers = <span class="keyword">new</span> SplObjectStorage();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_name = $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">attach</span><span class="params">(SplObserver $observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_observers-&gt;attach($observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detach</span><span class="params">(SplObserver $observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_observers-&gt;detach($observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">notify</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_observers <span class="keyword">as</span> $observer) &#123;</span><br><span class="line">            $observer-&gt;update(<span class="keyword">$this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$observer1 = <span class="keyword">new</span> MyObserver1();</span><br><span class="line">$observer2 = <span class="keyword">new</span> MyObserver2();</span><br><span class="line"></span><br><span class="line">$subject = <span class="keyword">new</span> MySubject(<span class="string">"test"</span>);</span><br><span class="line"></span><br><span class="line">$subject-&gt;attach($observer1);</span><br><span class="line">$subject-&gt;attach($observer2);</span><br><span class="line">$subject-&gt;notify();</span><br></pre></td></tr></table></figure></p>
<h2 id="一个报纸和订阅者的例子，很像发布和订阅"><a href="#一个报纸和订阅者的例子，很像发布和订阅" class="headerlink" title="一个报纸和订阅者的例子，很像发布和订阅"></a>一个报纸和订阅者的例子，很像发布和订阅</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Subject,that who makes news</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Newspaper</span> <span class="keyword">implements</span> \<span class="title">SplSubject</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $name;</span><br><span class="line">    <span class="keyword">private</span> $observers = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> $content;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//add observer</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">attach</span><span class="params">(\SplObserver $observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;observers[] = $observer;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//remove observer</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detach</span><span class="params">(\SplObserver $observer)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        $key = array_search($observer,<span class="keyword">$this</span>-&gt;observers, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span>($key)&#123;</span><br><span class="line">            <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;observers[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//set breakouts news</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">breakOutNews</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = $content;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;notify();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;content.<span class="string">" (&#123;$this-&gt;name&#125;)"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//notify observers(or some of them)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">notify</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;observers <span class="keyword">as</span> $value) &#123;</span><br><span class="line">            $value-&gt;update(<span class="keyword">$this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Observer,that who recieves news</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reader</span> <span class="keyword">implements</span> <span class="title">SplObserver</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(\SplSubject $subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;name.<span class="string">' is reading breakout news &lt;b&gt;'</span>.$subject-&gt;getContent().<span class="string">'&lt;/b&gt;&lt;br&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$newspaper = <span class="keyword">new</span> Newspaper(<span class="string">'Newyork Times'</span>);</span><br><span class="line"></span><br><span class="line">$allen = <span class="keyword">new</span> Reader(<span class="string">'Allen'</span>);</span><br><span class="line">$jim = <span class="keyword">new</span> Reader(<span class="string">'Jim'</span>);</span><br><span class="line">$linda = <span class="keyword">new</span> Reader(<span class="string">'Linda'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//add reader</span></span><br><span class="line">$newspaper-&gt;attach($allen);</span><br><span class="line">$newspaper-&gt;attach($jim);</span><br><span class="line">$newspaper-&gt;attach($linda);</span><br><span class="line"></span><br><span class="line"><span class="comment">//remove reader</span></span><br><span class="line">$newspaper-&gt;detach($linda);</span><br><span class="line"></span><br><span class="line"><span class="comment">//set break outs</span></span><br><span class="line">$newspaper-&gt;breakOutNews(<span class="string">'USA break down!'</span>);</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>design pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>YC创业课笔记</title>
    <url>/2015/06/20/yc-create-note/</url>
    <content><![CDATA[<h1 id="成为有完整作品的人"><a href="#成为有完整作品的人" class="headerlink" title="成为有完整作品的人"></a>成为有完整作品的人</h1><p><code>成长的最靠谱起点是什么？Sam的这篇文章里有个很好的建议</code>：</p>
<blockquote>
<p>No matter what you choose, build stuff and be around smart people. “Stuff” can be a lot of different things。 Building stuffs—-做出东西来。</p>
</blockquote>
<p>我个人最看中人的这个特质。人群中只有少数人最终能拿出完整的作品—-人与人之间的差异是如此之大，乃至于少数人有作品，更少数人有好的作品，只极少数极少数人才可能作出传世的作品；而与此同时，绝大多数人（万分之九千九百九十九的人）一辈子都没有像样的作品，他们连一篇作文都写不明白。<br><a id="more"></a><br>从一开始就要想尽一切办法做出完整的作品来，哪怕最初的作品很差—-但必须完整。那些有完整作品的人，能力、耐力、学习能力都会超出他人许多倍。无论看起来多简单的作品，只要是完整的，其表面之下的复杂程度是那些没做出过东西的人全然无法想像的。</p>
<p>另外一个很自然的现象是，如果一个人能做出像样的东西来，那么他身边的聪明人密度无论如何都会比其他人的高出很多。</p>
<h1 id="伟大的公司的几个要素"><a href="#伟大的公司的几个要素" class="headerlink" title="伟大的公司的几个要素"></a>伟大的公司的几个要素</h1><ul>
<li>Great Idea （创见）</li>
<li>Great Product （产品）</li>
<li>Great Team （团队）</li>
<li>Great Execution （执行）</li>
</ul>
<p>前前后后需要考虑的东西：</p>
<blockquote>
<p>这是否是真实的需求？（或者说：是否是真真切切需要解决的问题？—-人们真的很擅长杜撰伪问题……） 市场是否足够大？（或者换个说法，跑道是否足够长？） 市场成长是否足够快？（一个”快”字可能会顺带解决很多很多问题……） 如果真的因为这个创见创业了，那么，公司成长的策略是什么？ 公司如何进行必要的防御？策略又是什么？</p>
</blockquote>
<p>当这些问题都需要认真回答，并且需要得到满意答复的时候，我们就会发现很多的”点子”其实不过是垃圾—-根本无法满足我们的追求。</p>
<h1 id="逻辑陷阱"><a href="#逻辑陷阱" class="headerlink" title="逻辑陷阱"></a>逻辑陷阱</h1><p>不是所有的事情都是非此即彼，</p>
<blockquote>
<p>反过来不一定成立吧？</p>
</blockquote>
<p>或者更简洁一点：</p>
<blockquote>
<p>不一定吧？</p>
</blockquote>
<p>然后花一点时间多想想有哪些可能的反例…… 许多年来，这种简单的思考让我避开了很多可能导致严重后果的陷阱。 我也会常常这样问自己：</p>
<blockquote>
<p>嗯，很有道理…… 不过，需要看情况吧？在什么情况下这个对，而在什么情况下这个并不见得对，甚至干脆是错的呢？ 嗯，那些时不时自言自语的不全都是精神病患者。</p>
</blockquote>
<h1 id="从自己的问题入手，一个好的行为模式"><a href="#从自己的问题入手，一个好的行为模式" class="headerlink" title="从自己的问题入手，一个好的行为模式"></a>从自己的问题入手，一个好的行为模式</h1><ul>
<li>目的</li>
<li>手段</li>
<li><p>结果</p>
</li>
<li><p>我们的目的是：避免最终做出一个实际上没人真用的东西……</p>
</li>
<li><p>我们的手段是：”先从解决自己的问题开始”。</p>
</li>
<li>我们采取这个手段的结果是：如果我自己就有这个需求，那么它一定是真实的需求；而后，也一定会有其他人也有这个需求…… 继而问自己这个问题要足够重要、解决方案要足够有效、市场要足够大、成长空间要足够广阔……</li>
</ul>
<p>不过，”先从解决自己的需求/问题开始”有更值得一提的众多好处：</p>
<blockquote>
<p>因为是自己的问题，我们会对解决它有更多的热情和耐心 因为是自己的问题，我们会对解决方案有更精准的判断标准 因为是自己的问题，我们更容易体会到解决它的成就感，甚至产生使命感—-这多么求之难得的东西！</p>
</blockquote>
<h1 id="转换焦点看问题，避免单一"><a href="#转换焦点看问题，避免单一" class="headerlink" title="转换焦点看问题，避免单一"></a>转换焦点看问题，避免单一</h1><blockquote>
<p>fall in love with the problem, not the solution. 爱上问题和麻烦，而不是去解决（转换态度）</p>
</blockquote>
<blockquote>
<p>It is your job to listen to their problems, and translate those into what is going to build the best and simplest solution for them… 于是，有人能做到”不是用户要什么就给什么”，原因在于关注焦点并不在于问题本身，而是想尽一切办法找到那需求的根源—-即，关注焦点在于更本质的、更深层次的原因，而后给出最好、最简的解决方式。</p>
</blockquote>
<p>当我有足够的时间思考之时，我常常这样玩：</p>
<blockquote>
<p><strong>目的、手段、结果</strong>：我现在这样想，可能是因为我更关注结果，如果我更关注手段，那我会想什么呢？…… <strong>过去、现在、将来</strong>：我现在这么想，可能是因为我想未来更多一些，要是我更关注现在，那我会想什么呢？ <strong>优点、缺点</strong>：我刚才想这事儿的时候，我关注它的缺点更多一些，；那我要是关注优点更多一些，会想什么呢？</p>
</blockquote>
<h1 id="如何让自己变得更聪明？"><a href="#如何让自己变得更聪明？" class="headerlink" title="如何让自己变得更聪明？"></a>如何让自己变得更聪明？</h1><p>如何判断一个人是否聪明？</p>
<ol>
<li>此人是否拥有足够多且清晰准确的概念？</li>
<li>对这些概念之间的联系是否足够清晰准确？</li>
<li>是否有足够系统的方法论？</li>
<li>是否有一定的成功经验？</li>
</ol>
<p>必要、清晰、且准确的概念，是一切思考的基石。 如何有效的思考，那些常常审视自己思考质量的人，都会很认真地定义自己所使用的概念：(科学方法论)</p>
<h2 id="应该形成的思考方式"><a href="#应该形成的思考方式" class="headerlink" title="应该形成的思考方式"></a>应该形成的思考方式</h2><blockquote>
<p>这个概念有必要存在吗？ 它指的究竟是什么？ 反过来，它所指的究竟不是什么？ 它与什么类似？但有什么不同？ 使用它的时候要注意什么？ 用错的时候可能产生什么样的后果？</p>
</blockquote>
<p>那些<strong>有作品的人</strong>，就是”成功人士”，他们已经做出像样的东西，”成功”的程度不一样而已，而他们的成长速度一定很快、更快。更为重要的是，要看这些人的多个作品—-作品与作品之间的差异，基本上就是他们进步程度的展现。 另外一个判断方式是看他有无长期持续做的事情，然后去看他做得如何。懂得<strong>长期持续做事</strong>的人，通常不笨，也通常没办法做不好那件事儿。 谁比谁的智商差多少，只不过聪明的人有一套自己的方法论，他们知道如何快速习得，快速迭代的而已。</p>
<h1 id="如何寻找合伙人？"><a href="#如何寻找合伙人？" class="headerlink" title="如何寻找合伙人？"></a>如何寻找合伙人？</h1><ul>
<li>我了解这个人吗？</li>
<li>他的优点、缺点都是什么？</li>
<li>他信任你吗？有多信任？反过来呢？</li>
<li>他出了任何问题，你都愿意帮助他吗？反过来呢？</li>
<li>未来的若干年中，你们能做到荣辱与共吗？</li>
</ul>
<p>合伙人的最重要素质是什么？ 答案其实与选择婚姻伴侣一样：找到勇于主动承担责任的人，并且双方（或多方）都必须是肯于承担责任的人。哦，对了，勇于承担责任的人有个共同的特征，出了问题的时候，他们会先在自己身上找问题。</p>
<h1 id="直觉靠谱吗？-intuitive-counter-intuitive"><a href="#直觉靠谱吗？-intuitive-counter-intuitive" class="headerlink" title="直觉靠谱吗？(intuitive,counter-intuitive)"></a>直觉靠谱吗？(intuitive,counter-intuitive)</h1><p>直觉虽然显现为瞬间不假思索的判断，但它不是没有来历的，它实际上是经验、训练和知识的长期积累瞬间内共同发挥作用的结果，而不是无理由的猜测。 随着经验的增加，训练的辅助，知识的积累，所谓的”直觉”也在不断发展,如此看来，人与人之间的直觉质量常常有着天壤之别。</p>
<ol>
<li>如果你在某个领域是真正的专家—-只有名头没有真知”砖家”的不算数，在那个领域里，你不仅要相信你的直觉，还要刻意打磨你的直觉—-通过持续的观察、思考、训练和自我成长。</li>
<li><p>如果你不是那个领域里真的专家，你的直觉就是个屁。</p>
<blockquote>
<p>Sam是在回答”如何寻找现在以及将来10年里成长最快的市场”时说：这个时候，年轻人应该相信你的直觉。Sam的这个回答固然有些含混，但也确实至少部分正确，因为正在”感受并发现飞速成长的东西”确实是年轻人比老年人更有经验的领域。</p>
</blockquote>
</li>
</ol>
<h1 id="如何精通自己的用户"><a href="#如何精通自己的用户" class="headerlink" title="如何精通自己的用户?"></a>如何精通自己的用户?</h1><ul>
<li>想尽一切办法亲自去找用户—-而不是采用程序员喜欢的自动的方式；</li>
<li>做更深入的，能够获得用户真实答案的调查</li>
<li>关注各种各样的进阶指标，DAU、Retention之类……</li>
</ul>
<p>我的一个项目合伙人（他做出来的产品不用任何PR都可以初期每天增长几万用户）曾经跟我分享他的方法论：</p>
<blockquote>
<p>我就想，如果我做出来之后，放在那里，会不会有陌生人主动来用？会不会有很多陌生人来用？他们会不会把这个东西推荐给身边的人？</p>
</blockquote>
<p>还有一个普适的方法论：无论做什么，都可以再问一遍：”<strong>更本质的是什么</strong>？”</p>
<blockquote>
<p>如果用户有这么个需求，那么更本质的原因是什么？ 于是，就有了很多这样的思考： 用户要什么就给什么是不对的，因为大多数用户不可能对你的产品有全面深入长期的打算。 一切能够满足人性弱点的产品都是令用户热爱的。比如，如果你能让用户再懒一点再懒一点，那他们就会爱你多一些再多一些。</p>
</blockquote>
<p>关于精通用户的方法论，还可以再推荐出自斯坦福教授Nir Eyal的一本书：(Hooked: How to Build Habit-Forming Products。)[<a href="https://www.amazon.com/Hooked-How-Build-Habit-Forming-Products-ebook/dp/B00HJ4A43S?ie=UTF8&amp;*Version*=1&amp;*entries*=0" target="_blank" rel="noopener">https://www.amazon.com/Hooked-How-Build-Habit-Forming-Products-ebook/dp/B00HJ4A43S?ie=UTF8&amp;*Version*=1&amp;*entries*=0</a>]</p>
<h1 id="不停得学习，学习无终点"><a href="#不停得学习，学习无终点" class="headerlink" title="不停得学习，学习无终点"></a>不停得学习，学习无终点</h1><ul>
<li>学很多值得学的东西</li>
<li>仔细琢磨你感兴趣的日常生活中的痛点(正如自己总会莫名的焦虑，对未来没有信心等)</li>
<li>多与牛人在一起（这是怎样找到合伙人的诀窍）</li>
</ul>
<h1 id="认真、仔细、不怕麻烦"><a href="#认真、仔细、不怕麻烦" class="headerlink" title="认真、仔细、不怕麻烦"></a>认真、仔细、不怕麻烦</h1><ol>
<li>直接应聘去清洁公司上班，买各种可以买得到的书去看，有培训班就马上去参加……</li>
<li>研究一切可以找得到的关于这个领域内其它公司的资料，把搜索引擎上可以找的资料前1000条全都读一遍……要是上市公司的话，就直接去查找S1文件……</li>
<li>公司还小的时候，不可能像Facebook一样有个Growth Team，那么就靠自己来，一切都手动，不要自动—-因为自动会有遗漏，且有可能浮于表面……</li>
<li>公司大了，有钱了，也不是直接烧钱打网络广告，而是罗列一切可能的渠道，而后一个一个地尝试。一次只试验一个渠道，失败了，就退回分支，去尝试另外一个选择—-直至遍历所有可能性……</li>
</ol>
<p>我见过很多团队，他们东施效颦地信奉一些教条：</p>
<blockquote>
<p>我们是一个有信仰的团队。 我们坚信这个方向是绝对没有问题的。 我们只是需要坚持、坚持、再坚持……</p>
</blockquote>
<p>什么时候应该转型？没有标准答案,什么时候应该继续坚持？没有标准答案。 有一点倒是可以值得参考，就是成长速度快不快？不快，那就要小心了。</p>
<h1 id="优秀的人需要怎样的激励"><a href="#优秀的人需要怎样的激励" class="headerlink" title="优秀的人需要怎样的激励"></a>优秀的人需要怎样的激励</h1><ul>
<li>autonomy 自治</li>
<li>mastery 精通</li>
<li>purpose 追求</li>
</ul>
<h1 id="不是每个人都适合创业的"><a href="#不是每个人都适合创业的" class="headerlink" title="不是每个人都适合创业的"></a>不是每个人都适合创业的</h1><p>Sam在第一课里说，创业是一个非常机会均匀的领域：</p>
<blockquote>
<p>One of the exciting things about startups is that they are a surprisingly even playing field. Young and inexperienced, you can do this. Old and experienced, you can do this, too. 但也有需要注意的情况。在创业这件事儿上，年轻人更有优势。其他的不说，面对失败的能力，还是年轻人更强，他们更输的起—-因为对他们来说，这本来就是常态。除此之外，年轻人常常有更大的野心，他们有更多的持续战斗力。</p>
</blockquote>
<h1 id="复杂的模式思考常常难以表达清楚"><a href="#复杂的模式思考常常难以表达清楚" class="headerlink" title="复杂的模式思考常常难以表达清楚"></a>复杂的模式思考常常难以表达清楚</h1><ul>
<li>capturing value</li>
<li>lies people tell</li>
<li>how to build a monopoly</li>
<li>last mover advantage</li>
<li>history of innovation</li>
<li>psychology of competition</li>
</ul>
<p>一个观察：21世纪开始，有大量的公司把各种单独不能赚钱的技术整合起来，形成了垄断优势。 三个策略（顺序不分前后）： 从垄断一个小的，甚至没人认为值得垄断的市场开始 比老二好十倍（From Zero to One里有详述） 善用后发优势</p>
<p>这一点我个人比较容易理解：那些思维复杂且缜密的人，往往最终会拥有一个与绝大多数人不可能相同的价值判断（或者模式）体系。而他们的每一个结论，常常要么显得平淡无奇，要么显得荒诞不经。当他们必须向他人—-即，那些头脑比他们简单单得多的人—-传递思考结果的时候，是很困难的，因为他们的每句话都可能实际上与显现的并不完全相同，也总是被各种误解。而又为了传递清楚，他们常常不得不从许多个角度去阐释一个问题，可这其实又给头脑简单的人增加了一个困难：把一件事儿理解成许多件事儿……</p>
<p><strong>他擅长用模式思考能力去识别他人有意无意的谎言</strong></p>
<p>(YC 创业课)[<a href="http://zhibimo.com/read/xiaolai/growth/competition-is-for-losers.html" target="_blank" rel="noopener">http://zhibimo.com/read/xiaolai/growth/competition-is-for-losers.html</a>]</p>
]]></content>
      <tags>
        <tag>创业</tag>
        <tag>读书</tag>
      </tags>
  </entry>
  <entry>
    <title>awk</title>
    <url>/2017/01/25/awk/</url>
    <content><![CDATA[<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">'&#123;pattern + action&#125;'</span> &#123;filenames&#125;</span><br><span class="line"></span><br><span class="line">变量名	含义 </span><br><span class="line">ARGC	命令行变元个数 </span><br><span class="line">ARGV	命令行变元数组 </span><br><span class="line">FILENAME	当前输入文件名 </span><br><span class="line">FNR	当前文件中的记录号 </span><br><span class="line">FS	输入域分隔符，默认为一个空格 </span><br><span class="line">RS	输入记录分隔符 </span><br><span class="line">NF	当前记录里域个数 </span><br><span class="line">NR	到目前为止记录数 </span><br><span class="line">OFS	输出域分隔符 </span><br><span class="line">ORS	输出记录分隔符</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="调用awk"><a href="#调用awk" class="headerlink" title="调用awk"></a>调用awk</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">1、awk <span class="string">'/101/'</span>               file 显示文件file中包含101的匹配行。 </span><br><span class="line">   awk <span class="string">'/101/,/105/'</span>         file </span><br><span class="line">   awk <span class="string">'$1 == 5'</span>             file </span><br><span class="line">   awk <span class="string">'$1 == "CT"'</span>          file 注意必须带双引号 </span><br><span class="line">   awk <span class="string">'$1 * $2 &gt;100 '</span>       file  </span><br><span class="line">   awk <span class="string">'$2 &gt;5 &amp;&amp; $2&lt;=15'</span>     file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2、awk <span class="string">'&#123;print NR,NF,$1,$NF,&#125;'</span> file 显示文件file的当前记录号、域数和每一行的第一个和最后一个域。 </span><br><span class="line">   awk <span class="string">'/101/ &#123;print $1,$2 + 10&#125;'</span> file 显示文件file的匹配行的第一、二个域加10。 </span><br><span class="line">   awk <span class="string">'/101/ &#123;print $1$2&#125;'</span>  file </span><br><span class="line">   awk <span class="string">'/101/ &#123;print $1 $2&#125;'</span> file 显示文件file的匹配行的第一、二个域，但显示时域中间没有分隔符。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3、df | awk <span class="string">'$4&gt;1000000 '</span>         通过管道符获得输入，如：显示第4个域满足条件的行。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4、awk -F <span class="string">"|"</span> <span class="string">'&#123;print $1&#125;'</span>   file 按照新的分隔符“|”进行操作。 </span><br><span class="line">   awk  <span class="string">'BEGIN &#123; FS="[: \t|]" &#125; </span></span><br><span class="line"><span class="string">   &#123;print $1,$2,$3&#125;'</span> 	     file 通过设置输入分隔符（FS=<span class="string">"[: \t|]"</span>）修改输入分隔符。 </span><br><span class="line"></span><br><span class="line">   Sep=<span class="string">"|"</span> </span><br><span class="line">   awk -F <span class="variable">$Sep</span> <span class="string">'&#123;print $1&#125;'</span>  file 按照环境变量Sep的值做为分隔符。    </span><br><span class="line">   awk -F <span class="string">'[ :\t|]'</span> <span class="string">'&#123;print $1&#125;'</span> file 按照正则表达式的值做为分隔符，这里代表空格、:、TAB、|同时做为分隔符。 </span><br><span class="line">   awk -F <span class="string">'[][]'</span>    <span class="string">'&#123;print $1&#125;'</span> file 按照正则表达式的值做为分隔符，这里代表[、]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5、awk -f awkfile 	     file 通过文件awkfile的内容依次进行控制。 </span><br><span class="line">   cat awkfile </span><br><span class="line">/101/&#123;<span class="built_in">print</span> <span class="string">"\047 Hello! \047"</span>&#125; --遇到匹配行以后打印 <span class="string">' Hello! '</span>.\047代表单引号。 </span><br><span class="line">&#123;<span class="built_in">print</span> <span class="variable">$1</span>,<span class="variable">$2</span>&#125;                   --因为没有模式控制，打印每一行的前两个域。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6、awk <span class="string">'$1 ~ /101/ &#123;print $1&#125;'</span> file 显示文件中第一个域匹配101的行（记录）。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7、awk   <span class="string">'BEGIN &#123; OFS="%"&#125; </span></span><br><span class="line"><span class="string">   &#123;print $1,$2&#125;'</span>           file 通过设置输出分隔符（OFS=<span class="string">"%"</span>）修改输出格式。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">8、awk   <span class="string">'BEGIN &#123; max=100 ;print "max=" max&#125;             BEGIN 表示在处理任意行之前进行的操作。 </span></span><br><span class="line"><span class="string">   &#123;max=($1 &gt;max ?$1:max); print $1,"Now max is "max&#125;'</span> file 取得文件第一个域的最大值。 </span><br><span class="line">   （表达式1?表达式2:表达式3 相当于： </span><br><span class="line">   <span class="keyword">if</span> (表达式1) </span><br><span class="line">       表达式2 </span><br><span class="line">   <span class="keyword">else</span> </span><br><span class="line">       表达式3 </span><br><span class="line">   awk <span class="string">'&#123;print ($1&gt;4 ? "high "$1: "low "$1)&#125;'</span> file </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">9、awk <span class="string">'$1 * $2 &gt;100 &#123;print $1&#125;'</span> file 显示文件中第一个域匹配101的行（记录）。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">10、awk <span class="string">'&#123;$1 == '</span>Chi<span class="string">' &#123;$3 = '</span>China<span class="string">'; print&#125;'</span> file 找到匹配行后先将第3个域替换后再显示该行（记录）。 </span><br><span class="line">    awk <span class="string">'&#123;$7 %= 3; print $7&#125;'</span>  file 将第7域被3除，并将余数赋给第7域再打印。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">11、awk <span class="string">'/tom/ &#123;wage=$2+$3; printf wage&#125;'</span> file 找到匹配行后为变量wage赋值并打印该变量。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">12、awk <span class="string">'/tom/ &#123;count++;&#125;  </span></span><br><span class="line"><span class="string">         END &#123;print "tom was found "count" times"&#125;'</span> file END表示在所有输入行处理完后进行处理。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">13、awk <span class="string">'gsub(/\$/,"");gsub(/,/,""); cost+=$4; </span></span><br><span class="line"><span class="string">         END &#123;print "The total is $" cost&gt;"filename"&#125;'</span>    file gsub函数用空串替换$和,再将结果输出到filename中。 </span><br><span class="line">    1 2 3 <span class="variable">$1</span>,200.00 </span><br><span class="line">    1 2 3 <span class="variable">$2</span>,300.00 </span><br><span class="line">    1 2 3 <span class="variable">$4</span>,000.00 </span><br><span class="line"></span><br><span class="line">    awk <span class="string">'&#123;gsub(/\$/,"");gsub(/,/,""); </span></span><br><span class="line"><span class="string">    if ($4&gt;1000&amp;&amp;$4&lt;2000) c1+=$4; </span></span><br><span class="line"><span class="string">    else if ($4&gt;2000&amp;&amp;$4&lt;3000) c2+=$4; </span></span><br><span class="line"><span class="string">    else if ($4&gt;3000&amp;&amp;$4&lt;4000) c3+=$4; </span></span><br><span class="line"><span class="string">    else c4+=$4; &#125; </span></span><br><span class="line"><span class="string">    END &#123;printf  "c1=[%d];c2=[%d];c3=[%d];c4=[%d]\n",c1,c2,c3,c4&#125;"'</span> file </span><br><span class="line">    通过<span class="keyword">if</span>和<span class="keyword">else</span> <span class="keyword">if</span>完成条件语句 </span><br><span class="line"></span><br><span class="line">    awk <span class="string">'&#123;gsub(/\$/,"");gsub(/,/,""); </span></span><br><span class="line"><span class="string">    if ($4&gt;3000&amp;&amp;$4&lt;4000) exit; </span></span><br><span class="line"><span class="string">    else c4+=$4; &#125; </span></span><br><span class="line"><span class="string">    END &#123;printf  "c1=[%d];c2=[%d];c3=[%d];c4=[%d]\n",c1,c2,c3,c4&#125;"'</span> file </span><br><span class="line">    通过<span class="built_in">exit</span>在某条件时退出，但是仍执行END操作。 </span><br><span class="line">    awk <span class="string">'&#123;gsub(/\$/,"");gsub(/,/,""); </span></span><br><span class="line"><span class="string">    if ($4&gt;3000) next; </span></span><br><span class="line"><span class="string">    else c4+=$4; &#125; </span></span><br><span class="line"><span class="string">    END &#123;printf  "c4=[%d]\n",c4&#125;"'</span> file </span><br><span class="line">    通过next在某条件时跳过该行，对下一行执行操作。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">14、awk <span class="string">'&#123; print FILENAME,$0 &#125;'</span> file1 file2 file3&gt;fileall 把file1、file2、file3的文件内容全部写到fileall中，格式为 </span><br><span class="line">    打印文件并前置文件名。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">15、awk <span class="string">' $1!=previous &#123; close(previous); previous=$1 &#125;    </span></span><br><span class="line"><span class="string">    &#123;print substr($0,index($0," ") +1)&gt;$1&#125;'</span> fileall 把合并后的文件重新分拆为3个文件。并与原文件一致。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">16、awk <span class="string">'BEGIN &#123;"date"|getline d; print d&#125;'</span>         通过管道把date的执行结果送给getline，并赋给变量d，然后打印。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">17、awk <span class="string">'BEGIN &#123;system("echo \"Input your name:\\c\""); getline d;print "\nYour name is",d,"\b!\n"&#125;'</span> </span><br><span class="line">    通过getline命令交互输入name，并显示出来。 </span><br><span class="line">    awk <span class="string">'BEGIN &#123;FS=":"; while(getline&lt; "/etc/passwd" &gt;0) &#123; if($1~"050[0-9]_") print $1&#125;&#125;'</span> </span><br><span class="line">    打印/etc/passwd文件中用户名包含050x_的用户名。 </span><br><span class="line"></span><br><span class="line">18、awk <span class="string">'&#123; i=1;while(i&lt;NF) &#123;print NF,$i;i++&#125;&#125;'</span> file 通过<span class="keyword">while</span>语句实现循环。 </span><br><span class="line">    awk <span class="string">'&#123; for(i=1;i&lt;NF;i++) &#123;print NF,$i&#125;&#125;'</span>   file 通过<span class="keyword">for</span>语句实现循环。     </span><br><span class="line">    <span class="built_in">type</span> file|awk -F <span class="string">"/"</span> <span class="string">' </span></span><br><span class="line"><span class="string">    &#123; for(i=1;i&lt;NF;i++) </span></span><br><span class="line"><span class="string">    &#123; if(i==NF-1) &#123; printf "%s",$i &#125; </span></span><br><span class="line"><span class="string">    else &#123; printf "%s/",$i &#125; &#125;&#125;'</span>               显示一个文件的全路径。 </span><br><span class="line">    用<span class="keyword">for</span>和<span class="keyword">if</span>显示日期 </span><br><span class="line">    awk  <span class="string">'BEGIN &#123; </span></span><br><span class="line"><span class="string">for(j=1;j&lt;=12;j++) </span></span><br><span class="line"><span class="string">&#123; flag=0; </span></span><br><span class="line"><span class="string">  printf "\n%d月份\n",j; </span></span><br><span class="line"><span class="string">        for(i=1;i&lt;=31;i++) </span></span><br><span class="line"><span class="string">        &#123; </span></span><br><span class="line"><span class="string">        if (j==2&amp;&amp;i&gt;28) flag=1; </span></span><br><span class="line"><span class="string">        if ((j==4||j==6||j==9||j==11)&amp;&amp;i&gt;30) flag=1; </span></span><br><span class="line"><span class="string">        if (flag==0) &#123;printf "%02d%02d ",j,i&#125; </span></span><br><span class="line"><span class="string">        &#125; </span></span><br><span class="line"><span class="string">&#125; </span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">19、在awk中调用系统变量必须用单引号，如果是双引号，则表示字符串 </span><br><span class="line">Flag=abcd </span><br><span class="line">awk <span class="string">'&#123;print '</span><span class="variable">$Flag</span><span class="string">'&#125;'</span>   结果为abcd </span><br><span class="line">awk <span class="string">'&#123;print  "$Flag"&#125;'</span>   结果为<span class="variable">$Flag</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对a.txt文件的第四个域进行求和！</span></span><br><span class="line">awk <span class="string">'BEGIN&#123;total=0&#125;&#123;total+=$4&#125;END&#123;print total&#125;'</span> a.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印所有以模式no或so开头的行。</span></span><br><span class="line">awk <span class="string">'/^(no|so)/'</span> <span class="built_in">test</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果记录以n或s开头，就打印这个记录。</span></span><br><span class="line">awk <span class="string">'/^[ns]/&#123;print $1&#125;'</span> <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果第一个域以两个数字结束就打印这个记录。</span></span><br><span class="line">awk <span class="string">'$1 ~/[0-9][0-9]$/(print $1&#125;'</span> <span class="built_in">test</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果第一个或等于100或者第二个域小于50，则打印该行。</span></span><br><span class="line">awk <span class="string">'$1 == 100 || $2 &lt; 50'</span> <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果第一个域不等于10就打印该行。</span></span><br><span class="line">awk <span class="string">'$1 != 10'</span> <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果记录包含正则表达式test，则第一个域加10并打印出来。</span></span><br><span class="line">awk <span class="string">'/test/&#123;print $1 + 10&#125;'</span> <span class="built_in">test</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#如果第一个域大于5则打印问号后面的表达式值，否则打印冒号后面的表达式值。</span></span><br><span class="line">awk <span class="string">'&#123;print ($1 &gt; 5 ? "ok "$1: "error"$1)&#125;'</span> <span class="built_in">test</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#打印以正则表达式root开头的记录到以正则表达式mysql开头的记录范围内的所有记录。如果找到一个新的正则表达式root开头的记 录，则继续打印直到下一个以正则表达式mysql开头的记录为止，或到文件末尾。</span></span><br><span class="line">awk <span class="string">'/^root/,/^mysql/'</span> <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 一个示例</span><br><span class="line">set -e</span><br><span class="line">login=&quot;-h192.168.1.70 -P3306 -uroot -proot&quot;</span><br><span class="line">#读数据</span><br><span class="line">databases=$(mysql $&#123;login&#125; -N -e &quot;show databases like &apos;pre_%&apos;;&quot;)</span><br><span class="line">if [ -e datasAll.txt ]; then</span><br><span class="line">    cat /dev/null &gt;datasAll.txt</span><br><span class="line">fi</span><br><span class="line">for i in $&#123;databases&#125;</span><br><span class="line">do</span><br><span class="line">    echo $&#123;i&#125; &gt;&gt;log.txt</span><br><span class="line">    tables=$(mysql $&#123;login&#125; -N -e &quot;use $&#123;i&#125;; show tables;&quot;)</span><br><span class="line">    for j in $&#123;tables&#125;</span><br><span class="line">    do</span><br><span class="line">        mysql $&#123;login&#125; -N --default-character-set=utf8 -e &quot;use $&#123;i&#125;; select uid, income, spend, create_at from $&#123;j&#125;&quot; &gt;&gt;datasAll.txt</span><br><span class="line">    done</span><br><span class="line">done</span><br><span class="line">#统计数据</span><br><span class="line">echo &apos;--&gt;step 1&apos; &gt;&gt;log.txt</span><br><span class="line">grep &quot;2014-&quot; datasAll.txt &gt;datas2014.txt</span><br><span class="line">echo &apos;--&gt;step 2&apos; &gt;&gt;log.txt</span><br><span class="line">awk &apos;BEGIN&#123;FS=&quot;\t&quot;;OFS=&quot;\t&quot;;&#125;&#123;income[$1]+=$2;outlays[$1]+=$3;&#125;END&#123;for(key in income)&#123;print key,income[key],outlays[key] &gt;&quot;sumAll.txt&quot;&#125;&#125;&apos; datasAll.txt</span><br><span class="line">echo &apos;--&gt;step 3&apos; &gt;&gt;log.txt</span><br><span class="line">awk &apos;BEGIN&#123;FS=&quot;\t&quot;;OFS=&quot;\t&quot;;&#125;&#123;income[$1]+=$2;outlays[$1]+=$3;&#125;END&#123;for(key in income)&#123;print key,income[key],outlays[key] &gt;&quot;sum2014.txt&quot;&#125;&#125;&apos; datas2014.txt</span><br><span class="line">echo &apos;--&gt;step 4&apos; &gt;&gt;log.txt</span><br><span class="line">awk &apos;BEGIN&#123;FS=&quot;\t&quot;;OFS=&quot;\t&quot;;&#125;&#123;if(NR==FNR)&#123;uid[$1]=$2&#125;else if(NR&gt;FNR)&#123;if($1 in uid)&#123;margin=uid[$1]+$3;if(margin&gt;0)&#123;print $1,$2+$3-margin,margin &gt;&quot;baseDatas.txt&quot;&#125;&#125;&#125;&#125;&apos; sum2014.txt sumAll.txt</span><br><span class="line"></span><br><span class="line">#清理数据</span><br><span class="line">echo &apos;--&gt;step 6&apos; &gt;&gt;log.txt</span><br><span class="line">rm -f datasAll.txt sumAll.txt datas2014.txt sum2014.txt log.txt</span><br><span class="line">#baseDatas.txt : 用户ID | 更新后摇豆总结余 | 2014年摇豆总结余 </span><br><span class="line"></span><br><span class="line">echo &apos;--&gt;OVER&apos; &gt;&gt;log.txt</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>门面模式(singleton pattern)</title>
    <url>/2015/09/23/singleton-pattern/</url>
    <content><![CDATA[<ul>
<li>必须拥有一个访问级别为 <code>private</code> 的构造函数，有效防止类被随意实例化； </li>
<li>必须拥有一个保存类的实例的静态变量； </li>
<li>必须拥有一个访问这个实例的公共的静态方法，该方法通常被命名为 getInstance()； </li>
<li>必须拥有一个私有的空的__clone方法，防止实例被克隆复制</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement __clone() method.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>::$instance <span class="keyword">instanceof</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>::$instance = <span class="keyword">new</span> <span class="keyword">self</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setName</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHi</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"hi"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用demo</span></span><br><span class="line"></span><br><span class="line">$single = Singleton::getInstance();</span><br><span class="line"><span class="comment">//$c_single= clone  $single;</span></span><br><span class="line">$single-&gt;setName(<span class="string">"TOM"</span>);</span><br><span class="line"><span class="keyword">echo</span> $single-&gt;getName();</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>design pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>javascript立即执行函数</title>
    <url>/2017/01/25/js-now-exec-func/</url>
    <content><![CDATA[<h3 id="立即执行函数"><a href="#立即执行函数" class="headerlink" title="立即执行函数"></a>立即执行函数</h3><p>立即执行函数：函数在定义后立即被执行，有特定的书写模式。例如：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="number">123</span>);</span><br><span class="line">&#125;)&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p>或者<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="number">123</span>);</span><br><span class="line">&#125;())</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>这种模式本质上就是函数表达式(命名的或者匿名的)，在创建后立即执行；立即执行函数并不是标准的叫法，是自我理解的叫法。</p>
</blockquote>
<p>错误的写法<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="number">123</span>);</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure></p>
<p>原因：在一个表达式后面加上括号()，该表达式会立即执行，但是在一个语句后面加上括号()，是完全不一样的意思，他的只是分组操作符。</p>
<p>要解决上述问题，非常简单，我们只需要用大括弧将代码的代码全部括住就行了，因为JavaScript里括弧()里面不能包含语句，所以在这一点上，解析器在解析function关键字的时候，会将相应的代码解析成function表达式，而不是function声明。</p>
<p>所以立即执行函数需要有一个（）！！！！</p>
<h3 id="也常常应用于局部作用域或者只执行一次的的场景"><a href="#也常常应用于局部作用域或者只执行一次的的场景" class="headerlink" title="也常常应用于局部作用域或者只执行一次的的场景"></a>也常常应用于局部作用域或者只执行一次的的场景</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">var</span> days = [<span class="string">'Sun'</span>, <span class="string">'Mon'</span>, <span class="string">'Tue'</span>, <span class="string">'Wed'</span>, <span class="string">'Thu'</span>, <span class="string">'Fri'</span>, <span class="string">'Sat'</span>], </span><br><span class="line">    today = <span class="keyword">new</span> <span class="built_in">Date</span>(), </span><br><span class="line">    msg = <span class="string">'Today is '</span> + days[today.getDay()] + <span class="string">', '</span> + today.getDate(); </span><br><span class="line">    alert(msg); </span><br><span class="line">&#125; ());</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果代码没有被包裹在立即执行函数中，那么局部变量days，today和msg都将成为全局变量，初始化代码的遗留产物。</p>
</blockquote>
<h3 id="立即执行函数的参数"><a href="#立即执行函数的参数" class="headerlink" title="立即执行函数的参数"></a>立即执行函数的参数</h3><p>传递参数方式如下：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">global</span>) </span>&#123; </span><br><span class="line">	<span class="comment">// access the global object via `global` </span></span><br><span class="line">&#125;(<span class="keyword">this</span>));</span><br></pre></td></tr></table></figure></p>
<p>例子：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">who, when</span>) </span>&#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"I met "</span> + who + <span class="string">" on "</span> + when); </span><br><span class="line">&#125; (<span class="string">"Joe Black"</span>, <span class="keyword">new</span> <span class="built_in">Date</span>()));</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通常，全局变量被作为一个参数传递给立即执行参数，这样它在函数内部不使用window也可以被访问到：这种方式可以让代码在环境(除了浏览器)中更加通用：</p>
</blockquote>
<h3 id="立即执行函数的返回值"><a href="#立即执行函数的返回值" class="headerlink" title="立即执行函数的返回值"></a>立即执行函数的返回值</h3><p>例子：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> result = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> + <span class="number">2</span>; </span><br><span class="line">&#125;());</span><br></pre></td></tr></table></figure></p>
<p>例子2：<br>先被计算并被储存在立即执行函数的闭包中<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> result = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> res = <span class="number">2</span> * <span class="number">9</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;());</span><br></pre></td></tr></table></figure></p>
<p>例子3：<br>立即执行函数也可以用来定义对象的属性；</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123; </span><br><span class="line">    message: (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">var</span> who = <span class="string">"me"</span>, </span><br><span class="line">        what = <span class="string">"call"</span>; </span><br><span class="line">        <span class="keyword">return</span> what + <span class="string">" "</span> + who; </span><br><span class="line">    &#125; ()), </span><br><span class="line">    getMsg: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.message; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;; </span><br><span class="line"><span class="comment">// usage </span></span><br><span class="line">o.getMsg(); <span class="comment">// "call me" </span></span><br><span class="line">o.message; <span class="comment">// "call me" </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//jquery</span></span><br><span class="line"><span class="keyword">var</span> m = (<span class="function"><span class="keyword">function</span>(<span class="params">e, t</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> n = <span class="number">1</span>;</span><br><span class="line">	toArray: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> h.call(<span class="keyword">this</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	b.fn = &#123;</span><br><span class="line">		<span class="comment">//内容</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;)(<span class="built_in">window</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> counter = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="keyword">get</span>: function()&#123;</span><br><span class="line">      <span class="keyword">return</span> i;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span>: function( val )&#123;</span><br><span class="line">      i = val;</span><br><span class="line">    &#125;,</span><br><span class="line">    increment: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> ++i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;());</span><br><span class="line"></span><br><span class="line"><span class="comment">//counter.get(); // 0</span></span><br><span class="line"><span class="comment">//counter.set( 3 );</span></span><br><span class="line"><span class="comment">//counter.increment(); // 4</span></span><br><span class="line"><span class="comment">//counter.increment(); // 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//counter.i; // undefined i并不是counter的属性</span></span><br><span class="line"><span class="comment">//i; // ReferenceError: i is not defined (函数内部的是局部变量)</span></span><br></pre></td></tr></table></figure>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions" target="_blank" rel="noopener">参考</a></p>
]]></content>
  </entry>
  <entry>
    <title>代理模式(proxy pattern)</title>
    <url>/2015/09/29/proxy-pattern/</url>
    <content><![CDATA[<p>代理模式（Proxy）为其他对象提供一种代理以控制对这个对象的访问。使用代理模式创建代理对象，让代理对象控制目标对象的访问（目标对象可以是远程的对象、创建开销大的对象或需要安全控制的对象），并且可以在不改变目标对象的情况下添加一些额外的功能。</p>
<p>在某些情况下，一个客户不想或者不能直接引用另一个对象，而<strong>代理对象可以在客户端和目标对象之间起到中介的作用</strong>，并且可以通过代理对象去掉客户不能看到的内容和服务或者添加客户需要的额外服务。</p>
<p>代理模式在很多情况下都非常有用，特别是你想强行控制一个对象的时候，比如<strong>延迟加载、监视状态</strong>变更的方法等等。</p>
<p>与类似接口的区别：</p>
<ul>
<li>适配器模式 —— 适配器模式为它所适配的对象提供了一个不同的接口，而代理提供了与它的实体相同的接口。</li>
<li>装饰器模式 —— 两者目的不同：装饰器为对象添加一个或多个功能，而代理则控制对对象的访问。</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// record.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Structural</span>\<span class="title">Proxy</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Record类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Record</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> null $data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = (<span class="keyword">array</span>) $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * magic setter</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed  $value</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span><span class="params">($name, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[(string) $name] = $value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * magic getter</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[(string) $name];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// RecordProxy.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Structural</span>\<span class="title">Proxy</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RecordProxy类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecordProxy</span> <span class="keyword">extends</span> <span class="title">Record</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $isDirty = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $isInitialized = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct($data);</span><br><span class="line">        <span class="comment">//当记录有数据时，将其标记为初始化.</span></span><br><span class="line">		<span class="comment">//由于记录将保持我们的业务逻辑，我们不想在那里实现这个行为，而不是在一个新的代理类</span></span><br><span class="line">		<span class="comment">//扩展记录类</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> !== $data) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;isInitialized = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;isDirty = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * magic setter</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed  $value</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span><span class="params">($name, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;isDirty = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">parent</span>::__set($name, $value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//测试代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Structural</span>\<span class="title">Proxy</span>\<span class="title">Tests</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Structural</span>\<span class="title">Proxy</span>\<span class="title">Record</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Structural</span>\<span class="title">Proxy</span>\<span class="title">RecordProxy</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> <span class="keyword">extends</span> \<span class="title">PHPUnit_Framework_TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testSetAttribute</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $data = [];</span><br><span class="line">        $proxy = <span class="keyword">new</span> RecordProxy($data);</span><br><span class="line">        $proxy-&gt;xyz = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($proxy-&gt;xyz===<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>design pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>关于登陆的那些事</title>
    <url>/2017/03/15/login-more/</url>
    <content><![CDATA[<h3 id="普通的登录"><a href="#普通的登录" class="headerlink" title="普通的登录"></a>普通的登录</h3><p>这个是极其普通的登录需求，要的就是一个登录页面，输入账号密码，提交Form表单，后端查询数据库对应用户名的密码，匹配正确则把用户记录到Session，不正确则返回错误。<br>这种登录，在上学的时候，也许敬爱的老师就已经教过你了。<br>但可能他没有教你的是，密码需要hash加密，session为什么可以记录登录用户的原理。</p>
<h4 id="密码Hash"><a href="#密码Hash" class="headerlink" title="密码Hash"></a>密码Hash</h4><p>密码hash，就是存进数据库的密码是一串密文，密文是明文密码通过不可逆算法得出的。在Nodejs中，你可以使用bcryptjs，它提供了hash以及对应的compare方法，非常适合用于密码的加密和对比。</p>
<h4 id="Session原理"><a href="#Session原理" class="headerlink" title="Session原理"></a>Session原理</h4><p>Session的原理其实还是依赖了Cookie，所以Cookie才是记录用户凭证的真理。它的原理大概是酱紫的：服务器端维护一个session的表，这个表的每一条记录存的就是与某一个客户端的会话，会话会有过期时间，过期的会话会被清理。然后这个会话，会有一个对应的id，一般是一串长长的看不懂的字符串，然后这个字符串会被存储在客户端的cookie中，每一次请求服务器端都会带上这个cookie，服务器端就知道访问的就是哪个客户端了。<br>欲知更多有关「Session原理」请点击传送门：Session原理</p>
<h3 id="使用独立登录系统"><a href="#使用独立登录系统" class="headerlink" title="使用独立登录系统"></a>使用独立登录系统</h3><p>应项目需要，登录逻辑需要独立出来做成一个系统，就是另外一个项目。与原来的主站不是在同一个项目中了。一个域名是 <a href="http://www.site.com，一个则是passport.site.com了。要在不同的域名下进行登录，一般的方法是www.site.com/login" target="_blank" rel="noopener">www.site.com，一个则是passport.site.com了。要在不同的域名下进行登录，一般的方法是www.site.com/login</a> 跳转到 passport.site.com/login，passport这边是一个登录页面，用户输入账号密码登录成功之后，passport会通过带着一个可逆加密的包含用户信息的token，重定向到<a href="http://www.site.com提供的回调处理地址，然后进行解密，匹配正确，则登录用户。" target="_blank" rel="noopener">www.site.com提供的回调处理地址，然后进行解密，匹配正确，则登录用户。</a><br>要注意的是，这里的加密的信息需要包含一个时间戳，接收方需要认证这个时间戳，过期登录失败。避免token被窃取，被无限登录site系统。</p>
<h3 id="单点登录"><a href="#单点登录" class="headerlink" title="单点登录"></a>单点登录</h3><p>单点登录需要实现的需求，说白了就是在站点A的登录了，那么用户就自动在站点B、站点C、站点E、F、G登录。<br>这又分两种情况，A站点和B站点是否在同一个二级域名下。<br>假如是在同一个域名下，例如<code>siteA.site.com</code>与<code>siteB.site.com</code>，因为cookie允许设置到二级域名下<code>.site.com</code>，所以siteA和siteB是可以共享cookie的，用户的信息可以通过可逆加密放在二级域名下的cookie，并且设置http only，就可以一站登录，站站登录。<br>而如果A站点和B站点不在同一二级域名下，例如<code>www.siteA.com</code>与<code>www.siteB.com</code>，他们就无法通过共享cookie的方式共享用户信息，所以需要用到jsonp的方式，用户在siteA登录之后，提供一个jsonp接口获取加密的用户信息，siteB访问这个jsonp获取加密信息。达到共享用户状态的效果。</p>
<p>单点登录SSO（Single Sign On）说得简单点就是在一个多系统共存的环境下，用户在一处登录后，就不用在其他系统中登录，也就是用户的一次登录能得到其他所有系统的信任。单点登录在大型网站里使用得非常频繁，例如像阿里巴巴这样的网站，在网站的背后是成百上千的子系统，用户一次操作或交易可能涉及到几十个子系统的协作，如果每个子系统都需要用户认证，不仅用户会疯掉，各子系统也会为这种重复认证授权的逻辑搞疯掉。实现单点登录说到底就是要解决如何产生和存储那个信任，再就是其他系统如何验证这个信任的有效性，因此要点也就以下两个：</p>
<blockquote>
<ul>
<li>存储信任</li>
<li>验证信任</li>
</ul>
</blockquote>
<h4 id="以Cookie作为凭证媒介"><a href="#以Cookie作为凭证媒介" class="headerlink" title="以Cookie作为凭证媒介"></a>以Cookie作为凭证媒介</h4><p>最简单的单点登录实现方式，是使用cookie作为媒介，存放用户凭证。<br>用户登录父应用之后，应用返回一个加密的cookie，当用户访问子应用的时候，携带上这个cookie，授权应用解密cookie并进行校验，校验通过则登录当前用户。</p>
<p>不难发现以上方式把信任存储在客户端的Cookie中，这种方式很容易令人质疑：</p>
<blockquote>
<ul>
<li>Cookie不安全</li>
<li>不能跨域实现免登</li>
</ul>
</blockquote>
<p>对于第一个问题，通过加密Cookie可以保证安全性，当然这是在源代码不泄露的前提下。如果Cookie的加密算法泄露，攻击者通过伪造Cookie则可以伪造特定用户身份，这是很危险的。<br>对于第二个问题，更是硬伤。</p>
<h4 id="通过JSONP实现"><a href="#通过JSONP实现" class="headerlink" title="通过JSONP实现"></a>通过JSONP实现</h4><p>对于跨域问题，可以使用JSONP实现。<br>用户在父应用中登录后，跟Session匹配的Cookie会存到客户端中，当用户需要登录子应用的时候，授权应用访问父应用提供的JSONP接口，并在请求中带上父应用域名下的Cookie，父应用接收到请求，验证用户的登录状态，返回加密的信息，子应用通过解析返回来的加密信息来验证用户，如果通过验证则登录用户。<br><img src="http://upload-images.jianshu.io/upload_images/79702-7ddba46df098374b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="img"></p>
<h4 id="通过页面重定向的方式"><a href="#通过页面重定向的方式" class="headerlink" title="通过页面重定向的方式"></a>通过页面重定向的方式</h4><p>是通过父应用和子应用来回重定向中进行通信，实现信息的安全传递。<br>父应用提供一个GET方式的登录接口，用户通过子应用重定向连接的方式访问这个接口，如果用户还没有登录，则返回一个的登录页面，用户输入账号密码进行登录。如果用户已经登录了，则生成加密的Token，并且重定向到子应用提供的验证Token的接口，通过解密和校验之后，子应用登录当前用户。</p>
<h3 id="OAuth2-0登录"><a href="#OAuth2-0登录" class="headerlink" title="OAuth2.0登录"></a>OAuth2.0登录</h3><p>这就比较普遍了，现在随随便便做个网站，都接入「微信登录」、「微博登录」、「豆瓣登录」、「QQ登录」、「Github登录」,这些统一叫做：「第三方登录」。<br>第三方登录都是实现了OAuth2.0协议的，流程大概是酱紫的：<br>第三方提供一个登录入口，也就是第三方域名下的登录页面。主站需要登录的时候，引导用户重定向到第三方的登录页面，用户输入账号密码之后，登录第三方系统，第三方系统匹配帐号成功之后，带上一个code到主站的回调地址，主站接收到code，短时间内拿着code请求第三方提供获取长期凭证的接口(因为code有一个比较短的过期时间)，这个长期凭证叫<code>access_token</code>，获取之后就把这个<code>access_token</code>存到数据库中，请求一些第三方提供的API，需要用到这个<code>access_token</code>，因为这个token就是记录用户在第三方系统的一个身份凭证。<br>一些系统，在获取<code>access_token</code>的时候，还会返回一个副参数<code>refresh_token</code>，因为<code>access_token</code>是有过期时间的，一旦过期了，主站可以使用refresh_token请求第三方提供的接口获取新的<code>access_token</code>以及新的<code>refresh_token</code>。<br>在Nodejs中，你可以使用passport来给第三方登录提供一个统一解决方案，而如果你是开发「微信公众号」授权，除了<a href="https://www.npmjs.com/package/passport" target="_blank" rel="noopener">passport</a>，也可以使用<a href="https://www.npmjs.com/package/wechat-oauth" target="_blank" rel="noopener">wechat-oauth</a></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>其实登录问题，理解了Session原理是很重要的，这个也不难理解。然后站点之间的用户信息交流，就是通过各种跨域限制，各种加密解密而已。在做这个的时候，需要充分考虑到加密的token是否会被窃取的可能性，还要考虑让这个token加上时间的验证，在一些可能会被窃取，安全需求比较高的情况，就需要把token的时间设置的更短。</p>
<p>加密的方式需要依照需求不同而选择可逆或者不可逆，<code>hash sha1</code>,还是<code>JWT(Json Web Token)</code>。<br>sha1加密，可以使用Nodejs自带的<code>crypto</code>,php 的 <code>sha1</code>，JWT可以使用<a href="https://jwt.io/" target="_blank" rel="noopener">json web token</a></p>
]]></content>
  </entry>
  <entry>
    <title>Docker入门</title>
    <url>/2017/07/31/docker-tutorial/</url>
    <content><![CDATA[<h2 id="使用Docker能为我们解决什么问题？"><a href="#使用Docker能为我们解决什么问题？" class="headerlink" title="使用Docker能为我们解决什么问题？"></a>使用Docker能为我们解决什么问题？</h2><p>可以快速思考开发和部署没有Docker的应用程序的典型工作流程。</p>
<p>共享设置脚本吗，你真的会使用泊坞窗运行设置脚本，并分享图像生成。此映像包含应用程序运行应用程序所需的所有依赖项，包括Ubuntu等平台。因此，当您基于这个映像运行一个容器时，它不需要下载任何东西。这也确保了在构建映像时使用的软件版本将是随处使用的软件版本。</p>
<a id="more"></a>
<p>由于每个容器都基于相同的映像，所以为了更新，您只需更新构建脚本，构建映像，测试映像仍然按预期运行，然后使用新映像部署新容器，并切换旧容器实例。这样可以确保容器彼此一致。</p>
<p>一个容器会有一个单独的守护进程（Docker deamon） ，然后共享内核（the kernel）。</p>
<p><strong> 使用Docker可确保部署的应用程序实例之间的一致性，最大限度地减少错误，并通过像Kubernetes这样的工具，使管理可扩展基础架构更加轻松。 </strong></p>
<table>
<thead>
<tr>
<th>header 1</th>
<th>应用架构</th>
<th>部署架构</th>
</tr>
</thead>
<tbody>
<tr>
<td>模块化</td>
<td>包和组件</td>
<td>容器</td>
</tr>
<tr>
<td>关注点分离</td>
<td>单一责任原则</td>
<td>面向服务的体系结构 (SOA)</td>
</tr>
</tbody>
</table>
<p>举个例子，一个典型的社交媒体被分割成几个部分：</p>
<ul>
<li>一个核心的应用<code>python</code> or <code>nodejs</code> or <code>php</code> 或者其他语言</li>
<li>一个mongodb数据库已提供应用信息</li>
<li>一个搜索引擎，例如elasticsearch 来返回查询结果</li>
<li>一个nginx的web服务器去处理请求和响应</li>
</ul>
<p>您将有四个容器，一个用于应用程序的每个分支。</p>
<h2 id="术语（terminology）"><a href="#术语（terminology）" class="headerlink" title="术语（terminology）"></a>术语（terminology）</h2><ul>
<li>镜像(images)用于创建容器的应用程序的文件系统和配置。想了解更多关于码头工人的形象，运行Docker视察高山。在演示中，你使用泊坞窗拉命令下载高山图像。当你执行命令Docker运行Hello World，它也没有一个码头工人拉幕后下载你好世界图像。</li>
<li>容器 (containers) 运行Docker容器图像实例的运行实际的应用。容器包含应用程序及其所有依赖项。它与其他容器共享内核，并作为主机操作系统上的用户空间中的一个隔离进程运行。你创造了一个你下载的<code>alpine image</code>。你可以用<code>docker ps</code>这个命令列出所有的容器。</li>
<li>Docker守护进程(Docker daemon) 管理大楼的主机上运行的后台服务，运行和分配的docker containers.</li>
<li>docker client 命令行工具，允许用户与后台交互和Docker Deamon.</li>
<li>Docker Store  docker 商店 你可以去下载使用别人做好的容器，插件等。</li>
</ul>
<h2 id="installion"><a href="#installion" class="headerlink" title="installion"></a>installion</h2><p><code>uname -r</code> 查看版本且必须大于3.1才能使用docker</p>
<h3 id="ubuntu"><a href="#ubuntu" class="headerlink" title="ubuntu"></a>ubuntu</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget -qO- https://get.docker.com/ | sh</span><br><span class="line">sudo usermod -aG docker runoob  // 非root用户执行</span><br><span class="line">sudo service docker start</span><br><span class="line">//执行这个想去找hello-world 镜像，然后运行</span><br><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure>
<h3 id="centos"><a href="#centos" class="headerlink" title="centos"></a>centos</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install docker</span><br><span class="line">service docker start</span><br><span class="line">docker run hello-world</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用或者脚本安装</span></span><br><span class="line">sudo yum update</span><br><span class="line">curl -fsSL https://get.docker.com/ | sh</span><br><span class="line">sudo service docker start</span><br><span class="line">sudo docker run hello-world</span><br></pre></td></tr></table></figure>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker version</span><br><span class="line">&gt; - Client:  </span><br><span class="line">&gt; -  Version:      1.13.1</span><br><span class="line">&gt; -  API version:  1.26</span><br><span class="line">&gt; -  Go version:   go1.7.5</span><br><span class="line">&gt; -  Git commit:   092cba3</span><br><span class="line">&gt; -  Built:        Wed Feb  8 06:50:14 2017</span><br><span class="line">&gt; -  OS/Arch:      linux/amd64</span><br><span class="line">&gt; - </span><br><span class="line">&gt; - Server:  </span><br><span class="line">&gt; -  Version:      1.13.1</span><br><span class="line">&gt; -  API version:  1.26 (minimum version 1.12)</span><br><span class="line">&gt; -  Go version:   go1.7.5</span><br><span class="line">&gt; -  Git commit:   092cba3</span><br><span class="line">&gt; -  Built:        Wed Feb  8 06:50:14 2017</span><br><span class="line">&gt; -  OS/Arch:      linux/amd64</span><br><span class="line">&gt; -  Experimental: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo docker pull ubuntu</span><br><span class="line">sudo docker images</span><br><span class="line"></span><br><span class="line">sudo docker ps -a  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//Docker容器连接</span><br><span class="line">docker run -d -P training/webapp python app.py</span><br><span class="line">docker run -d -p 5000:5000 training/webapp python app.py</span><br><span class="line">docker run -d -p 127.0.0.1:5001:5002 training/webapp python app.py</span><br><span class="line">docker run -d -p 127.0.0.1:5000:5000/udp training/webapp python app.py</span><br><span class="line">//自定义</span><br><span class="line">docker run -d -P --name my_container_name training/webapp python app.py</span><br><span class="line"></span><br><span class="line">docker run --name static-site -e AUTHOR=<span class="string">"Your Name"</span> -d -P dockersamples/static-site</span><br><span class="line"></span><br><span class="line">docker ps</span><br><span class="line">docker ps -l</span><br><span class="line">docker ps -a</span><br><span class="line"></span><br><span class="line">&gt; -d: 后台运行</span><br><span class="line">&gt; -P: 创建</span><br><span class="line">&gt; -p: 端口或者地址</span><br><span class="line">&gt;- e: 是如何将环境变量传递给容器</span><br><span class="line">&gt;- name:  自定义容器名称</span><br></pre></td></tr></table></figure>
<h2 id="webapps-whit-docker"><a href="#webapps-whit-docker" class="headerlink" title="webapps whit docker"></a>webapps whit docker</h2><h3 id="Run-a-static-website-in-a-container"><a href="#Run-a-static-website-in-a-container" class="headerlink" title="Run a static website in a container"></a>Run a static website in a container</h3><p>在<a href="https://github.com/docker/labs/tree/master/beginner/static-site" target="_blank" rel="noopener">这里</a> 有一个写好的容器下载<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -d dockersamples/static-site</span><br><span class="line">docker ps // 查看</span><br><span class="line"></span><br><span class="line">docker port static-site</span><br><span class="line">//run</span><br><span class="line">docker run --name static-site-2 -e AUTHOR=&quot;Your Name&quot; -d -p 8888:80 dockersamples/static-site</span><br><span class="line">open localhost:8888/</span><br><span class="line"></span><br><span class="line">//stop</span><br><span class="line">docker stop a7a0e504ca3e // 停止</span><br><span class="line">docker rm a7a0e504ca3e   // 删除</span><br><span class="line"></span><br><span class="line">//或者直接</span><br><span class="line">docker rm -f static-site-2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker ps</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure></p>
<h2 id="docker-images"><a href="#docker-images" class="headerlink" title="docker images"></a>docker images</h2><p>可以在<a href="https://store.docker.com/" target="_blank" rel="noopener">docker Store</a> 使用官方或者自己的镜像<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//加载ubuntu 16.04</span><br><span class="line">docker pull ubuntu:16.04  </span><br><span class="line">// 拉取latest</span><br><span class="line">docker pull ubuntu</span><br></pre></td></tr></table></figure></p>
<h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><p>其他可以发布自己的store，或者<a href="https://github.com/docker/labs/blob/master/beginner/chapters/votingapp.md" target="_blank" rel="noopener">部署多个app的方法</a>。</p>
<p><a href="https://github.com/docker/labs/blob/master/beginner/readme.md" target="_blank" rel="noopener">教程参考</a></p>
]]></content>
  </entry>
  <entry>
    <title>盗火：硅谷、海豹突击队和疯狂科学家正在给我们的工作和生活带来一个革命</title>
    <url>/2017/09/02/daohuo/</url>
    <content><![CDATA[<p> 本书是由史蒂芬·科特勒和杰尔·威尔一起写的，这书名相当的长，下面简称“盗火”。</p>
<p> 这是一本讲述“出神状态”的书籍，不知道大家有没有这样一个的体验：在做一些事情时候，很专注去想解决方案而迟迟想不出来，但突然间，解决方案自己在我们的脑海中闪过，我们似乎很轻松地找到了解决方法。很难描述这种感觉，但自己真正地感受到了，这种体验就是出神状态的其中一种。虽然很难捕捉，但世界上有很多人正在研究或利用这种状态，而硅谷、海豹突击队和疯狂科学家都在寻找这种状态，两位作者走访了很多人，把最新的研究写成“盗火”这本书，将这种神秘的体验公开出来。</p>
<p>首先是海豹突击队，海豹突击队执行任务时，环境一般是变化多的、信息模糊、充满不确定性，所以团队非常讲究配合。如何达到高效的配合，海豹给出的答案是团队达到“<strong>集体心流</strong>”状态，。<br><a id="more"></a></p>
<p>一旦进入状态，整个队伍融合成一个集体心理，处处合拍，能高效地完成任务。具体来说的话，海豹有两个基本行动规则:</p>
<ol>
<li>你要跟前面的队友做不一样的事——比如在搜索房子时，前面队友搜索左边，你就要搜索右边，从而形成自动分工；</li>
<li>队伍没有固定的领导，谁知道下一步该干什么，他马上成为领导，其他人马上跟随他。目前海豹并没有找到一个有效的方法训练“集体心流”，只能通过“促进团队感情”的常规手段和筛选士兵的方式来训练“集体心流”</li>
</ol>
<p>不仅仅海豹想要做这种出神状态，硅谷的人也想要。作者发现火人节是达到出神状态的一种方式，这是受硅谷欢迎的狂欢活动，在内华达州一片沙漠中举行。在火人节，每个人都要为别人服务，来换取别人的服务，钱在这里起不到作用。据说有各种跳舞狂欢，有艺术展览，还有些人裸体、服迷幻药。火人节的精神就是狂欢，是<strong>一种忘我的出神状态</strong></p>
<p>此外，心流基因组计划也一直在寻找三种状态的出神技术：<br>1) 第一个是心流，忘我地投入工作，灵感爆棚。一般是艺术家、运动员会经常达到心流；<br>2) 其次是通过某种仪式达到一种神秘的境界，这通常是宗教人士的体验。<br>3) 最后一个是迷幻，通过吸毒的方法进入。这三种都可以称为出神状态，都是潜意识的活动。当处于出神状态时，主管理性思维和大脑前额叶皮层的活动的降低，负责潜意识的区域活动增加.</p>
<p>作者还从脑波角度分析了这种出神状态。我们大脑一般会发出四种脑波：<br>（1）“β波”:对应前额叶皮层主导的理性思维，保持机警；<br>（2）“ɑ波”：对应白日梦、更平静的大脑活动；<br>（3）“θ波”：对应排除外界干扰的深入思考；<br>（4）“r波”：对应创造性思维的尤里卡时刻。（尤里卡时刻可以简单理解创新状态的瞬间）<br>   当你达到出神状态时，大脑发出的ɑ、θ、r波会加强，而β波会减弱，也就是关闭冷认识，让热认知主导。那有什么方法可以达到出神状态呢，作者介绍了三种常规方法：</p>
<blockquote>
<p>-（1）冥想；<br>-（2）经颅磁刺激，用很微弱的磁脉冲去刺激大脑，让大脑的前额叶皮层暂时关闭；<br>-（3）服药，服药是更快、更方便 的方法，如LSD、“裸盖菇素”，但科学家不建议使用</p>
</blockquote>
<p>作者讲到，出神体验有四个特征：<br>（1）忘记自己<br>（2）忘记时间流逝<br>（3）获得丰富信息<br>（4）做复杂工作毫不费力，而且有强烈的愉悦感</p>
<p>  这其中带来的启示就是：</p>
<p>  首先，你要忘我，关闭大脑中的几个声音。也就是说你在做高强度的工作时，你不要想着午饭吃什么，晚上该干什么，也不要评顾虑自己的效率是不是太低，别人会怎么看我，你要专注于现在；其次是去除时间感，不要考虑过去，担心未来，要专注于眼前。但后面两个特征会比较难达到了，不过只要你是为了一个明确目标而努力，你大致能够体验到工作带来的愉悦感。</p>
<p>  此外，作者还讲到了可以用身体影响大脑的一些离奇体验，以及“耶路撒冷综合征”：当你处于出神状态时，你可能感到自己特别了不起，感觉自己是个圣人。</p>
<p>   在本书最后，作者还忠告：达到了出神状态，别忘了回来。该投入就投入，投入完了还能回来，这才是真正的自由.</p>
]]></content>
  </entry>
  <entry>
    <title>Mysql MRG_MyISAM引擎分表法</title>
    <url>/2017/01/25/mrg_myisam/</url>
    <content><![CDATA[<p>一般来说，当我们的数据库的数据超过了100w记录的时候就应该考虑分表或者分区了，这次我来详细说说分表的一些方法。目前我所知道的方法都是MYISAM的，INNODB如何做分表并且保留事务和外键，我还不是很了解。</p>
<p>首先，我们需要想好到底分多少个表，前提当然是满足应用。这里我使用了一个比较简单的分表方法，就是根据自增id的尾数来分，也就是说分0-9一共10个表，其取值也很好做，就是对10进行取模。另外，还可以根据某一字段的md5值取其中几位进行分表，这样的话，可以分的表就很多了。</p>
<p>好了，先来创建表吧，代码如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`article_0`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">BIGINT</span>( <span class="number">20</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`subject`</span> <span class="built_in">VARCHAR</span>( <span class="number">200</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> ( <span class="string">`id`</span> )  </span><br><span class="line">) <span class="keyword">ENGINE</span> = MYISAM <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`article_1`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">BIGINT</span>( <span class="number">20</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`subject`</span> <span class="built_in">VARCHAR</span>( <span class="number">200</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> ( <span class="string">`id`</span> )  </span><br><span class="line">) <span class="keyword">ENGINE</span> = MYISAM <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`article_2`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">BIGINT</span>( <span class="number">20</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`subject`</span> <span class="built_in">VARCHAR</span>( <span class="number">200</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> ( <span class="string">`id`</span> )  </span><br><span class="line">) <span class="keyword">ENGINE</span> = MYISAM <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`article_3`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">BIGINT</span>( <span class="number">20</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`subject`</span> <span class="built_in">VARCHAR</span>( <span class="number">200</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> ( <span class="string">`id`</span> )  </span><br><span class="line">) <span class="keyword">ENGINE</span> = MYISAM <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`article_4`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">BIGINT</span>( <span class="number">20</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`subject`</span> <span class="built_in">VARCHAR</span>( <span class="number">200</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> ( <span class="string">`id`</span> )  </span><br><span class="line">) <span class="keyword">ENGINE</span> = MYISAM <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`article_5`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">BIGINT</span>( <span class="number">20</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`subject`</span> <span class="built_in">VARCHAR</span>( <span class="number">200</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> ( <span class="string">`id`</span> )  </span><br><span class="line">) <span class="keyword">ENGINE</span> = MYISAM <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`article_6`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">BIGINT</span>( <span class="number">20</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`subject`</span> <span class="built_in">VARCHAR</span>( <span class="number">200</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> ( <span class="string">`id`</span> )  </span><br><span class="line">) <span class="keyword">ENGINE</span> = MYISAM <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`article_7`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">BIGINT</span>( <span class="number">20</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`subject`</span> <span class="built_in">VARCHAR</span>( <span class="number">200</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> ( <span class="string">`id`</span> )  </span><br><span class="line">) <span class="keyword">ENGINE</span> = MYISAM <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`article_8`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">BIGINT</span>( <span class="number">20</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`subject`</span> <span class="built_in">VARCHAR</span>( <span class="number">200</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> ( <span class="string">`id`</span> )  </span><br><span class="line">) <span class="keyword">ENGINE</span> = MYISAM <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`article_9`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">BIGINT</span>( <span class="number">20</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`subject`</span> <span class="built_in">VARCHAR</span>( <span class="number">200</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> ( <span class="string">`id`</span> )  </span><br><span class="line">) <span class="keyword">ENGINE</span> = MYISAM <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci</span><br></pre></td></tr></table></figure>
<p> 好了10个表创建完毕了，需要注意的是，这里的id不能设为自增，而且所有的表结构必须一致，包括结构，类型，长度，字段的顺序都必须一致那么对于这个id如何取得呢？后面我会详细说明。现在，我们需要一个合并表，用于查询，创建合并表的代码如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`article`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">BIGINT</span>( <span class="number">20</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`subject`</span> <span class="built_in">VARCHAR</span>( <span class="number">200</span> ) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line"><span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> ( <span class="string">`id`</span> )  </span><br><span class="line">) <span class="keyword">ENGINE</span>=MRG_MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 INSERT_METHOD=<span class="number">0</span> <span class="keyword">UNION</span>=(<span class="string">`article_0`</span>,<span class="string">`article_1`</span>,<span class="string">`article_2`</span>,<span class="string">`article_3`</span>,<span class="string">`article_4`</span>,<span class="string">`article_5`</span>,<span class="string">`article_6`</span>,<span class="string">`article_7`</span>,<span class="string">`article_8`</span>,<span class="string">`article_9`</span>);</span><br></pre></td></tr></table></figure>
<pre><code>这里INSERT_METHOD=0在某些版本可能不工作，需要改成INSERT_METHOD=NO
</code></pre><p>注意，合并表也必须和前面的表有相同的结构，类型，长度，包括字段的顺序都必须一致这里的<code>INSERT_METHOD=0</code>表示不允许对本表进行insert操作。好了，当需要查询的时候，我们可以只对article这个表进行操作就可以了，也就是说这个表仅仅只能进行select操作</p>
<p>那么对于插入也就是insert操作应该如何来搞呢，首先就是获取唯一的id了，这里就还需要一个表来专门创建id，代码如下<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `test`.`create_id` (  </span><br><span class="line">`id` BIGINT( 20 ) NOT NULL AUTO_INCREMENT PRIMARY KEY  </span><br><span class="line">) ENGINE = MYISAM   </span><br><span class="line">  也 就是说，当我们需要插入数据的时候，必须由这个表来产生id值，我的php代码的方法如下</span><br><span class="line"></span><br><span class="line">function get_AI_ID() &#123;  </span><br><span class="line">    $sql  = &quot;insert into create_id (id) values(&apos;&apos;)&quot;;  </span><br><span class="line">    $this-&gt;db-&gt;query($sql);  </span><br><span class="line">    return $this-&gt;db-&gt;insertID();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  好了，现在假设我们要插入一条数据了，应该怎么操作呢？还是继续看代码吧</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">function new_Article() &#123;  </span><br><span class="line">    $id  = $this-&gt;get_AI_ID();  </span><br><span class="line">    $table_name = $this-&gt;get_Table_Name($id);  </span><br><span class="line">    $sql = "<span class="keyword">insert</span> <span class="keyword">into</span> &#123;$table_name&#125; (<span class="keyword">id</span>,subject,<span class="keyword">content</span>) <span class="keyword">values</span>(<span class="string">'&#123;$id&#125;'</span>,<span class="string">'测试标题'</span>,<span class="string">'测试内容'</span>)<span class="string">";  </span></span><br><span class="line"><span class="string">    $this-&gt;db-&gt;query($sql);  </span></span><br><span class="line"><span class="string">&#125;  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/** </span></span><br><span class="line"><span class="string"> * 用于根据id获取表名 </span></span><br><span class="line"><span class="string"> */  </span></span><br><span class="line"><span class="string">function get_Table_Name($id) &#123;  </span></span><br><span class="line"><span class="string">    return 'article_'.intval($id)%10;  </span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>其实很简单的，对吧，就是先获取id，然后根据id获取应该插入到哪个表，然后就很简单了。</p>
<p>对于update的操作我想应该不需要再说了吧，无非是有了id，然后获取表名，然后进行update操作就好了。</p>
]]></content>
  </entry>
  <entry>
    <title>Redis is configured to save RDB snapshots</title>
    <url>/2017/01/25/redis-snapshots-bug/</url>
    <content><![CDATA[<p>今天在<code>redis</code>中执行<code>setrange name 1 chun</code> 命令时报了如下错误提示：</p>
<p><code>(error) MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error．</code></p>
<p>大意为：（错误）<code>misconf redis</code>被配置以保存数据库快照，但<code>misconf redis</code>目前不能在硬盘上持久化。用来修改数据集合的命令不能用，请使用日志的错误详细信息。</p>
<ol>
<li>磁盘满了，快照无法写入</li>
<li>这是由于强制停止<code>redis</code>快照，不能持久化引起的，</li>
</ol>
<p>运行info命令查看<code>redis</code>快照的状态，如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rdb_last_bgsave_status:err</span><br></pre></td></tr></table></figure>
<p>解决方案如下：</p>
<p>运行　<code>config set stop-writes-on-bgsave-error no</code>　命令</p>
<p>关闭配置项<code>stop-writes-on-bgsave-error</code>解决该问题。</p>
]]></content>
  </entry>
  <entry>
    <title>JavaScript Standard Style</title>
    <url>/2017/07/11/JavaScript-Standard-Style/</url>
    <content><![CDATA[<h1 id="JavaScript-Standard-Style"><a href="#JavaScript-Standard-Style" class="headerlink" title="JavaScript Standard Style"></a>JavaScript Standard Style</h1><p>这是 JavaScript <a href="https://github.com/feross/standard" target="_blank" rel="noopener">standard</a> 代码规范的全文。</p>
<p>掌握本规范的最好方法是安装并在自己的代码中使用它。</p>
<h2 id="细则"><a href="#细则" class="headerlink" title="细则"></a>细则</h2><ul>
<li><p><strong>使用两个空格</strong>进行缩进。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/indent" target="_blank" rel="noopener"><code>indent</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hello</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'hi'</span>, name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
</li>
<li><p>除需要转义的情况外，<strong>字符串统一使用单引号</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/quotes" target="_blank" rel="noopener"><code>quotes</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'hello there'</span>)</span><br><span class="line">$(<span class="string">"&lt;div class='box'&gt;"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要定义未使用的变量</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-unused-vars" target="_blank" rel="noopener"><code>no-unused-vars</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result = something()   <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>关键字后面加空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/keyword-spacing" target="_blank" rel="noopener"><code>keyword-spacing</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (condition) &#123; ... &#125;   <span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">if</span>(condition) &#123; ... &#125;    <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>函数声明时括号与函数名间加空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/space-before-function-paren" target="_blank" rel="noopener"><code>space-before-function-paren</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">name</span> (<span class="params">arg</span>) </span>&#123; ... &#125;   <span class="comment">// ✓ ok</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params">arg</span>) </span>&#123; ... &#125;    <span class="comment">// ✗ avoid</span></span><br><span class="line"></span><br><span class="line">run(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; ... &#125;)      <span class="comment">// ✓ ok</span></span><br><span class="line">run(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; ... &#125;)       <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>始终使用</strong> <code>===</code> 替代 <code>==</code>。<br><br>例外： <code>obj == null</code> 可以用来检查 <code>null || undefined</code>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/eqeqeq" target="_blank" rel="noopener"><code>eqeqeq</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (name === <span class="string">'John'</span>)   <span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">if</span> (name == <span class="string">'John'</span>)    <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (name !== <span class="string">'John'</span>)   <span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">if</span> (name != <span class="string">'John'</span>)    <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>字符串拼接操作符 (Infix operators)</strong> 之间要留空格。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/space-infix-ops" target="_blank" rel="noopener"><code>space-infix-ops</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">var</span> x = <span class="number">2</span></span><br><span class="line"><span class="keyword">var</span> message = <span class="string">'hello, '</span> + name + <span class="string">'!'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> x=<span class="number">2</span></span><br><span class="line"><span class="keyword">var</span> message = <span class="string">'hello, '</span>+name+<span class="string">'!'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>逗号后面加空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/comma-spacing" target="_blank" rel="noopener"><code>comma-spacing</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">var</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">greet</span> (<span class="params">name, options</span>) </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> list = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">greet</span> (<span class="params">name,options</span>) </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>else 关键字要与花括号</strong>保持在同一行。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/brace-style" target="_blank" rel="noopener"><code>brace-style</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>多行 if 语句的</strong>的括号不能省。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/curly" target="_blank" rel="noopener"><code>curly</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">if</span> (options.quiet !== <span class="literal">true</span>) <span class="built_in">console</span>.log(<span class="string">'done'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">if</span> (options.quiet !== <span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'done'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">if</span> (options.quiet !== <span class="literal">true</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'done'</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要丢掉</strong>异常处理中<code>err</code>参数。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/handle-callback-err" target="_blank" rel="noopener"><code>handle-callback-err</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line">run(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err</span><br><span class="line">  <span class="built_in">window</span>.alert(<span class="string">'done'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line">run(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.alert(<span class="string">'done'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用浏览器全局变量时加上</strong> <code>window.</code> 前缀。<br><br>Exceptions are: <code>document</code>, <code>console</code> and <code>navigator</code>.</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-undef" target="_blank" rel="noopener"><code>no-undef</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">window</span>.alert(<span class="string">'hi'</span>)   <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不允许有连续多行空行</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-multiple-empty-lines" target="_blank" rel="noopener"><code>no-multiple-empty-lines</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">var</span> value = <span class="string">'hello world'</span></span><br><span class="line"><span class="built_in">console</span>.log(value)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> value = <span class="string">'hello world'</span></span><br></pre></td></tr></table></figure>
<p>console.log(value)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">* **对于三元运算符** `?` 和 `:` 与他们所负责的代码处于同一行</span><br><span class="line"></span><br><span class="line">  eslint: [`operator-linebreak`](http://eslint.org/docs/rules/operator-linebreak)</span><br><span class="line"></span><br><span class="line">  ```js</span><br><span class="line">  // ✓ ok</span><br><span class="line">  var location = env.development ? &apos;localhost&apos; : &apos;www.api.com&apos;</span><br><span class="line"></span><br><span class="line">  // ✓ ok</span><br><span class="line">  var location = env.development</span><br><span class="line">    ? &apos;localhost&apos;</span><br><span class="line">    : &apos;www.api.com&apos;</span><br><span class="line"></span><br><span class="line">  // ✗ avoid</span><br><span class="line">  var location = env.development ?</span><br><span class="line">    &apos;localhost&apos; :</span><br><span class="line">    &apos;www.api.com&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>每个 var 关键字</strong>单独声明一个变量。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/one-var" target="_blank" rel="noopener"><code>one-var</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">var</span> silent = <span class="literal">true</span></span><br><span class="line"><span class="keyword">var</span> verbose = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> silent = <span class="literal">true</span>, verbose = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> silent = <span class="literal">true</span>,</span><br><span class="line">    verbose = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>条件语句中赋值语句</strong>使用括号包起来。这样使得代码更加清晰可读，而不会认为是将条件判断语句的全等号（<code>===</code>）错写成了等号（<code>=</code>）。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-cond-assign" target="_blank" rel="noopener"><code>no-cond-assign</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">while</span> ((m = text.match(expr))) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">while</span> (m = text.match(expr)) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>单行代码块两边加空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/block-spacing" target="_blank" rel="noopener"><code>block-spacing</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> (<span class="params"></span>) </span>&#123;<span class="keyword">return</span> <span class="literal">true</span>&#125;    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="literal">true</span> &#125;  <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>对于变量和函数名统一使用驼峰命名法</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/camelcase" target="_blank" rel="noopener"><code>camelcase</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">my_function</span> (<span class="params"></span>) </span>&#123; &#125;    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span> (<span class="params"></span>) </span>&#123; &#125;     <span class="comment">// ✓ ok</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> my_var = <span class="string">'hello'</span>           <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> myVar = <span class="string">'hello'</span>            <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不允许有多余的行末逗号</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/comma-dangle" target="_blank" rel="noopener"><code>comma-dangle</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  message: <span class="string">'hello'</span>,   <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>始终将逗号置于行末</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/comma-style" target="_blank" rel="noopener"><code>comma-style</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  foo: <span class="string">'foo'</span></span><br><span class="line">  ,<span class="attr">bar</span>: <span class="string">'bar'</span>   <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  foo: <span class="string">'foo'</span>,</span><br><span class="line">  bar: <span class="string">'bar'</span>   <span class="comment">// ✓ ok</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>点号操作符须与属性需在同一行</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/dot-location" target="_blank" rel="noopener"><code>dot-location</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.</span><br><span class="line">  log(<span class="string">'hello'</span>)  <span class="comment">// ✗ avoid</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span></span><br><span class="line">  .log(<span class="string">'hello'</span>) <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>文件末尾留一空行</strong>。</p>
<p>elint: <a href="http://eslint.org/docs/rules/eol-last" target="_blank" rel="noopener"><code>eol-last</code></a></p>
</li>
<li><p><strong>函数调用时标识符与括号间不留间隔</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/func-call-spacing" target="_blank" rel="noopener"><code>func-call-spacing</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log (<span class="string">'hello'</span>) <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'hello'</span>)  <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>键值对当中冒号与值之间要留空白</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/key-spacing" target="_blank" rel="noopener"><code>key-spacing</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123; <span class="string">'key'</span> : <span class="string">'value'</span> &#125;    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="string">'key'</span> :<span class="string">'value'</span> &#125;     <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="string">'key'</span>:<span class="string">'value'</span> &#125;      <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="string">'key'</span>: <span class="string">'value'</span> &#125;     <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>构造函数要以大写字母开头</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/new-cap" target="_blank" rel="noopener"><code>new-cap</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">animal</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> dog = <span class="keyword">new</span> animal()    <span class="comment">// ✗ avoid</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Animal</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> dog = <span class="keyword">new</span> Animal()    <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>无参的构造函数调用时要带上括号</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/new-parens" target="_blank" rel="noopener"><code>new-parens</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Animal</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> dog = <span class="keyword">new</span> Animal    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> dog = <span class="keyword">new</span> Animal()  <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>对象中定义了存值器，一定要对应的定义取值器</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/accessor-pairs" target="_blank" rel="noopener"><code>accessor-pairs</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  <span class="keyword">set</span> name (value) &#123;    <span class="comment">// ✗ avoid</span></span><br><span class="line">    <span class="keyword">this</span>.name = value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  <span class="keyword">set</span> name (value) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = value</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">get</span> name () &#123;         <span class="comment">// ✓ ok</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>子类的构造器中一定要调用 <code>super</code></strong></p>
<p>eslint: <a href="http://eslint.org/docs/rules/constructor-super" target="_blank" rel="noopener"><code>constructor-super</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">super</span>()   <span class="comment">// ✗ avoid</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Mammal</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">super</span>()   <span class="comment">// ✓ ok</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用数组字面量而不是构造器</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-array-constructor" target="_blank" rel="noopener"><code>no-array-constructor</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> nums = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)   <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> nums = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]            <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免使用 <code>arguments.callee</code> 和 <code>arguments.caller</code></strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-caller" target="_blank" rel="noopener"><code>no-caller</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> (<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">arguments</span>.callee(n - <span class="number">1</span>)   <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> (<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  foo(n - <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免对类名重新赋值</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-class-assign" target="_blank" rel="noopener"><code>no-class-assign</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;&#125;</span><br><span class="line">Dog = <span class="string">'Fido'</span>    <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免修改使用 <code>const</code> 声明的变量</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-const-assign" target="_blank" rel="noopener"><code>no-const-assign</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> score = <span class="number">100</span></span><br><span class="line">score = <span class="number">125</span>       <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免使用常量作为条件表达式的条件（循环语句除外）</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-constant-condition" target="_blank" rel="noopener"><code>no-constant-condition</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="literal">false</span>) &#123;    <span class="comment">// ✗ avoid</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (x === <span class="number">0</span>) &#123;  <span class="comment">// ✓ ok</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;  <span class="comment">// ✓ ok</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>正则中不要使用控制符</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-control-regex" target="_blank" rel="noopener"><code>no-control-regex</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> pattern = <span class="regexp">/\x1f/</span>    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> pattern = <span class="regexp">/\x20/</span>    <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要使用 <code>debugger</code></strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-debugger" target="_blank" rel="noopener"><code>no-debugger</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">debugger</span>      <span class="comment">// ✗ avoid</span></span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要对变量使用 <code>delete</code> 操作</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-delete-var" target="_blank" rel="noopener"><code>no-delete-var</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name</span><br><span class="line"><span class="keyword">delete</span> name     <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要定义冗余的函数参数</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-dupe-args" target="_blank" rel="noopener"><code>no-dupe-args</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span> (<span class="params">a, b, a</span>) </span>&#123;  <span class="comment">// ✗ avoid</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span> (<span class="params">a, b, c</span>) </span>&#123;  <span class="comment">// ✓ ok</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>类中不要定义冗余的属性</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-dupe-class-members" target="_blank" rel="noopener"><code>no-dupe-class-members</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">  bark () &#123;&#125;</span><br><span class="line">  bark () &#123;&#125;    <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>对象字面量中不要定义重复的属性</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-dupe-keys" target="_blank" rel="noopener"><code>no-dupe-keys</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> user = &#123;</span><br><span class="line">  name: <span class="string">'Jane Doe'</span>,</span><br><span class="line">  name: <span class="string">'John Doe'</span>    <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>switch</code> 语句中不要定义重复的 <code>case</code> 分支</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-duplicate-case" target="_blank" rel="noopener"><code>no-duplicate-case</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">switch</span> (id) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:     <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>同一模块有多个导入时一次性写完</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-duplicate-imports" target="_blank" rel="noopener"><code>no-duplicate-imports</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; myFunc1 &#125; <span class="keyword">from</span> <span class="string">'module'</span></span><br><span class="line"><span class="keyword">import</span> &#123; myFunc2 &#125; <span class="keyword">from</span> <span class="string">'module'</span>          <span class="comment">// ✗ avoid</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; myFunc1, myFunc2 &#125; <span class="keyword">from</span> <span class="string">'module'</span> <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>正则中不要使用空字符</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-empty-character-class" target="_blank" rel="noopener"><code>no-empty-character-class</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> myRegex = <span class="regexp">/^abc[]/</span>      <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> myRegex = <span class="regexp">/^abc[a-z]/</span>   <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要解构空值</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-empty-pattern" target="_blank" rel="noopener"><code>no-empty-pattern</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="attr">a</span>: &#123;&#125; &#125; = foo         <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">a</span>: &#123; b &#125; &#125; = foo      <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要使用 <code>eval()</code></strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-eval" target="_blank" rel="noopener"><code>no-eval</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">eval</span>( <span class="string">"var result = user."</span> + propName ) <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">var</span> result = user[propName]             <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>catch</code> 中不要对错误重新赋值</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-ex-assign" target="_blank" rel="noopener"><code>no-ex-assign</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  e = <span class="string">'new value'</span>             <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="keyword">const</span> newVal = <span class="string">'new value'</span>  <span class="comment">// ✓ ok</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要扩展原生对象</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-extend-native" target="_blank" rel="noopener"><code>no-extend-native</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Object</span>.prototype.age = <span class="number">21</span>     <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免多余的函数上下文绑定</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-extra-bind" target="_blank" rel="noopener"><code>no-extra-bind</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> name = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  getName()</span><br><span class="line">&#125;.bind(user)    <span class="comment">// ✗ avoid</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> name = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.getName()</span><br><span class="line">&#125;.bind(user)    <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免不必要的布尔转换</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-extra-boolean-cast" target="_blank" rel="noopener"><code>no-extra-boolean-cast</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="literal">true</span></span><br><span class="line"><span class="keyword">if</span> (!!result) &#123;   <span class="comment">// ✗ avoid</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="literal">true</span></span><br><span class="line"><span class="keyword">if</span> (result) &#123;     <span class="comment">// ✓ ok</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要使用多余的括号包裹函数</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-extra-parens" target="_blank" rel="noopener"><code>no-extra-parens</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> myFunc = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;)   <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> myFunc = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;     <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>switch</code> 一定要使用 <code>break</code> 来将条件分支正常中断</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-fallthrough" target="_blank" rel="noopener"><code>no-fallthrough</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">switch</span> (filter) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    doSomething()    <span class="comment">// ✗ avoid</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    doSomethingElse()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (filter) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    doSomething()</span><br><span class="line">    <span class="keyword">break</span>           <span class="comment">// ✓ ok</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    doSomethingElse()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (filter) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    doSomething()</span><br><span class="line">    <span class="comment">// fallthrough  // ✓ ok</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    doSomethingElse()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要省去小数点前面的0</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-floating-decimal" target="_blank" rel="noopener"><code>no-floating-decimal</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> discount = <span class="number">.5</span>      <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> discount = <span class="number">0.5</span>     <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免对声明过的函数重新赋值</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-func-assign" target="_blank" rel="noopener"><code>no-func-assign</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span> (<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line">myFunc = myOtherFunc    <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要对全局只读对象重新赋值</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-global-assign" target="_blank" rel="noopener"><code>no-global-assign</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">window</span> = &#123;&#125;     <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>注意隐式的 <code>eval()</code></strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-implied-eval" target="_blank" rel="noopener"><code>no-implied-eval</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">setTimeout(<span class="string">"alert('Hello world')"</span>)                   <span class="comment">// ✗ avoid</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; alert(<span class="string">'Hello world'</span>) &#125;)     <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>嵌套的代码块中禁止再定义函数</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-inner-declarations" target="_blank" rel="noopener"><code>no-inner-declarations</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (authenticated) &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setAuthUser</span> (<span class="params"></span>) </span>&#123;&#125;    <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要向 <code>RegExp</code> 构造器传入非法的正则表达式</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-invalid-regexp" target="_blank" rel="noopener"><code>no-invalid-regexp</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">RegExp</span>(<span class="string">'[a-z'</span>)    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="built_in">RegExp</span>(<span class="string">'[a-z]'</span>)   <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要使用非法的空白符</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-irregular-whitespace" target="_blank" rel="noopener"><code>no-irregular-whitespace</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span> (<span class="params"></span>) /*&lt;<span class="title">NBSP</span>&gt;*/</span>&#123;&#125;   <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>禁止使用 <code>__iterator__</code></strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-iterator" target="_blank" rel="noopener"><code>no-iterator</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Foo.prototype.__iterator__ = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;   <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>外部变量不要与对象属性重名</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-label-var" target="_blank" rel="noopener"><code>no-label-var</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> score = <span class="number">100</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">game</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  score: <span class="number">50</span>         <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要使用标签语句</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-labels" target="_blank" rel="noopener"><code>no-labels</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">label:</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">break</span> label     <span class="comment">// ✗ avoid</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要书写不必要的嵌套代码块</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-lone-blocks" target="_blank" rel="noopener"><code>no-lone-blocks</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  &#123;                   <span class="comment">// ✗ avoid</span></span><br><span class="line">    myOtherFunc()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  myOtherFunc()       <span class="comment">// ✓ ok</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要混合使用空格与制表符作为缩进</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-mixed-spaces-and-tabs" target="_blank" rel="noopener"><code>no-mixed-spaces-and-tabs</code></a></p>
</li>
<li><p><strong>除了缩进，不要使用多个空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-multi-spaces" target="_blank" rel="noopener"><code>no-multi-spaces</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> id =    <span class="number">1234</span>    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> id = <span class="number">1234</span>       <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要使用多行字符串</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-multi-str" target="_blank" rel="noopener"><code>no-multi-str</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">'Hello \</span></span><br><span class="line"><span class="string">                 world'</span>     <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>new</code> 创建对象实例后需要赋值给变量</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-new" target="_blank" rel="noopener"><code>no-new</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> Character()                     <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> character = <span class="keyword">new</span> Character()   <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>禁止使用 <code>Function</code> 构造器</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-new-func" target="_blank" rel="noopener"><code>no-new-func</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> sum = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'return a + b'</span>)    <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>禁止使用 <code>Object</code> 构造器</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-new-object" target="_blank" rel="noopener"><code>no-new-object</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> config = <span class="keyword">new</span> <span class="built_in">Object</span>()   <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>禁止使用 <code>new require</code></strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-new-require" target="_blank" rel="noopener"><code>no-new-require</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> myModule = <span class="keyword">new</span> <span class="built_in">require</span>(<span class="string">'my-module'</span>)    <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>禁止使用 <code>Symbol</code> 构造器</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-new-symbol" target="_blank" rel="noopener"><code>no-new-symbol</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = <span class="keyword">new</span> <span class="built_in">Symbol</span>(<span class="string">'foo'</span>)   <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>禁止使用原始包装器</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-new-wrappers" target="_blank" rel="noopener"><code>no-new-wrappers</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">'hello'</span>)   <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要将全局对象的属性作为函数调用</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-obj-calls" target="_blank" rel="noopener"><code>no-obj-calls</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> math = <span class="built_in">Math</span>()   <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要使用八进制字面量</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-octal" target="_blank" rel="noopener"><code>no-octal</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> num = <span class="number">042</span>     <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> num = <span class="string">'042'</span>   <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>字符串字面量中也不要使用八进制转义字符</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-octal-escape" target="_blank" rel="noopener"><code>no-octal-escape</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> copyright = <span class="string">'Copyright \251'</span>  <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用 <code>__dirname</code> 和 <code>__filename</code> 时尽量避免使用字符串拼接</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-path-concat" target="_blank" rel="noopener"><code>no-path-concat</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> pathToFile = __dirname + <span class="string">'/app.js'</span>            <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> pathToFile = path.join(__dirname, <span class="string">'app.js'</span>)   <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <code>getPrototypeOf</code> 来替代 <strong><code>__proto__</code></strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-proto" target="_blank" rel="noopener"><code>no-proto</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = obj.__proto__               <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> foo = <span class="built_in">Object</span>.getPrototypeOf(obj)  <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要重复声明变量</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-redeclare" target="_blank" rel="noopener"><code>no-redeclare</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> name = <span class="string">'John'</span></span><br><span class="line"><span class="keyword">let</span> name = <span class="string">'Jane'</span>     <span class="comment">// ✗ avoid</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> name = <span class="string">'John'</span></span><br><span class="line">name = <span class="string">'Jane'</span>         <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>正则中避免使用多个空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-regex-spaces" target="_blank" rel="noopener"><code>no-regex-spaces</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> regexp = <span class="regexp">/test   value/</span>   <span class="comment">// ✗ avoid</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> regexp = <span class="regexp">/test &#123;3&#125;value/</span>  <span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">const</span> regexp = <span class="regexp">/test value/</span>     <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>return 语句中的赋值必需有括号包裹</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-return-assign" target="_blank" rel="noopener"><code>no-return-assign</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> result = a + b     <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (result = a + b)   <span class="comment">// ✓ ok</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免将变量赋值给自己</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-self-assign" target="_blank" rel="noopener"><code>no-self-assign</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">name = name   <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免将变量与自己进行比较操作</strong>。</p>
<p>esint: <a href="http://eslint.org/docs/rules/no-self-compare" target="_blank" rel="noopener"><code>no-self-compare</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (score === score) &#123;&#125;   <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免使用逗号操作符</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-sequences" target="_blank" rel="noopener"><code>no-sequences</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (doSomething(), !!test) &#123;&#125;   <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要随意更改关键字的值</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-shadow-restricted-names" target="_blank" rel="noopener"><code>no-shadow-restricted-names</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="literal">undefined</span> = <span class="string">'value'</span>     <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>禁止使用稀疏数组（Sparse arrays）</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-sparse-arrays" target="_blank" rel="noopener"><code>no-sparse-arrays</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> fruits = [<span class="string">'apple'</span>,, <span class="string">'orange'</span>]       <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>不要使用制表符</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-tabs" target="_blank" rel="noopener"><code>no-tabs</code></a></p>
</li>
<li><p><strong>正确使用 ES6 中的字符串模板</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-template-curly-in-string" target="_blank" rel="noopener"><code>no-template-curly-in-string</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">'Hello $&#123;name&#125;'</span>   <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> message = <span class="string">`Hello <span class="subst">$&#123;name&#125;</span>`</span>   <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用 <code>this</code> 前请确保 <code>super()</code> 已调用</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-this-before-super" target="_blank" rel="noopener"><code>no-this-before-super</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">this</span>.legs = <span class="number">4</span>     <span class="comment">// ✗ avoid</span></span><br><span class="line">    <span class="keyword">super</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>用 <code>throw</code> 抛错时，抛出 <code>Error</code> 对象而不是字符串</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-throw-literal" target="_blank" rel="noopener"><code>no-throw-literal</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="string">'error'</span>               <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error'</span>)    <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>行末不留空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-trailing-spaces" target="_blank" rel="noopener"><code>no-trailing-spaces</code></a></p>
</li>
<li><p><strong>不要使用 <code>undefined</code> 来初始化变量</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-undef-init" target="_blank" rel="noopener"><code>no-undef-init</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> name = <span class="literal">undefined</span>    <span class="comment">// ✗ avoid</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> name</span><br><span class="line">name = <span class="string">'value'</span>          <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>循环语句中注意更新循环变量</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-unmodified-loop-condition" target="_blank" rel="noopener"><code>no-unmodified-loop-condition</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.length; j++) &#123;...&#125;    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.length; i++) &#123;...&#125;    <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>如果有更好的实现，尽量不要使用三元表达式</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-unneeded-ternary" target="_blank" rel="noopener"><code>no-unneeded-ternary</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> score = val ? val : <span class="number">0</span>     <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">let</span> score = val || <span class="number">0</span>          <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>return</code>，<code>throw</code>，<code>continue</code> 和 <code>break</code> 后不要再跟代码</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-unreachable" target="_blank" rel="noopener"><code>no-unreachable</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'never called'</span>)     <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>finally</code> 代码块中不要再改变程序执行流程</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-unsafe-finally" target="_blank" rel="noopener"><code>no-unsafe-finally</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">42</span>     <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>关系运算符的左值不要做取反操作</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-unsafe-negation" target="_blank" rel="noopener"><code>no-unsafe-negation</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!key <span class="keyword">in</span> obj) &#123;&#125;       <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免不必要的 <code>.call()</code> 和 <code>.apply()</code></strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-useless-call" target="_blank" rel="noopener"><code>no-useless-call</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">sum.call(<span class="literal">null</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)   <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免使用不必要的计算值作对象属性</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-useless-computed-key" target="_blank" rel="noopener"><code>no-useless-computed-key</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123; [<span class="string">'name'</span>]: <span class="string">'John Doe'</span> &#125;   <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> user = &#123; <span class="attr">name</span>: <span class="string">'John Doe'</span> &#125;       <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>禁止多余的构造器</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-useless-constructor" target="_blank" rel="noopener"><code>no-useless-constructor</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;      <span class="comment">// ✗ avoid</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>禁止不必要的转义</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-useless-escape" target="_blank" rel="noopener"><code>no-useless-escape</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> message = <span class="string">'Hell\o'</span>  <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>import, export 和解构操作中，禁止赋值到同名变量</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-useless-rename" target="_blank" rel="noopener"><code>no-useless-rename</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; config <span class="keyword">as</span> config &#125; <span class="keyword">from</span> <span class="string">'./config'</span>     <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">import</span> &#123; config &#125; <span class="keyword">from</span> <span class="string">'./config'</span>               <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>属性前面不要加空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-whitespace-before-property" target="_blank" rel="noopener"><code>no-whitespace-before-property</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">user .name      <span class="comment">// ✗ avoid</span></span><br><span class="line">user.name       <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>禁止使用 <code>with</code></strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-with" target="_blank" rel="noopener"><code>no-with</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> (val) &#123;...&#125;    <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>对象属性换行时注意统一代码风格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/object-property-newline" target="_blank" rel="noopener"><code>object-property-newline</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">  name: <span class="string">'Jane Doe'</span>, <span class="attr">age</span>: <span class="number">30</span>,</span><br><span class="line">  username: <span class="string">'jdoe86'</span>            <span class="comment">// ✗ avoid</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> user = &#123; <span class="attr">name</span>: <span class="string">'Jane Doe'</span>, <span class="attr">age</span>: <span class="number">30</span>, <span class="attr">username</span>: <span class="string">'jdoe86'</span> &#125;    <span class="comment">// ✓ ok</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">  name: <span class="string">'Jane Doe'</span>,</span><br><span class="line">  age: <span class="number">30</span>,</span><br><span class="line">  username: <span class="string">'jdoe86'</span></span><br><span class="line">&#125;                                                                 <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>代码块中避免多余留白</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/padded-blocks" target="_blank" rel="noopener"><code>padded-blocks</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (user) &#123;</span><br><span class="line">                            <span class="comment">// ✗ avoid</span></span><br><span class="line">  <span class="keyword">const</span> name = getName()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (user) &#123;</span><br><span class="line">  <span class="keyword">const</span> name = getName()    <span class="comment">// ✓ ok</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>展开运算符与它的表达式间不要留空白</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/rest-spread-spacing" target="_blank" rel="noopener"><code>rest-spread-spacing</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">fn(... args)    <span class="comment">// ✗ avoid</span></span><br><span class="line">fn(...args)     <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>遇到分号时空格要后留前不留</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/semi-spacing" target="_blank" rel="noopener"><code>semi-spacing</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span> ;i &lt; items.length ;i++) &#123;...&#125;    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.length; i++) &#123;...&#125;    <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>代码块首尾留空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/space-before-blocks" target="_blank" rel="noopener"><code>space-before-blocks</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (admin)&#123;...&#125;     <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">if</span> (admin) &#123;...&#125;    <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>圆括号间不留空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/space-in-parens" target="_blank" rel="noopener"><code>space-in-parens</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">getName( name )     <span class="comment">// ✗ avoid</span></span><br><span class="line">getName(name)       <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>一元运算符后面跟一个空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/space-unary-ops" target="_blank" rel="noopener"><code>space-unary-ops</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typeof</span>!admin        <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">typeof</span> !admin        <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>注释首尾留空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/spaced-comment" target="_blank" rel="noopener"><code>spaced-comment</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//comment           // ✗ avoid</span></span><br><span class="line"><span class="comment">// comment          // ✓ ok</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*comment*/</span>         <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="comment">/* comment */</span>       <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>模板字符串中变量前后不加空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/template-curly-spacing" target="_blank" rel="noopener"><code>template-curly-spacing</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="string">`Hello, <span class="subst">$&#123; name &#125;</span>`</span>    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">const</span> message = <span class="string">`Hello, <span class="subst">$&#123;name&#125;</span>`</span>      <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>检查 <code>NaN</code> 的正确姿势是使用 <code>isNaN()</code></strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/use-isnan" target="_blank" rel="noopener"><code>use-isnan</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (price === <span class="literal">NaN</span>) &#123; &#125;      <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">isNaN</span>(price)) &#123; &#125;       <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>用合法的字符串跟 <code>typeof</code> 进行比较操作</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/valid-typeof" target="_blank" rel="noopener"><code>valid-typeof</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typeof</span> name === <span class="string">'undefimed'</span>     <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">typeof</span> name === <span class="string">'undefined'</span>     <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>自调用匿名函数 (IIFEs) 使用括号包裹</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/wrap-iife" target="_blank" rel="noopener"><code>wrap-iife</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;()     <span class="comment">// ✗ avoid</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getName = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;())   <span class="comment">// ✓ ok</span></span><br><span class="line"><span class="keyword">const</span> getName = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;)()   <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>yield *</code> 中的 <code>*</code> 前后都要有空格</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/yield-star-spacing" target="_blank" rel="noopener"><code>yield-star-spacing</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">yield</span>* increment()    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">yield</span> * increment()   <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>请书写优雅的条件语句（avoid Yoda conditions）</strong>。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/yoda" target="_blank" rel="noopener"><code>yoda</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="number">42</span> === age) &#123; &#125;    <span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="keyword">if</span> (age === <span class="number">42</span>) &#123; &#125;    <span class="comment">// ✓ ok</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="关于分号"><a href="#关于分号" class="headerlink" title="关于分号"></a>关于分号</h2><ul>
<li><p>不要使用分号。 (参见：<a href="http://blog.izs.me/post/2353458699/an-open-letter-to-javascript-leaders-regarding" target="_blank" rel="noopener">1</a>，<a href="http://inimino.org/%7Einimino/blog/javascript_semicolons" target="_blank" rel="noopener">2</a>，<a href="https://www.youtube.com/watch?v=gsfbh17Ax9I" target="_blank" rel="noopener">3</a>)</p>
<p>eslint: <a href="http://eslint.org/docs/rules/semi" target="_blank" rel="noopener"><code>semi</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">window</span>.alert(<span class="string">'hi'</span>)   <span class="comment">// ✓ ok</span></span><br><span class="line"><span class="built_in">window</span>.alert(<span class="string">'hi'</span>);  <span class="comment">// ✗ avoid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>不要使用 <code>(</code>, <code>[</code>, or <code>`</code> 等作为一行的开始。在没有分号的情况下代码压缩后会导致报错，而坚持这一规范则可避免出错。</p>
<p>eslint: <a href="http://eslint.org/docs/rules/no-unexpected-multiline" target="_blank" rel="noopener"><code>no-unexpected-multiline</code></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line">;(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.alert(<span class="string">'ok'</span>)</span><br><span class="line">&#125;())</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.alert(<span class="string">'ok'</span>)</span><br><span class="line">&#125;())</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line">;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].forEach(bar)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].forEach(bar)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ✓ ok</span></span><br><span class="line">;<span class="string">`hello`</span>.indexOf(<span class="string">'o'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✗ avoid</span></span><br><span class="line"><span class="string">`hello`</span>.indexOf(<span class="string">'o'</span>)</span><br></pre></td></tr></table></figure>
<p>备注：上面的写法只能说聪明过头了。</p>
<p>相比更加可读易懂的代码，那些看似投巧的写法是不可取的。</p>
<p>譬如：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].forEach(bar)</span><br></pre></td></tr></table></figure>
<p>建议的写法是：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> nums = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">nums.forEach(bar)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="拓展阅读"><a href="#拓展阅读" class="headerlink" title="拓展阅读"></a>拓展阅读</h2><ul>
<li><a href="http://blog.izs.me/post/2353458699/an-open-letter-to-javascript-leaders-regarding" target="_blank" rel="noopener">An Open Letter to JavaScript Leaders Regarding Semicolons</a></li>
<li><a href="http://inimino.org/~inimino/blog/javascript_semicolons" target="_blank" rel="noopener">JavaScript Semicolon Insertion – Everything you need to know</a></li>
</ul>
<h5 id="一个值得观看的视频："><a href="#一个值得观看的视频：" class="headerlink" title="一个值得观看的视频："></a>一个值得观看的视频：</h5><ul>
<li><a href="https://www.youtube.com/watch?v=gsfbh17Ax9I" target="_blank" rel="noopener">JavaScript 中的分号多余吗？- YouTube</a></li>
</ul>
<p>当前主流的代码压缩方案都是基于词法（AST-based）进行的，所以在处理无分号的代码时完全没有压力（何况 JavaScript 中分号本来就不是强制的）。</p>
<h5 id="一段摘抄自-“An-Open-Letter-to-JavaScript-Leaders-Regarding-Semicolons”-这篇文章的内容："><a href="#一段摘抄自-“An-Open-Letter-to-JavaScript-Leaders-Regarding-Semicolons”-这篇文章的内容：" class="headerlink" title="一段摘抄自 “An Open Letter to JavaScript Leaders Regarding Semicolons” 这篇文章的内容："></a>一段摘抄自 <em><a href="http://blog.izs.me/post/2353458699/an-open-letter-to-javascript-leaders-regarding" target="_blank" rel="noopener">“An Open Letter to JavaScript Leaders Regarding Semicolons”</a></em> 这篇文章的内容：</h5><blockquote>
<p>[自动化插入分号的做法]是安全可依赖的，而且其产出的代码能够在所有浏览器里很好地运行。 Closure compiler, yuicompressor, packer 还有 jsmin 都能正确地对这样的代码进行压缩处理。并没有任何性能相关的问题。</p>
<p>不得不说，Javascript 社区里的大牛们一直是错误的，并不能教给你最佳实践。真是让人忧伤啊。 我建议先弄清楚 JS 是怎样断句的（还有就是哪些地方看起来断了其实并没有），明白了这个后就可以随心写出漂亮的代码了。</p>
<p>一般来说， <code>\n</code> 表示语句结束，除非：</p>
<pre><code>1. 该语句有未闭合的括号， 数组字面量， 对象字面量 或者其他不能正常结束一条语句的情况（譬如，以 `.` 或 `,` 结尾）
2. 该语句是 `--` 或者 `++` （它会将后面的内容进行自增或减）
3. 该语句是 `for()`，`while()`，`do`，`if()` 或者 `else` 并且没有 `{`
4. 下一行以 `[`，`(`，`+`，`*`，`/`，`-`，`,`，`.` 或者其他只会单独出现在两块内容间的二元操作符。
</code></pre><p>第一条很容易理解。即使在 JSLint 中，也允许 JSON，构造器的括号中，以及使用 <code>var</code> 配合 <code>,</code> 结尾来声明多个变量等这些情中包含 <code>\n</code>。</p>
<p>第二条有点奇葩。 我还想不出谁会（除了这里用作讨论外）写出 <code>i\n++\nj</code> 这样的代码来，不过，顺便说一下，这种写法最后解析的结果是 <code>i; ++j</code>，而不是 <code>i++; j</code>。</p>
<p>第三条也容易理解。 <code>if (x)\ny()</code> 等价于 <code>if (x) { y() }</code>。解释器会向下寻找到代码块或一条语句为止。</p>
<p><code>;</code> 是条合法的 JavaScript 语句。所以 <code>if(x);</code> 等价于 <code>if(x){}</code>，表示 “如果 x 为真，什么也不做。” 这种写法在循环里面可以看到，就是当条件判断与条件更新是同一个方法的时候。 不常见，但也不至于没听说过吧。</p>
<p>第四条就是常见的 “看，说过要加分号！” 的情形。但这些情况可以通过在语句前面加上分号来解决，如果你确定该语句跟前面的没关系的话。举个例子，假如你想这样：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; foo();</span><br><span class="line">&gt; [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].forEach(bar);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>那么完全可以这样来写：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&gt; foo()</span><br><span class="line">&gt; ;[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].forEach(bar)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>后者的好处是分号比较瞩目，一旦习惯后便再也不会看到以 <code>(</code> 和 <code>[</code> 开头又不带分号的语句了。</p>
</blockquote>
]]></content>
  </entry>
  <entry>
    <title>浅析Yii2中GridView</title>
    <url>/2017/01/25/yii-girdview/</url>
    <content><![CDATA[<p>是否显示某列案例<br>我们举一个简单的案例<br>条件：有一个get形参数type<br>需求：仅且type的值等于1的时候，列name才显示，否则该列不显示<br><a id="more"></a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line"><span class="string">'attribute'</span> =&gt; <span class="string">'name'</span>,</span><br><span class="line"><span class="string">'value'</span> =&gt; $model-&gt;name,</span><br><span class="line"><span class="string">'visible'</span> =&gt; intval(Yii::$app-&gt;request-&gt;get(<span class="string">'type'</span>)) == <span class="number">1</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>链接可点击跳转案例</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line"><span class="string">'attribute'</span> =&gt; <span class="string">'order_id'</span>,</span><br><span class="line"><span class="string">'value'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($model)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Html::a($model-&gt;order_id, <span class="string">"/order?id=&#123;$model-&gt;order_id&#125;"</span>, [<span class="string">'target'</span> =&gt; <span class="string">'_blank'</span>]);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">'format'</span> =&gt; <span class="string">'raw'</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>这里只需要指定format格式为image即可，format第二个参数可设定图片大小<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line"><span class="string">'label'</span> =&gt; <span class="string">'头像'</span>,</span><br><span class="line"><span class="string">'format'</span> =&gt; [</span><br><span class="line"><span class="string">'image'</span>, </span><br><span class="line">[</span><br><span class="line"><span class="string">'width'</span>=&gt;<span class="string">'84'</span>,</span><br><span class="line"><span class="string">'height'</span>=&gt;<span class="string">'84'</span></span><br><span class="line">]</span><br><span class="line">],</span><br><span class="line"><span class="string">'value'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($model)</span> </span>&#123; </span><br><span class="line"><span class="keyword">return</span> $model-&gt;image; </span><br><span class="line">&#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure></p>
<p>html渲染案例</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line"><span class="string">'attribute'</span> =&gt; <span class="string">'title'</span>,</span><br><span class="line">	<span class="string">'value'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($model)</span> </span>&#123; </span><br><span class="line">	<span class="keyword">return</span> Html::encode($model-&gt;title); </span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">'format'</span> =&gt; <span class="string">'raw'</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>自定义按钮案例</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line"><span class="string">'class'</span> =&gt; <span class="string">'yii\grid\ActionColumn'</span>,</span><br><span class="line"><span class="string">'template'</span> =&gt; <span class="string">'&#123;get-xxx&#125; &#123;view&#125; &#123;update&#125;'</span>,</span><br><span class="line"><span class="string">'header'</span> =&gt; <span class="string">'操作'</span>,</span><br><span class="line"><span class="string">'buttons'</span> =&gt; [</span><br><span class="line"><span class="string">'get-xxx'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($url, $model, $key)</span> </span>&#123; </span><br><span class="line"><span class="keyword">return</span> Html::a(<span class="string">'获取xxx'</span>, $url, [<span class="string">'title'</span> =&gt; <span class="string">'获取xxx'</span>] ); </span><br><span class="line">&#125;,</span><br><span class="line">],</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>设定宽度案例</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line"><span class="string">'attribute'</span> =&gt; <span class="string">'title'</span>,</span><br><span class="line"><span class="string">'value'</span> =&gt; <span class="string">'title'</span>,</span><br><span class="line"><span class="string">'headerOptions'</span> =&gt; [<span class="string">'width'</span> =&gt; <span class="string">'100'</span>],</span><br><span class="line"><span class="string">'contentOptions'</span>=&gt;[<span class="string">'width'</span>=&gt;<span class="number">20</span>]</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'rowOptions'</span> =&gt; <span class="function"><span class="keyword">function</span><span class="params">($model, $key, $index, $grid)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> [<span class="string">'class'</span> =&gt; $index % <span class="number">2</span> ==<span class="number">0</span> ? <span class="string">'label-red'</span> : <span class="string">'label-green'</span>];</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>增加按钮调用js操作案例</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line"><span class="string">'class'</span> =&gt; <span class="string">'yii\grid\ActionColumn'</span>,</span><br><span class="line"><span class="string">'header'</span> =&gt; <span class="string">'操作'</span>,</span><br><span class="line"><span class="string">'template'</span> =&gt; <span class="string">'&#123;view&#125; &#123;update&#125; &#123;update-status&#125;'</span>,</span><br><span class="line"><span class="string">'buttons'</span> =&gt; [</span><br><span class="line"><span class="string">'update-status'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($url, $model, $key)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Html::a(<span class="string">'更新状态'</span>, <span class="string">'javascript:;'</span>, [<span class="string">'onclick'</span>=&gt;<span class="string">'update_status(this, '</span>.$model-&gt;id.<span class="string">');'</span>]); &#125;,</span><br><span class="line">],</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<ol>
<li><p>处理时间<br>数据列的主要配置项是 yii\grid\DataColumn::format 属性。<br>它的值默认是使用 \yii\i18n\Formatter 应用组件。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">&apos;label&apos;=&gt;&apos;更新日期&apos;,</span><br><span class="line">&apos;format&apos; =&gt; [&apos;date&apos;, &apos;php:Y-m-d&apos;],</span><br><span class="line">&apos;value&apos; =&gt; &apos;updated_at&apos;</span><br><span class="line">],</span><br><span class="line">//or</span><br><span class="line">[</span><br><span class="line">//&apos;attribute&apos; =&gt; &apos;created_at&apos;,</span><br><span class="line">&apos;label&apos;=&gt;&apos;更新时间&apos;,</span><br><span class="line">&apos;value&apos;=&gt;function($model)&#123;</span><br><span class="line">return date(&apos;Y-m-d H:i:s&apos;,$model-&gt;created_at); </span><br><span class="line">&#125;,</span><br><span class="line">&apos;headerOptions&apos; =&gt; [&apos;width&apos; =&gt; &apos;170&apos;],</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
<li><p>处理图片</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">&apos;label&apos;=&gt;&apos;封面图&apos;,</span><br><span class="line">&apos;format&apos;=&gt;&apos;raw&apos;,</span><br><span class="line">&apos;value&apos;=&gt;function($m)&#123;</span><br><span class="line">return Html::img($m-&gt;cover,</span><br><span class="line">[&apos;class&apos; =&gt; &apos;img-circle&apos;,</span><br><span class="line">&apos;width&apos; =&gt; 30]</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据列有链接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">&apos;attribute&apos; =&gt; &apos;title&apos;,</span><br><span class="line">&apos;value&apos; =&gt; function ($model, $key, $index, $column) &#123;</span><br><span class="line">return Html::a($model-&gt;title, </span><br><span class="line">[&apos;article/view&apos;, &apos;id&apos; =&gt; $key]);</span><br><span class="line">&#125;,</span><br><span class="line">&apos;format&apos; =&gt; &apos;raw&apos;,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据列显示枚举值(男/女）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">&apos;attribute&apos; =&gt; &apos;sex&apos;, </span><br><span class="line">&apos;value&apos;=&gt;function ($model,$key,$index,$column)&#123;</span><br><span class="line">return $model-&gt;sex==1?&apos;男&apos;:&apos;女&apos;; </span><br><span class="line">&#125;，</span><br><span class="line">//在搜索条件（过滤条件）中使用下拉框来搜索</span><br><span class="line">&apos;filter&apos; =&gt; [&apos;1&apos;=&gt;&apos;男&apos;,&apos;0&apos;=&gt;&apos;女&apos;],</span><br><span class="line">//or</span><br><span class="line">&apos;filter&apos; =&gt; Html::activeDropDownList($searchModel,</span><br><span class="line">&apos;sex&apos;,[&apos;1&apos;=&gt;&apos;男&apos;,&apos;0&apos;=&gt;&apos;女&apos;],</span><br><span class="line">[&apos;prompt&apos;=&gt;&apos;全部&apos;]</span><br><span class="line">)</span><br><span class="line">],</span><br><span class="line">[</span><br><span class="line">&apos;label&apos;=&gt;&apos;产品状态&apos;, </span><br><span class="line">&apos;attribute&apos; =&gt; &apos;pro_name&apos;, </span><br><span class="line">&apos;value&apos; =&gt; function ($model) &#123;</span><br><span class="line">$state = [</span><br><span class="line">&apos;0&apos; =&gt; &apos;未发货&apos;,</span><br><span class="line">&apos;1&apos; =&gt; &apos;已发货&apos;,</span><br><span class="line">&apos;9&apos; =&gt; &apos;退货，已处理&apos;,</span><br><span class="line">];</span><br><span class="line">return $state[$model-&gt;pro_name];</span><br><span class="line">&#125;,</span><br><span class="line">&apos;headerOptions&apos; =&gt; [&apos;width&apos; =&gt; &apos;120&apos;] </span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>1对多类业务架构分割</title>
    <url>/2017/07/11/one2more-db-separation/</url>
    <content><![CDATA[<p>本文将以“帖子中心”为例，介绍“1对多”类业务，随着数据量的逐步增大，数据库性能显著降低，数据库水平切分相关的架构实践：</p>
<ul>
<li>如何来实施水平切分</li>
<li>水平切分后常见的问题</li>
<li>典型问题的优化思路及实践</li>
</ul>
<p>一、什么是1对多关系<br>所谓的“1对1”，“1对多”，“多对多”，来自数据库设计中的“实体-关系”ER模型，用来描述实体之间的映射关系。</p>
 <a id="more"></a>
<p>1对1</p>
<ul>
<li>一个用户只有一个登录名，一个登录名只对应一个用户</li>
<li>一个uid对应一个login_name，一个login_name只对应一个uid<br>这是一个1对1的关系。</li>
</ul>
<p>1对多</p>
<ul>
<li>一个用户可以发多条微博，一条微博只有一个发送者</li>
<li>一个uid对应多个msg_id，一个msg_id只对应一个uid<br>这是一个1对多的关系。</li>
</ul>
<p>多对多</p>
<ul>
<li>一个用户可以关注多个用户</li>
<li>一个用户也可以被多个粉丝关注<br>这是一个多对多的关系。</li>
</ul>
<p>二、帖子中心业务分析</p>
<p>帖子中心是一个典型的1对多业务。</p>
<p>一个用户可以发布多个帖子，一个帖子只对应一个发布者。</p>
<p>任何脱离业务的架构设计都是耍流氓，先来看看帖子中心对应的业务需求。</p>
<p>帖子中心，是一个提供帖子发布/修改/删除/查看/搜索的服务。</p>
<p>写操作：</p>
<ul>
<li>发布(insert)帖子</li>
<li>修改(update)帖子</li>
<li>删除(delete)帖子</li>
</ul>
<p>读操作：</p>
<ul>
<li>通过tid查询(select)帖子实体，单行查询</li>
<li>通过uid查询(select)用户发布过的帖子，列表查询</li>
<li>帖子检索(search)，例如通过时间、标题、内容搜索符合条件的帖子</li>
</ul>
<p>在数据量较大，并发量较大的时候，通常通过元数据与索引数据分离的架构来满足不同类型的需求：</p>
<p>架构中的几个关键点：</p>
<ul>
<li>tiezi-center：帖子服务</li>
<li>tiezi-db：提供元数据存储</li>
<li>tiezi-search：帖子搜索服务</li>
<li>tiezi-index：提供索引数据存储</li>
<li>MQ：tiezi-center与tiezi-search通讯媒介，一般不直接使用RPC调用，而是通过MQ对两个子系统解耦（为何这么解耦，请参见《到底什么时候该使用MQ？》）</li>
</ul>
<p>其中，tiezi-center和tiezi-search分别满足两类不同的读需求：</p>
<p>如上图所示：</p>
<ul>
<li>tid和uid上的查询需求，可以由tiezi-center从元数据读取并返回</li>
<li>其他类检索需求，可以由tiezi-search从索引数据检索并返回</li>
</ul>
<p>对于写需求：</p>
<p>如上图所示：</p>
<ul>
<li>增加，修改，删除的操作都会从tiezi-center发起</li>
<li>tiezi-center修改元数据</li>
<li>tiezi-center将信息修改通知发送给MQ</li>
<li>tiezi-search从MQ接受修改信息</li>
<li>tiezi-search修改索引数据</li>
</ul>
<p>tiezi-search，搜索架构不是本文的重点（外置索引架构设计，请参见《100亿数据1万属性数据架构设计》），后文将重点描述帖子中心元数据这一块的水平切分设计。</p>
<p>三、帖子中心元数据设计<br>通过帖子中心业务分析，很容易了解到，其核心元数据为：<br>Tiezi(tid, uid, time, title, content, …);<br>其中：</p>
<ul>
<li>tid为帖子ID，主键</li>
<li>uid为用户ID，发帖人</li>
<li>time, title, content …等为帖子属性</li>
</ul>
<p>数据库设计上，在业务初期，单库就能满足元数据存储要求，其典型的架构设计为：</p>
<ul>
<li>tiezi-center：帖子中心服务，对调用者提供友好的RPC接口</li>
<li>tiezi-db：对帖子数据进行存储</li>
</ul>
<p>在相关字段上建立索引，就能满足相关业务需求：</p>
<ul>
<li>帖子记录查询，通过tid查询，约占读请求量90%<br>select * from t_tiezi where tid=$tid</li>
<li>帖子列表查询，通过uid查询其发布的所有帖子，约占读请求量10%<br>select * from t_tiezi where uid=$uid</li>
</ul>
<p>四、帖子中心水平切分-tid切分法<br>当数据量越来越大时，需要对帖子数据的存储进行线性扩展。</p>
<p>既然是帖子中心，并且帖子记录查询量占了总请求的90%，很容易想到通过tid字段取模来进行水平切分：</p>
<p>这个方法简单直接，优点：</p>
<ul>
<li>100%写请求可以直接定位到库</li>
<li>90%的读请求可以直接定位到库</li>
</ul>
<p>缺点：</p>
<ul>
<li>一个用户发布的所有帖子可能会落到不同的库上，10%的请求通过uid来查询会比较麻烦</li>
</ul>
<p>如上图，一个uid访问需要遍历所有库。</p>
<p>五、帖子中心水平切分-uid切分法<br>有没有一种切分方法，确保同一个用户发布的所有帖子都落在同一个库上，而在查询一个用户发布的所有帖子时，不需要去遍历所有的库呢？<br>答：使用uid来分库可以解决这个问题。</p>
<p>新出现的问题：如果使用uid来分库，确保了一个用户的帖子数据落在同一个库上，那通过tid来查询，就不知道这个帖子落在哪个库上了，岂不是还需要遍历全库，需要怎么优化呢？<br>答：tid的查询是单行记录查询，只要在数据库（或者缓存）记录tid到uid的映射关系，就能解决这个问题。</p>
<p>新增一个索引库：<br>t_mapping(tid, uid);</p>
<ul>
<li>这个库只有两列，可以承载很多数据</li>
<li>即使数据量过大，索引库可以利用tid水平切分</li>
<li>这类kv形式的索引结构，可以很好的利用cache优化查询性能</li>
<li>一旦帖子发布，tid和uid的映射关系就不会发生变化，cache的命中率会非常高</li>
</ul>
<p>使用uid分库，并增加索引库记录tid到uid的映射关系之后，每当有uid上的查询：</p>
<p>可以通过uid直接定位到库。</p>
<p>每当有tid上的查询：</p>
<ul>
<li>先查询索引表，通过tid查询到对应的uid</li>
<li>再通过uid定位到库</li>
</ul>
<p>这个方法的优点：</p>
<ul>
<li>一个用户发布的所以帖子落在同一个库上</li>
<li>10%的请求过过uid来查询列表，可以直接定位到库</li>
<li>索引表cache命中率非常高，因为tid与uid的映射关系不会变</li>
</ul>
<p>缺点：</p>
<ul>
<li>90%的tid请求，以及100%的修改请求，不能直接定位到库，需要先进行一次索引表的查询，当然这个查询非常块，通常在5ms内可以返回</li>
<li>数据插入时需要操作元数据与索引表，可能引发潜在的一致性问题</li>
</ul>
<p>六、帖子中心水平切分-基因法<br>有没有一种方法，既能够通过uid定位到库，又不需要建立索引表来进行二次查询呢，这就是本文要叙述的“1对多”业务分库最佳实践，基因法。</p>
<p>什么是分库基因？<br>通过uid分库，假设分为16个库，采用uid%16的方式来进行数据库路由，这里的uid%16，其本质是uid的最后4个bit决定这行数据落在哪个库上，这4个bit，就是分库基因。</p>
<p>什么是基因法分库？<br>在“1对多”的业务场景，使用“1”分库，在“多”的数据id生成时，id末端加入分库基因，就能同时满足“1”和“多”的分库查询需求。</p>
<p>如上图所示，uid=666的用户发布了一条帖子（666的二进制表示为：1010011010）：</p>
<ul>
<li>使用uid%16分库，决定这行数据要插入到哪个库中</li>
<li>分库基因是uid的最后4个bit，即1010</li>
<li>在生成tid时，先使用一种分布式ID生成算法生成前60bit（上图中绿色部分）</li>
<li>将分库基因加入到tid的最后4个bit（上图中粉色部分）</li>
<li>拼装成最终的64bit帖子tid（上图中蓝色部分）<br>（怎么生成60bit分布式唯一ID，请参见《分布式ID生成算法》）</li>
</ul>
<p>这般，保证了同一个用户发布的所有帖子的tid，都落在同一个库上，tid的最后4个bit都相同，于是：</p>
<ul>
<li>通过uid%16能够定位到库</li>
<li>通过tid%16也能定位到库</li>
</ul>
<p>潜在问题一：同一个uid发布的tid落在同一个库上，会不会出现数据不均衡？<br>答：只要uid是均衡的，每个用户发布的平均帖子数是均衡的，每个库的数据就是均衡的。</p>
<p>潜在问题二：最开始分16库，分库基因是4bit，未来要扩充成32库，分库基因变成了5bit，那怎么办？<br>答：需要提前做好容量预估，例如事先规划好5年内数据增长256库足够，就提前预留8bit基因。</p>
<p>七、总结<br>将以“帖子中心”为典型的“1对多”类业务，在架构上，采用元数据与索引数据分离的架构设计方法：</p>
<ul>
<li>帖子服务，元数据满足uid和tid的查询需求</li>
<li>搜索服务，索引数据满足复杂搜索寻求</li>
</ul>
<p>对于元数据的存储，在数据量较大的情况下，有三种常见的切分方法：</p>
<ul>
<li>tid切分法，按照tid分库，同一个用户发布的帖子落在不同的库上，通过uid来查询要遍历所有库</li>
<li>uid切分法，按照uid分库，同一个用户发布的帖子落在同一个库上，需要通过索引表或者缓存来记录tid与uid的映射关系，通过tid来查询时，先查到uid，再通过uid定位库</li>
<li>基因法，按照uid分库，在生成tid里加入uid上的分库基因，保证通过uid和tid都能直接定位到库</li>
</ul>
<p>对于1对多的业务场景，分库架构不再是瓶颈。</p>
]]></content>
  </entry>
  <entry>
    <title>倒排索引</title>
    <url>/2016/08/11/Inverted-index/</url>
    <content><![CDATA[<h3 id="正排索引和倒排索引"><a href="#正排索引和倒排索引" class="headerlink" title="正排索引和倒排索引"></a>正排索引和倒排索引</h3><p><strong>倒排索引</strong>（英语：Inverted index），也常被称为<strong>反向索引</strong>、<strong>置入档案</strong>或<strong>反向档案</strong>，被用来存储在全文搜索下某个单词在一个文档或者一组文档中的存储位置的映射。它是文档检索系统中最常用的数据结构。<br><a id="more"></a><br>有两种不同的反向索引形式：</p>
<p>一条记录的水平反向索引（或者反向档案索引）包含每个引用单词的文档的列表。<br>一个单词的水平反向索引（或者完全反向索引）又包含每个单词在一个文档中的位置。<br>后者的形式提供了更多的兼容性（比如短语搜索），但是需要更多的时间和空间来创建。</p>
<p>所谓的正排索引是从索引文档到关键词到内容，倒排索引则是相反从关键词到词频，位置，目录等信息，现在通常用于搜索的。由于互联网上的数据量无限大，不可能存储足够多的文档，所以正排索引用处不大。</p>
<p>有两种不同的反向索引形式：</p>
<ul>
<li><p>一条记录的水平反向索引（或者反向档案索引）包含每个引用单词的文档的<a href="https://zh.wikipedia.org/wiki/%E5%88%97%E8%A1%A8" target="_blank" rel="noopener">列表</a>。</p>
</li>
<li><p>一个单词的水平反向索引（或者完全反向索引）又包含每个单词在一个文档中的位置。</p>
</li>
</ul>
<p>  ​我们就能得到下面的反向文件索引：</p>
<ul>
<li><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/1ab3d9202f18a678affe9a339511bef0a7b8b110" alt="{\displaystyleT_{0}=}"><code>&quot;it is what it is&quot;</code></li>
<li><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/57ac5840245616f79874f4635b3bcb2e3da344dd" alt="{\displaystyleT_{1}=}"><code>&quot;what is it&quot;</code></li>
<li><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/5713cf5634b3846b4d68c3383b65db289511d8bf" alt="{\displaystyleT_{2}=}"><code>&quot;it is a banana&quot;</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;a&quot;:      &#123;2&#125;</span><br><span class="line">&quot;banana&quot;: &#123;2&#125;</span><br><span class="line">&quot;is&quot;:     &#123;0, 1, 2&#125;</span><br><span class="line">&quot;it&quot;:     &#123;0, 1, 2&#125;</span><br><span class="line">&quot;what&quot;:   &#123;0, 1&#125;</span><br></pre></td></tr></table></figure>
<p>检索的条件”what”, “is” 和 “it” 将对应这个集合： <img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/576f880df65391031d612f3d9130ebd81575f6a1" alt="coll"></p>
<p>对相同的文字，我们得到后面这些完全反向索引，有文档数量和当前查询的单词结果组成的的成对数据。 同样，文档数量和当前查询的单词结果都从零开始。所以，<code>&quot;banana&quot;: {(2, 3)}</code> 就是说 “banana”在第三个文档里 ( {\displaystyle T_{2}} T_{2})，而且在第三个文档的位置是第四个单词(地址为 3)。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;a&quot;:      &#123;(2, 2)&#125;</span><br><span class="line">&quot;banana&quot;: &#123;(2, 3)&#125;</span><br><span class="line">&quot;is&quot;:     &#123;(0, 1), (0, 4), (1, 1), (2, 1)&#125;</span><br><span class="line">&quot;it&quot;:     &#123;(0, 0), (0, 3), (1, 2), (2, 0)&#125;</span><br><span class="line">&quot;what&quot;:   &#123;(0, 2), (1, 0)&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们执行短语搜索”what is it” 我们得到这个短语的全部单词各自的结果所在文档为文档0和文档1。但是这个短语检索的连续的条件仅仅在文档1得到。</p>
<p>反向索引数据结构是典型的搜索引擎检索算法重要的部分。<br>一个搜索引擎执行的目标就是优化查询的速度：找到某个单词在文档中出现的地方。以前，正向索引开发出来用来存储每个文档的单词的列表，接着掉头来开发了一种反向索引。 正向索引的查询往往满足每个文档有序频繁的全文查询和每个单词在校验文档中的验证这样的查询。<br>实际上，时间、内存、处理器等等资源的限制，技术上正向索引是不能实现的。<br>为了替代正向索引的每个文档的单词列表，能列出每个查询的单词所有所在文档的列表的反向索引数据结构开发了出来。<br>随着反向索引的创建，如今的查询能通过立即的单词标示迅速获取结果（经过随机存储）。随机存储也通常被认为快于顺序存储。</p>
<h3 id="构建方法"><a href="#构建方法" class="headerlink" title="构建方法"></a>构建方法</h3><h4 id="简单法"><a href="#简单法" class="headerlink" title="简单法"></a>简单法</h4><p>  索引的构建[4]  相当于从正排表到倒排表的建立过程。当我们分析完网页时 ,得到的是以网页为主码的索引表。当索引建立完成后 ,应得到倒排表 ,具体流程如图所示：<br>  流程描述如下：<br>  1）将文档分析称单词term标记，<br>  2）使用hash去重单词term<br>  　　3）对单词生成倒排列表<br>  　　倒排列表就是文档编号DocID，没有包含其他的信息（如词频，单词位置等），这就是简单的索引。<br>  　　这个简单索引功能可以用于小数据，例如索引几千个文档。然而它有两点限制：<br>  　　1）需要有足够的内存来存储倒排表，对于搜索引擎来说， 都是G级别数据，特别是当规模不断扩大时 ,我们根本不可能提供这么多的内存。<br>  　　2）算法是顺序执行，不便于并行处理。</p>
<h4 id="合并法"><a href="#合并法" class="headerlink" title="合并法"></a>合并法</h4><p>  归并法[4]  ,即每次将内存中数据写入磁盘时，包括词典在内的所有中间结果信息都被写入磁盘，这样内存所有内容都可以被清空，后续建立索引可以使用全部的定额内存。<br>  归并索引<br>  归并索引<br>  如图 归并示意图：<br>  合并流程：<br>  1）页面分析，生成临时倒排数据索引A，B，当临时倒排数据索引A，B占满内存后，将内存索引A，B写入临时文件生成临时倒排文件，<br>  　　2) 对生成的多个临时倒排文件 ,执行多路归并 ,输出得到最终的倒排文件 ( inverted file)。<br>  合并流程<br>  合并流程<br>  索引创建过程中的页面分析 ,特别是中文分词为主要时间开销。算法的第二步相对很快。这样创建算法的优化集中在中文分词效率上。</p>
<blockquote>
</blockquote>
]]></content>
  </entry>
  <entry>
    <title>beyond feeling 读书笔记</title>
    <url>/2016/07/30/beyond-feeling/</url>
    <content><![CDATA[<blockquote>
<p>我们的很多思考与想法都源于自己大脑底层的思想来源，对于我们社会人受到家庭，学校，大众媒体各种各样的影响，对一个事物的认识早已经不是我们自己思考的结果，可能早已经被“操纵”了。如果成长为一个独立的个体，超越情感，保持个性。就这这本出提供给我们的一些方法论。</p>
</blockquote>
<a id="more"></a>
<h1 id="你是谁"><a href="#你是谁" class="headerlink" title="你是谁"></a>你是谁</h1><h2 id="时间和地点的影响"><a href="#时间和地点的影响" class="headerlink" title="时间和地点的影响"></a>时间和地点的影响</h2><h2 id="大众文化的影响"><a href="#大众文化的影响" class="headerlink" title="大众文化的影响"></a>大众文化的影响</h2><h2 id="操纵的学问"><a href="#操纵的学问" class="headerlink" title="操纵的学问"></a>操纵的学问</h2><p>美国心理学家约翰沃森（John Watson）行为主义之父的称号，发现对消费者吸引不在思维<code>而在情感。</code>这种行为操纵被用于广告商、甚至是政界。<br>我们已有的观念逻辑，也就早已经被植入到自己的“磁带中”，当我们听到这个观点时候就自动“回放”，我们早没有独立思考的能力，已经被植入很多概念。我们视为最珍贵的、并以最大热情捍卫的许多信仰，也许就是这种方式根植于我们的大脑中了。</p>
<h2 id="心理学的影响"><a href="#心理学的影响" class="headerlink" title="心理学的影响"></a>心理学的影响</h2><h2 id="成为个体"><a href="#成为个体" class="headerlink" title="成为个体"></a>成为个体</h2><p>我们如何看待个性？后天获得的。我们不可能逃脱他人和环境的影响。个性的的本质就是警惕。下面的指导原则将帮助你达到这一点：</p>
<ol>
<li><strong> 把你对任何人、议题、或情势的第一反应看作是尝试性的。</strong> 无论他多么吸引人，在你未考察它之前，都不要接受他。</li>
<li><strong> 判断你为什么有这种反应。</strong> 考虑你是不是借鉴其他人－－朋友、父母或者名人、电视中虚构的角色。如果可能，确定是什么特定的经验让你做出这样的选择。</li>
<li><strong> 考虑你有可能对这个人、议题或情势做出其他反应的可能。 </strong></li>
<li><strong> 询问你自己是否还有其他比你的第一反应更恰当的反应 </strong> 你在回答时，排除你的制约条件的影响。</li>
</ol>
<h2 id="应用练习"><a href="#应用练习" class="headerlink" title="应用练习"></a>应用练习</h2><p>用笔记住你的观察、思考和想法。在反思你记录的想法，考虑所观察到的东西的意义和应用，回答所提出的问题，仔细阐述这些想法，记录你的洞见。</p>
<h1 id="什么是批判性思考？"><a href="#什么是批判性思考？" class="headerlink" title="什么是批判性思考？"></a>什么是批判性思考？</h1><p>我感觉，和我认为是两种不同的概念。 感觉是包括情感、情绪和欲望的主观反应。思考是用用来解决问题，做出决定取得理解而进行的有意识的精神过程。思考有两大类一种是创造性的，一种是批判性的。批判的本质就是评价。批判性思考界定为用以检验各种主张和论据，并判定那些具有有点那些就有缺点的过程。其实就是一种<code>寻找答案的过程，是一种探究。</code></p>
<h2 id="直觉的作用"><a href="#直觉的作用" class="headerlink" title="直觉的作用"></a>直觉的作用</h2><p>直觉往往是<code>不运用理性推理</code>,而对某事的感觉或者理解。</p>
<h2 id="批判性思考的基本活动"><a href="#批判性思考的基本活动" class="headerlink" title="批判性思考的基本活动"></a>批判性思考的基本活动</h2><blockquote>
<ol>
<li>调查。发现证据－－回答有关该议题的关键问题的材料。要求证据必须是相关和充分的。</li>
<li>解释。 判定证据的意思是什么。要求这种解释必须比其他竞争的解释更合理。</li>
<li>判断。 就此议题得出结论。   要求这个结论必须通过逻辑检验。</li>
</ol>
</blockquote>
<p>从调查、解释、判断是这个过来的，而不负责任的思考者则是完全相反，先认定自己的结论，然后找出证据来证明他们选择的正确性。关键在于不是让预感和假设操纵我们的思考，并预先规定了我们的结论。</p>
<h2 id="批判性的思考与写作"><a href="#批判性的思考与写作" class="headerlink" title="批判性的思考与写作"></a>批判性的思考与写作</h2><p>写作的广泛目标是发现思想或者交流思想。当写作开发思想的时候，集中与你正在考察的问题并记录下你所有的想法、疑问和断言。直接面对你的心智劳动，但对意识边缘的想法保持敏感。</p>
<h2 id="批判性的思考与讨论"><a href="#批判性的思考与讨论" class="headerlink" title="批判性的思考与讨论"></a>批判性的思考与讨论</h2><p>讨论是加深并促进问题的解决和决策。花一定的时候去找一个你已经了解的知识，然后去扩展你自己的知识。从网上找到所有的观点信息，在表达中有可能表达的不同观点，并考虑每一个观点的相对优点。这时让要对你的结论保持相当的试探性，以便其他人将提出的事实和解释保持开放的心态。</p>
<ol>
<li>设置合理的预期</li>
<li>抛弃自我中心和个人议程</li>
<li>起作用但是不主导一切</li>
<li>避免分散注意力的讲话习惯</li>
<li>积极的倾听</li>
<li>负责人的批判</li>
<li>抵制喊叫或打断的冲动</li>
</ol>
<h2 id="避免抄袭"><a href="#避免抄袭" class="headerlink" title="避免抄袭"></a>避免抄袭</h2><p>记录出处，作者版号等。或者用自己的话语复述作者的观点。</p>
<h1 id="真理是什么？"><a href="#真理是什么？" class="headerlink" title="真理是什么？"></a>真理是什么？</h1><p>​:happy:​🐴</p>
<blockquote>
<p>未完待续－－－</p>
</blockquote>
]]></content>
      <tags>
        <tag>逻辑</tag>
        <tag>阅读</tag>
      </tags>
  </entry>
  <entry>
    <title>《智能时代》</title>
    <url>/2016/10/16/big-data-time/</url>
    <content><![CDATA[<p>大数据是一场以数据为基础的，改造各种行业的一场革命。真正意义上的大数据要符合三种特征，大量的，多维度的（相关的数据模型），完备性。当同事满足这三种状态，通过各种设备终端大量采集的数据，构建机器学习的模型，在某个特定的领域可以实现更智能，比如翻译，adwords广告，自动驾驶（自动驾驶其实是在采集过的道路上行驶时没有问题的，但是在没有采集的路段是无法行驶的）等。<br><a id="more"></a></p>
<h3 id="机器学习"><a href="#机器学习" class="headerlink" title="机器学习"></a>机器学习</h3><p>已google搜索为例子：</p>
<ul>
<li>第一：根据网页确定哪些用户在谷歌未过的复杂问题，可以回答那些回答不了，我们大约涨到了70%到80%的问题，在谷歌第一页都能找到正确答案。</li>
<li>第二，把位体和网页中的每一句话做一匹配，消除那些可能是男的片段，至于怎么调就是机器学习的东西了。</li>
<li>第三，就是利用自然语言处理技术，把答案的片段合成一个完整的段落。<br>在智能机器，它背后是数据中心强大的服务器集群，从数据中学习信息和知识，这次技术革命的特点是机器的智能化，我们称之为智能革命。因为有了大量的数据，机器智能就从量变到质变到学习变成了可能。</li>
</ul>
<h3 id="思维的革命"><a href="#思维的革命" class="headerlink" title="思维的革命"></a>思维的革命</h3><p>在无法确定因果时，数据为我们提供了解决问题的新方法，数据中所包含的信息可以帮助我们消除不确定性而数据之间的相关联，<strong>而数据之间的相关联性在某种程度上可以取代原来的因果关系</strong>，帮助我们得到我们想知道的答案，这边是大数据思维的核心。</p>
<hr>
<p>所谓的<strong>机械思维</strong>就是，从确定中推导一切，有一定的因果关系。正因为过去两百年之间的，牛顿、爱斯坦推等科学家了世界，时间，空间，地球运动等都是有规律的，所以人们的思维固定在，所有的事物都会有规律的，有因果关系上。牛顿通过自己伟大的成就，宣告科技科学时代的来临，作为思想家，他让人类相信，世界万物的运动规律是可以被认识的，他告诉认为世界万物是运动的，而且这些运动规律，有着确定性的规律，这些规律又是可以被认识的。</p>
<blockquote>
<p>牛顿的方法论可以概括为机械思维，其核心思想可概括为以下三个方面:</p>
<ul>
<li>因世界变化的规律是确定的。</li>
<li>因为有确定性做保障，因此规律不仅可以被认识，也可以通过简单的公式或者语言描述清楚</li>
<li>这些规律应该是放之四海而皆谁的，可以用到各种未知的领域做指导。</li>
</ul>
</blockquote>
<p>这些其实是机械思维中积极的本质。</p>
<hr>
<p>整个历史进程起是:理论，规律，发明，实践，爆发。也提醒我们，在一个行业里面的经验规律，其实可以应用到其他行业的。</p>
<p>世界发展到今天，大的东西被我们发现的差不多的时候，当印因果关系不能解决，我们身边中很多其他的问题时候，对一个事物了解的越多越细致就会发现，梦想世界的变量其实非常多，不能通过简单的办法，或者公式来计算出来，人们把他们归为不确定的一类。当不确定的问题无法解决的时候大数据，大数据就提供了我们一种思路。其实想想中医以后就可以通过大数据来查找那些药品，对我们人类是一个很有益处的。中医往往可以治得了某些人病，但是某些人却吃不了，其中，肯定会有某个药物对人类卵细胞是一次有规律的，如果通过大数据到计算能力，而不是通过人来，相信中医会有一个更好的发展。</p>
<blockquote>
<p>不需要知道为什么只需要知道怎么办就好。</p>
</blockquote>
<hr>
<p>科学方法论的思想 ： <code>大胆假设，小心求证</code>。包括整个说服科学，行为科学，都是建立在大量的，实验对比，验证的，实践基础上，总结出来的规律。</p>
<p>香农理论(最初是用在信息类的上面，他把世界的不确定性和信息联系了起来。)</p>
<ul>
<li>我们对某件事情一无所知的时候，就需要大量的信息</li>
<li>如果我们对某件事情已经有足够多的了解，那么就不需要太多的信息，我们就能把它搞清楚。</li>
</ul>
<p>信息的度量就等于不确定性的多少，这样香浓就把熵和信息量联系了起来，要想去除系统中的不确定性，就要引入大量信息。信息论是完全建立在不确定性的基础之上。</p>
<blockquote>
<p>信息时代的方法论，谁掌握了信息就谁就能获得财富。<br>就像在工业时代，谁掌握了资本，谁就获取了财富。</p>
</blockquote>
<hr>
<p>大数据的特征，量大，多维度，完备性。数据的完备性的重要，当两个数据源完全一致时。他们的交叉熵等于0，当它们相差较大时，它们的交叉熵也很大。所有采用数据驱动的方法，建立模型作用的数据和使用模型的数据之间需要一致的，否则这种方法就会失效，而交叉熵，就是对这种代表性或者一致性的一种精确的量化度量。从而避免出现黑天鹅效应（以前没有到澳大利亚之前，都是白天鹅，但是到澳大利亚之后就有了，黑天鹅，这之前的猜测都是错的）。<br>所以大数据源的量大其实是为了消除信息的不确定性。</p>
<h3 id="从因果关系到强关联关系，从机械思维到大数据思维"><a href="#从因果关系到强关联关系，从机械思维到大数据思维" class="headerlink" title="从因果关系到强关联关系，从机械思维到大数据思维"></a>从因果关系到强关联关系，从机械思维到大数据思维</h3><p>比如谷歌的，adwords点击模型。搜索排序占70%到80%的权重，英关系已经变成相关联性的。所以后面的商业逻辑都是围绕了，建立获取相关性而展开。</p>
<p>总结:</p>
<blockquote>
<p>机械思维和大数据思维并非对立的，如果我们能找到，确定性和因果关系，机械思维依然是最好的结果。如果我们想消除信息中的不确定性，数据之间的 <strong>相关性</strong>在某种特殊程度上可以取代原来的因果关系，帮助我们得到我们想要的答案，这便是大数据思维，后者更多是对前者的补充，在新的时代，一定要有新的方法论，也一定会产生新的方法论。</p>
</blockquote>
<h3 id="大数据与商业"><a href="#大数据与商业" class="headerlink" title="大数据与商业"></a>大数据与商业</h3><p>总的思想是在新的居住环境下把那些人，过去不确定性，不好解决的，用大数据的思维解决掉。李子这里讲了一个美国偷税漏税的例子，查看用电量就可以知道，和种植毒品的例子。</p>
<h4 id="巨大的商业利好相关性，时效性，个性化的重要性"><a href="#巨大的商业利好相关性，时效性，个性化的重要性" class="headerlink" title="巨大的商业利好相关性，时效性，个性化的重要性"></a>巨大的商业利好相关性，时效性，个性化的重要性</h4><p>商品直接盖章推介商品，推荐新闻，个性化是笑话，最重要的一个例子就是一个父亲不知道一个少女怀孕的例子。<br>很多产业都可以通过一个，IFID芯片，来搜集数据，从而来获得数据，改善用户体验。</p>
<p><strong>穷举法</strong>依靠大量的数据，来无限逼近事实的真相，从而解决我们生活中的问题。</p>
<blockquote>
<p>这里有一个谷歌汽车的例子，无人驾驶，其实整个道路都被扫描了一遍数据，其中一个例子啊，只是道路上多了一个黑色状物，谷歌汽车却不知道怎么走了，其实就是在之前的扫描数据之前没有个东西，从而不知道该如何处理。如果说是技术不达标，其实不如说是数据缺失的问题。</p>
</blockquote>
<h3 id="大数据智能革命的挑战。"><a href="#大数据智能革命的挑战。" class="headerlink" title="大数据智能革命的挑战。"></a>大数据智能革命的挑战。</h3><p>从技术存储，接收，处理，时时，还有很多机器学习的算法，比如人工神经网络算法，最大熵模型，逻辑自回归。</p>
<p>机器学习的过程是一个不断迭代，不断进步的过程，只要事先制定出一个学习的目标，这样双方就会不断的优化模型，让它越来越接近真实的情况，可以说机器学习学的算法迭代次数越多，学习的越深入，得到数据模型就越好。</p>
<ul>
<li>数据量大，采用比较简单的模型，而比较少的地段成熟，也就是说用大量的数据做一个虔诚的机器学习，</li>
<li>数据量小，就采用比较复杂的模型，而且经过很多迭代次数，训练出准确的模型参数。</li>
</ul>
<h3 id="未来的智能化产业"><a href="#未来的智能化产业" class="headerlink" title="未来的智能化产业"></a>未来的智能化产业</h3><h4 id="未来的农业"><a href="#未来的农业" class="headerlink" title="未来的农业"></a>未来的农业</h4><p>以色列的沙漠种植的例子，将滴水管线直接送水和肥料到植物的根系，节约了大量的水和肥料。</p>
<h5 id="未来的体育业"><a href="#未来的体育业" class="headerlink" title="未来的体育业"></a>未来的体育业</h5><p>你如果风险投资人好工程师，男队勇士队，打法，从24英尺外的，三分线投篮。通过数据分析，和统计，最有效的进攻是眼花缭乱的传球和准确的投篮，而不是彰显个人能力，勇士队队员苦练投篮神器。</p>
<h4 id="未来的制造业"><a href="#未来的制造业" class="headerlink" title="未来的制造业"></a>未来的制造业</h4><p>个人定制化，c2b的过程。把自己作为一个，利用大数据给客户提供个性化服务的定位。</p>
<h4 id="未来的医疗"><a href="#未来的医疗" class="headerlink" title="未来的医疗"></a>未来的医疗</h4><p>根据不同人的基因，不同人的身体素质，用不同的药，而且对人体进行监控，把疾病那个杀在摇篮中。</p>
<h4 id="未来的媒体。"><a href="#未来的媒体。" class="headerlink" title="未来的媒体。"></a>未来的媒体。</h4><p>对于简单的，股票类的新闻都可以达到机器来自动编写。</p>
<h3 id="智能社会"><a href="#智能社会" class="headerlink" title="智能社会"></a>智能社会</h3><p>这是最好的时代，也是最好的时代，这是英国文豪狄更斯在著名的《双城记》开篇的一句话。智能革命无疑将给我们带来一个更美好的社会，它是智能的，精细化的，人性化的。同时社会资源的利用率极大提高，就要做到社会的精细化。</p>
<h4 id="区块链技术"><a href="#区块链技术" class="headerlink" title="区块链技术"></a>区块链技术</h4><p>区块链是我们每一笔交易都会被追踪它无法被伪造，是一串由随机算法产生的随机数，被存储在区块中。</p>
<h4 id="从标准化服务到个性化服务"><a href="#从标准化服务到个性化服务" class="headerlink" title="从标准化服务到个性化服务"></a>从标准化服务到个性化服务</h4><p>最切合实际的就是用医疗资源为每个人做病人服务，一方面一个人都积累了完整的你自己健康状况相关的数据，另一方面医院有，完备的数据。</p>
<h4 id="关于隐私"><a href="#关于隐私" class="headerlink" title="关于隐私"></a>关于隐私</h4><p>很多隐私其实都是我们自己泄露的，建立在，别人的善意上，根本靠不住。如果保险公司能获取到每个人都得了什么病，从而拒绝，给其提供保险，那将是很可怕的。</p>
<h4 id="机器抢掉人的饭碗"><a href="#机器抢掉人的饭碗" class="headerlink" title="机器抢掉人的饭碗"></a>机器抢掉人的饭碗</h4><p>从前三次的工业革命有一个共同特点，它会对社会，产生了巨大冲击，它需要经过大约半个世纪甚至更长的时间，才能背会消化掉。我们这代人要经过几个时期，婴儿需要，我们必须有快速的学习能力才能生存。</p>
<h4 id="智能革命的冲击"><a href="#智能革命的冲击" class="headerlink" title="智能革命的冲击"></a>智能革命的冲击</h4><p>智能革命对社会的冲击是巨大的，它会影响到上至国家，中到企业，下至个人的命运。</p>
<ul>
<li>首先信息革命本身带来的影响还没有消化完。</li>
<li>其次，今天和两百年前已经不同，消化掉技术革命的影响要比工业革命来得多</li>
<li>最后也是最重要的一点，智能革命所要期待的是人类最值得自豪的部分–大脑。</li>
</ul>
<p>到了智能革命后，任何简单的脑力工作都会消失，甚至那些现在从事所谓高大上的职业也会失去工作。</p>
<h4 id="争当2-的人"><a href="#争当2-的人" class="headerlink" title="争当2%的人"></a>争当2%的人</h4><p>在历次技术革命中，一个人，一家企业，甚至一个国家，可以选择的道路，只有两条，要么进入前2%的行列，要么被淘汰，抱怨是没有用的。<br>大家要接受一个新的，所谓方式，利用好大数据和机器智能，首先受益的是和那些产业相关的善于利用新技术的人。</p>
<p>思路例子:<br>在电子商品上加电商的入口功能，从而就变成了一家<strong>服务</strong>的企业（冰箱上增加购物的入口，或者在内部装一个检测器，需要什么东西）。<br>卖茶叶，从而记录每天进来多少人？没来过的什么茶？什么时候来？什么时候完成交易？你是否有回头客？他们是谁？如果顾客买了一次不来了？我是为什么常年客每年消费多少茶叶？男人经常消费的是哪种茶叶价位多少？店面外每天的人流情况是如何？你所要做的事，就是找到他们经常买茶叶的人，和他们建立长期的供货需求，这样就会有一个稳定的收入，而且渠道成本很低。</p>
<h4 id="写在最後"><a href="#写在最後" class="headerlink" title="写在最後"></a>写在最後</h4><p>在智能革命到来之际，每个人都有两种选择，要么观望徘徊，最后被淘汰，要么加入，到这2%的人，做愿意吃螃蟹的人，成为这2%的收益者。</p>
]]></content>
  </entry>
  <entry>
    <title>MangoDB 学习指南</title>
    <url>/2016/11/02/MangoDB-cheatsheet/</url>
    <content><![CDATA[<h3 id="安装篇"><a href="#安装篇" class="headerlink" title="安装篇"></a>安装篇</h3><h4 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -O https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel62-3.2.10.tgz</span><br><span class="line">tar zxvf mongodb-linux-x86_64-rhel62-3.2.10.tgz</span><br><span class="line">mv mongodb-linux-x86_64-rhel62-3.2.10 /usr/local/</span><br><span class="line">mv mongodb-linux-x86_64-rhel62-3.2.10 mongodb</span><br><span class="line"></span><br><span class="line">mkdir /data/db</span><br><span class="line">touch /var/logs/mongodb/mongodb.logs</span><br><span class="line">cd mongdb/bin &amp;&amp; vim mongodb.conf</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="配置mongodb-conf"><a href="#配置mongodb-conf" class="headerlink" title="配置mongodb.conf"></a>配置mongodb.conf</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dbpath=/data/db</span><br><span class="line">logpath=/var/logs/mongodb</span><br><span class="line">port=27017</span><br><span class="line">#fork=true</span><br><span class="line">#nohttpinterface=true</span><br></pre></td></tr></table></figure>
<p>####　重新绑定mongodb的配置文件地址和访问IP</p>
<p><code>/usr/local/mongodb/bin/mongod --bind_ip localhost -f /usr/local/mongodb/mongodb.conf</code><br>可以通过 <code>/usr/local/mongodb/bin/mongod --help</code> 查看帮助 ，其中 -f（–config） 配置文件，–bind_ip 绑定ip<br><code>/usr/local/mongodb/bin/mongod --config /usr/local/mongodb/mongodb.conf</code> 添加到 <code>/etc/rc.d/rc.local</code> 开机启动</p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>其中 <code>mongod --config /usr/local/mongodb/mongodb.conf</code> 服务之后，启动 <code>/usr/local/mongodb/bin/mongo</code> 客户端，支持JavaScript 版本，<code>show dbs</code> 查看数据库，<code>db.version()</code> 查看版本</p>
<h5 id="查看当前mongodb进程信息"><a href="#查看当前mongodb进程信息" class="headerlink" title="查看当前mongodb进程信息"></a>查看当前mongodb进程信息</h5><p>ps -ef | grep mongod  //查看进程号码<br>cat /proc/24283/limits //查看具体信息</p>
<h3 id="php的扩展与测试"><a href="#php的扩展与测试" class="headerlink" title="php的扩展与测试"></a>php的扩展与测试</h3><p><a href="https://pecl.php.net/package/mongodb" target="_blank" rel="noopener">扩展包地址</a><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd mongodb-1.1.9</span><br><span class="line">/usr/php/bin/phpize</span><br><span class="line">./configure --with-php-config=/usr/askphp/bin/php-config </span><br><span class="line">make;make install</span><br></pre></td></tr></table></figure></p>
<h4 id="PHP代码"><a href="#PHP代码" class="headerlink" title="PHP代码"></a>PHP代码</h4><h5 id="创建集合"><a href="#创建集合" class="headerlink" title="创建集合"></a>创建集合</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$m = <span class="keyword">new</span> \MongoClient();</span><br><span class="line">$db = $m-&gt;selectDB(<span class="string">"test"</span>);</span><br><span class="line">$collection = $db-&gt;createCollection(<span class="string">"my_col"</span>);</span><br></pre></td></tr></table></figure>
<h5 id="插入文档"><a href="#插入文档" class="headerlink" title="插入文档"></a>插入文档</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$m = <span class="keyword">new</span> \MongoClient();</span><br><span class="line">$db = $m-&gt;selectDB(<span class="string">"test"</span>);</span><br><span class="line">$collection = $db-&gt;my_col;</span><br><span class="line">$document = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">"title"</span> =&gt; <span class="string">"MongoDB"</span>,</span><br><span class="line">            <span class="string">"description"</span> =&gt; <span class="string">"database"</span>,</span><br><span class="line">            <span class="string">"likes"</span> =&gt; <span class="number">100</span>,</span><br><span class="line">            <span class="string">"url"</span> =&gt; <span class="string">"http://www.baidu.com"</span>,</span><br><span class="line">            <span class="string">"by"</span>=&gt;<span class="string">"change.net"</span></span><br><span class="line">            );</span><br><span class="line">$ret_ins  = $collection-&gt;insert($document);</span><br></pre></td></tr></table></figure>
<h5 id="查找文档"><a href="#查找文档" class="headerlink" title="查找文档"></a>查找文档</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$m = <span class="keyword">new</span> \MongoClient();</span><br><span class="line">$db = $m-&gt;selectDB(<span class="string">"test"</span>);</span><br><span class="line">$collection = $db-&gt;my_col;</span><br><span class="line">$cursor = $collection-&gt;find();</span><br><span class="line"><span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $document) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $document[<span class="string">"title"</span>] . <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$m = <span class="keyword">new</span> \MongoClient();</span><br><span class="line">$db = $m-&gt;selectDB(<span class="string">"test"</span>);</span><br><span class="line">$collection = $db-&gt;my_col;</span><br><span class="line">$collection-&gt;update(<span class="keyword">array</span>(<span class="string">"title"</span>=&gt;<span class="string">"MongoDB"</span>), <span class="keyword">array</span>(<span class="string">'$set'</span>=&gt;<span class="keyword">array</span>(<span class="string">"title"</span>=&gt;<span class="string">"MongoDB"</span>)));</span><br><span class="line">$cursor = $collection-&gt;find();</span><br><span class="line"><span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $document) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $document[<span class="string">"title"</span>] . <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$m = <span class="keyword">new</span> \MongoClient();</span><br><span class="line">$db = $m-&gt;selectDB(<span class="string">"test"</span>);</span><br><span class="line">$collection = $db-&gt;my_col;</span><br><span class="line">$collection-&gt;remove(<span class="keyword">array</span>(<span class="string">"title"</span>=&gt;<span class="string">"MongoDB"</span>),  <span class="keyword">array</span>(<span class="string">"justOne"</span> =&gt; <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">$cursor = $collection-&gt;find();</span><br><span class="line"><span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $document) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $document[<span class="string">"title"</span>] . <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="使用篇"><a href="#使用篇" class="headerlink" title="使用篇"></a>使用篇</h3><h4 id="Start-Mongod-amp-amp-Command"><a href="#Start-Mongod-amp-amp-Command" class="headerlink" title="Start Mongod &amp;&amp; Command"></a>Start Mongod &amp;&amp; Command</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">mongod</span><br><span class="line">ps aux | grep mongo</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Start the Mongo Shell</span></span><br><span class="line">mongo</span><br><span class="line"><span class="keyword">show</span> dbs</span><br><span class="line"><span class="keyword">use</span> meals-development</span><br><span class="line"><span class="keyword">show</span> collections</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">users</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">roles</span></span><br><span class="line"><span class="keyword">show</span> profile</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span></span><br><span class="line"></span><br><span class="line">db.auth()</span><br><span class="line">db.help()</span><br><span class="line"><span class="comment">-- collection 为集合的意思 查看更多帮助，查询帮助</span></span><br><span class="line">db.collection.help()</span><br><span class="line">db.collection.find().help()</span><br><span class="line"></span><br><span class="line">db.collection.findOne()</span><br><span class="line">db.collection.find().toArray()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.collection.insert()</span><br><span class="line">db.collection.update()</span><br><span class="line">db.collection.save()</span><br><span class="line">db.collection.remove()</span><br><span class="line">db.collection.drop()</span><br><span class="line">db.collection.createIndex()</span><br><span class="line">db.getSiblingDB()</span><br></pre></td></tr></table></figure>
<h4 id="Data-Types-类型比较"><a href="#Data-Types-类型比较" class="headerlink" title="Data Types 类型比较"></a>Data Types 类型比较</h4><p><a href="https://docs.mongodb.com/v3.2/core/shell-types/#types" target="_blank" rel="noopener">参考</a></p>
<h5 id="Date"><a href="#Date" class="headerlink" title="Date"></a>Date</h5><ul>
<li>Date() method which returns the current date as a string.</li>
<li>new Date() constructor which returns a Date object using the ISODate() wrapper.</li>
<li>ISODate() constructor which returns a Date object using the ISODate() wrapper.</li>
</ul>
<h5 id="ObjectId"><a href="#ObjectId" class="headerlink" title="ObjectId"></a>ObjectId</h5><p>new ObjectId</p>
<h5 id="NumberLong-amp-amp-NumberInt"><a href="#NumberLong-amp-amp-NumberInt" class="headerlink" title="NumberLong &amp;&amp;  NumberInt"></a>NumberLong &amp;&amp;  NumberInt</h5><p>NumberLong(“2090845886852”)。demo：</p>
<blockquote>
<p>db.collection.insert( { _id: 10, calc: NumberLong(“2090845886852”) } )<br>db.collection.update( { _id: 10 },{$set:{ calc: NumberLong(“2555555000000”)}})</p>
</blockquote>
<blockquote>
<p>db.collection.update( { _id: 10 },{$inc:{ calc: NumberLong(5) } } )</p>
</blockquote>
<h4 id="Check-Types"><a href="#Check-Types" class="headerlink" title="Check Types"></a>Check Types</h4><ul>
<li>instanceof – mydoc._id instanceof ObjectId</li>
<li>typeof – typeof mydoc._id</li>
</ul>
<h4 id="SQL-amp-amp-MongoDB-Mapping-Chart"><a href="#SQL-amp-amp-MongoDB-Mapping-Chart" class="headerlink" title="SQL &amp;&amp;  MongoDB Mapping Chart"></a>SQL &amp;&amp;  MongoDB Mapping Chart</h4><p><a href="https://gist.github.com/aponxi/4380516" target="_blank" rel="noopener">sql与nosql的不同于区别参考</a></p>
<h5 id="Executables"><a href="#Executables" class="headerlink" title="Executables"></a>Executables</h5><table>
<thead>
<tr>
<th></th>
<th>MySQL/Oracle</th>
<th>MongoDB</th>
</tr>
</thead>
<tbody>
<tr>
<td>Database Server</td>
<td>mysqld/oracle</td>
<td>mongod</td>
</tr>
<tr>
<td>Database Client</td>
<td>mysql/sqlplus</td>
<td>mongo</td>
</tr>
</tbody>
</table>
<h5 id="Terminology-and-Concepts"><a href="#Terminology-and-Concepts" class="headerlink" title="Terminology and Concepts"></a>Terminology and Concepts</h5><table>
<thead>
<tr>
<th>SQL Terms/Concepts</th>
<th>MongoDB Terms/Concepts</th>
</tr>
</thead>
<tbody>
<tr>
<td>database</td>
<td>database</td>
</tr>
<tr>
<td>table</td>
<td>collection</td>
</tr>
<tr>
<td>row</td>
<td>document or BSON document</td>
</tr>
<tr>
<td>column</td>
<td>field</td>
</tr>
<tr>
<td>index</td>
<td>index</td>
</tr>
<tr>
<td>table joins</td>
<td>embedded documents and linking</td>
</tr>
<tr>
<td>primary key,Specify any unique column or column combination as primary key.</td>
<td>primary key,In MongoDB, the primary key is automatically set to the _id field.</td>
</tr>
</tbody>
</table>
<h4 id="Create-and-Alter-and-CURD"><a href="#Create-and-Alter-and-CURD" class="headerlink" title="Create and Alter and CURD"></a>Create and Alter and CURD</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.users.insert( &#123;</span><br><span class="line">    user_id: <span class="string">"abc123"</span>,</span><br><span class="line">    age: <span class="number">55</span>,</span><br><span class="line">    <span class="keyword">status</span>: <span class="string">"A"</span></span><br><span class="line"> &#125; )</span><br><span class="line"> </span><br><span class="line"> <span class="comment">-- However, you can also explicitly create a collection:</span></span><br><span class="line"> db.createCollection(<span class="string">"users"</span>)</span><br><span class="line"> </span><br><span class="line"> db.users.ensureIndex( &#123; user_id: <span class="number">1</span> &#125; )</span><br><span class="line"> db.users.ensureIndex( &#123; user_id: <span class="number">1</span>, age: <span class="number">-1</span> &#125; )</span><br><span class="line"> db.users.drop()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> db.users.find()</span><br><span class="line"> db.users.find(</span><br><span class="line">    &#123; &#125;,</span><br><span class="line">    &#123; user_id: <span class="number">1</span>, <span class="keyword">status</span>: <span class="number">1</span> &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db.users.find(</span><br><span class="line">    &#123; &#125;,</span><br><span class="line">    &#123; user_id: <span class="number">1</span>, <span class="keyword">status</span>: <span class="number">1</span>, _id: <span class="number">0</span> &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db.users.find(</span><br><span class="line">    &#123; <span class="keyword">status</span>: <span class="string">"A"</span> &#125;,</span><br><span class="line">    &#123; user_id: <span class="number">1</span>, <span class="keyword">status</span>: <span class="number">1</span>, _id: <span class="number">0</span> &#125;</span><br><span class="line">)</span><br><span class="line">db.users.find(</span><br><span class="line">   &#123; age: &#123; $gt: <span class="number">25</span>, $lte: <span class="number">50</span> &#125; &#125;</span><br><span class="line">)</span><br><span class="line">db.users.find(</span><br><span class="line">   &#123; user_id: /^bc/ &#125;</span><br><span class="line">)</span><br><span class="line">db.users.find( &#123; <span class="keyword">status</span>: <span class="string">"A"</span> &#125; ).sort( &#123; user_id: <span class="number">1</span> &#125; )</span><br><span class="line"></span><br><span class="line">db.users.count()</span><br><span class="line">db.users.find().count()</span><br><span class="line"></span><br><span class="line">db.users.count( &#123; user_id: &#123; $<span class="keyword">exists</span>: <span class="literal">true</span> &#125; &#125; )</span><br><span class="line">db.users.find( &#123; user_id: &#123; $<span class="keyword">exists</span>: <span class="literal">true</span> &#125; &#125; ).count()</span><br><span class="line"></span><br><span class="line">db.users.count( &#123; age: &#123; $gt: <span class="number">30</span> &#125; &#125; )</span><br><span class="line">db.users.find( &#123; age: &#123; $gt: <span class="number">30</span> &#125; &#125; ).count()</span><br><span class="line"></span><br><span class="line">db.users.distinct( <span class="string">"status"</span> )</span><br><span class="line"></span><br><span class="line">db.users.findOne()</span><br><span class="line">db.users.find().limit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">db.users.find().limit(<span class="number">5</span>).skip(<span class="number">10</span>)</span><br><span class="line">db.users.find( &#123; <span class="keyword">status</span>: <span class="string">"A"</span> &#125; ).explain()</span><br><span class="line"></span><br><span class="line">db.users.update(</span><br><span class="line">   &#123; age: &#123; $gt: <span class="number">25</span> &#125; &#125;,</span><br><span class="line">   &#123; $<span class="keyword">set</span>: &#123; <span class="keyword">status</span>: <span class="string">"C"</span> &#125; &#125;,</span><br><span class="line">   &#123; multi: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db.users.update(</span><br><span class="line">   &#123; <span class="keyword">status</span>: <span class="string">"A"</span> &#125; ,</span><br><span class="line">   &#123; $inc: &#123; age: <span class="number">3</span> &#125; &#125;,</span><br><span class="line">   &#123; multi: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.users.remove( &#123; <span class="keyword">status</span>: <span class="string">"D"</span> &#125; )</span><br><span class="line">db.users.remove( )</span><br></pre></td></tr></table></figure>
<h4 id="详细使用"><a href="#详细使用" class="headerlink" title="详细使用"></a>详细使用</h4><h5 id="INSERTING-DATA"><a href="#INSERTING-DATA" class="headerlink" title="INSERTING DATA"></a>INSERTING DATA</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.customers.insert(&#123;  </span><br><span class="line">    first_name: <span class="string">"chris"</span>,</span><br><span class="line">    last_name:  <span class="string">"aiv"</span> </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">--Append a lot of data into a customer</span></span><br><span class="line">db.customers.insert(&#123;  </span><br><span class="line">    first_name: <span class="string">"Peter"</span>,</span><br><span class="line">    age: <span class="number">32</span>,</span><br><span class="line">    address: &#123;</span><br><span class="line">        street: <span class="string">"120 Main St"</span>,</span><br><span class="line">        city: <span class="string">"Chicago"</span>,</span><br><span class="line">        state: <span class="string">"Illinois"</span>,</span><br><span class="line">        zip: <span class="string">"38475"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    phone: &#123;</span><br><span class="line">        home: <span class="string">"5555555555"</span>,</span><br><span class="line">        <span class="keyword">work</span>: <span class="string">"4444444444"</span>,</span><br><span class="line">        mobile: <span class="string">"3333333333"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    services: [</span><br><span class="line">        &#123;</span><br><span class="line">            service_id: <span class="string">"time warner"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            service_id: <span class="string">"pge"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            service_id: <span class="string">"moviepass"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    services_count: <span class="number">3</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Append data to a customer</span></span><br><span class="line"></span><br><span class="line">db.customers.insert(&#123;  </span><br><span class="line">    first_name: <span class="string">"Billy"</span>,</span><br><span class="line">    last_name:  <span class="string">"Corgan"</span>,</span><br><span class="line">    gender: <span class="string">"m"</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Insert multiple customers in one query</span></span><br><span class="line"></span><br><span class="line">db.customers.insert([  </span><br><span class="line">    &#123;</span><br><span class="line">    first_name: <span class="string">"Jimmy"</span>,</span><br><span class="line">    last_name:  <span class="string">"Hendrix"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">    first_name: <span class="string">"Jimmy"</span>,</span><br><span class="line">    last_name:  <span class="string">"Page"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">    first_name: <span class="string">"Kurt"</span>,</span><br><span class="line">    last_name:  <span class="string">"Cobain"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">    first_name: <span class="string">"Adrian"</span>,</span><br><span class="line">    last_name:  <span class="string">"Belew"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">    first_name: <span class="string">"Billy"</span>,</span><br><span class="line">    last_name:  <span class="string">"Corgan"</span></span><br><span class="line">    &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<h5 id="FINDING-DATA"><a href="#FINDING-DATA" class="headerlink" title="FINDING DATA"></a>FINDING DATA</h5><figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.customers.find(&#123; first_name: "Peter"&#125;, &#123; services: 1&#125;)  </span><br><span class="line">db.customers.find(&#123; first_name: "Peter"&#125;, &#123; "services.service_id": 1&#125;)  </span><br><span class="line">db.customers.findOne(  </span><br><span class="line">    &#123; first_name: /^billy$/i &#125;,</span><br><span class="line">    &#123; first_name: 1 &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db.customers.find(&#123;  </span><br><span class="line">    gender: "male"</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db.customers.find(&#123;  </span><br><span class="line">    gender: /(m|male)/i, first_name: /^billy$/i </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="UPDATING-DATA"><a href="#UPDATING-DATA" class="headerlink" title="UPDATING DATA"></a>UPDATING DATA</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 慎用，破坏式的更新</span></span><br><span class="line">db.customers.update(  </span><br><span class="line">    &#123; first_name: <span class="string">"Jimmy"</span> &#125;,</span><br><span class="line">    &#123; last_name:  <span class="string">"Hendrix"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="comment">-- Gentel Update </span></span><br><span class="line">db.customers.update(  </span><br><span class="line">    &#123; last_name: /^hendrix$/i &#125;,</span><br><span class="line">    &#123; $<span class="keyword">set</span>: &#123; first_name: <span class="string">"Jimmy"</span> &#125; &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Increment a value in a field</span></span><br><span class="line">db.customers.update(  </span><br><span class="line">    &#123; first_name: <span class="string">"Billy"</span> &#125;,</span><br><span class="line">    &#123; $inc: &#123; age: <span class="number">1</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Update or Insert a field using an object ID</span></span><br><span class="line">db.customers.update(  </span><br><span class="line">    &#123; _id: ObjectId(<span class="string">"581fef808e5fac221dea48ef"</span>) &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        $<span class="keyword">set</span>: &#123;</span><br><span class="line">            first_name:<span class="string">"Lucy"</span>,</span><br><span class="line">            gender: <span class="string">"m"</span>,</span><br><span class="line">            age: <span class="number">40</span>,</span><br><span class="line">            birthdate: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">"2016-11-02"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="comment">-- Update a field using someones first name</span></span><br><span class="line">db.customers.update(  </span><br><span class="line">    &#123; first_name: <span class="string">"Jimmy"</span> &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        $<span class="keyword">set</span>: &#123;</span><br><span class="line">            gender: <span class="string">"male"</span>,</span><br><span class="line">            age: <span class="number">50</span>,</span><br><span class="line">            birthdate: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">"Aug 20, 1985"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="keyword">upsert</span>: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br><span class="line"><span class="comment">-- Add to an existing document</span></span><br><span class="line">db.customers.update(  </span><br><span class="line">    &#123; first_name: <span class="string">"Jimmy"</span> &#125;,</span><br><span class="line">    &#123; $push: &#123;</span><br><span class="line">        services: &#123;</span><br><span class="line">            service_id: <span class="string">'hosting windows'</span>,</span><br><span class="line">            service_name: <span class="string">"windows hosting"</span></span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="comment">-- 第三个参数,如果条件默认不存在，则新增为true表示新增的，默认为false，第四个参数表示全部更新</span></span><br><span class="line">db.customers.update(&#123;first_name:<span class="string">"jack"</span>&#125;,&#123;$inc:&#123;age:<span class="number">2</span>&#125;&#125;,<span class="literal">true</span>);</span><br><span class="line">db.customers.update(&#123;first_name:<span class="string">"Jimmy"</span>&#125;,&#123;$inc:&#123;age:<span class="number">3</span>&#125;&#125;,<span class="literal">false</span>,<span class="literal">true</span>);</span><br><span class="line">db.customers.update(&#123;first_name:<span class="string">"Kurt"</span>&#125;,&#123;$inc:&#123;age:<span class="number">-2</span>&#125;&#125;);</span><br></pre></td></tr></table></figure>
<h5 id="REMOVING-DATA"><a href="#REMOVING-DATA" class="headerlink" title="REMOVING DATA"></a>REMOVING DATA</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--Remove a field</span></span><br><span class="line">db.customers.update(  </span><br><span class="line">    &#123; last_name: <span class="string">"Page"</span> &#125;,</span><br><span class="line">    &#123; </span><br><span class="line">        $unset: &#123; age: <span class="number">1</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db.customers.update(&#123;first_name:<span class="string">"jack"</span>&#125;,&#123;$inc:&#123;age:<span class="number">1</span>&#125;&#125;)</span><br><span class="line"><span class="comment">--Remove a customer</span></span><br><span class="line">db.customers.remove(  </span><br><span class="line">    //!!! <span class="keyword">DO</span> <span class="keyword">NOT</span> US THIS</span><br><span class="line">    &#123; first_name: <span class="string">"Billy"</span>&#125;, <span class="literal">true</span> </span><br><span class="line">)</span><br><span class="line"><span class="comment">-- Remove any customer above the age of 31</span></span><br><span class="line">db.customers.remove(  </span><br><span class="line">    &#123; age: &#123; $gt: <span class="number">31</span> &#125; &#125;</span><br><span class="line">    , <span class="literal">true</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h5 id="DELETING-DATA"><a href="#DELETING-DATA" class="headerlink" title="DELETING DATA"></a>DELETING DATA</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Delete a collection</span></span><br><span class="line">db.customers.drop()</span><br></pre></td></tr></table></figure>
<h5 id="SEARCHING-DATA"><a href="#SEARCHING-DATA" class="headerlink" title="SEARCHING DATA"></a>SEARCHING DATA</h5><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  _id: 1,</span><br><span class="line">  name: &#123; first: 'John', last: 'Backus' &#125;,</span><br><span class="line">  birth: new Date('Dec 03, 1924'),</span><br><span class="line">  death: new Date('Mar 17, 2007'),</span><br><span class="line">  contribs: [ 'Fortran', 'ALGOL', 'Backus-Naur Form', 'FP' ],</span><br><span class="line">  awards: [</span><br><span class="line">            &#123; award: 'National Medal',</span><br><span class="line">              year: 1975,</span><br><span class="line">              by: 'NSF' &#125;,</span><br><span class="line">            &#123; award: 'Turing Award',</span><br><span class="line">              year: 1977,</span><br><span class="line">              by: 'ACM' &#125;</span><br><span class="line">          ]</span><br><span class="line">&#125;</span><br><span class="line">db.users.find(&#123;awards: &#123;$elemMatch: &#123;award:'National Medal', year:1975&#125;&#125;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--  $gt,gte,$lt,$lte,$ne</span></span><br><span class="line">db.col.find(&#123;"by":"菜鸟教程"&#125;).pretty()</span><br><span class="line">db.col.find(&#123;"likes":&#123;$lt:50&#125;&#125;).pretty()</span><br><span class="line">db.col.find(&#123;"likes":&#123;$ne:50&#125;&#125;).pretty()</span><br><span class="line">db.users.find(&#123;"likes" : &#123;$gt : 100&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- and or 使用</span></span><br><span class="line">db.customers.find(&#123;$or: [&#123;key1: value1&#125;, &#123;key2:value2&#125;]&#125;).pretty()</span><br><span class="line">db.col.find(&#123;"likes": &#123;$gt:50&#125;, $or: [&#123;"by": "教程"&#125;,&#123;"title": "MongoDB 教程"&#125;]&#125;).pretty()</span><br><span class="line">//支持js</span><br><span class="line">db.customers.find(&#123;$where:function()&#123; return this.first_name=="jack"&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正则查询</span></span><br><span class="line"></span><br><span class="line">db.customers.find(&#123;name:&#123;$regex:"yaolan.com"&#125;&#125;)</span><br><span class="line"><span class="comment">-- 或者</span></span><br><span class="line">db.customers.find(&#123;name:/yaolan.com/&#125;)</span><br><span class="line"><span class="comment">-- 不区分大小写</span></span><br><span class="line">db.customers.find(&#123;name:&#123;$regex:"yaolan.com",$options:"$i"&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="关于统计，排序，分页，分组等"><a href="#关于统计，排序，分页，分组等" class="headerlink" title="关于统计，排序，分页，分组等"></a>关于统计，排序，分页，分组等</h4><ul>
<li>db.collections.help() 查看更多操作</li>
<li>db.collection.find().help();</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.customers.distinct("first_name");</span><br><span class="line">db.customers.count(&#123;first_name:"Jimmy",age:&#123;$gt:1&#125;&#125;);</span><br><span class="line">db.customers.count(&#123;first_name:"Jimmy",age:&#123;$in:[8,90]&#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用于分页</span></span><br><span class="line">db.customers.find().limit(2).skip(1)</span><br><span class="line"><span class="comment">-- 用于排序，其中value为1 或 -1 分别为升降序</span></span><br><span class="line">db.customers.find().sort(&#123;first_name:1&#125;);</span><br><span class="line">db.customers.find().sort(&#123;first_name:-1&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分组 </span></span><br><span class="line"><span class="comment">-- key ：按照那个字段分组</span></span><br><span class="line"><span class="comment">-- initial:初始化函数</span></span><br><span class="line"><span class="comment">-- reduce 函数第一个参数当前文档，第二个参数为前一个集合对象</span></span><br><span class="line"><span class="comment">-- condition: 这个就是过滤条件。</span></span><br><span class="line"><span class="comment">-- finalize: 每一组文档执行完后，多会触发此方法，那么在每组集合里面加上count也就是它的活了</span></span><br><span class="line">db.customers.group(&#123;</span><br><span class="line">    key:&#123;age:true&#125;,</span><br><span class="line">    initial:&#123;customers:[]&#125;,</span><br><span class="line">    reduce:function(curr,prev)&#123; prev.customers.push(curr.first_name) &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">db.customers.group(&#123;</span><br><span class="line">    key:&#123;age:true&#125;,</span><br><span class="line">    initial:&#123;obj:[]&#125;,</span><br><span class="line">    reduce:function(curr,prev)&#123; </span><br><span class="line">        prev.obj.push(curr.first_name); </span><br><span class="line">        prev.obj.push(curr.last_name);</span><br><span class="line">        prev.obj.push(&#123;address:"abc"&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 存储整个值</span></span><br><span class="line">db.customers.group(&#123;</span><br><span class="line">    key:&#123;age:true&#125;,</span><br><span class="line">    initial:&#123;obj:[]&#125;,</span><br><span class="line">    reduce:function(curr,prev)&#123; </span><br><span class="line">        prev.obj.push(JSON.stringify(curr)); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删选条件加，每次执行完事件</span></span><br><span class="line">db.customers.group(&#123;</span><br><span class="line">    key:&#123;age:true&#125;,</span><br><span class="line">    initial:&#123;obj:[]&#125;,</span><br><span class="line">    condition:&#123;age:&#123;$gt:7&#125;&#125;,</span><br><span class="line">    reduce:function(curr,prev)&#123; </span><br><span class="line">        prev.list = JSON.stringify(curr);   </span><br><span class="line">    &#125;,</span><br><span class="line">    finalize:function(prev)&#123;</span><br><span class="line">        prev.count =  prev.obj.length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h5 id="aggregate-聚合"><a href="#aggregate-聚合" class="headerlink" title="aggregate 聚合"></a>aggregate 聚合</h5><p>按照age分组，并以sum的value累计计算和, 聚合，实例类似sql语句： <code>select by_user, count(*) from mycol group by by_user</code>，在上面的例子中，我们通过字段by_user字段对数据进行分组，并计算by_user字段相同值的总和。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">db.customers.aggregate([&#123;$group : &#123;_id : "$by_user", num_tutorial : &#123;$sum : 1&#125;&#125;&#125;])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.customers.aggregate([&#123;$group : &#123;_id: "$age",num:&#123;$sum:2&#125;&#125;&#125;])</span><br><span class="line">db.customers.aggregate([&#123;$group : &#123;_id: "$age",num:&#123;$avg:1&#125;&#125;&#125;])</span><br></pre></td></tr></table></figure>
<h5 id="管道的概念"><a href="#管道的概念" class="headerlink" title="管道的概念"></a>管道的概念</h5><p>管道在Unix和Linux中一般用于将当前命令的输出结果作为下一个命令的参数。</p>
<blockquote>
<ul>
<li>$project：修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档。</li>
<li>$match：用于过滤数据，只输出符合条件的文档。<code>$match</code>使用MongoDB的标准查询操作。</li>
<li>$limit：用来限制MongoDB聚合管道返回的文档数。</li>
<li>$skip：在聚合管道中跳过指定数量的文档，并返回余下的文档。</li>
<li>$unwind：将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值。</li>
<li>$group：将集合中的文档分组，可用于统计结果。</li>
<li>$sort：将输入文档排序后输出。</li>
<li>$geoNear：输出接近某一地理位置的有序文档。</li>
</ul>
</blockquote>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">db.article.aggregate(</span><br><span class="line">    &#123; $project : &#123;</span><br><span class="line">        title : 1 ,</span><br><span class="line">        author : 1 ,</span><br><span class="line">    &#125;&#125;</span><br><span class="line"> );</span><br><span class="line"></span><br><span class="line">db.customers.aggregate(&#123;$project:&#123;first_name:1,age:1&#125;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.article.aggregate(</span><br><span class="line">&#123; $project : &#123;</span><br><span class="line">    _id : 0 ,</span><br><span class="line">    title : 1 ,</span><br><span class="line">    author : 1</span><br><span class="line">&#125;&#125;);</span><br><span class="line"><span class="comment">-- $match用于获取分数大于70小于或等于90记录，然后将符合条件的记录送到下一阶段$group管道操作符进行处理。</span></span><br><span class="line">db.articles.aggregate( [</span><br><span class="line">    &#123; $match : &#123; score : &#123; $gt : 70, $lte : 90 &#125; &#125; &#125;,</span><br><span class="line">    &#123; $group: &#123; _id: null, count: &#123; $sum: 1 &#125; &#125; &#125;</span><br><span class="line">   ] );</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 经过$skip管道操作符处理后，前五个文档被"过滤"掉。</span></span><br><span class="line">db.article.aggregate(&#123; $skip : 5 &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="mapReduce"><a href="#mapReduce" class="headerlink" title="mapReduce"></a>mapReduce</h3><p>Map-Reduce是一种计算模型，简单的说就是将大批量的工作（数据）分解（MAP）执行，然后再将结果合并成最终结果（REDUCE）。</p>
<blockquote>
<p>map ：映射函数 (生成键值对序列,作为 reduce 函数参数)。<br>reduce 统计函数，reduce函数的任务就是将key-values变成key-value，也就是把values数组变成一个单一的值value。。<br>out 统计结果存放集合 (不指定则使用临时集合,在客户端断开后自动删除)。<br>query 一个筛选条件，只有满足条件的文档才会调用map函数。（query。limit，sort可以随意组合）<br>sort 和limit结合的sort排序参数（也是在发往map函数前给文档排序），可以优化分组机制<br>limit 发往map函数的文档数量的上限（要是没有limit，单独使用sort的用处不大）</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">db.collection.mapReduce(</span><br><span class="line">   function() &#123;emit(key,value);&#125;,  //map 函数</span><br><span class="line">   function(key,<span class="keyword">values</span>) &#123;<span class="keyword">return</span> reduceFunction&#125;,   //reduce 函数</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">out</span>: collection,</span><br><span class="line">      <span class="keyword">query</span>: <span class="keyword">document</span>,</span><br><span class="line">      <span class="keyword">sort</span>: <span class="keyword">document</span>,</span><br><span class="line">      <span class="keyword">limit</span>: <span class="built_in">number</span></span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- demo</span></span><br><span class="line">db.posts.mapReduce( </span><br><span class="line">   function() &#123; emit(this.user_name,1); &#125;, </span><br><span class="line">   function(key, <span class="keyword">values</span>) &#123;<span class="keyword">return</span> Array.sum(<span class="keyword">values</span>)&#125;, </span><br><span class="line">      &#123;  </span><br><span class="line">         <span class="keyword">query</span>:&#123;<span class="keyword">status</span>:<span class="string">"active"</span>&#125;,  </span><br><span class="line">         <span class="keyword">out</span>:<span class="string">"post_total"</span> </span><br><span class="line">      &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="游标"><a href="#游标" class="headerlink" title="游标"></a>游标</h3><p>针对这样的操作，result其实并没有获取到customers中的文档，而是申明一个“查询结构”,for或者next()一次性加载过来，然后让游标逐行读取，当我们枚举完了之后，游标销毁。<br>var result = db.customers.find().limit(2).skip(1)<br>var result = db.customers.find();<br>result.forEach(function(curr){<br>    print(curr.first_name);<br>});</p>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 性能分析函数</span><br><span class="line">db.customers.find(&#123;age:7&#125;).explain();</span><br><span class="line">-- hint 强制使用索引</span><br><span class="line">db.customers.find(&#123;gender:&quot;M&quot;&#125;,&#123;user_name:1,_id:0&#125;).hint(&#123;gender:1,user_name:1&#125;)</span><br><span class="line">db.customers.find(&#123;gender:&quot;M&quot;&#125;,&#123;user_name:1,_id:0&#125;).hint(&#123;gender:1,user_name:1&#125;).explain();</span><br><span class="line"></span><br><span class="line">-- 建立索引 (`ensureIndex` 将要被 `createIndex` 替代)</span><br><span class="line">db.customers.ensureIndex(&#123;&quot;first_name&quot;:1&#125;)</span><br><span class="line">db.customers.createIndex(&#123;&quot;first_name&quot;:1&#125;)</span><br><span class="line">db.customers.createIndexes([&#123;&quot;first_name&quot;:1&#125;,&#123;&quot;age&quot;:-1&#125;])</span><br><span class="line">-- 唯一索引</span><br><span class="line">db.customers.ensureIndex(&#123;&quot;first_name&quot;:1&#125;,&#123;&quot;unique&quot;:true&#125;)</span><br><span class="line">-- 联合索引</span><br><span class="line">db.customers.ensureIndex(&#123;&quot;first_name&quot;:1,&quot;age&quot;:-1&#125;)</span><br><span class="line">db.customers.createIndexes([&#123;&quot;first_name&quot;:1&#125;,&#123;&quot;age&quot;:-1&#125;])</span><br><span class="line">-- 查看索引</span><br><span class="line">db.customers.getIndexes();</span><br><span class="line">--删除索引</span><br><span class="line">db.customers.dropIndex(&quot;first_name_1&quot;) </span><br><span class="line">db.customers.dropIndex(&#123;&quot;first_name&quot;:1&#125;)</span><br><span class="line">db.customers.dropIndexes();</span><br></pre></td></tr></table></figure>
<h3 id="Mongodb复制"><a href="#Mongodb复制" class="headerlink" title="Mongodb复制"></a>Mongodb复制</h3><p>mongod –help</p>
<h4 id="主从读写分离（旧版本的，将用replica-副本集代替）"><a href="#主从读写分离（旧版本的，将用replica-副本集代替）" class="headerlink" title="主从读写分离（旧版本的，将用replica 副本集代替）"></a>主从读写分离（旧版本的，将用replica 副本集代替）</h4><p>通过主数据库的<code>OpLog</code>日志来复制,如果配置成功可看见<code>sync_pullOpLog</code><br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 一主两从，主服务器不写默认端口 27017</span></span><br><span class="line">mongod <span class="comment">--dbpath=E:\MongoDB\datamaster --master</span></span><br><span class="line">mongod <span class="comment">--dbpath=E:\MongoDB\dataslave --port=27018 --slave --source=127.0.0.1:27017</span></span><br><span class="line">mongod <span class="comment">--dbpath=E:\MongoDB\dataslave1 --port=27019 --slave --source=127.0.0.1:27017</span></span><br><span class="line"><span class="comment">-- 测试同步</span></span><br><span class="line">mongo 127.0.0.1:27017</span><br><span class="line">db.users.insert(&#123;<span class="keyword">name</span>:<span class="string">"tom"</span>,age:<span class="number">10</span>&#125;)</span><br><span class="line">db.users.insert(&#123;<span class="keyword">name</span>:<span class="string">"lucy"</span>,age:<span class="number">13</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在从服务器上查看</span></span><br><span class="line">db.usrs.find();</span><br></pre></td></tr></table></figure></p>
<p>主从配置好之后，从服务器默认是不可读取的，如果出现了 <code>error: { &quot;$err&quot; : &quot;not master and slaveok=false&quot;, &quot;code&quot; : 13435 }</code> 这个错误，需要在从服务器上执行<code>rs.slaveok()</code>,之后再从服务器上查询即可。</p>
<h4 id="副本集-代替旧的主从-（-–replSet）"><a href="#副本集-代替旧的主从-（-–replSet）" class="headerlink" title="副本集(代替旧的主从)（ –replSet）"></a>副本集(代替旧的主从)（ –replSet）</h4><ol>
<li>该集群没有特定的主数据库</li>
<li>如果哪个主数据库宕机了，集群中就会推选出一个从属数据库作为主数据库顶上，这就具备了自动故障恢复功能<blockquote>
<p>N 个节点的集群(至少3个)<br>任何节点可作为主节点<br>所有写入操作都在主节点上<br>自动故障转移<br>自动恢复</p>
</blockquote>
</li>
</ol>
<p><img src="/images/replica.jpg" alt="replica"></p>
<p>我们使用同一个MongoDB来做MongoDB主从的实验， 操作步骤如下：<br>关闭正在运行的MongoDB服务器。<br><code>mongod --port 27017 --dbpath=E:\MongoDB\datamaster --replSet rs0</code><br>以上实例会启动一个名为rs0的MongoDB实例，其端口号为27017。<br>启动后打开命令提示框并连接上mongoDB服务。<br>在Mongo客户端使用命令<code>rs.initiate()</code>来启动一个新的副本集。<br>我们可以使用<code>rs.conf()</code>来查看副本集的配置<br>查看副本集状态使用 <code>rs.status()</code> 命令</p>
<p>在不同机机子上，需要建立集群名称,具体可以参考如下：（示例在一个机子上，用端口区分）<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongod --dbpath=E:\MongoDB\replsetmaster --port=27017  --replSet replset</span><br><span class="line">mongod --dbpath=E:\MongoDB\replsetslave --port=27018 --replSet replset</span><br><span class="line">mongod --dbpath=E:\MongoDB\replsetslave1 --port=27019  --replSet replset</span><br><span class="line">-- 在任意一个`mongo` 初始化副本集，replset 为上面的副本集名称</span><br><span class="line"></span><br><span class="line">rs.initiate(&#123;</span><br><span class="line">    _id:&quot;replset&quot;,</span><br><span class="line">    members:[</span><br><span class="line">    &#123;</span><br><span class="line">        _id:0,</span><br><span class="line">        host:&quot;127.0.0.1:27017&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        _id:1,</span><br><span class="line">        host:&quot;127.0.0.1:27018&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        _id:2,</span><br><span class="line">        host:&quot;127.0.0.1:27019&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- 测试同步</span><br><span class="line">mongo 127.0.0.1:27017</span><br><span class="line">db.users.insert(&#123;name:&quot;tom&quot;,age:10&#125;)</span><br><span class="line">db.users.insert(&#123;name:&quot;lucy&quot;,age:13&#125;)</span><br><span class="line"></span><br><span class="line">-- 在第二个服务器上查看</span><br><span class="line">db.usrs.find();</span><br><span class="line">-- 如果出现错误`not master and slaveok=false` ,默认是从主节点读写数据的，副本节点上不允许读，需要设置副本节点可以读,然后执行 `db.getMongo().setSlaveOk()` 或者`rs.slaveOk()`即可</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- rs.addArb() 使用这个追加一个仲裁服务器</span><br><span class="line">mongod --dbpath=xxxx --port=27020 --replSet replset</span><br><span class="line">rs.addArb(&quot;192.168.1.2:27020&quot;)</span><br><span class="line"></span><br><span class="line">-- rs.add 陆续增加更多的副本</span><br><span class="line">rs.add(&quot;192.168.1.2:27021&quot;)</span><br></pre></td></tr></table></figure></p>
<p>最后查看副本集状态使用 <code>rs.status()</code> 命令。判断当前运行的Mongo服务是否为主节点可以使用命令<code>db.isMaster()</code>,MongoDB的副本集与我们常见的主从有所不同，主从在主机宕机后所有服务将停止，而副本集在主机宕机后，副本会接管主节点成为主节点，不会出现宕机，无缝切换</p>
<h3 id="分片技术（Shard）"><a href="#分片技术（Shard）" class="headerlink" title="分片技术（Shard）"></a>分片技术（Shard）</h3><p>在Mongodb里面存在另一种集群(cluster)，就是分片技术,可以满足MongoDB数据量大量增长的需求。</p>
<blockquote>
<p>复制所有的写入操作到主节点<br>延迟的敏感数据会在主节点查询<br>单个副本集限制在12个节点<br>当请求量巨大时会出现内存不足。<br>本地磁盘不足<br>垂直扩展价格昂贵</p>
</blockquote>
<p><img src="/images/mongo-cluster.jpg" alt="MongoDB Cluster"></p>
<blockquote>
<ul>
<li>Shard:用于存储实际的数据块，实际生产环境中一个shard server角色可由几台机器组个一个replica set承担，防止主机单点故障</li>
<li>Config Server:mongod实例，存储了整个 ClusterMetadata，其中包括 chunk信息。</li>
<li>Query Routers: 前端路由，客户端由此接入，且让整个集群看上去像单一数据库，前端应用可以透明使用。</li>
</ul>
</blockquote>
<p>模拟在单机上启用不同的端口，分片<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 服务器分布</span><br><span class="line">Shard Server 1：27020</span><br><span class="line">Shard Server 2：27021</span><br><span class="line">Shard Server 3：27022</span><br><span class="line">Shard Server 4：27023</span><br><span class="line">Config Server ：27100</span><br><span class="line">Route Process：40000</span><br><span class="line"></span><br><span class="line">-- 1. 启动Shard Server</span><br><span class="line">mkdir -p /www/mongoDB/shard/s0</span><br><span class="line">mkdir -p /www/mongoDB/shard/s1</span><br><span class="line">mkdir -p /www/mongoDB/shard/s2</span><br><span class="line">mkdir -p /www/mongoDB/shard/s3</span><br><span class="line">mkdir -p /www/mongoDB/shard/log</span><br><span class="line"></span><br><span class="line">/usr/local/mongoDB/bin/mongod --port 27020 --dbpath=E:/MongoDB/shard/s0 --logpath=E:/MongoDB/shard/log/s0.log --logappend</span><br><span class="line">/usr/local/mongoDB/bin/mongod --port 27021 --dbpath=E:/MongoDB/shard/s1 --logpath=E:/MongoDB/shard/log/s1.log --logappend</span><br><span class="line">/usr/local/mongoDB/bin/mongod --port 27022 --dbpath=E:/MongoDB/shard/s2 --logpath=E:/MongoDB/shard/log/s2.log --logappend</span><br><span class="line">/usr/local/mongoDB/bin/mongod --port 27023 --dbpath=E:/MongoDB/shard/s3 --logpath=E:/MongoDB/shard/log/s3.log --logappend</span><br><span class="line"></span><br><span class="line">-- 2. 启动Config Server,这里只有一台config server 如果不是一台，添加 `--configsvr` 参数</span><br><span class="line">mkdir -p /www/mongoDB/shard/config</span><br><span class="line">/usr/local/mongoDB/bin/mongod --port 27100 --configsvr --dbpath=E:/MongoDB/shard/config --logpath=E:/MongoDB/shard/log/config.log --logappend</span><br><span class="line"></span><br><span class="line">-- 3. 启动Route Process，mongos启动参数中，chunkSize这一项是用来指定chunk的大小的，单位是MB，默认大小为200MB.</span><br><span class="line"></span><br><span class="line">/usr/local/mongoDB/bin/mongos --port 40000 --configdb localhost:27100 --logpath=E:/MongoDB/shard/log/route.log --chunkSize 200</span><br><span class="line"></span><br><span class="line">-- 4. 配置Sharding,使用MongoDB Shell登录到mongos，添加Shard节点,然后按照普通的mongo数据库那样，将数据库连接接入接口40000</span><br><span class="line">/usr/local/mongoDB/bin/mongo admin --port 40000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.runCommand(&#123; addshard:&quot;localhost:27020&quot; &#125;)</span><br><span class="line">db.runCommand(&#123; addshard:&quot;localhost:27021&quot; &#125;)</span><br><span class="line">db.runCommand(&#123; addshard:&quot;localhost:27022&quot; &#125;)</span><br><span class="line">db.runCommand(&#123; addshard:&quot;localhost:27023&quot; &#125;)</span><br><span class="line">db.runCommand(&#123; enablesharding:&quot;test&quot; &#125;)</span><br><span class="line">db.runCommand(&#123; shardcollection: &quot;users&quot;, key: &#123; id:1,time:1&#125;&#125;)</span><br><span class="line">-- 或者下面写写法是一样的</span><br><span class="line">sh.addShard(&quot;localhost:27020&quot;);</span><br><span class="line">sh.addShard(&quot;localhost:27021&quot;);</span><br><span class="line">sh.addShard(&quot;localhost:27022&quot;);</span><br><span class="line">sh.addShard(&quot;localhost:27023&quot;);</span><br><span class="line">sh.enableSharding(&quot;test&quot;);</span><br><span class="line">-- sh.shardCollection(&quot;&lt;database&gt;.&lt;collection&gt;&quot;, shard-key-pattern) 按照collection的key来分片</span><br><span class="line">sh.shardCollection(&quot;test.users&quot;,&#123;&quot;name&quot;:1,&quot;_id&quot;:1&#125;);</span><br><span class="line"></span><br><span class="line">-- 5. 插入数据,测试分片</span><br><span class="line">    use test</span><br><span class="line"></span><br><span class="line">    for(var i=0;i&lt;=100000;i++) &#123;</span><br><span class="line">        db.users.insert(&#123;name:&quot;lucy&quot;+i,age:i&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">-- 6. 查看分片信息</span><br><span class="line">sh.status()</span><br></pre></td></tr></table></figure></p>
<h3 id="安全管理"><a href="#安全管理" class="headerlink" title="安全管理"></a>安全管理</h3><ol>
<li>以安全认证模式启动<br>mongod –auth –dbpath /usr/mongo/data -f /var/mongo.log<br>使用–auth选项启动mongod进程即可启用认证模式。<br>或者，也可以修改<code>/etc/mongodb.conf</code>，设置<code>auth=true</code>，重启mongod进程。</li>
<li>添加用户</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 创建用户</span><br><span class="line">db.createUser(&#123;  </span><br><span class="line">    &quot;user&quot;: &quot;chrisaiv&quot;,</span><br><span class="line">    &quot;pwd&quot;: &quot;password&quot;,</span><br><span class="line">    &quot;roles&quot;: [</span><br><span class="line">        &#123; role: &quot;clusterAdmin&quot;, db: &quot;admin&quot; &#125;,</span><br><span class="line">        &#123; role: &quot;readAnyDatabase&quot;, db: &quot;admin&quot; &#125;,</span><br><span class="line">        &quot;readWrite&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; w: &quot;majority&quot;, wtimeout: 5000 &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">测试数据库安全认证: `db.auth(&quot;admin&quot;, &quot;123456&quot;)`</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><p>为数据库写数据（同步到磁盘）加锁<br><code>db.runCommand({fsync:1,lock:1})</code><br>说明：该操作已经对数据库上锁，不允许执行写数据操作，一般在执行数据库备份时有用。</p>
</li>
<li><p>查看当前锁状态<br><code>db.currentOp()</code></p>
</li>
<li><p>解锁<br><code>use local
db.$cmd.sys.unlock.findOne()</code><br>说明：<br>执行解锁，结果如下所示：<br><code>db.currentOp()</code></p>
</li>
</ol>
<h3 id="数据备份、恢复与迁移管理"><a href="#数据备份、恢复与迁移管理" class="headerlink" title="数据备份、恢复与迁移管理"></a>数据备份、恢复与迁移管理</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">mongodump -h dbhost -d dbname -c collection -o dbdirectory</span><br><span class="line">mongorestore -h dbhost -d dbname -c collection <span class="comment">--directoryperdb dbdirectory</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 备份全部数据库</span></span><br><span class="line">mkdir testbak</span><br><span class="line">mongodump </span><br><span class="line"><span class="comment">-- 备份指定数据库</span></span><br><span class="line">mongodump -d pagedb</span><br><span class="line"><span class="comment">-- 备份一个数据库中的某个集合</span></span><br><span class="line">mongodump -d pagedb -c page</span><br><span class="line"><span class="comment">-- 恢复全部数据库</span></span><br><span class="line">cd testbak</span><br><span class="line">mongorestore <span class="comment">--drop</span></span><br><span class="line"><span class="comment">-- 恢复某个数据库的数据</span></span><br><span class="line">cd testbak</span><br><span class="line">mongorestore -d pagedb <span class="comment">--drop</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 恢复某个数据库的某个集合的数据</span></span><br><span class="line">mongorestore -d pagedb -c page <span class="comment">--drop</span></span><br><span class="line"><span class="comment">-- 向MongoDB导入数据</span></span><br><span class="line">mongoimport -d pagedb -c page <span class="comment">--type csv --headerline --drop &lt; csvORtsvFile.csv</span></span><br><span class="line"><span class="comment">-- 将文件csvORtsvFile.csv的数据导入到pagedb数据库的page集合中，使用cvs或tsv文件的列名作为集合的列名。</span></span><br><span class="line"><span class="comment">-- 需要注意的是，使用`--headerline`选项时，只支持csv和tsv文件。</span></span><br><span class="line"><span class="comment">-- type支持的类型有三个：csv、tsv、json</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### MongoDB 监控</span></span><br><span class="line">```sql</span><br><span class="line">mongostat </span><br><span class="line">mongotop</span><br><span class="line">mongotop 10   <span class="comment">-- 等待时间</span></span><br><span class="line">mongotop <span class="comment">--locks  -- 报告每个数据库的锁的使用</span></span><br></pre></td></tr></table></figure>
<h3 id="MongoDB-自动增长"><a href="#MongoDB-自动增长" class="headerlink" title="MongoDB 自动增长"></a>MongoDB 自动增长</h3><p>MongoDB 没有像 SQL 一样有自动增长的功能， MongoDB 的 _id 是系统自动生成的12字节唯一标识。<code>db.createCollection(&quot;counters&quot;)</code>,通过<code>db.counters.insert({_id:&quot;productid&quot;,sequence_value:0})</code> 来实现</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNextSequenceValue</span>(<span class="params">sequenceName</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> sequenceDocument = db.counters.findAndModify(</span><br><span class="line">      &#123;</span><br><span class="line">         query:&#123;<span class="attr">_id</span>: sequenceName &#125;,</span><br><span class="line">         update: &#123;<span class="attr">$inc</span>:&#123;<span class="attr">sequence_value</span>:<span class="number">1</span>&#125;&#125;,</span><br><span class="line">         <span class="keyword">new</span>:<span class="literal">true</span></span><br><span class="line">      &#125;);</span><br><span class="line">   <span class="keyword">return</span> sequenceDocument.sequence_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"> db.products.insert(&#123;</span><br><span class="line">    <span class="string">"_id"</span>:getNextSequenceValue(<span class="string">"productid"</span>),</span><br><span class="line">    <span class="string">"product_name"</span>:<span class="string">"Apple iPhone"</span>,</span><br><span class="line">    <span class="string">"category"</span>:<span class="string">"mobiles"</span></span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line"> db.products.insert(&#123;</span><br><span class="line"><span class="string">"_id"</span>:getNextSequenceValue(<span class="string">"productid"</span>),</span><br><span class="line"><span class="string">"product_name"</span>:<span class="string">"Samsung S3"</span>,</span><br><span class="line"><span class="string">"category"</span>:<span class="string">"mobiles"</span>&#125;)</span><br><span class="line"></span><br><span class="line">db.products.find()</span><br></pre></td></tr></table></figure>
<h3 id="关于ObjectId"><a href="#关于ObjectId" class="headerlink" title="关于ObjectId"></a>关于ObjectId</h3><blockquote>
<p>前4个字节表示时间戳<br>接下来的3个字节是机器标识码<br>紧接的两个字节由进程id组成（PID）<br>最后三个字节是随机数。<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">newObjectId = ObjectId()</span><br><span class="line">myObjectId = ObjectId("5349b4ddd2781d08c09890f4")</span><br><span class="line">ObjectId("5349b4ddd2781d08c09890f4").getTimestamp()</span><br><span class="line"></span><br><span class="line">new ObjectId().str</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="GridFS"><a href="#GridFS" class="headerlink" title="GridFS"></a>GridFS</h3><p>GridFS 用于存储和恢复那些超过16M（BSON文件限制）的文件(如：图片、音频、视频等)。<br>GridFS 也是文件存储的一种方式，但是它是存储在MonoDB的集合中。<br>GridFS 可以更好的存储大于16M的文件。<br>GridFS 会将大文件对象分割成多个小的chunk(文件片段),一般为256k/个,每个chunk将作为MongoDB的一个文档(document)被存储在chunks集合中。<br>GridFS 用两个集合来存储一个文件：<code>fs.files</code>与<code>fs.chunks</code>。<br><figure class="highlight"><table><tr><td class="code"><pre><span class="line"> <span class="comment">--fs.files</span></span><br><span class="line">&#123;</span><br><span class="line">   "filename": "test.txt",</span><br><span class="line">   "chunkSize": NumberInt(261120),</span><br><span class="line">   "uploadDate": ISODate("2014-04-13T11:32:33.557Z"),</span><br><span class="line">   "md5": "7b762939321e146569b07f72c62cca4f",</span><br><span class="line">   "length": NumberInt(646)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- fs.chunks</span></span><br><span class="line">&#123;</span><br><span class="line">   "files_id": ObjectId("534a75d19f54bfec8a2fe44b"),</span><br><span class="line">   "n": NumberInt(0),</span><br><span class="line">   "data": "Mongo Binary Data"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加文件</span></span><br><span class="line">mongofiles.exe -d gridfs put song.mp3</span><br><span class="line">db.fs.files.find()</span><br><span class="line"></span><br><span class="line"><span class="comment">--_id 获取区块(chunk)</span></span><br><span class="line">db.fs.chunks.find(&#123;files_id:ObjectId('534a811bf8b4aa4d33fdf94d')&#125;)</span><br></pre></td></tr></table></figure></p>
<ul>
<li><a href="https://docs.mongodb.com/v3.2/tutorial/access-mongo-shell-help/" target="_blank" rel="noopener">参考</a></li>
</ul>
]]></content>
      <tags>
        <tag>db</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库设计</title>
    <url>/2016/01/28/design-mysql/</url>
    <content><![CDATA[<h1 id="数据库的基本概念"><a href="#数据库的基本概念" class="headerlink" title="数据库的基本概念"></a>数据库的基本概念</h1><p>基本概念就一页PPT，让大家就一些数据库方面的概念达成一致。</p>
<ol>
<li><p>“单库”。</p>
</li>
<li><p>“分片”，也就是水平切分，它是用来解决数据量大的问题。有一些数据库支持auto sharding，自动分片，例如mongoDB，后来发现auto sharding不太可控，不知道什么时候会进行数据迁移，数据迁移过程中会有大粒度的锁，读写被阻塞，业务会有抖动和毛刺，这些是业务不能接受的。</p>
</li>
</ol>
<a id="more"></a>
<p>一旦进行分片，就会面临“数据路由”的问题，来了一个请求，要将请求路由到对应的数据库分片上。互联网常用的数据路由方法有三种：</p>
<ol>
<li><p>一个是按照数据范围路由，比如有两个分片，一个范围是0-1亿，一个范围是1亿-2亿，这样来路由。<br>这个方式的优点是非常的简单，并且扩展性好，假如两个分片不够了，增加一个2亿-3亿的分片即可。<br>这个方式的缺点是：虽然数据的分布是均衡的，每一个库的数据量差不多，但请求的负载会不均衡。例如有一些业务场景，新注册的用户活跃度更高，大范围的分片请求负载会更高。</p>
</li>
<li><p>二个是按照hash路由，比如有两个分片，数据模2寻库即可。<br>这个方式的优点是路由方式很简单，数据分布也是均衡的，请求负载也是均衡的。<br>这个方式的缺点是如果两个分片数据量过大，要变成三个分片，数据迁移会比较麻烦，即扩展性会受限。</p>
</li>
<li><p>三个是路由服务。前面两个数据路由方法均有一个缺点，业务线需要耦合路由规则，如果路由规则发生变化，业务线是需要配合升级的。路由服务可以实现业务线与路由规则的解耦，业务线每次访问数据库之前先调用路由服务，来知道数据究竟存放在哪个分库上。</p>
</li>
</ol>
<ol start="3">
<li>“分组”与“复制”，这解决的是扩展读性能，保证读高可用的问题。<br>大部分互联网的业务都是读多写少。<br>淘宝、京东查询商品，搜索商品的请求可能占了99%，只有下单和支付的时候有写请求。<br>58同城搜索帖子，察看列表页，查看详情页都是读请求，发布帖子是写请求，写请求的量也是比较少的。<br>大部分互联网的场景都读多写少，一般来说读性能会最先成为瓶颈，怎么快速解决这个问题呢？</li>
</ol>
<p>我们通常使用<strong>读写分离</strong>，扩充读库的方式来提升系统的读性能，同时多个读库也保证了读的可用性，一台读库挂了，另外一台读库可以持续的提供服务。</p>
<h1 id="可用性架构实践"><a href="#可用性架构实践" class="headerlink" title="可用性架构实践"></a>可用性架构实践</h1><p>数据库大家都用，平时除了根据业务设计表结构，根据访问来设计索引之外，还应该在设计时考虑数据的可用性，可用性又分为读的高可用与写的高可用。</p>
<p>上图是“读”高可用的常见玩法，我们是怎么样保证读库的高可用的呢？解决高可用这个问题的思路是冗余。<br>解决站点的可用性问题冗余多个站点，解决服务的可用性问题冗余多个服务，解决数据的可用性问题冗余多份数据。<br>如果用一个读库，保证不了读高可用，就复制读库，一个读库挂了另一个仍然可以提供服务，这么用复制的方式来保证读的可用性。</p>
<p>数据的冗余会引发一个副作用，就是一致性的问题。<br>如果是单库，读和写都落在同一个库上，每次读到的都是最新的数据库，不存在一致性的问题。<br>但是为了保证可用性将数据复制到多个地方，而这多个地方的数据绝对不是实时同步的，会有同步时延，所以有可能会读到旧的数据。如何解决主从数据库一致性问题我们在后面再来讲。</p>
<p>很多互联网公司的数据库软件架构都是一主两从或者一主三从，不能够保证“写”的高可用，因为写其实还是只有一个库，仍是单点，如果这个库挂了的话，写会受影响。那小伙伴们为什么还使用这个架构呢？<br>我刚才提到大部分互联网公司99%的业务都是“读”业务，写库不是主要矛盾，写库挂了，可能只有1%的用户会受影响。<br>如果要做到“写”的高可用，对数据库软件架构的冲击比较大，不一定值得，为了解决1%的问题引入了80%的复杂度，所以很多互联网公司都没有解决写数据库的高可用的问题。</p>
<p>怎么来解决写的高可用问题呢？思路还是<strong>冗余</strong>，读的高可用是冗余读库，写的高可用是冗余写库。把一个写变成两个写，做一个<strong>双主同步</strong>，一个挂了的话，可以将写的流量自动切到另外一个，写库的高可用性。</p>
<p>用双主同步的方式保证写高可用性会存在什么样的问题？</p>
<p>刚才提到，用冗余的方式保证可用性会存在一致性问题。因为两个主相互同步，这个同步是有时延的，很多公司用到auto-increment-id这样的一些数据库的特性，<strong>如果用双主同步的架构，一个主id由10变成11，在数据没有同步过去之前，另一个主又来了一个写请求，也由10变成11，双向同步会主键冲突，同步失败，造成数据丢失</strong>。</p>
<p>解决这个双主同步id冲突的方案有两种：</p>
<ol>
<li>一个是双主使用不同的初始值，相同的步长来生成id，一个库从0开始（生成02468），一个库从1开始（生成13579），步长都为2，这样两边同步数据就不会冲突。</li>
<li>另一个方式是不要使用数据库的auto-increment-id，而由业务层来保证生成的id不冲突。<a href="http://changyuan.github.io/2015/12/04/gen-id-way/">参考</a></li>
<li>使用的是“双主”当“主从”的方式来保证数据库的读写可用性,虽然看上去是双主同步，但是读写都在一个主上，另一个主库没有读写流量，完全是备份。当一个主库挂掉的时候，流量会自动的切换到另外一个主库上，这一切对业务线都是透明的，自动完成。但缺点有两个：<ul>
<li>数据库资源利用率只有50%；</li>
<li>没有办法通过增加读库的方式来扩展系统的读性能；</li>
</ul>
</li>
</ol>
<h1 id="读性能架构实践"><a href="#读性能架构实践" class="headerlink" title="读性能架构实践"></a>读性能架构实践</h1><p>如何增加数据库的读性能，先看下传统的玩法：</p>
<ol>
<li>增加从库，通过增加从库来提升读性能，缺点是什么呢？从库越多，写的性能越慢，同步的时间越长，不一致的可能性越高。</li>
<li>增加缓存，缓存是大家用的非常多的一种提高系统读性能方法，特别是对于读多写少的互联网场景非常的有效。上游是业务线，下游是读写分离主从同步和一个cache。<br>对于写操作：<strong>会先淘汰cache，再写数据库</strong>。<br>对于读操作：先读cache，如果cache hit则返回数据，如果cache miss则读从库，然后把读出来的数据再入缓存。</li>
</ol>
<p>cache玩法在一种异常时序下，会引发严重的一致性问题，考虑这样一个特殊的时序：</p>
<ol>
<li>先来了一个写请求，淘汰了cache，写了数据库；</li>
<li>又来了一个读请求，读cache，cache miss了，然后读从库，此时写请求还没有同步到从库上，于是读了一个脏数据，接着脏数据入缓存；</li>
<li>最后主从同步完成，这个时序会导致脏数据一直在缓存中没有办法被淘汰掉，数据库和缓存中的数据严重不一致。</li>
</ol>
<h1 id="一致性架构实践"><a href="#一致性架构实践" class="headerlink" title="一致性架构实践"></a>一致性架构实践</h1><p>58同城采用“服务+缓存+数据库”一套的方式来保证数据的一致性，由于58同城使用“双主当主从用”的数据库读写高可用架构，读写都在一个主库上，不会读到所谓“读库的脏数据”，所以数据库与缓存的不一致情况也不会存在。</p>
<p>主从为什么会不一致？刚才提到读写会有时延，有可能读到从库上的旧数据。常见的方法是引入中间件，业务层不直接访问数据库，而是通过中间件访问数据库，这个中间件会记录哪一些key上发生了写请求，在数据主从同步时间窗口之内，如果key上又出了读请求，就将这个请求也路由到主库上去（因为此时从库可能还没有同步完成，是旧数据），使用这个方法来保证数据的一致性。</p>
<p>中间件的方案很理想，那为什么大部分的互联网的公司都没有使用这种方案来保证主从数据的一致性呢？那是因为数据库中间件的技术门槛比较高，有一些大公司，例如百度，腾讯，阿里他们可能有自己的中间件，并不是所有的创业公司互联网公司有自己的中间件产品，况且很多互联网公司的业务对数据一致性的要求并没有那么高。比如说同城搜一个帖子，可能5秒钟之后才搜出来，对用户的体验并没有多大的影响。</p>
<p>除了中间件，读写都路由到主库，58同城就是这么干的，也是一种解决主从不一致的常用方案。</p>
<p>解决完主从不一致，第二个要解决的是数据库和缓存的不一致，刚才提到cache传统的玩法，脏数据有可能入cache，我们怎么解决呢？<br>两个实践：第一个是缓存双淘汰机制，第二个是建议为所有item设定过期时间（前提是允许cache miss）。<br>（1）缓存双淘汰，传统的玩法在进行写操作的时候，先淘汰cache再写主库。上文提到，在主从同步时间窗口之内可能有脏数据入cache，此时如果再发起一个异步的淘汰，即使不一致时间窗内脏数据入了cache，也会再次淘汰掉。<br>（2）为所有item设定超时时间，例如10分钟。极限时序下，即使有脏数据入cache，这个脏数据也最多存在十分钟。带来的副作用是，可能每十分钟，这个key上有一个读请求会穿透到数据库上，但我们认为这对数据库的从库压力增加是非常小的。</p>
<h1 id="扩展性架构实践"><a href="#扩展性架构实践" class="headerlink" title="扩展性架构实践"></a>扩展性架构实践</h1><p>扩展性也是架构师在做数据库架构设计的时候需要考虑的一点。我分享一个58同城非常帅气的秒级数据扩容的方案。这个方案解决什么问题呢？原来数据库水平切分成N个库，现在要扩容成2N个库，要解决这个问题。</p>
<p>假设原来分成两个库，假设按照hash的方式分片，如上图分为奇数库和偶数库。</p>
<p>第一个步骤提升从库，底下一个从库放到上面来（其实什么动作都没有做）；<br>第二个步骤修改配置，此时扩容完成，原来是2个分片，修改配置后变成4个分片，这个过程没有数据的迁移。原来偶数的那一部分现在变成了两个部分，一部分是0，一部分是2，奇数的部分现在变成1和3。0库和2库没有数据冲突，只是扩容之后在短时间内双主的可用性这个特性丢失掉了。</p>
<p>第三个步骤还要做一些收尾操作：把旧的双主给解除掉，为了保证可用性增加新的双主同步，原来拥有全部的数据，现在只为一半的数据提供服务了，我们把多余的数据删除掉，结尾这三个步骤可以事后慢慢操作。整个扩容在过程在第二步提升从库，修改配置其实就秒级完成了，非常的帅气。<br>这个方案的缺点是只能实现N库到2N 库的扩容，2变4、4变8，不能实现2库变3库，2库变5库的扩容，如何能够实现这种扩容呢？</p>
<p>数据库扩展性方面有很多的需求，例如刚才说的2库扩3库，2库扩5库。产品经理经常变化需求，扩充表的属性也是经常的事情，今年的数据库大会同行也介绍了一些使用触发器来做online schema change的方案，但是触发器的局限性在于：<br>第一、触发器对数据库性能的影响比较大；<br>第二、触发器只能在同一个库上才有效，而互联网的场景特点是数据量非常大，并发量非常大，库都分布在不同的物理机器上，触发器没法弄。<br>最后还有一类扩展性需求，底层存储介质发生变化，原来是mongodb存储，现在要变为mysql存储，这也是扩展性需求（虽然很少），这三类需求怎么扩展？</p>
<p>方法是导库，迁移数据，迁移数据有几种做法，第一种停服务，如果大家的业务能够接受这种方法，强烈建议使用这种方法，例如有一些游戏公司，晚上一点到两点服务器维护，可能就是在干分区或者合区这类导库的事情。</p>
<p>如果业务上不允许停服务，想做到平滑迁移，双写法可以解决这类问题。<br>（1）双写法迁移数据的第一步是升级服务，原来的服务是写一个库，现在建立新的数据库，双写。比如底层存储介质的变化，我们原来是mongo数据库，现在建立好新的mysql数据库，然后对服务的所有写接口进行双库写升级。</p>
<p>（2）第二步写一个小程序去进行数据的迁移。比如写一个离线的程序，把两个库的数据重新分片，分到三个库里。也可能是把一个只有三个属性的用户表导到五个属性的数据表里面。这个数据迁移要限速，导完之后两个库的数据一致吗？只要提前双写，如果没有什么意外，两边的数据应该是一致的。<br>什么时候会有意外呢？在导某一条数据的过程当中正好发生了一个删除操作，这个数据刚被服务双写删除，又被迁移数据的程序插入到了新库中，这种非常极限的情况下会造成两边的数据不一致。</p>
<p>（3）建议第三步再开发一个小脚本，对两边的数据进行比对，如果发现了不一致，就将数据修复。当修复完成之后，我们认为数据是一致的，再将双写又变成单写，数据完成迁移。<br>这个方式的优点：<br>第一、改动是非常小的，对服务的影响比较小，单写变双写，开发两个小工具，一个是迁移程序，从一个库读数据，另外一个库插进去；还有一个数据校验程序，两个数据进行比对，改动是比较小的。<br>第二、随时可回滚的，方案风险比较小，在任何一个步骤如果发现问题，可以随时停止操作。比如迁移数据的过程当中发现不对，就把新的数据库干掉，重新再迁。因为在切换之前，所有线上的读服务和写服务都是旧库提供，只有切了以后，才是新库提供的服务。这是我们非常帅气的一个平滑导库的方式。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>分片解决的是数据量大的问题，</li>
<li>复制和分组解决的是提高读性能，保证读的可用性的问题。</li>
<li>分片会引入路由，常用的三种路由的方法，按照范围、按照hash，或者新增服务来路由。</li>
<li>怎么保证数据的<strong>可用性</strong>，保证数据可用性的思路是<strong>冗余</strong>，但会引发数据的不一致，可用性的实践是<strong>双主当主从用</strong>，读写流量都在一个库上，另一个库standby，一个主库挂掉流量自动迁移到另外一个主库，只是资源利用率是50%，并且不能通过增加从库的方式提高读性。</li>
<li>读性能的实践：传统的玩法是<strong>增加从库</strong>或者<strong>增加缓存</strong>。存在的问题是：主从可能不一致，同城的玩法是<strong>服务+数据库+缓存</strong>一套的方式来解决这些问题。</li>
<li>一致性的实践，解决主从不一致性有两种方法:<br>增加中间件: 中间件记录哪些key上发生了写操作，在主从同步时间窗口之内的读操作也路由到主库。<br>强制读主: 数据库与缓存的一致性，我们的实践是双淘汰，在发生写请求的时候，淘汰缓存，写入数据库，再做一个延时的缓存淘汰操作。第二个实践是建议为所有的item设置一个超时时间。</li>
</ul>
<p><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=400465735&amp;idx=1&amp;sn=8d7067de4cc8f73ea5558f07e0a9340e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">如何秒级扩容的结构？</a></p>
<blockquote>
<ol>
<li>提升从库 （把原来的shadow-master改成master）</li>
<li>修改配置（靠服务，hash取模）</li>
<li>接触旧的双主；新增新的双主；删除旧的数据（余0的主，可以将余2的数据删除掉）<br><img src="/images/technology/snowflake-64bit.jpg" alt="db-mater"></li>
</ol>
</blockquote>
<p>P.S.:</p>
<blockquote>
<ul>
<li>分布式领域CAP理论：</li>
<li>Consistency(一致性), 数据一致更新，所有数据变动都是同步的</li>
<li>Availability(可用性), 好的响应性能</li>
<li>Partition tolerance(分区容错性) 可靠性</li>
<li>任何分布式系统只可同时满足二点，没法三者兼顾。 </li>
<li>忠告：不要将精力浪费在如何设计能满足三者的完美分布式系统，而是进行取舍。</li>
</ul>
</blockquote>
]]></content>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>【转】赶集Mysql军规</title>
    <url>/2016/01/28/ganji-design-msyql-rule/</url>
    <content><![CDATA[<p>写在前面:</p>
<p>++ 总是在灾难发生后，才想起容灾的重要性；总是在吃过亏后，才记得曾经有人提醒过。++</p>
<h1 id="核心军规"><a href="#核心军规" class="headerlink" title="核心军规"></a>核心军规</h1><ol>
<li>不在数据库做运算：cpu计算务必移至业务层</li>
<li>控制单表数据量：单表记录控制在1000w</li>
<li>控制列数量：字段数控制在20以内</li>
<li>平衡范式与冗余：为提高效率牺牲范式设计，冗余数据</li>
<li>拒绝3B：拒绝大sql，大事物，大批量</li>
</ol>
<a id="more"></a>
<h1 id="字段类军规"><a href="#字段类军规" class="headerlink" title="字段类军规"></a>字段类军规</h1><ol start="7">
<li>用好数值类型</li>
</ol>
<ul>
<li>tinyint(1Byte)</li>
<li>smallint(2Byte)</li>
<li>mediumint(3Byte)</li>
<li>int(4Byte)</li>
<li>bigint(8Byte)</li>
<li>bad case：int(1)/int(11)</li>
</ul>
<ol start="8">
<li>字符转化为数字</li>
</ol>
<ul>
<li>用int而不是char(15)存储ip</li>
<li>优先使用enum或set,例如：<code>sex</code> enum (‘F’, ‘M’)</li>
<li>避免使用NULL字段；NULL字段很难查询优化；NULL字段的索引需要额外空间；NULL字段的复合索引无效<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">bad case：</span><br><span class="line">`name` char(32) default null</span><br><span class="line">`age` int not null</span><br><span class="line">good case：</span><br><span class="line">`age` int not null default 0</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="9">
<li>少用text/blob<br>varchar的性能会比text高很多；实在避免不了blob，请拆表;不在数据库里存图片：是否需要解释？</li>
</ol>
<h1 id="索引类军规"><a href="#索引类军规" class="headerlink" title="索引类军规"></a>索引类军规</h1><ol start="12">
<li>谨慎合理使用索引；改善查询、减慢更新；索引一定不是越多越好（能不加就不加，要加的一定得加）；覆盖记录条数过多不适合建索引，例如“性别”</li>
<li>字符字段必须建前缀索引</li>
<li>不在索引做列运算：<code>select id where age +1 = 10;</code></li>
<li>innodb主键推荐使用自增列（SK：博主不认可）;主键建立聚簇索引;主键不应该被修改；字符串不应该做主键；如果不指定主键，innodb会使用唯一且非空值索引代替</li>
<li>不用外键；请由程序保证约束</li>
</ol>
<h1 id="sql类军规"><a href="#sql类军规" class="headerlink" title="sql类军规"></a>sql类军规</h1><ol start="17">
<li>sql语句尽可能简单；一条sql只能在一个cpu运算；大语句拆小语句，减少锁时间；一条大sql可以堵死整个库</li>
<li>简单的事务,事务时间尽可能短。不好的例子：上传图片事务</li>
<li>避免使用trig/func；触发器、函数不用；客户端程序取而代之</li>
<li>不用select * ： 消耗cpu，io，内存，带宽，这种程序不具有扩展性</li>
<li><p>OR改写为IN()；<code>or</code>的效率是n级别；<code>in</code>的消息时log(n)级别；in的个数建议控制在200以内</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> phone=’<span class="number">159</span>′ <span class="keyword">or</span> phone=’<span class="number">136</span>′;</span><br><span class="line">=&gt;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> phone <span class="keyword">in</span> (’<span class="number">159</span>′, ’<span class="number">136</span>′);</span><br></pre></td></tr></table></figure>
</li>
<li><p>OR改写为UNION<br>mysql的索引合并很弱智</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> phone = ’<span class="number">159</span>′ <span class="keyword">or</span> <span class="keyword">name</span> = ‘john’;</span><br><span class="line">=&gt;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> phone=’<span class="number">159</span>′</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">name</span>=’jonh’</span><br></pre></td></tr></table></figure>
</li>
<li><p>避免负向%</p>
</li>
<li>慎用count(*)</li>
<li><p>limit高效分页<br>limit越大，效率越低</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">limit</span> <span class="number">10000</span>, <span class="number">10</span>;</span><br><span class="line">=&gt;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">id</span> &gt; <span class="number">10000</span> <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>union all</code>替代<code>union</code>, <code>union</code>有去重开销</p>
</li>
<li>少用连接join</li>
<li>使用group by,分组,自动排序</li>
<li>请使用同类型比较</li>
<li>使用<code>load data</code>导数据<br>load data比insert快约20倍；</li>
<li>打散批量更新</li>
<li>新能分析工具<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> profile;</span><br><span class="line">mysqlsla;</span><br><span class="line">mysqldumpslow;</span><br><span class="line"><span class="keyword">explain</span>;</span><br><span class="line"><span class="keyword">show</span> slow <span class="keyword">log</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">processlist</span>;</span><br><span class="line"><span class="keyword">show</span> query_response_time(percona)</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>做好产品</title>
    <url>/2016/06/23/growth-hack/</url>
    <content><![CDATA[<h1 id="Growth-Hack-把产品做好"><a href="#Growth-Hack-把产品做好" class="headerlink" title="Growth Hack = 把产品做好"></a>Growth Hack = 把产品做好</h1><h2 id="产品完成度-百分制"><a href="#产品完成度-百分制" class="headerlink" title="产品完成度(百分制)"></a>产品完成度(百分制)</h2><p>1.mvp(minimal viable product),最小的解决方法 20分 2.pmf(product market fit) （60分）</p>
<ul>
<li>产品在这个市场做的下去</li>
<li>养得起员工</li>
<li>持续有小型成长 3.Growth Hack （60(可以温饱)-90（垄断市场）） 4.20分(有人用)–&gt;75分（有用户回流）</li>
</ul>
<p>pitch</p>
<h2 id="產品的系統性成長-Growth-方法"><a href="#產品的系統性成長-Growth-方法" class="headerlink" title="產品的系統性成長 ( Growth ) 方法"></a>產品的系統性成長 ( Growth ) 方法</h2><p>首先，你必須認知到自己的產品到底屬於哪一個階段。</p>
<p>10 分：沒人用 20 分：Minmal Viable Product 40 分：可以跟顧客收錢 60 分：Product Market Fit 75 分：客戶回流高 90 分：壟斷市場</p>
<p>使用 NPS 量測： 產品 40 分以上的產品，NPS 必須是正的。 產品 60 分以上的產品，NPS 必須要超過 20 分。 產品 75 分以上的產品，NPS 必須要超過 40 分。 產品 90 分以上的產品，NPS 必須要超過 50 分。 值得注意的是，免費與低價的產品，通常 NPS 太高沒有真正的價值。</p>
<p>如果你的產品價格正常， NPS 還是時常遠高於 70，那可能收費太便宜了。<br><a id="more"></a></p>
<h1 id="創業第一階段如何挑選主題，並找到客戶"><a href="#創業第一階段如何挑選主題，並找到客戶" class="headerlink" title="創業第一階段如何挑選主題，並找到客戶"></a>創業第一階段如何挑選主題，並找到客戶</h1><h2 id="快速PMF主题"><a href="#快速PMF主题" class="headerlink" title="快速PMF主题"></a>快速PMF主题</h2><ul>
<li>你熟悉的主题：做得好马上可以解决大家的需求</li>
<li>周边需要量很大的主题：需求大了用户就多了，方案不好也没关系 选择一个20-50（有人用—收支平衡） 3-6个月建成。很多人失败的原因是选择0分—30分的题目,花了两年。</li>
</ul>
<h3 id="growth（成长）-conversion（转化）-churn-流失"><a href="#growth（成长）-conversion（转化）-churn-流失" class="headerlink" title="growth（成长） = conversion（转化） - churn(流失)"></a>growth（成长） = conversion（转化） - churn(流失)</h3><p>成长=增加转化率，并且减少流失的空间。</p>
<h2 id="建立介紹產品页面-Landing-page"><a href="#建立介紹產品页面-Landing-page" class="headerlink" title="建立介紹產品页面(Landing page)"></a>建立介紹產品页面(Landing page)</h2><ul>
<li>一句话形容自己的「价值」而不是「功能」</li>
<li>使用这个服务的三大好处</li>
<li>How it works</li>
<li>使用者见证/报导</li>
<li>CALL TO ACTION(行动号召)</li>
<li>消除疑虑</li>
</ul>
<h2 id="CALL-TO-ACTION-之后"><a href="#CALL-TO-ACTION-之后" class="headerlink" title="CALL TO ACTION 之后"></a>CALL TO ACTION 之后</h2><p>用工具搜集 “Leads” （ Email List 销售机会） 或直接購買產品</p>
<h2 id="放上-online-chat"><a href="#放上-online-chat" class="headerlink" title="放上 online chat"></a>放上 online chat</h2><p>Churn 也包括流失的销售机会，所以你一定要放上 online chat 软文捕捉这些人</p>
<p>Intercom Zopim</p>
<p><a href="http://blog.xdite.net/posts/2016/02/01/grow-product-systematically" target="_blank" rel="noopener">http://blog.xdite.net/posts/2016/02/01/grow-product-systematically</a></p>
]]></content>
  </entry>
  <entry>
    <title>mysql位运算简化一对多关系</title>
    <url>/2016/12/23/mysql-bit/</url>
    <content><![CDATA[<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>&amp; : 按位与，二进制位同时都为1的位设为1。<br>| : 按位或，二进制位有一个位为1就为1.<br>^ : 位异或，对应位的二进制数不同时，对应位的结果才为1；如果两个对应位数都为0或者都为1，则对应位的结果为0。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$a = 6 转化为2进制为 110</span><br><span class="line">$b = 3 转化为2进制为 11</span><br><span class="line">$a &amp; $b即是 110 与 11</span><br><span class="line">将$a和$b中都为1的位设为1,位数不够的补0.即110 与 011</span><br><span class="line">运算结果010,转化为十进制结果为2</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>每个景点包含很多属性，例如适合旅游的月份，我们一般的做法可能有两种：</p>
<ol>
<li>是增加一个varchar字段，每个月份之间用一个特殊符号分隔保存，例如“1,2,3,11</li>
<li>建立一个关系表,在这里不能使用1-12的数字来表示月份，而是使用1，2，4，8，16，32，64，128，512，1024，2048，4096来表示，如果是多个月份，可以相互组合相加，之后存储为一个值。<br>比如 1,10,12月份，就可以存储<code>1+512+4096=4609</code>,4096 这个值。</li>
</ol>
<blockquote>
<p>这个技巧<strong>适用于属性较少的一对多</strong>的场景，可以存储1个或者多个，太多的话还是推荐试用关系表。常用的属性有：月份，消息提醒类型，各种有限的类型组合等等。</p>
</blockquote>
<h4 id="使用技巧："><a href="#使用技巧：" class="headerlink" title="使用技巧："></a>使用技巧：</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 添加一个分类 用 “|”</span></span><br><span class="line"><span class="keyword">SELECT</span> (<span class="number">4</span>|<span class="number">2</span>|<span class="number">1</span>); <span class="comment">--- = 7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 去掉一个分类，用“^”</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">7</span> ^ <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 当我们需要查询某个月份的景点时，例如查询3月份的景点，可使用以下语句：</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`spots`</span> <span class="keyword">WHERE</span> <span class="string">`month`</span> &amp; <span class="number">4</span> = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 当设置某个景点适合某个月份时，例如设置4325的景点适合2月份，可使用下面的语句：</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`spots`</span> <span class="keyword">SET</span> <span class="string">`month`</span> = <span class="string">`month`</span> | <span class="number">2</span> <span class="keyword">WHERE</span> <span class="string">`id`</span> = <span class="number">4325</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 当取消设置某个景点的月份时，可使用下面的语句：</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`spots`</span> <span class="keyword">SET</span><span class="string">` month`</span> = <span class="string">`month`</span> ^ <span class="number">2</span> <span class="keyword">WHERE</span><span class="string">`id`</span>= <span class="number">4325</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询同时适合多个月份的数据，例如需要查询设置了11，12，1月份的景点，将其三个月份对应的数值加起来，结果为6145，然后使用这个数值进行查询：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`spots`</span> <span class="keyword">WHERE</span> <span class="string">`month`</span> &amp; <span class="number">6145</span> = <span class="number">6145</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询只要适合，1,11,12月份其中一个月份的景点就行</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`spots`</span> <span class="keyword">WHERE</span> (<span class="string">`month`</span> &amp; <span class="number">4096</span> = <span class="number">4096</span>) <span class="keyword">or</span> (<span class="string">`month`</span> &amp; <span class="number">2048</span> = <span class="number">2048</span>) <span class="keyword">or</span> (<span class="string">`month`</span> &amp; <span class="number">1</span> = <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>《细节，如何轻松的影响他人》（说服科学）</title>
    <url>/2016/10/12/influence/</url>
    <content><![CDATA[<p>整本书都是一些社会实验出来的，从小的行为改变，去让周围的人发生行为改变，小改变，大影响。也是书中说的四两拨千斤的效果。本书列举了50多个小的技巧，总结一些好好的把这些应用到自己的生活场景中去，才算真正的读到了，学到了。当应用中会有更多的思考，是否有效，有一些已经在生活中已经使用，只不过我们不知道。以及如何更好的应用？怎样多个技巧叠加使用，还是只能使用一个技巧？多个技巧使用了反而没有效果了？为什么？因此写在这里，以备日后查找，总结。<br><a id="more"></a></p>
<h5 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h5><p>－ 整个说服科学（persuasion science）来自实实在在的证据。<br>－ 互惠－人们都有义务偿还别人给予的恩惠<br>－ 权威－人们都相信专家的指点<br>－ 稀缺－物以稀为贵<br>－ 喜好－人们越喜欢某个人，就越容易答应他的请求，爱屋及乌<br>－ 保持一致－人们希望做出自己的承诺和价值观相符合的行为<br>－ 社会认同你－人们会参照他人的做法知道自己的行为<br>做一些小的调整，把你要说的信息与对方的内心深处的冬季关联起来，找到关键的地方，就能带来显著的成效。</p>
<h5 id="向“大众”借力"><a href="#向“大众”借力" class="headerlink" title="向“大众”借力"></a>向“大众”借力</h5><p>社会认同原理（social proof），也就说从众心理。社会认同的力量往往胜过理性的认知。“大家怎么做，我就怎么做”是一个通往明智的，高效的捷径。人们通常对于很多事情不会去独立思考，而选择从众。缴税的例子，在提醒的例子上，提示有多少人已经缴税，而且数据缴税数字说的更准确一些。<br>－ 高效作出决定<br>－ 获得社会认同<br>－ 所提倡的事情要是积极的，积极的态度看待自己</p>
<h5 id="“小众”的反作用力"><a href="#“小众”的反作用力" class="headerlink" title="“小众”的反作用力"></a>“小众”的反作用力</h5><p>当作出和大众不同的决策时候，“小众”人群的大脑中与情绪处理有关的区域被激活了，与众人背道而驰是有情感成本的，我们获得了痛苦的代价。<br>当一个需要衡量的行为被公之于众的的时候，与群体划清界限的的攻击越强。当企业开发新用户的群体的时候，现有的这些客户群体为了把自己和这些新客户区分开，不屑与他们为伍，就不在使用这些产品了。这些“小众”的群里就是那部分特立独行的，寻找身份认同的。和苹果手机的一些用户也是。</p>
<h5 id="非常态VS常态"><a href="#非常态VS常态" class="headerlink" title="非常态VS常态"></a>非常态VS常态</h5><p>看不同的人是否遵守<strong>社会规范（social norm）</strong>。人们都愿意与社会规范保持一致，有的人为了张扬个性，刻意特立独行。如果咬说服这类人，需要使用<em>违背</em>原则，按照违背他们的角度去遣词造句，会更有效。<em>推正拉反，强调少数人，争取多数人</em>，</p>
<blockquote>
<p>例子：对于开会迟到大家是否认同，那么为了更好的影响更多的人的结果。如果大部分肯定，则强掉迟到的人有哪些负面的特质。相反，强调按时开会具备哪些积极正面的反应</p>
</blockquote>
<blockquote>
<p>例子：1。积极健身和成熟、聪明联系在一起2.把负面，愚蠢与不健康的生活方式联系在一起。发现越是正面的，越受2的影响，认为不常见的，则越受第一种的影响，即健身与正面的成熟的意见影响。都是相反的。</p>
</blockquote>
<h5 id="强大的环境暗示"><a href="#强大的环境暗示" class="headerlink" title="强大的环境暗示"></a>强大的环境暗示</h5><p>破窗理论<br>对环境背景作出一个小的调整，就会带来一个小的改变，当一个坏习惯没有得到制止，则会有更多的坏习惯。人都是环境的产物，很多人在国内扔垃圾在国外却不扔，人没有变，但是环境改变了，能量场改变了</p>
<h5 id="改个名字，改变一切"><a href="#改个名字，改变一切" class="headerlink" title="改个名字，改变一切"></a>改个名字，改变一切</h5><p>人们更倾向于和自己有相似背景的人或者事物站在一起。比如自己的相同的名字，自己的老乡。在传递的信息中展现他人的名字和地址等，则更显亲切。想获得更多人支持。</p>
<h5 id="如何化敌为友"><a href="#如何化敌为友" class="headerlink" title="如何化敌为友"></a>如何化敌为友</h5><p>人以群居，物以类分。和其他人找到同一种身份认同。或者寻找共同点，刻意帮助团队和合作伙伴更顺畅。</p>
<h5 id="预测他人的喜好、渴望与需求"><a href="#预测他人的喜好、渴望与需求" class="headerlink" title="预测他人的喜好、渴望与需求"></a>预测他人的喜好、渴望与需求</h5><p> 无论你是和一个认识多年的老客户打交道，还是可以一个合作很久的工作搭档相处，要给他们定期交换新秩序，安排一些非正式的沟通机会，增进彼此了解，讲座的重要性怎么强调也不为过。</p>
<h5 id="主动承诺的力量"><a href="#主动承诺的力量" class="headerlink" title="主动承诺的力量"></a>主动承诺的力量</h5><p>主动承诺。如果晨会结束，今年让每个人把工作复述一遍，切实执行就更有望实现。亲自把下次月的时间和，日前写的卡片上。八，自己，所有的行动计划记录下来，然后分发给众人，然后再发电子邮件，加上一段简单的话，请收件人，回复一个好的，来确认。</p>
<h5 id="承诺要行动，要公开"><a href="#承诺要行动，要公开" class="headerlink" title="承诺要行动，要公开"></a>承诺要行动，要公开</h5><p>承诺要行动要公开。当你要劝说某人许下承诺时，请他做一个，比较宽泛，而不是具体的承诺，你的成功概率会更大。</p>
<h5 id="“心安理得”效应"><a href="#“心安理得”效应" class="headerlink" title="“心安理得”效应"></a>“心安理得”效应</h5><p>心安理得效应。客人在办理入住时先签个承诺书，这不仅提高毛毯和床单的水冲水效率，而且让客人在离开房间更容易记得关灯关电视，这就是一个正向溢出效应。如果人们在使用和丢弃产品时产生了内疚心理，那么通过回收利用的行为，他们就可以减少这种因过度消费而产生，的负面情绪。</p>
<h5 id="如何为员工鼓励儿加油"><a href="#如何为员工鼓励儿加油" class="headerlink" title="如何为员工鼓励儿加油"></a>如何为员工鼓励儿加油</h5><p>使用前文提出的主动承诺原理，请团队挑出自己喜欢做的事情，并当着同事单独出来。另一个做法是，把客户请过来现身说法，让员工听见客户的声音。就是让员工意识到自己做的事情的重要性外化出来，从而提高他的成就感，这个小技巧，也是金钱有时候达不到的。也许管理者能做的最微小的改变，就是看到员工做得出色，<strong>是简单说一句，干的漂亮吧</strong>。</p>
<h5 id="如何避开决策陷阱"><a href="#如何避开决策陷阱" class="headerlink" title="如何避开决策陷阱"></a>如何避开决策陷阱</h5><p>把决策者和谈判者的角色分开，承诺升级以及财务上的风险就可以规避了。不能自己是运动员，又是裁判员。如果你，在组织中负责某个项目的执行，那你最好把评估它成功与否的工作交给组织里的其他人来做，这里是，因为你容易过高的估计，而且项目的价值有时候高估的程度会惊人。因为自己已经先入为主，受环境影响了，评估人跟你联系越少，评判客观度会更高。</p>
<h5 id="巧用“执行意向”"><a href="#巧用“执行意向”" class="headerlink" title="巧用“执行意向”"></a>巧用“执行意向”</h5><p>让他们做一个具体的计划，说说他们打算在，何时、何地、准备如何执行这件事。例子，这周三下午4点能来开会吗？改成这周三下午4点之前，开会之前你打算做什么？写下你具体需要执行的，那个时间。我们会倡导受试者把承诺公开。</p>
<h5 id="推迟一点会更好"><a href="#推迟一点会更好" class="headerlink" title="推迟一点会更好"></a>推迟一点会更好</h5><p>未来绑定法，当你想要去说服他人接受你，我改变的时候不要让他立即就改，而是改变放到未来的某个时段，当然前提是，这改变对他是有益的。这样你可能会得到更多人的支持和认同。回来把你放到另一个是用年月是购买公共服务，比如安装宽带，有线电视信用卡。比如那年的淘宝的十月围城也是过了几个月，然后再调高费用。</p>
<h5 id="为了将来的自己"><a href="#为了将来的自己" class="headerlink" title="为了将来的自己"></a>为了将来的自己</h5><p>将来的自己过得好不好，却要仰仗现在的你，你现在的决策，将决定将来的自己能拥有多少财务安全感。尽管生活中某些方面会随着时间改变的是每个人的核心身份，他们最真实的自我始终是不变的，要想方设法拉近现在的我和未来的我的之间的距离，例如用ps软件，看到自己苍老的未来。</p>
<h5 id="目标设得好，干劲会更足"><a href="#目标设得好，干劲会更足" class="headerlink" title="目标设得好，干劲会更足"></a>目标设得好，干劲会更足</h5><p>给自己设立一个浮动的区间（8%~10%）。让人们实现目标两个最重要的因素，挑战性与可实践性。简单地说，他之所以能够促使人们重拾目标，是因为让人能打可实现性和可挑战性的方面成就感全占了。就像很多诱惑的广告，把你搞的蠢蠢欲动，其实就是拉近了可实践性和挑战性的距离。</p>
<h5 id="损失规避原则"><a href="#损失规避原则" class="headerlink" title="损失规避原则"></a>损失规避原则</h5><p>人们得到十块钱和失去十块钱的，痛苦是不一样的。这个启发就告诉我们甚至两个选择，让受众者主动挑选一个，然后再向前迈一步，你想让他们选的那个包装一下，向他们指出，如果不这么做的话，就会损失什么。例子，今年秋天我会打流感疫苗，因为我想降低流感的风险，并且节省五十美元，或者，今年秋天我不想打疫苗，即便这意味着我得流感，风险可能会挺高，而且无法节省五十美元。</p>
<h5 id="如何克服拖延症"><a href="#如何克服拖延症" class="headerlink" title="如何克服拖延症"></a>如何克服拖延症</h5><p>设立一个截止日期。注册率设置一个临近的截止日期。<br>推荐一部热门影片，《杯酒人生》里面的一个片段，教你如何不露痕迹地说服他人:</p>
<blockquote>
<p>迈尔斯:我存了点好东西，一瓶1961年，白马酒庄的好酒。<br>玛雅:你有瓶1961年白马酒庄的酒却放着不喝，品尝它的最佳时间可能已经过了，你在等什么呢？<br>迈尔斯:不知道，某个特别的日子吧，给一个对的人共享，我本想留到结婚十周年纪念日上喝的<br>玛雅:把1961年白马酒庄的酒打开的那一天就是特别的日子。</p>
</blockquote>
<h5 id="如何留住顾客跟定你"><a href="#如何留住顾客跟定你" class="headerlink" title="如何留住顾客跟定你"></a>如何留住顾客跟定你</h5><p>改善自己的服务，如果电话在没有接听之前，您可以跟顾客一点事情做，给顾客分分心，降低她的焦虑感。像海底捞一样等待的人那么多可以提供玩具玩。</p>
<h5 id="把潜力变成现实"><a href="#把潜力变成现实" class="headerlink" title="把潜力变成现实"></a>把潜力变成现实</h5><p>把潜力变成现实，一个工作经验，和过往业绩，压根无法跟你相提并论的对手，把客户从你这抢走了。人对潜力更有兴趣。</p>
<h5 id="把会议开的更高效"><a href="#把会议开的更高效" class="headerlink" title="把会议开的更高效"></a>把会议开的更高效</h5><ul>
<li>第一，请参加会议的人提前提交信息，提交大家的想法。如果，你面临一个问题，还想挑战下每个组员都贡献智慧，那么与其让每个人都同时说出想法和建议，更高效的做法，让大家花几分钟静静的想一想自己的主页，然后写下来提交给全组。</li>
<li>第二，组织会议的最后一个人的发言会对大家产生影响，先入为主，所以领导者要先倾听大家的声音，最后表达自己的建议。</li>
<li>第三，做个任务清单会很有用。列出必要的点。</li>
<li>第四，对会议的座次安排作出微妙调整，圆桌式的会能唤起人们的归属感，参与者更容易重视小组整体目标，也更容易强调全组人的利益，相反，当作是安排呈现出带角的形状，或方形的形状，效果刚好相反，这种将激发了人们，对独特性的追求，很容易产生个人主义。所以当一个领导者想要说服自己的员工行动起来，大家齐心协力，最好把座椅，摆成圆桌式的，如果一个领导，让自己的团队为自己的行为负责，那么正方形或者长方形的桌椅更好。</li>
</ul>
<h5 id="服装的影响力"><a href="#服装的影响力" class="headerlink" title="服装的影响力"></a>服装的影响力</h5><p>你的气质和你的穿着打扮要相当，比如说你是个教授，或者和，别的公司去谈判，不能穿着太随意。</p>
<h5 id="亮出专家身份"><a href="#亮出专家身份" class="headerlink" title="亮出专家身份"></a>亮出专家身份</h5><p>人们总是相信专家的权威，当某人接受了专家的建议，那么他的脑部活动就停止了，也就是说，不再进行批判性思维，反驳的力度也就降低了，如果有关专家的建议可以使用，那就把它早早的摆出来，要不这样的话可能就有点傻了。</p>
<h5 id="不确定的说服力"><a href="#不确定的说服力" class="headerlink" title="不确定的说服力"></a>不确定的说服力</h5><p>语气中带有某种程度不确定的专家，会更激发人们的兴趣。在没有明显带有正确的情况下，表现出一点不确定，非但不会损害你的说服力，反而还有极大的帮助，当商业顾问说服决策者的时候，与其把轻微不确定遮掩起来，还不如明明白白的点出来，因为这世界上会让他显得更有说服力，有利于建立信任。98%的好，还有2%的不确定，没有完美。</p>
<h5 id="中心位置的影响力"><a href="#中心位置的影响力" class="headerlink" title="中心位置的影响力"></a>中心位置的影响力</h5><p>放到中间的那个明显更受欢迎。从海报到平面广告到电视剧，都是这样设置的。有商家会给经理付钱，争取最好的位置。可以绑着畅销最受欢迎的字，你到外包装上，这样就可以不受位置影响。</p>
<h5 id="如何激发创意"><a href="#如何激发创意" class="headerlink" title="如何激发创意"></a>如何激发创意</h5><p>当天花板高的时候，人的想法更富创意，更概念化，当天花板较低的时候，人们的想法就更具体更局限性。</p>
<h5 id="主场还是客场"><a href="#主场还是客场" class="headerlink" title="主场还是客场"></a>主场还是客场</h5><p>对于比赛还是考试各种，都有自己的主场优势，在自己熟悉的环境可能更容易应付，所以在谈判的时候，最好在自己的主场或者提前过去，熟悉下环境。</p>
<h5 id="如何让自己变得更强大"><a href="#如何让自己变得更强大" class="headerlink" title="如何让自己变得更强大"></a>如何让自己变得更强大</h5><p>写下让自己感觉强大的经历，这么一个小小的举动就可以大为不同。回忆一个让自己感到强大的时刻。良种，典型的身体语言会爱试出人的心理状态是强是弱，舒展身体和开放程度，心态强大的人，体态会感到更舒服、开放，体弱无力的人会显得局促、封闭。</p>
<h5 id="你所需的只是爱"><a href="#你所需的只是爱" class="headerlink" title="你所需的只是爱"></a>你所需的只是爱</h5><p>其实我们打算建议的事情要小的多:只是在你的影响行为中添加一点象征，爱意的线索就行了。比如说声谢谢，或者在网站上什么地方多弄一颗爱心，爱是温暖的。</p>
<h5 id="完美的礼物哪里找"><a href="#完美的礼物哪里找" class="headerlink" title="完美的礼物哪里找"></a>完美的礼物哪里找</h5><p>适合他们的就是最好的。维护之前一定要了解对方的喜好而不是自己认为最有价值的，对方关注的才是有价值的，从对方的喜好清单里面去找。</p>
<h5 id="为互助留出余地"><a href="#为互助留出余地" class="headerlink" title="为互助留出余地"></a>为互助留出余地</h5><p>互助原理。在收到恩惠后，人们愿意以相同的方式来回报。要注意最重要的一点是你 <strong>第一个行动</strong> 。第一个出手相助会激活互惠原理，并因此增加未来互助的次数，对于职场中 <strong>共同成功</strong> 这个因素至关重要。第二，要把你提供的帮助或者有价值的信息做个定位，把日后对方可以全力回报你的可能性 <strong>凸显</strong> 出来。<br>用三种应答方式用它们来回应对方对你的感谢:</p>
<blockquote>
<ul>
<li>一，能帮上你的忙我很高兴，因为我知道当一个人需要帮忙的时候，别人的一双援手是多么的有价值，</li>
<li>二，不客气，同事之间理应如此，</li>
<li>三，没关系，因为我知道如果需要帮助的是我，你也会这么做的。<strong>以此方式来激活互惠原理</strong>，维护会互惠留出余地。</li>
</ul>
</blockquote>
<h5 id="表达感激好处多"><a href="#表达感激好处多" class="headerlink" title="表达感激好处多"></a>表达感激好处多</h5><p>当给予别人，更多的帮助获得他人的肯定，觉得自己更有价值，所谓的成就感。例子来自政府的纳税单，来自天猫卖家的手写信。</p>
<h5 id="出乎意料与抛砖引玉"><a href="#出乎意料与抛砖引玉" class="headerlink" title="出乎意料与抛砖引玉"></a>出乎意料与抛砖引玉</h5><p>以出乎意料的方式给予，<strong>提供惊喜</strong>，先给予后获取。人们之所以会笑，回幽默很大程度是因为出乎意外的<code>惊喜</code>。</p>
<blockquote>
<p>能量守恒定律，能量总是从高到低去的，你强他弱，你弱他就强，是一个动态平衡。</p>
</blockquote>
<h5 id="如何获得帮助"><a href="#如何获得帮助" class="headerlink" title="如何获得帮助"></a>如何获得帮助</h5><p>爱是尽管开口。在一组实验中，求助的人低估了对方愿意帮忙的可能性，愿意帮忙的人也高估了别人开口求助的可能性，既然没人开口，就是你家不需要帮忙呗！一句话，事实没自己想象的那么糟，也没自己想象的那么好。<strong>所以开始行动吧</strong>！</p>
<h5 id="先下手为强"><a href="#先下手为强" class="headerlink" title="先下手为强"></a>先下手为强</h5><p>去关注那些好的方面，而不是被带入沟里去关注那些负面裂痕，从而，低估了价值。参加谈判之前，一定要在脑子里想好一下价格，还应该把合理的原因 <strong>清单</strong>列出来，在谈判，中，一定要把这些，摆在面前，足够提醒你，抵消自己心中的质疑。</p>
<h5 id="报价精确一点会更好"><a href="#报价精确一点会更好" class="headerlink" title="报价精确一点会更好"></a>报价精确一点会更好</h5><blockquote>
<p>如果你想要涨工资，可以刷福利待遇提10%，更应该提出9.8%或者10.2%会更好。<br>如果一个保姆拿到每小时十五美元的薪水，他应该向老板提出15.585，但美元而不是16美元。<br>如果是项目管理，等出最终的精确时间，如果让别人答应你一个未来的计划时间给出一个模糊时间，前提是<em>对他有益</em>。</p>
</blockquote>
<p>准确的数字增加可信度，这个结果是经过深思熟虑计算出来的，而不是漫天要价。<br>比如:要求几天完成工作，更精准的是“周三下午，3:47把他交给我好吗“？而不是笼统的说几天完成。效果更好。报价更精准一些，让人更相信你认真研究过。</p>
<h5 id="定价末尾数字有玄机"><a href="#定价末尾数字有玄机" class="headerlink" title="定价末尾数字有玄机"></a>定价末尾数字有玄机</h5><p><strong>降档效应</strong>,<strong>左位数效应</strong>。先说价值把价值谈得高高的最后说价格，这是价格就不觉得那么高了，取小数不要取整数，尽管整数容易计算。</p>
<h5 id="顺序改一改，生意滚滚来"><a href="#顺序改一改，生意滚滚来" class="headerlink" title="顺序改一改，生意滚滚来"></a>顺序改一改，生意滚滚来</h5><blockquote>
<p>心理学有一个基本概念叫做视觉“对比现象”:意思是不必改变物体本身，只改变人看到这个物体之前的体验，就能改变人对这件东西的影响。</p>
</blockquote>
<ul>
<li>比如说六十美元一瓶倒红酒列在开头，这瓶35年的酒，价格看起来就很合理，酒一点也没有变，改变的是人们对他的看法。<strong>来源自比较</strong>。当数字不容易计算的时候，人们更喜欢数字在前价格战后的数据。</li>
<li>比如人们更喜欢580小时的节目收费286元，而不是286元可看580小时的节目，虽然这两种表达方式在一模一样。所以在你的工作中下调整，先说你的服务项目，最后说价格。</li>
<li>当你面试时写简历的时候，不要强调你有多少年工作经验，先把你这段时间取得的成绩。更好的方法，把成绩发出来，把你取得的成绩全部列出来，然后再说工作年限。先说收益，后说成本。</li>
</ul>
<h5 id="如何事半功倍"><a href="#如何事半功倍" class="headerlink" title="如何事半功倍"></a>如何事半功倍</h5><p>当你提供了一个高价值的东西，不要再和低价值的东西放在一起，那样会<strong>过犹不及</strong>，削弱你的层次。<br>例子：</p>
<blockquote>
<p>想乱丢垃圾的人，处以750美元的罚款<br>向丢垃圾的人处以750美元的罚款，外加两个小时的社区服务。</p>
</blockquote>
<p>条件多了反而没有重点，其实750美元其实已经足够有吸引力。两种办法各取所长，同样的资源为少部分抽选的用户增加更诱人的价值，而不是把所有的资源都扑上去。这就好像往热水里加温水一样，只能，降低整体的维度。更好的做法是重视的客户提供量身打造，诱人的格外优惠，你触发了互惠原则。</p>
<h5 id="化整为零"><a href="#化整为零" class="headerlink" title="化整为零"></a>化整为零</h5><p>如果让你捐款，你救助一个学生为他捐多少，而是在为整体捐多少。人们对数字有时候是没有概念的，就像拍电影一样，人对一个人的，生活是个很有童心感的，在对一个整体冷冰冰的数字是没有感觉的。</p>
<h5 id="鲜明生动的细节"><a href="#鲜明生动的细节" class="headerlink" title="鲜明生动的细节"></a>鲜明生动的细节</h5><p>塑造一个活生生的鲜明形象。而不是表格上那些干巴巴的数字，而是应该摆出团队成员的照片，让这些人的形象变得鲜活。就像前段时间希腊的那个海滩上的小男孩，其实之前已经报道很多希腊的难民，涌入，但是大家都无感，等大家看到了这个小孩的照片之后，大家就引发了同情。  当你需要说服，别人为你提供资源去帮助你达成某个目标的时候，你应该去引导对方关注两个方面形象鲜明的受益对象，以及清晰具体的干预手段，形象说明对象具体一个词，一个动作，一个事件，一种手段的方法提醒。</p>
<h5 id="指出机会成本"><a href="#指出机会成本" class="headerlink" title="指出机会成本"></a>指出机会成本</h5><p>指出你省下来的钱可以被用来购买其他的相关产品。你把自己的大家的计划写在团队的板板上公之于众效果会更好。当说服，用户来买你的东西的时候，前提是你的产品足够吸引人，提醒，你买了之后可以省下来更多的钱去做什么？</p>
<h5 id="如何激励他人，还有自己，完成任务"><a href="#如何激励他人，还有自己，完成任务" class="headerlink" title="如何激励他人，还有自己，完成任务"></a>如何激励他人，还有自己，完成任务</h5><p>在任务的早期，你应更应该关注 <strong>我已经完成多少</strong>，然而，进程过半的时候，你更应该关注 <strong>我还剩下多少</strong>。这个方法能够帮你，坚持下来。刚开始的时候，你应该关注的的是已经减掉了多少重量，到了后期你就要去想想还有多少斤没有减掉。</p>
<h5 id="如何提高客户忠诚度"><a href="#如何提高客户忠诚度" class="headerlink" title="如何提高客户忠诚度"></a>如何提高客户忠诚度</h5><p>如果让别人认同你的想法，加入你的计划。要给出最宽松的条件限制，但一旦开始为了达到目标，就要严格要求执行，更有效果完成。比如按顺序买红酒的例子，是自由购买还是无顺序购买？把一件事拆解开来，分成一个个小的步骤，分开执行看来更有效果，更容易达到目标。</p>
<h5 id="如何让一加一大于二"><a href="#如何让一加一大于二" class="headerlink" title="如何让一加一大于二"></a>如何让一加一大于二</h5><p>人们对失去的，在优过，得到了对他的渴望。这就是说，人类在遇到困难的时候会放大困难，而一旦过了这个时段回过头来看，觉得这个困难不算什么。我们都是牺牲明天享受今天的景象，如果今天拿到二十元，明天拿到21元的选择，绝大多数人都会，选择今天拿到钱。可是你再把千金换一下，说七天之后拿到二十美元和八天之后拿到20亿美元，更多人就愿意多等一天。有时候人的决策和行为是多么不一致。因此，当你用奖品或者激励手段来促使他人完成任务的时候，应该把激励手段或奖品非常不同的类别。——因为人们害怕失去。</p>
<h5 id="退后一步看问题"><a href="#退后一步看问题" class="headerlink" title="退后一步看问题"></a>退后一步看问题</h5><p>当你面对一个棘手的问题，只需要后退，站的更远一点看问题就能改变这个问题的难度感知，这个问题就不会那么棘手了。把人和选择之间的实际距离加大，可以显著提高人作出购买决策的速度。   当你为了一件棘手的公事烦恼不已的时候，为什么那个从远处探过头来瞧你电脑屏幕，自命不凡的同事总是以为他能更快地找出解决办法。<strong>当遇到难题时，退后，离的远一点</strong>。</p>
<h5 id="从他人的错误中汲取教训"><a href="#从他人的错误中汲取教训" class="headerlink" title="从他人的错误中汲取教训"></a>从他人的错误中汲取教训</h5><p>把时间花在辨别，并避免他人作出的，导致商业失败的愚蠢决策上。因此最好做一份属于自己的愚蠢清单，把他人犯过的错误也记录下来，当你碰到要做重大决策的时候，要拿出来看一遍再做决策。<br>事实远不止如此，负面的信息也更容易让人记住，在角色中占有比例更高。经验素材库，让他吸引你团队的注意力更容易从中汲取教训，让大家牢牢记住，并且提供促使人采取行动建设性的忠告。</p>
<p>因为这份清单记住的都是别人犯错的错，你更容易看出毛病在哪？如果这些错误是你犯的有点费力跟一个念头对抗，往往还是败阵下来的，如果你想说服自己这些压根就不是错误，只不过运气不好，或者时机不对，害得你没法掌握而已。但别人的错误跟你无关，你不会被自己，电话蒙蔽了双眼，因此它是一个非常有效对你很有好处的学习工具。</p>
<ul>
<li>精明的领导者回答大家，从其他人的错误中汲取教训，在以后的日后行为作出改善。</li>
<li>老师们可以把往届学生犯的错误整理一份，`避免错误的清单，给现在的学生参考。</li>
<li>医生也可以提到以前的一两个患者做错了什么，结果导致什么病情加重，借此来确保现在的患者不在犯同样的错误。</li>
<li>健身教练可以向新客户指出，别人在使用健身器材的时候犯过的错来保证新客户不会重蹈覆，让他们从健身训练中获得最好的收效。</li>
</ul>
<p>做一份错误清单，定期从中学习。能帮你在商界里做，对的一个小举措就是一列一张别人做，过错似的清单。<br>如果你忽视了，记录错误的价值，那么就把这条列入你的错误清单中。</p>
<h5 id="对错误进行管理"><a href="#对错误进行管理" class="headerlink" title="对错误进行管理"></a>对错误进行管理</h5><p>这些错误不仅能够帮，你在将来做得更好，甚至还能增强你的影响力。<br>知道错误可能出现在什么地方，又是怎么发生的第二个要求就是，培训是要指导学生如何，<code>用最好的方式去面对错误，让学员知道你的错误出现那种心态是最好的</code>。<strong>犯错是很自然的</strong>，这是学习过程中的一部分，犯错越多，学到东西越多，错误会告诉你，你还有哪些东西要学，这些反馈方式几种药会让结果大为不同，<em>这是因为如果没有这些点拨，人们多半会把错误看成失败，而不是指向成功的路标，</em> 这种知道培训对出道成功的企业文化是如此重要，<code>所以为了尽早成功，多犯点错吧！</code></p>
<blockquote>
<p>人们的期望总是过高的在现代商业，鬼复杂，如果把资源用于追求一个错误也不脱出的乌托邦的目标，工作效率低的整体成本也会高很多，倒不如把资源用在寻求解决问题纠正错误的目标上，获得更高的顾客满意度。零错误反倒不如及时改正错误好，完善体验带来惊喜。</p>
</blockquote>
<h5 id="当天就点评"><a href="#当天就点评" class="headerlink" title="当天就点评"></a>当天就点评</h5><p>及时反馈。与正面信息相伴，人们更容易关注负面信息，也更有可能从中汲取教训或者孕检信息。当在网上看到一个最近的一个评论的正面信息，会带来更多的赞，更多的客户，但如果是信息都很陈旧的，就不想去看了。</p>
<h5 id="给邮件加点料，让谈判更顺畅"><a href="#给邮件加点料，让谈判更顺畅" class="headerlink" title="给邮件加点料，让谈判更顺畅"></a>给邮件加点料，让谈判更顺畅</h5><p>笑声是人与人之间最短的距离，信任是非常重要的因素。给你来，邮件加上一个，好玩的漫画，添加一些有血有肉的人情味儿。为了给对方建立良好的关系，主动透露一点个人信息，不但能够减少排放，谈判中的僵局还能，让对方都能取得更好的结果。有时候不能写为健全而淡之的是面谈，或者干脆打个电话，会增加亲切感。</p>
<h5 id="碰触的魔力"><a href="#碰触的魔力" class="headerlink" title="碰触的魔力"></a>碰触的魔力</h5><p>能够摸到产品的卖家开出的价格就比那些摸不到的产品开价更高。作为主持人，或培训师，不要，把资料放在学员的桌子上，而是应该请他们走进房间的时候亲自分发，为了提高，会议赞助的小礼品的价值感，会议活动组织者可以时间选出一组不错合适的时机，把它从袋子里掏出来，然后亲自递给参会的人，这样不仅能够提高他的价值感，也会避免这个小礼物被无人问津。如果当产品无法被人摸到的时候，<strong>只需要顾客在头脑里想象与他的感觉就能够强化有关</strong>，从而提高它的价值。</p>
<h5 id="把最好的留到最后"><a href="#把最好的留到最后" class="headerlink" title="把最好的留到最后"></a>把最好的留到最后</h5><p><strong>峰——终体验</strong>。人们只会记住，记住最后一次或者体验最好的一次的感觉。在客人办理入住的时候，送一个个性化的变迁，然后在结账退房的时候送上一个小礼物。与其把重点放在有问题的产品，浪费在你许多时间，不如去强调它，给客户带来不便和痛苦多么严重。<strong>强调体验</strong> 如果你希望下次度假时带回精彩又开心的回忆，那么与其把预算平均分配给一连串短途旅行观光，还不如把钱花在两天特别有意思的事情上，把升舱的机会留在回程，这样你会更加开心。</p>
<h5 id="多个细节叠加使用，效果未必会叠加"><a href="#多个细节叠加使用，效果未必会叠加" class="headerlink" title="多个细节叠加使用，效果未必会叠加"></a>多个细节叠加使用，效果未必会叠加</h5><p>关于说服科学的<strong>叠加使用规则</strong>,并不是所有的规则叠加起来都会更多，有可能会相互抵消。<br>有三个原因解释:</p>
<ul>
<li>第一，这几条策略背后的心理动机互不相容。</li>
<li>第二，你一次使用的说服工具越多，对方就越不容易在第一时间积极响应。</li>
<li>第三，方法用得越多，意图就越明显有时候你把一堆不起眼的小策略放在一起的时候，那种不显山不漏水的微妙感觉就没有了，说服的意图就变成了露骨，对方就容易拒绝你。<br>构思说服他人的措辞时，好像存在一个临界点，超过这个点多余的理由和论据，反而更让人容易抗拒，削弱了说服力的力度。使用的技巧一般<strong>不超过三个</strong>，事不过三。</li>
</ul>
<h5 id="写在最後"><a href="#写在最後" class="headerlink" title="写在最後"></a>写在最後</h5><p>學了這麼多技巧，最終要的是在生活中得到有效應用，多觀察，多实践，多思考，触类旁通，从而真正的融会贯通，内化掉。</p>
]]></content>
      <tags>
        <tag>读书</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql-cheatsheet</title>
    <url>/2016/11/02/mysql-cheatsheet/</url>
    <content><![CDATA[<h3 id="Connect-Disconnect"><a href="#Connect-Disconnect" class="headerlink" title="Connect/Disconnect"></a>Connect/Disconnect</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -h &lt;host&gt; -u &lt;user&gt; -p&lt;passwd&gt;</span><br><span class="line">mysql -h &lt;host&gt; -u &lt;user&gt; -p</span><br><span class="line">Enter password: ********</span><br><span class="line">mysql -u user -p</span><br><span class="line">mysql</span><br><span class="line">mysql -h &lt;host&gt; -u &lt;user&gt; -p &lt;Database&gt;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">table</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> table1, table2, ...</span><br><span class="line"><span class="keyword">SELECT</span> field1, field2, ... <span class="keyword">FROM</span> table1, table2, ...</span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ... <span class="keyword">WHERE</span> condition</span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ... <span class="keyword">WHERE</span> condition <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">field</span></span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ... <span class="keyword">WHERE</span> condition <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">field</span> <span class="keyword">HAVING</span> condition2</span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ... <span class="keyword">WHERE</span> condition <span class="keyword">ORDER</span> <span class="keyword">BY</span> field1, field2</span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ... <span class="keyword">WHERE</span> condition <span class="keyword">ORDER</span> <span class="keyword">BY</span> field1, field2 <span class="keyword">DESC</span></span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ... <span class="keyword">WHERE</span> condition <span class="keyword">LIMIT</span> <span class="number">10</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> field1 <span class="keyword">FROM</span> ...</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> field1, field2 <span class="keyword">FROM</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> t1 <span class="keyword">JOIN</span> t2 <span class="keyword">ON</span> t1.id1 = t2.id2 <span class="keyword">WHERE</span> condition</span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> t1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t2 <span class="keyword">ON</span> t1.id1 = t2.id2 <span class="keyword">WHERE</span> condition</span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> t1 <span class="keyword">JOIN</span> (t2 <span class="keyword">JOIN</span> t3 <span class="keyword">ON</span> ...) <span class="keyword">ON</span> ...</span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> t1 <span class="keyword">JOIN</span> t2 <span class="keyword">USING</span>(<span class="keyword">id</span>) <span class="keyword">WHERE</span> condition</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正则查询（RLIKE|REGEXP）</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> <span class="keyword">column</span> REGEXP <span class="string">'^(A|B|C)'</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> rec <span class="keyword">RLIKE</span> <span class="string">"^b$"</span>;  </span><br><span class="line"><span class="comment">-- 获得表或者行信息</span></span><br><span class="line"><span class="keyword">DESCRIBE</span> <span class="keyword">table</span> [<span class="keyword">column</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">--日期时间</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CURRENT_DATE</span>, (<span class="keyword">YEAR</span>(<span class="keyword">CURRENT_DATE</span>)­<span class="keyword">YEAR</span>(date_col)) <span class="keyword">AS</span> time_diff [<span class="keyword">FROM</span> <span class="keyword">table</span>];</span><br></pre></td></tr></table></figure>
<h3 id="Conditionals"><a href="#Conditionals" class="headerlink" title="Conditionals"></a>Conditionals</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">field1 = value1</span><br><span class="line">field1 &lt;&gt; value1</span><br><span class="line">field1 LIKE &apos;value _ %&apos;</span><br><span class="line">field1 IS NULL</span><br><span class="line">field1 IS NOT NULL</span><br><span class="line">field1 IN (value1, value2)</span><br><span class="line">field1 NOT IN (value1, value2)</span><br><span class="line">condition1 AND condition2</span><br><span class="line">condition1 OR condition2</span><br></pre></td></tr></table></figure>
<h3 id="table-Index"><a href="#table-Index" class="headerlink" title="table Index"></a>table Index</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE [UNIQUE|FULLTEXT] INDEX index_name ON table (column,...)</span><br><span class="line">DROP INDEX index_name</span><br></pre></td></tr></table></figure>
<h3 id="Data-Manipulation"><a href="#Data-Manipulation" class="headerlink" title="Data Manipulation"></a>Data Manipulation</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO table1 (field1, field2, ...) VALUES (value1, value2, ...)</span><br><span class="line">INSERT table1 SET field1=value_1, field2=value_2 ...</span><br><span class="line"></span><br><span class="line">LOAD DATA INFILE &apos;/tmp/mydata.txt&apos; INTO TABLE table1</span><br><span class="line">FIELDS TERMINATED BY &apos;,&apos; OPTIONALLY ENCLOSED BY &apos;&quot;&apos; ESCAPED BY &apos;\\&apos;</span><br><span class="line"></span><br><span class="line">DELETE FROM table1 / TRUNCATE table1</span><br><span class="line">DELETE FROM table1 WHERE condition</span><br><span class="line">-- join:</span><br><span class="line">DELETE FROM table1, table2 WHERE table1.id1 = table2.id2 AND condition</span><br><span class="line"></span><br><span class="line">UPDATE table1 SET field1=new_value1 WHERE condition</span><br><span class="line">-- join:</span><br><span class="line">UPDATE table1, table2 SET field1=new_value1, field2=new_value2, ...</span><br><span class="line">WHERE table1.id1 = table2.id2 AND condition</span><br></pre></td></tr></table></figure>
<h3 id="Browsing"><a href="#Browsing" class="headerlink" title="Browsing"></a>Browsing</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW DATABASES</span><br><span class="line">SHOW TABLES</span><br><span class="line">SHOW FIELDS FROM table</span><br><span class="line">-- 几种查询表信息方法</span><br><span class="line">SHOW COLUMNS FROM table </span><br><span class="line">DESCRIBE table </span><br><span class="line">DESC table </span><br><span class="line">EXPLAIN table</span><br><span class="line"></span><br><span class="line">SHOW CREATE TABLE table</span><br><span class="line">SHOW CREATE TRIGGER trigger</span><br><span class="line">SHOW TRIGGERS LIKE &apos;%update%&apos;</span><br><span class="line">SHOW PROCESSLIST</span><br><span class="line">KILL process_number</span><br><span class="line">SELECT table_name, table_rows FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = &apos;**yourdbname**&apos;;</span><br><span class="line"></span><br><span class="line">mysqlshow</span><br><span class="line">mysqlshow database</span><br><span class="line"></span><br><span class="line">SELECT current_database()</span><br></pre></td></tr></table></figure>
<h3 id="Create-delete-select-alter-database"><a href="#Create-delete-select-alter-database" class="headerlink" title="Create / delete / select / alter database"></a>Create / delete / select / alter database</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE [IF NOT EXISTS] mabase [CHARACTER SET charset] [COLLATE collation]</span><br><span class="line"> CREATE DATABASE mabase CHARACTER SET utf8</span><br><span class="line"> DROP DATABASE mabase</span><br><span class="line"> USE mabase</span><br><span class="line"></span><br><span class="line"> ALTER DATABASE mabase CHARACTER SET utf8</span><br></pre></td></tr></table></figure>
<h3 id="Create-table"><a href="#Create-table" class="headerlink" title="Create table"></a>Create table</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE table (field1 type1, field2 type2, ...)</span><br><span class="line"> CREATE TABLE table (field1 type1 unsigned not null auto_increment, field2 type2, ...)</span><br><span class="line"> CREATE TABLE table (field1 type1, field2 type2, ..., INDEX (field))</span><br><span class="line"> CREATE TABLE table (field1 type1, field2 type2, ..., PRIMARY KEY (field1))</span><br><span class="line"> CREATE TABLE table (field1 type1, field2 type2, ..., PRIMARY KEY (field1, field2))</span><br><span class="line"> CREATE TABLE table1 (fk_field1 type1, field2 type2, ...,</span><br><span class="line">   FOREIGN KEY (fk_field1) REFERENCES table2 (t2_fieldA)</span><br><span class="line">     [ON UPDATE] [CASCADE|SET NULL|RESTRICT]</span><br><span class="line">     [ON DELETE] [CASCADE|SET NULL|RESTRICT])</span><br><span class="line"> CREATE TABLE table1 (fk_field1 type1, fk_field2 type2, ...,</span><br><span class="line">   FOREIGN KEY (fk_field1, fk_field2) REFERENCES table2 (t2_fieldA, t2_fieldB))</span><br><span class="line"> CREATE TABLE table IF NOT EXISTS (...)</span><br><span class="line"></span><br><span class="line"> CREATE TABLE new_tbl_name LIKE tbl_name</span><br><span class="line">   [SELECT ... FROM tbl_name ...]</span><br><span class="line"></span><br><span class="line"> CREATE TEMPORARY TABLE table (...)</span><br><span class="line"></span><br><span class="line"> CREATE table new_table_name as SELECT [ *|column1, column2 ] FROM table_name</span><br></pre></td></tr></table></figure>
<h3 id="delete-table"><a href="#delete-table" class="headerlink" title="delete table"></a>delete table</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP TABLE table</span><br><span class="line"> DROP TABLE IF EXISTS table</span><br><span class="line"> DROP TABLE table1, table2, ...</span><br><span class="line"> DROP TEMPORARY TABLE table</span><br></pre></td></tr></table></figure>
<h3 id="modify-table"><a href="#modify-table" class="headerlink" title="modify table"></a>modify table</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> ALTER TABLE table MODIFY field1 type1 </span><br><span class="line"> ALTER TABLE table MODIFY field1 type1 NOT NULL ... </span><br><span class="line"> ALTER TABLE table CHANGE old_name_field1 new_name_field1 type1</span><br><span class="line"> ALTER TABLE table CHANGE old_name_field1 new_name_field1 type1 NOT NULL ...</span><br><span class="line"> ALTER TABLE table ALTER field1 SET DEFAULT ...</span><br><span class="line"> ALTER TABLE table ALTER field1 DROP DEFAULT</span><br><span class="line"> ALTER TABLE table ADD new_name_field1 type1</span><br><span class="line"> ALTER TABLE table ADD new_name_field1 type1 FIRST</span><br><span class="line"> ALTER TABLE table ADD new_name_field1 type1 AFTER another_field</span><br><span class="line"> ALTER TABLE table DROP field1</span><br><span class="line"> ALTER TABLE table ADD INDEX (field);</span><br><span class="line"> ALTER TABLE table ADD PRIMARY KEY (field);</span><br><span class="line"></span><br><span class="line"> -- Change field order:</span><br><span class="line"> ALTER TABLE table MODIFY field1 type1 FIRST</span><br><span class="line"> ALTER TABLE table MODIFY field1 type1 AFTER another_field</span><br><span class="line"> ALTER TABLE table CHANGE old_name_field1 new_name_field1 type1 FIRST</span><br><span class="line"> ALTER TABLE table CHANGE old_name_field1 new_name_field1 type1 AFTER another_field</span><br><span class="line"></span><br><span class="line"> ALTER TABLE old_name RENAME new_name;</span><br><span class="line">Keys</span><br><span class="line"> CREATE TABLE table (..., PRIMARY KEY (field1, field2))</span><br><span class="line"> CREATE TABLE table (..., FOREIGN KEY (field1, field2) REFERENCES table2 (t2_field1, t2_field2))</span><br><span class="line"> ALTER TABLE table ADD PRIMARY KEY (field);</span><br><span class="line"> ALTER TABLE table ADD CONSTRAINT constraint_name PRIMARY KEY (field, field2);</span><br></pre></td></tr></table></figure>
<h3 id="create-modify-drop-view"><a href="#create-modify-drop-view" class="headerlink" title="create/modify/drop view"></a>create/modify/drop view</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE VIEW view AS SELECT ... FROM table WHERE ...</span><br></pre></td></tr></table></figure>
<h3 id="Privileges"><a href="#Privileges" class="headerlink" title="Privileges"></a>Privileges</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE USER &apos;user&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;password&apos;;</span><br><span class="line"></span><br><span class="line"> GRANT ALL PRIVILEGES ON base.* TO &apos;user&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;password&apos;;</span><br><span class="line"> GRANT SELECT, INSERT, DELETE ON base.* TO &apos;user&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;password&apos;;</span><br><span class="line"> REVOKE ALL PRIVILEGES ON base.* FROM &apos;user&apos;@&apos;host&apos;; -- one permission only</span><br><span class="line"> REVOKE ALL PRIVILEGES, GRANT OPTION FROM &apos;user&apos;@&apos;host&apos;; -- all permissions</span><br><span class="line"></span><br><span class="line"> SET PASSWORD = PASSWORD(&apos;new_pass&apos;)</span><br><span class="line"> SET PASSWORD FOR &apos;user&apos;@&apos;host&apos; = PASSWORD(&apos;new_pass&apos;)</span><br><span class="line"> SET PASSWORD = OLD_PASSWORD(&apos;new_pass&apos;)</span><br><span class="line"></span><br><span class="line"> DROP USER &apos;user&apos;@&apos;host&apos;</span><br></pre></td></tr></table></figure>
<h3 id="Main-data-types"><a href="#Main-data-types" class="headerlink" title="Main data types"></a>Main data types</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TINYINT   (1o: -127+128) </span><br><span class="line">SMALLINT  (2o: +-65 000)</span><br><span class="line">MEDIUMINT (3o: +-16 000 000) </span><br><span class="line">INT       (4o: +-2 000 000 000)</span><br><span class="line">BIGINT    (8o: +-9.10^18)</span><br><span class="line">  Precise interval: -(2^(8*N-1)) -&gt; (2^8*N)-1</span><br><span class="line">  /!\ INT(2) = &quot;2 digits displayed&quot; -- NOT &quot;number with 2 digits max&quot;</span><br><span class="line">INT NOT NULL auto_increment PRIMARY KEY -- auto-counter for PK</span><br><span class="line">FLOAT(M,D) DOUBLE(M,D) FLOAT(D=0-&gt;53) </span><br><span class="line">  /!\ 8,3 -&gt; 12345,678 -- NOT 12345678,123!</span><br><span class="line">TIME (HH:MM) YEAR (AAAA) DATE (AAAA-MM-JJ) DATETIME (AAAA-MM-JJ HH:MM; années 1000-&gt;9999)</span><br><span class="line">  TIMESTAMP (like DATETIME, but 1970-&gt;2038, compatible with Unix)</span><br><span class="line">VARCHAR (single-line; explicit size)  </span><br><span class="line">TEXT (multi-lines; max size=65535) </span><br><span class="line">BLOB (binary; max size=65535)</span><br><span class="line">  Variants for TEXT&amp;BLOB: TINY (max=255) MEDIUM (max=~16000) LONG (max=4Go)</span><br><span class="line"> Ex: VARCHAR(32), TINYTEXT, LONGBLOB, MEDIUMTEXT</span><br><span class="line">ENUM (&apos;value1&apos;, &apos;value2&apos;, ...) -- (default NULL, or &apos;&apos; if NOT NULL)</span><br></pre></td></tr></table></figure>
<h3 id="Forgot-root-password"><a href="#Forgot-root-password" class="headerlink" title="Forgot root password?"></a>Forgot root password?</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ /etc/init.d/mysql stop</span><br><span class="line">$ mysqld_safe --skip-grant-tables &amp;</span><br><span class="line">$ mysql # on another terminal</span><br><span class="line">mysql &gt; UPDATE mysql.user SET password=PASSWORD(&apos;nouveau&apos;) WHERE user=&apos;root&apos;;</span><br><span class="line">## Kill mysqld_safe from the terminal, using Control + \</span><br><span class="line">$ /etc/init.d/mysql start</span><br></pre></td></tr></table></figure>
<h3 id="Repair-tables-after-unclean-shutdown"><a href="#Repair-tables-after-unclean-shutdown" class="headerlink" title="Repair tables after unclean shutdown"></a>Repair tables after unclean shutdown</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqlcheck --all-databases</span><br><span class="line">mysqlcheck --all-databases --fast</span><br></pre></td></tr></table></figure>
<h3 id="Loading-data"><a href="#Loading-data" class="headerlink" title="Loading data"></a>Loading data</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SOURCE input_file</span><br><span class="line">mysql -uroot database &lt; filename-20120201.sql</span><br><span class="line"></span><br><span class="line">cat filename-20120201.sql | mysql database</span><br><span class="line"></span><br><span class="line">mysqldump -u [username] -p [database] &gt; data_backup.sql;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Load tab­delimited data into a table (Use \n f or NULL)</span></span><br><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> <span class="keyword">INFILE</span> <span class="string">"infile.txt"</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> table_name;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>npm-script</title>
    <url>/2016/11/23/npm-script/</url>
    <content><![CDATA[<h1 id="npm-scripts-使用指南"><a href="#npm-scripts-使用指南" class="headerlink" title="npm scripts 使用指南"></a>npm scripts 使用指南</h1><p>Node 开发离不开 npm，而脚本功能是 npm 最强大、最常用的功能之一。</p>
<p>本文介绍如何使用 npm 脚本（npm scripts）。</p>
<p><img src="http://www.ruanyifeng.com/blogimg/asset/2016/bg2016101101.jpg" alt></p>
<a id="more"></a>
<h2 id="一、什么是-npm-脚本？"><a href="#一、什么是-npm-脚本？" class="headerlink" title="一、什么是 npm 脚本？"></a>一、什么是 npm 脚本？</h2><p>npm 允许在<code>package.json</code>文件里面，使用<code>scripts</code>字段定义脚本命令。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"build"</span>: <span class="string">"node build.js"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码是<code>package.json</code>文件的一个片段，里面的<code>scripts</code>字段是一个对象。它的每一个属性，对应一段脚本。比如，<code>build</code>命令对应的脚本是<code>node build.js</code>。</p>
<p>命令行下使用<code>npm run</code>命令，就可以执行这段脚本。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm run build</span><br><span class="line"><span class="comment"># 等同于执行</span></span><br><span class="line">$ node build.js</span><br></pre></td></tr></table></figure>
<p>这些定义在<code>package.json</code>里面的脚本，就称为 npm 脚本。它的优点很多。</p>
<blockquote>
<ul>
<li>项目的相关脚本，可以集中在一个地方。</li>
<li>不同项目的脚本命令，只要功能相同，就可以有同样的对外接口。用户不需要知道怎么测试你的项目，只要运行<code>npm run test</code>即可。</li>
<li>可以利用 npm 提供的很多辅助功能。</li>
</ul>
</blockquote>
<p>查看当前项目的所有 npm 脚本命令，可以使用不带任何参数的<code>npm run</code>命令。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm run</span><br></pre></td></tr></table></figure>
<h2 id="二、原理"><a href="#二、原理" class="headerlink" title="二、原理"></a>二、原理</h2><p>npm 脚本的原理非常简单。每当执行<code>npm run</code>，就会自动新建一个 Shell，在这个 Shell 里面执行指定的脚本命令。因此，只要是 Shell（一般是 Bash）可以运行的命令，就可以写在 npm 脚本里面。</p>
<p>比较特别的是，<code>npm run</code>新建的这个 Shell，会将当前目录的<code>node_modules/.bin</code>子目录加入<code>PATH</code>变量，执行结束后，再将<code>PATH</code>变量恢复原样。</p>
<p>这意味着，当前目录的<code>node_modules/.bin</code>子目录里面的所有脚本，都可以直接用脚本名调用，而不必加上路径。比如，当前项目的依赖里面有 Mocha，只要直接写<code>mocha test</code>就可以了。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"test"</span>: <span class="string">"mocha test"</span></span><br></pre></td></tr></table></figure>
<p>而不用写成下面这样。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"test"</span>: <span class="string">"./node_modules/.bin/mocha test"</span></span><br></pre></td></tr></table></figure>
<p>由于 npm 脚本的唯一要求就是可以在 Shell 执行，因此它不一定是 Node 脚本，任何可执行文件都可以写在里面。</p>
<p>npm 脚本的退出码，也遵守 Shell 脚本规则。如果退出码不是<code>0</code>，npm 就认为这个脚本执行失败。</p>
<h2 id="三、通配符"><a href="#三、通配符" class="headerlink" title="三、通配符"></a>三、通配符</h2><p>由于 npm 脚本就是 Shell 脚本，因为可以使用 Shell 通配符。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"lint"</span>: <span class="string">"jshint *.js"</span></span><br><span class="line"><span class="string">"lint"</span>: <span class="string">"jshint **/*.js"</span></span><br></pre></td></tr></table></figure>
<p>上面代码中，<code>*</code>表示任意文件名，<code>**</code>表示任意一层子目录。</p>
<p>如果要将通配符传入原始命令，防止被 Shell 转义，要将星号转义。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"test"</span>: <span class="string">"tap test/\*.js"</span></span><br></pre></td></tr></table></figure>
<h2 id="四、传参"><a href="#四、传参" class="headerlink" title="四、传参"></a>四、传参</h2><p>向 npm 脚本传入参数，要使用<code>--</code>标明。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"lint"</span>: <span class="string">"jshint **.js"</span></span><br></pre></td></tr></table></figure>
<p>向上面的<code>npm run lint</code>命令传入参数，必须写成下面这样。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm run lint --  --reporter checkstyle &gt; checkstyle.xml</span><br></pre></td></tr></table></figure>
<p>也可以在<code>package.json</code>里面再封装一个命令。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"lint"</span>: <span class="string">"jshint **.js"</span>,</span><br><span class="line"><span class="string">"lint:checkstyle"</span>: <span class="string">"npm run lint -- --reporter checkstyle &gt; checkstyle.xml"</span></span><br></pre></td></tr></table></figure>
<h2 id="五、执行顺序"><a href="#五、执行顺序" class="headerlink" title="五、执行顺序"></a>五、执行顺序</h2><p>如果 npm 脚本里面需要执行多个任务，那么需要明确它们的执行顺序。</p>
<p>如果是并行执行（即同时的平行执行），可以使用<code>&amp;</code>符号。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm run script1.js &amp; npm run script2.js</span><br></pre></td></tr></table></figure>
<p>如果是继发执行（即只有前一个任务成功，才执行下一个任务），可以使用<code>&amp;&amp;</code>符号。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm run script1.js &amp;&amp; npm run script2.js</span><br></pre></td></tr></table></figure>
<p>这两个符号是 Bash 的功能。此外，还可以使用 node 的任务管理模块：<a href="https://github.com/paulpflug/script-runner" target="_blank" rel="noopener">script-runner</a>、<a href="https://github.com/mysticatea/npm-run-all" target="_blank" rel="noopener">npm-run-all</a>、<a href="https://github.com/coderaiser/redrun" target="_blank" rel="noopener">redrun</a>。</p>
<h2 id="六、默认值"><a href="#六、默认值" class="headerlink" title="六、默认值"></a>六、默认值</h2><p>一般来说，npm 脚本由用户提供。但是，npm 对两个脚本提供了默认值。也就是说，这两个脚本不用定义，就可以直接使用。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"start"</span>: <span class="string">"node server.js"</span>，</span><br><span class="line"><span class="string">"install"</span>: <span class="string">"node-gyp rebuild"</span></span><br></pre></td></tr></table></figure>
<p>上面代码中，<code>npm run start</code>的默认值是<code>node server.js</code>，前提是项目根目录下有<code>server.js</code>这个脚本；<code>npm run install</code>的默认值是<code>node-gyp rebuild</code>，前提是项目根目录下有<code>binding.gyp</code>文件。</p>
<h2 id="七、钩子"><a href="#七、钩子" class="headerlink" title="七、钩子"></a>七、钩子</h2><p>npm 脚本有<code>pre</code>和<code>post</code>两个钩子。举例来说，<code>build</code>脚本命令的钩子就是<code>prebuild</code>和<code>postbuild</code>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"prebuild"</span>: <span class="string">"echo I run before the build script"</span>,</span><br><span class="line"><span class="string">"build"</span>: <span class="string">"cross-env NODE_ENV=production webpack"</span>,</span><br><span class="line"><span class="string">"postbuild"</span>: <span class="string">"echo I run after the build script"</span></span><br></pre></td></tr></table></figure>
<p>用户执行<code>npm run build</code>的时候，会自动按照下面的顺序执行。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm run prebuild &amp;&amp; npm run build &amp;&amp; npm run postbuild</span><br></pre></td></tr></table></figure>
<p>因此，可以在这两个钩子里面，完成一些准备工作和清理工作。下面是一个例子。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"clean"</span>: <span class="string">"rimraf ./dist &amp;&amp; mkdir dist"</span>,</span><br><span class="line"><span class="string">"prebuild"</span>: <span class="string">"npm run clean"</span>,</span><br><span class="line"><span class="string">"build"</span>: <span class="string">"cross-env NODE_ENV=production webpack"</span></span><br></pre></td></tr></table></figure>
<p>npm 默认提供下面这些钩子。</p>
<blockquote>
<ul>
<li>prepublish，postpublish</li>
<li>preinstall，postinstall</li>
<li>preuninstall，postuninstall</li>
<li>preversion，postversion</li>
<li>pretest，posttest</li>
<li>prestop，poststop</li>
<li>prestart，poststart</li>
<li>prerestart，postrestart</li>
</ul>
</blockquote>
<p>自定义的脚本命令也可以加上<code>pre</code>和<code>post</code>钩子。比如，<code>myscript</code>这个脚本命令，也有<code>premyscript</code>和<code>postmyscript</code>钩子。不过，双重的<code>pre</code>和<code>post</code>无效，比如<code>prepretest</code>和<code>postposttest</code>是无效的。</p>
<p>npm 提供一个<code>npm_lifecycle_event</code>变量，返回当前正在运行的脚本名称，比如<code>pretest</code>、<code>test</code>、<code>posttest</code>等等。所以，可以利用这个变量，在同一个脚本文件里面，为不同的<code>npm scripts</code>命令编写代码。请看下面的例子。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> TARGET = process.env.npm_lifecycle_event;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (TARGET === <span class="string">'test'</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Running the test task!`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (TARGET === <span class="string">'pretest'</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Running the pretest task!`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (TARGET === <span class="string">'posttest'</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Running the posttest task!`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，<code>prepublish</code>这个钩子不仅会在<code>npm publish</code>命令之前运行，还会在<code>npm install</code>（不带任何参数）命令之前运行。这种行为很容易让用户感到困惑，所以 npm 4 引入了一个新的钩子<code>prepare</code>，行为等同于<code>prepublish</code>，而从 npm 5 开始，<code>prepublish</code>将只在<code>npm publish</code>命令之前运行。</p>
<h2 id="八、简写形式"><a href="#八、简写形式" class="headerlink" title="八、简写形式"></a>八、简写形式</h2><p>四个常用的 npm 脚本有简写形式。</p>
<blockquote>
<ul>
<li><code>npm start</code>是<code>npm run start</code></li>
<li><code>npm stop</code>是<code>npm run stop</code>的简写</li>
<li><code>npm test</code>是<code>npm run test</code>的简写</li>
<li><code>npm restart</code>是<code>npm run stop &amp;&amp; npm run restart &amp;&amp; npm run start</code>的简写</li>
</ul>
</blockquote>
<p><code>npm start</code>、<code>npm stop</code>和<code>npm restart</code>都比较好理解，而<code>npm restart</code>是一个复合命令，实际上会执行三个脚本命令：<code>stop</code>、<code>restart</code>、<code>start</code>。具体的执行顺序如下。</p>
<blockquote>
<ol>
<li>prerestart</li>
<li>prestop</li>
<li>stop</li>
<li>poststop</li>
<li>restart</li>
<li>prestart</li>
<li>start</li>
<li>poststart</li>
<li>postrestart </li>
</ol>
</blockquote>
<h2 id="九、变量"><a href="#九、变量" class="headerlink" title="九、变量"></a>九、变量</h2><p>npm 脚本有一个非常强大的功能，就是可以使用 npm 的内部变量。</p>
<p>首先，通过<code>npm_package_</code>前缀，npm 脚本可以拿到<code>package.json</code>里面的字段。比如，下面是一个<code>package.json</code>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"foo"</span>, </span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.2.5"</span>,</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"view"</span>: <span class="string">"node view.js"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么，变量<code>npm_package_name</code>返回<code>foo</code>，变量<code>npm_package_version</code>返回<code>1.2.5</code>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// view.js</span></span><br><span class="line"><span class="built_in">console</span>.log(process.env.npm_package_name); <span class="comment">// foo</span></span><br><span class="line"><span class="built_in">console</span>.log(process.env.npm_package_version); <span class="comment">// 1.2.5</span></span><br></pre></td></tr></table></figure>
<p>上面代码中，我们通过环境变量<code>process.env</code>对象，拿到<code>package.json</code>的字段值。如果是 Bash 脚本，可以用<code>$npm_package_name</code>和<code>$npm_package_version</code>取到这两个值。</p>
<p><code>npm_package_</code>前缀也支持嵌套的<code>package.json</code>字段。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"repository"</span>: &#123;</span><br><span class="line">  <span class="string">"type"</span>: <span class="string">"git"</span>,</span><br><span class="line">  <span class="string">"url"</span>: <span class="string">"xxx"</span></span><br><span class="line">&#125;,</span><br><span class="line">scripts: &#123;</span><br><span class="line">  <span class="string">"view"</span>: <span class="string">"echo $npm_package_repository_type"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中，<code>repository</code>字段的<code>type</code>属性，可以通过<code>npm_package_repository_type</code>取到。</p>
<p>下面是另外一个例子。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"install"</span>: <span class="string">"foo.js"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中，<code>npm_package_scripts_install</code>变量的值等于<code>foo.js</code>。</p>
<p>然后，npm 脚本还可以通过<code>npm_config_</code>前缀，拿到 npm 的配置变量，即<code>npm config get xxx</code>命令返回的值。比如，当前模块的发行标签，可以通过<code>npm_config_tag</code>取到。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"view"</span>: <span class="string">"echo $npm_config_tag"</span>,</span><br></pre></td></tr></table></figure>
<p>注意，<code>package.json</code>里面的<code>config</code>对象，可以被环境变量覆盖。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; </span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"foo"</span>,</span><br><span class="line">  <span class="string">"config"</span> : &#123; <span class="string">"port"</span> : <span class="string">"8080"</span> &#125;,</span><br><span class="line">  <span class="string">"scripts"</span> : &#123; <span class="string">"start"</span> : <span class="string">"node server.js"</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中，<code>npm_package_config_port</code>变量返回的是<code>8080</code>。这个值可以用下面的方法覆盖。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm config <span class="built_in">set</span> foo:port 80</span><br></pre></td></tr></table></figure>
<p>最后，<code>env</code>命令可以列出所有环境变量。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">"env"</span>: <span class="string">"env"</span></span><br></pre></td></tr></table></figure>
<h2 id="十、常用脚本示例"><a href="#十、常用脚本示例" class="headerlink" title="十、常用脚本示例"></a>十、常用脚本示例</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 删除目录</span></span><br><span class="line"><span class="string">"clean"</span>: <span class="string">"rimraf dist/*"</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 本地搭建一个 HTTP 服务</span></span><br><span class="line"><span class="string">"serve"</span>: <span class="string">"http-server -p 9090 dist/"</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开浏览器</span></span><br><span class="line"><span class="string">"open:dev"</span>: <span class="string">"opener http://localhost:9090"</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实时刷新</span></span><br><span class="line"> <span class="string">"livereload"</span>: <span class="string">"live-reload --port 9091 dist/"</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建 HTML 文件</span></span><br><span class="line"><span class="string">"build:html"</span>: <span class="string">"jade index.jade &gt; dist/index.html"</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只要 CSS 文件有变动，就重新执行构建</span></span><br><span class="line"><span class="string">"watch:css"</span>: <span class="string">"watch 'npm run build:css' assets/styles/"</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只要 HTML 文件有变动，就重新执行构建</span></span><br><span class="line"><span class="string">"watch:html"</span>: <span class="string">"watch 'npm run build:html' assets/html"</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 部署到 Amazon S3</span></span><br><span class="line"><span class="string">"deploy:prod"</span>: <span class="string">"s3-cli sync ./dist/ s3://example-com/prod-site/"</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建 favicon</span></span><br><span class="line"><span class="string">"build:favicon"</span>: <span class="string">"node scripts/favicon.js"</span>,</span><br></pre></td></tr></table></figure>
<h2 id="十一、参考链接"><a href="#十一、参考链接" class="headerlink" title="十一、参考链接"></a>十一、参考链接</h2><ul>
<li><a href="https://www.keithcirkel.co.uk/how-to-use-npm-as-a-build-tool/" target="_blank" rel="noopener">How to Use npm as a Build Tool</a>, by Keith Cirkel</li>
<li><a href="https://github.com/RyanZim/awesome-npm-scripts#articles" target="_blank" rel="noopener">Awesome npm scripts</a>, by Ryan Zimmerman</li>
</ul>
]]></content>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>php-faker</title>
    <url>/2016/08/19/php-faker/</url>
    <content><![CDATA[<p>Faker 是一个用来生成数据库实例数据的工具。Faker is a PHP library that generates fake data for you. Whether you need to bootstrap your database, create good-looking XML documents, fill-in your persistence to stress test it, or anonymize data taken from a production service, Faker is for you.<br><a id="more"></a></p>
<h3 id="installation"><a href="#installation" class="headerlink" title="installation"></a>installation</h3><p><code>composer require fzaninotto/faker</code></p>
<h3 id="basic-usage"><a href="#basic-usage" class="headerlink" title="basic usage"></a>basic usage</h3><p>Use <code>Faker\Factory::create()</code> to create and initialize a faker generator, which can generate data by accessing properties named after the type of data you want.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'/path/to/Faker/src/autoload.php'</span>;</span><br><span class="line">$faker = Faker\Factory::create();</span><br><span class="line"><span class="keyword">echo</span> $faker-&gt;name;</span><br><span class="line"><span class="keyword">echo</span> $faker-&gt;address;</span><br><span class="line"><span class="keyword">echo</span> $faker-&gt;text;</span><br><span class="line"><span class="keyword">echo</span> $faker-&gt;email;</span><br></pre></td></tr></table></figure>
<p>在<code>src/Faker/Generator.php</code> 中狠多种类型可以参考，包括file，image，uuid 各种数据类型。</p>
<h3 id="在laravel-中的使用"><a href="#在laravel-中的使用" class="headerlink" title="在laravel 中的使用"></a>在laravel 中的使用</h3><p>Laravel artisan 的 tinker 是一个 <a href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop" target="_blank" rel="noopener">REPL (read-eval-print-loop)</a> ，REPL 是指 交互式命令行界面，它可以让你输入一段代码去执行，并把执行结果直接打印到命令行界面里。通过<code>php artisan tinker</code>  和faker结合之后，可以直接用来测试。Tinker 是 Laravel 自带的 REPL，基于 <a href="http://psysh.org/" target="_blank" rel="noopener">PsySH</a> 构建而来。同样需要<code>psysh</code>的支持。</p>
<p>使用示例如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php artisan tinker</span><br><span class="line"><span class="comment">//这是是使用faker的工厂模式生成数据，其中App\User需要在database\factories\ModelFactories 文件中提前写好需要设置的数据类型和字段</span></span><br><span class="line">factory(<span class="string">"App\User::class"</span>,<span class="number">10</span>)-&gt;create(); </span><br><span class="line"><span class="comment">//查询</span></span><br><span class="line">APP\User::all(); </span><br><span class="line">App\User::count();</span><br><span class="line"><span class="comment">//增加数据</span></span><br><span class="line">$user = <span class="keyword">new</span> App\User;</span><br><span class="line">$user-&gt;name = <span class="string">"Wruce Bayne"</span>;</span><br><span class="line">$user-&gt;email = <span class="string">"iambatman@savegotham.com"</span>;</span><br><span class="line">$user-&gt;save();</span><br><span class="line"><span class="comment">// 删除数据</span></span><br><span class="line">$user = App\User::find(<span class="number">1</span>);</span><br><span class="line">$user-&gt;delete();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 还可以查看doc帮助</span></span><br><span class="line">doc dd</span><br><span class="line">doc app</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 显示源代码</span></span><br><span class="line"> show &lt;functionName&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>做过那么多计划，为何总是没成功？</title>
    <url>/2016/07/22/plan/</url>
    <content><![CDATA[<p><img src="/images/plan/1.png" alt="plan"><br>在生活中，我们为了成功，为了达成各式各样的目标 —— 赚更多钱、减肥、变自信 —— 不知来来回回制定过多少次 “完美无缺” 的计划。可最后惨痛的事实摆在眼前：没有几个人能完成计划。更讽刺的是，完成计划和中途放弃的两类人也陷入到两种截然不同的循环模式：前者总能够一次又一次地完成新的计划，能力越来越强，越来越自信；后者也会继续制定计划，但就是接连不断地缴械投降，越来越觉得自己没用，自信心也受到打击。将计划坚持到最后一刻的寥寥无几的人最终成为了大家眼中的成功人士。这样看来，成功的核心要素真的很简单 —— 就是 “坚持”。成功人士的成功轨迹各有不同，但唯一相同的一点便是 “坚持”。<br><a id="more"></a><br>成功人士在生活中的稀缺比例表明，大部分人做不到 <strong> “坚持”。坚持为什么这么难？是因为在实现目标的过程中诱惑太多了吗？是因为意志力不够坚定吗？是因为懒惰吗？是因为耐心不足吗？ </strong></p>
<p>我可以肯定地回答你 —— 是。</p>
<p>得到答案的你是否更心急、更绝望了？这么多需要克服的缺点，这辈子要等到何年何月才能学会坚持、才能成功啊！不过这些都是表面问题，试着从今天起，培养自己透过问题表面看本质的能力，反复问自己在实现目标的过程中，抵制不住诱惑、意志力不坚定、懒惰、耐心不够的根本原因是什么？</p>
<p>根本原因就是 <strong> 你发自内心想要实现这个目标的欲望、动机不够强烈、不够 “致命” 。</strong></p>
<p><img src="/images/plan/8.png" alt="plan"></p>
<p>我有个从未谈过恋爱的女性朋友，单身的原因主要是因为过胖。体脂严重超标，几十年来从未瘦过，不过她倒并不是不想瘦 —— 身边朋友的嘲讽她早就受够了，自己也很想瘦下来找个男朋友。但是因为管不住那一张贪吃的嘴，所以无论如何运动，效果也不大，顶多是从一个柔软的胖子晋级成为了一个结实的胖子。</p>
<p>可是忽然有一天，大家见面的时候，她竟然瘦成了一道闪电！我们都惊呆了，这几十年没做到的事怎么突然就做成了？原来是因为医生告诉她，如果再不调整饮食，她就很可能患上糖尿病。医生这一席话把她那一颗怕死的心天天吊在嗓子眼，从此以后拒绝一切高油高盐高糖分的食物，晚上改吃素，每天运动 3 小时，坚持了三个月后整个人瘦了好几圈，直接从 XXL 码跳到了 S 码。比较她减肥的两段历史，目标是相同的，但前者的动力源于爱美之心，后者的动力源于怕死之心。爱美之心拼不过食欲，怕死之心却战胜了一切！</p>
<p>可见，坚持与成功的关键就是拥有发自内心极其强烈的源动力。<strong> 这种源动力本质来说也是一种欲望，它必须比你身上拥有的其他任何欲望都要强烈。</strong> 我的那位女性朋友就是极佳的例子 —— 想要活下去的欲望战胜了多年以来克服不了的食欲与懒惰。</p>
<p>更多情况下，<strong> 实现目标的源动力不会一开始就表现得异常强烈，它需要培养。内心的欲望就像一个小火苗，越为它煽风点火，它就会燃烧得越旺盛。</strong></p>
<p><img src="/images/plan/2.png" alt="plan"><br>多年来我总能坚持在早上六点钟左右早起读书、晨跑，在大学这种散漫的环境里，很多朋友都深深佩服我这个习惯。其实，刚开始想要养成早起的习惯时，我也是设了十多个闹铃都没能把自己叫醒，后来有几次偶尔起来了，发现早起读书、跑步的感觉还真不赖 —— 身体变得有活力，思维也更加灵活，当我跑完步、看完书、做完护肤、吃完早餐看到室友还在沉睡时，就感觉比别人多出来的这几个小时简直是被我偷来的时光，非常有价值。</p>
<p>早起的每一天我都能感受到自己的进步，明白自己正在拉开与他人的差距。早起带来的这些好处反过来加大了我早起的欲望，有时候我甚至会学着村上春树四点钟起床。渐渐地，早起成了我雷打不动的习惯。其实我心里很明白，让我真正坚持早起的欲望来源于我内在的上进心 —— 不愿甘于平凡过着平庸的生活，想在只有一次的人生中做着自己喜欢的事情还能过上理想的生活，所以我必须很努力去赌一个未来。于是也验证了那句话 —— 每天唤醒我的不是闹钟，而是梦想。</p>
<p>既然对目标发自内心的深切渴望至关重要，那么如何给它加把火，让它战胜其他任何的欲望呢？在本文中我不会详说计划是如何制定的（我想你们可以找到很多计划制定的方法，参考今天推送的第二篇文章《只要是搜索引擎能回答的就不要问别人》），我要强调的是四个非常诚恳、能够有效坚持下去的方法。</p>
<p><img src="/images/plan/3.png" alt="plan"></p>
<h2 id="一定要给自己的坚持设定奖励回馈机制"><a href="#一定要给自己的坚持设定奖励回馈机制" class="headerlink" title="一定要给自己的坚持设定奖励回馈机制"></a>一定要给自己的坚持设定奖励回馈机制</h2><p>著名的喜剧演员 Jerry Seinfeld 曾说过他成功的秘诀 —— Don’t break the chain!（不要让红叉连起来的链条断掉！）。为了创作好的笑话，这位喜剧演员给自己设定了每天都写笑话的规矩。 他买了个巨大的挂历，每天创作完笑话后就用红色记号笔在那一天的方框里画个大大的叉。 坚持一段时间后，日历上就会出现一条红色的链子，接下来要做的，就是 “不要打断它”。<br><img src="/images/plan/4.png" alt="plan"><br>Jerry Seinfeld 的做法实际上是一种心理反馈激励机制，让自己看到过往付出的努力是很重要的，因为知道自己之前的每一天都做到了，所以今天也一定可以坚持下去。</p>
<p>除了单纯的精神激励，也可以通过物质奖励来刺激精神动力。在你的计划中，大目标是需要被拆解成小目标的，再把小目标拆解到每一天里。当你完成一个阶段性的小目标时，一定要奖励自己，最好是有物质上的奖励。随着阶段性目标的不断递进，每次完成时奖励的额度都应该增大。物质奖励不能与你的目标相冲突，比如说减肥的人不能瘦几斤就奖励自己一顿大餐把肉又给补回来了，相对于 “欺骗餐”，有经验的老司机告诉你：食欲被勾起真的很可怕，不如奖励自己更好的运动装备吧，你会更快完成目标的。 <strong> 但是请记住一点，在目标没有达成之前绝对不可以提前奖励自己，否则物质激励就完完全全失去了效果。 </strong></p>
<p>给自己设定奖励机制能够非常有效地促进你的欲望，通过不断地循环激励，你的能力会遵循马太效应 —— 越来越强，从而实现终极目标的欲火也会越来越旺盛。</p>
<h2 id="一次只专注一件事，养成习惯"><a href="#一次只专注一件事，养成习惯" class="headerlink" title="一次只专注一件事，养成习惯"></a>一次只专注一件事，养成习惯</h2><p>我知道每个人想要实现的愿望肯定不只一个，我也很肯定地告诉你，只要足够努力和坚持，你想要的东西都可以得到，但是你不会同时得到所有，你会在不同阶段中分别得到。人的意志力是有限的，一次只够做好一件事，三心二意的结果只能是一事无成。Roy F. Baumeister 教授在《意志力》（Willpower: Rediscovering the Greatest Human Strength）提到培养意志力的方法是：<strong> 一次只做一件事，适时奖励，养成习惯开启 “自动挡”。</strong></p>
<p>Baumeister 还指出，人在不同事物上的意志力是相互影响的，<strong> 一件事做好了，做好另一件事也会变得容易。</strong> 比如说当你学会把家里整理得井井有条时，就会发现吃饭时不吃不健康的食物、合理控制饮食也变得简单了。</p>
<p>意志力这件事很有趣，大家都认为每天坚持做一件事非常不容易，但是想想刷牙、洗澡、按时吃饭为什么我们能够几十年如一日地做，也没有觉得很困难？更多的时候，我们根本没有想过做这些事需要意志力。 这就是习惯的强大力量，当你把做某件事养成习惯了，它就会自动变成你的日常状态。不过 21天养成一个习惯是不够准确的，21 天只能说是初步培养出了一些习惯的感觉。坚持 21 天晨跑，你会发现第 22 天不晨跑有些难受，只要你接下来几天不晨跑，这个习惯依旧会消失。用我的经验来说，要是你想养成一个新习惯，比如说晨跑，<strong> 至少要一年。不要着急，好习惯需要慢慢养成，你的努力，时间都看得见。 </strong></p>
<h2 id="一定要给自己的坚持设定奖励回馈机制-1"><a href="#一定要给自己的坚持设定奖励回馈机制-1" class="headerlink" title="一定要给自己的坚持设定奖励回馈机制"></a>一定要给自己的坚持设定奖励回馈机制</h2><p><img src="/images/plan/5.png" alt="plan"><br>放弃者必败。我们一生中必然会犯许多错误，但这并不是最糟糕的；我们也会遇到很多问题，但最终总会找到解决的办法。可是如果我们半途而废，那么一切就真的无可挽回了。<strong> 如果在追求梦想的路上半途而废，我们就很可能永远终止了自己的梦想。停止追寻梦想的人无异于过着行尸走肉的生活。 </strong></p>
<p>我们的先人在很早以前就悟出了 “失败与苦难乃成功之母” 的道理：“<strong> 故天将降大任于斯人也，必先苦其心志，劳其筋骨，饿其体肤，空乏其身，行弗乱其所为，所以动心忍性，曾益其所不能。—— 《孟子》 </strong> ” 。<strong> 你想完成自己的目标，过更好的生活，必须先拥有能承受与这种生活相匹配的抗压能力。生活是公平的，你能够承受住多大的压力、解决多复杂的问题，它就会给你多少的回报 </strong> 。在实现目标的过程中，<strong> 你遇到的失败只是证明你还未拥有相应的能力，这个时候你唯一要做的就是绝不放弃，然后坚持下去。</strong> 想想打游戏时，当你升级进入下一个难度更高的关卡时，开始时总是挑战失败，多玩几次总结经验、避开之前的那些坑，最后不也顺利进入下一关了吗？不要害怕失败，你遇到失败意味着你已经突破了自己原有的能力局限，你在成长。坚持下去，<strong> 未来在前方已经为你准备好了许多惊喜。</strong><br><img src="/images/plan/6.png" alt="plan"><br>我很建议大家写<code>“成功日记”</code>，把自己每天做过的觉得成功的事情写在上面，哪怕是坚持写成功日记这件事也有资格记录在册。经常翻看成功日记，可以培养自己的自信。失败时看看自己做过的成功事迹，进行积极的心理暗示，告诉自己这一次目标达成后我也会把它记录在册。</p>
<p><strong> 遇到失败一定不要放弃，不要把对目标积累已久的 “欲火” 就这样让它熄灭了，坚持下去一定会成功的。</strong></p>
<h2 id="找到价值观一致的同类"><a href="#找到价值观一致的同类" class="headerlink" title="找到价值观一致的同类"></a>找到价值观一致的同类</h2><p><img src="/images/plan/7.png" alt="plan"><br>当你坚持做了很多事，养成了许多好习惯时，你必然已经成为了一个更好的人。这意味着在之前的环境中，你可能会不合群。千万不要被周围人所影响！<strong> 不要为了合群而去改变自己。</strong></p>
<p>我的大学不算特别好的学校，但我依然努力学习各种技能、出门参与各项工作实习，可身边出现了这样的声音 “你不过是一个一直想往上爬的人，我们跟你不一样，注定玩不到一块儿”，当时只有十几岁的我听到这种话真的很难过，但我非常庆幸自己当时没有改变自己，去追求和他们 “一样”，去跟他们玩到一起。</p>
<p>现在的我拥有了一个全新的环境，身边的人都是跟我一样的人：他们比我更聪明更努力，我就明白了这种团队与环境才是我想要的，我能够更快地成长、更好地完成自己的目标。燕雀安知鸿鹄之志哉？<br>同类也是遵循 <code>吸引力法则</code> 的，很多人会苦于自己在生活里找不到想要的优秀同类，我只想说<strong> 那是因为你还不够努力、还不够优秀。不断地提升自己，同类会自动被你吸引过来。</strong> 对这个法则有兴趣的朋友可以去阅读一下 <code>Rhonda Byrne 的《秘密》</code>。</p>
<blockquote><p>Improve the internal fire every day. Be persistent internally, then the external success will take of itself !!!<br>每天让渴望完成目标的欲火燃烧得更强烈些，你只需要发自内心地去坚持，外界的成功自然而然会到来！！！</p>
<footer><strong>Jame Saltucher</strong></footer></blockquote>
<hr>
<blockquote>
<p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDgyMTA3Mg==&amp;mid=2650055652&amp;idx=1&amp;sn=e69d8252994229b3b3521f1bc80671ce&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">转载</a></p>
</blockquote>
]]></content>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>做秒杀的几个思路</title>
    <url>/2016/12/01/seckill-sys/</url>
    <content><![CDATA[<h1 id="秒杀业务为什么难做"><a href="#秒杀业务为什么难做" class="headerlink" title="秒杀业务为什么难做"></a>秒杀业务为什么难做</h1><ol>
<li>im系统，例如qq或者微博，每个人都读自己的数据（好友列表、群列表、个人信息）；</li>
<li>微博系统，每个人读你关注的人的数据，一个人读多个人的数据；</li>
<li>秒杀系统，库存只有一份，所有人会在集中的时间读和写这些数据，多个人读一个数据。</li>
</ol>
<blockquote>
<p>小米手机每周二的秒杀，可能手机只有1万部，但瞬时进入的流量可能是几百几千万。</p>
</blockquote>
<blockquote>
<p>12306抢票，票是有限的，库存一份，瞬时流量非常多，都读相同的库存。读写冲突，锁非常严重，这是秒杀业务难的地方。那我们怎么优化秒杀业务的架构呢？（其实12306比淘宝要更难做，因为所有的都是动态库存，几百种sku。<a href="http://mp.weixin.qq.com/s?src=3&amp;timestamp=1483520302&amp;ver=1&amp;signature=oMV0qeEAoxDXix0z8h1QIV3pVyw4Bqm9EvLUMBtk8dsrtnHZe1fKK2M403x7M2w0ut03F2lv1oFCx65DJxfPl4PlFW1rZPzOaSQspD4bZqjZ7pcjPfvo-PsR3Ec7nmkZo9jni8iNFahs0QtAZ8R3eg==" target="_blank" rel="noopener">有兴趣请点击查看</a>）</p>
</blockquote>
<h1 id="优化方向"><a href="#优化方向" class="headerlink" title="优化方向"></a>优化方向</h1><ol>
<li><p>将请求尽量拦截在系统上游（不要让锁冲突落到数据库上去）。传统秒杀系统之所以挂，请求都压倒了后端数据层，数据读写锁冲突严重，并发高响应慢，几乎所有请求都超时，流量虽大，下单成功的有效流量甚小。以12306为例，一趟火车其实只有2000张票，200w个人来买，基本没有人能买成功，请求有效率为0。</p>
</li>
<li><p>充分利用缓存，秒杀买票，这是一个典型的<strong>读多些少</strong>的应用场景，大部分请求是车次查询，票查询，下单和支付才是写请求。一趟火车其实只有2000张票，200w个人来买，最多2000个人下单成功，其他人都是查询库存，写比例只有0.1%，读比例占99.9%，非常适合使用缓存来优化。</p>
</li>
</ol>
<h1 id="常见秒杀架构"><a href="#常见秒杀架构" class="headerlink" title="常见秒杀架构"></a>常见秒杀架构</h1><ol>
<li>浏览器端，最上层，会执行到一些JS代码</li>
<li>站点层，这一层会访问后端数据，拼html页面返回给浏览器</li>
<li>服务层，向上游屏蔽底层数据细节，提供数据访问</li>
<li>数据层，最终的库存是存在这里的，mysql是一个典型（当然还有会缓存）</li>
</ol>
<h1 id="各层次优化细节"><a href="#各层次优化细节" class="headerlink" title="各层次优化细节"></a>各层次优化细节</h1><h2 id="客户端怎么优化（浏览器层，APP层）"><a href="#客户端怎么优化（浏览器层，APP层）" class="headerlink" title="客户端怎么优化（浏览器层，APP层）"></a>客户端怎么优化（浏览器层，APP层）</h2><pre><code>- 产品层面，用户点击“查询”或者“购票”后，按钮置灰，禁止用户重复提交请求；
- JS层面，**限制用户**在x秒之内只能提交一次请求；
- APP层面，可以做类似的事情，虽然你疯狂的在摇微信，其实x秒才向后端发起一次请求。这就是所谓的“将请求尽量拦截在系统上游”，越上游越好，浏览器层，APP层就给拦住，这样就能挡住80%+的请求。
</code></pre><p>但是这种办法只能拦住普通用户（但99%的用户是普通用户）对于群内的高端程序员是拦不住的。firebug一抓包，http长啥样都知道，js是万万拦不住程序员写for循环，调用http接口的，这部分请求怎么处理？</p>
<h2 id="站点层面的请求拦截"><a href="#站点层面的请求拦截" class="headerlink" title="站点层面的请求拦截"></a>站点层面的请求拦截</h2><p>怎么拦截？怎么防止程序员写for循环调用，有去重依据么？ip？cookie-id？…想复杂了，这类业务都需要登录，用uid即可。在站点层面，对uid进行请求计数和去重，甚至不需要统一存储计数，直接站点层内存存储（这样计数会不准，但最简单）。一个uid，5秒只准透过1个请求，这样又能拦住99%的for循环请求。</p>
<p>5s只透过一个请求，其余的请求怎么办？<br><strong>缓存，页面缓存</strong>，同一个uid，限制访问频度，做页面缓存，x秒内到达站点层的请求，均返回同一页面。<br>同一个item的查询，例如车次，做页面缓存，x秒内到达站点层的请求，均返回同一页面。如此限流，既能保证用户有良好的用户体验（没有返回404）又能保证系统的健壮性（利用页面缓存，把请求拦截在站点层了）。</p>
<p>页面缓存不一定要保证所有站点返回一致的页面，直接放在每个站点的内存也是可以的。优点是简单，坏处是http请求落到不同的站点，返回的车票数据可能不一样，这是站点层的请求拦截与缓存优化。</p>
<p>好，这个方式拦住了写for循环发http请求的程序员，有些高端程序员（黑客）控制了10w个肉鸡，手里有10w个uid，同时发请求（先不考虑实名制的问题，小米抢手机不需要实名制），这下怎么办，站点层按照uid限流拦不住了。</p>
<h2 id="服务层来拦截（反正就是不要让请求落到数据库上去）"><a href="#服务层来拦截（反正就是不要让请求落到数据库上去）" class="headerlink" title="服务层来拦截（反正就是不要让请求落到数据库上去）"></a>服务层来拦截（反正就是不要让请求落到数据库上去）</h2><p>服务层怎么拦截？我是服务层，我清楚的知道小米只有1万部手机，我清楚的知道一列火车只有2000张车票，我透10w个请求去数据库有什么意义呢？没错，<strong> 请求队列！</strong><br>对于写请求，做请求队列，每次只透有限的写请求去数据层（<strong> 下订单，支付</strong> 这样的写业务）</p>
<blockquote>
<p>1w部手机，只透1w个下单请求去db<br>3k张火车票，只透3k个下单请求去db<br>如果均成功再放下一批，如果库存不够则队列里的写请求全部返回“已售完”。</p>
</blockquote>
<p>对于读请求，怎么优化？cache抗，不管是memcached还是redis，单机抗个<code>每秒10w</code>应该都是没什么问题的。如此限流，只有非常少的写请求，和非常少的读缓存mis的请求会透到数据层去，又有99.9%的请求被拦住了。</p>
<p>其他业务优化方面:</p>
<blockquote>
<ul>
<li>还有业务规则上的一些优化。回想12306所做的，分时分段售票，原来统一10点卖票，现在8点，8点半，9点，…每隔半个小时放出一批：将流量摊匀。</li>
<li>数据粒度的优化：你去购票，对于余票查询这个业务，票剩了58张，还是26张，你真的关注么，其实我们只关心有票和无票？流量大的时候，做一个<code>粗粒度</code>的“有票”“无票”缓存即可。</li>
<li>一些业务逻辑的异步：例如下单业务与 支付业务的分离。这些优化都是结合 业务 来的</li>
</ul>
</blockquote>
<h2 id="数据库层"><a href="#数据库层" class="headerlink" title="数据库层"></a>数据库层</h2><blockquote>
<ul>
<li>浏览器拦截了80%</li>
<li>站点层拦截了99.9%并做了页面缓存</li>
<li>服务层又做了写请求队列与数据缓存</li>
</ul>
</blockquote>
<p>每次透到数据库层的请求都是可控的,db基本就没什么压力了。库存是有限的，透这么多请求来数据库没有意义，全部透到数据库，100w个下单，0个成功，请求有效率0%。透3k个到数据，全部成功，请求有效率100%。</p>
<h1 id="总体思路"><a href="#总体思路" class="headerlink" title="总体思路"></a>总体思路</h1><ol>
<li>尽量将请求拦截在系统上游（越上游越好）；</li>
<li>读多写少的常用多使用缓存（缓存抗读压力）；</li>
</ol>
<blockquote>
<ul>
<li>浏览器和APP：做限速</li>
<li>站点层：按照uid做限速，做页面缓存</li>
<li>服务层：按照业务做写请求队列控制流量，做数据缓存</li>
<li>数据层：闲庭信步</li>
</ul>
</blockquote>
<h1 id="其他的优化："><a href="#其他的优化：" class="headerlink" title="其他的优化："></a>其他的优化：</h1><ul>
<li>当还是有大量流量到了站点层了，用扩容；或着<strong>拦截</strong>或抛弃50%的请求，50%的请求直接返回稍后重试，不能让所有的用户都失败。</li>
<li>服务层可以使用<strong>队列</strong>，若队列已经有远超过库存的，在过来的请求就直接返回稍后重试。<strong>可以一个服务一个队列，总数/服务个数</strong>。如果同意一个队列的话，有并发锁的问题。</li>
<li>其他常见的场景，运营活动页面，短时间的推送消息，都可以做<strong>缓存</strong>。</li>
<li>下单不支付，过了等待时间“回仓”改库存。</li>
<li>如果同时进行的活动很多，需要垂直拆分</li>
<li>如果业务失败的话，直接返回重试，没必要再从新放入队列</li>
<li>数据和缓存不一致的时候，脏读了，只要数据库层面真实性没有问题，这个场景是可以容忍的。</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>flex布局</title>
    <url>/2016/11/30/flex/</url>
    <content><![CDATA[<p>布局的传统解决方案，基于<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/box_model" target="_blank" rel="noopener">盒状模型</a>，依赖 display属性 + position属性 + float属性。它对于那些特殊布局非常不方便，比如，<a href="https://css-tricks.com/centering-css-complete-guide/" target="_blank" rel="noopener">垂直居中</a>就不容易实现。</p>
<p>Flex是Flexible Box的缩写，意为”弹性布局”，用来为盒状模型提供最大的灵活性。<br>任何一个容器都可以指定为Flex布局。<br><a id="more"></a><br><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.box</span>&#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  // display: inline-flex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.box</span>&#123;</span><br><span class="line">  <span class="attribute">display</span>: -webkit-flex; <span class="comment">/* Safari */</span></span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意，设为Flex布局以后，子元素的float、clear和vertical-align属性将失效。<br>采用Flex布局的元素，称为Flex容器（flex container），简称”容器”。它的所有子元素自动成为容器成员，称为Flex项目（flex item），简称”项目”。</p>
<h3 id="容器的属性"><a href="#容器的属性" class="headerlink" title="容器的属性"></a>容器的属性</h3><ol>
<li><p>flex-direction:</p>
<blockquote>
<ul>
<li>row（默认值）：主轴为水平方向，起点在左端。</li>
<li>row-reverse：主轴为水平方向，起点在右端。</li>
<li>column：主轴为垂直方向，起点在上沿。</li>
<li>column-reverse：主轴为垂直方向，起点在下沿。</li>
</ul>
</blockquote>
</li>
<li><p>flex-wrap:<br>nowrap | wrap | wrap-reverse</p>
</li>
<li><p>flex-flow<br>flex-flow属性是flex-direction属性和flex-wrap属性的简写形式，默认值为row nowrap。</p>
</li>
<li><p>justify-content</p>
<blockquote>
<ul>
<li>flex-start（默认值）：左对齐</li>
<li>flex-end：右对齐</li>
<li>center： 居中</li>
<li>space-between：两端对齐，项目之间的间隔都相等。</li>
<li>space-around：每个项目两侧的间隔相等。所以，项目之间的间隔比项目与边框的间隔大一倍。</li>
</ul>
</blockquote>
</li>
<li><p>align-items</p>
<blockquote>
<ul>
<li>flex-start：交叉轴的起点对齐。</li>
<li>flex-end：交叉轴的终点对齐。</li>
<li>center：交叉轴的中点对齐。</li>
<li>baseline: 项目的第一行文字的基线对齐。</li>
<li>stretch（默认值）：如果项目未设置高度或设为auto，将占满整个容器的高度。</li>
</ul>
</blockquote>
</li>
<li><p>align-content 属性定义了多根轴线的对齐方式。如果项目只有一根轴线，该属性不起作用。</p>
<blockquote>
<ul>
<li>flex-start：与交叉轴的起点对齐。</li>
<li>flex-end：与交叉轴的终点对齐。</li>
<li>center：与交叉轴的中点对齐。</li>
<li>space-between：与交叉轴两端对齐，轴线之间的间隔平均分布。</li>
<li>space-around：每根轴线两侧的间隔都相等。所以，轴线之间的间隔比轴线与边框的间隔大一倍。</li>
<li>stretch（默认值）：轴线占满整个交叉轴。</li>
</ul>
</blockquote>
</li>
</ol>
<h3 id="项目的属性"><a href="#项目的属性" class="headerlink" title="项目的属性"></a>项目的属性</h3><ol>
<li>order 属性定义项目的排列顺序。数值越小，排列越靠前，默认为0。</li>
<li>flex-grow 定义项目的放大比例，默认为0，即如果存在<strong>剩余空间</strong>，也不放大。0 为默认不放大，为文本本身的长度，如果没有则不显示</li>
<li>flex-shrink 属性定义了项目的缩小比例，默认为1，即<strong>如果空间不足</strong>，该项目将缩小。1 为默认，为原始大小，</li>
<li>flex-basis  属性定义了在分配多余空间之前，项目占据的主轴空间（main size）。浏览器根据这个属性，<strong>计算主轴是否有多余空间</strong>。它的默认值为auto，即项目的本来大小</li>
<li>flex  flex-grow, flex-shrink 和 flex-basis的简写，默认值为0 0 auto。后两个属性可选。</li>
<li>align-self  属性允许单个项目有与其他项目不一样的对齐方式，可覆盖align-items属性。默认值为auto，表示继承父元素的align-items属性，如果没有父元素，则等同于stretch。</li>
<li>margin : auto 设置”margin”值为”auto”值，自动获取弹性容器中剩余的空间。所以设置垂直方向margin值为”auto”。可以使弹性子元素在弹性容器的两上轴方向都<strong>完全集中</strong>。<br>以下实例在第一个弹性子元素上设置了 margin-right: auto; 。 它将剩余的空间放置在元素的右侧：</li>
</ol>
<p>flex ：默认    0 1 auto ; auto&lt;=&gt; “ 1 1 auto “; none&lt;=&gt; “0 0  auto”<br>参考一下代码，分别改变flex的三个值，去理解其中三个值的含义。<br>当总长度-去flex-basis的值之后，根据剩余的空间或者缩小比例 来改变grow或者shrink的值。<br><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-id">#main</span> &#123;</span></span><br><span class="line">    width: 350px;</span><br><span class="line">    height: 100px;</span><br><span class="line"><span class="css">    <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#c3c3c3</span>;</span></span><br><span class="line">    display: flex;</span><br><span class="line">&#125;</span><br><span class="line"><span class="css"><span class="selector-id">#main</span> <span class="selector-tag">div</span> &#123;</span></span><br><span class="line">    flex: 0 1 80px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="css"><span class="selector-id">#main</span> <span class="selector-tag">div</span><span class="selector-pseudo">:nth-of-type(5)</span> &#123;</span></span><br><span class="line">  flex: 0 1 30px;</span><br><span class="line">&#125;</span><br><span class="line">flex-grow : </span><br><span class="line">flex-shrink: </span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"main"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"background-color:coral;"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"background-color:lightblue;"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"background-color:khaki;"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"background-color:pink;"</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"background-color:lightgrey;"</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><a href="http://www.runoob.com/try/try.php?filename=trycss3_flexbox_margin" target="_blank" rel="noopener">示例</a></p>
<h3 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h3><p><a href="http://www.ruanyifeng.com/blog/2015/07/flex-grammar.html" target="_blank" rel="noopener">参考</a><br><a href="https://gist.github.com/changyuan/cce6e8818c038760d8cadccfd8f96824" target="_blank" rel="noopener">骰子</a><br><a href="https://gist.github.com/changyuan/02c14ca2aabc7107950d0056fa654522" target="_blank" rel="noopener">圣怀布局</a><br><a href="https://gist.github.com/changyuan/77cfcd7344a8522b7e365865a0428c2d" target="_blank" rel="noopener">常用后台布局</a></p>
]]></content>
  </entry>
  <entry>
    <title>principles(原则)</title>
    <url>/2016/06/15/principles/</url>
    <content><![CDATA[<blockquote>
<p>建立自己的原则系统, 把一些好的概念与方法论，应用到自己的生活中方方面，形成自己的“原则”。</p>
</blockquote>
<h1 id="进取型人格宣言"><a href="#进取型人格宣言" class="headerlink" title="进取型人格宣言"></a>进取型人格宣言</h1><ol>
<li>学习其实是一种生活方式，学习本身就是最好的洗脑方式。</li>
<li>只要我投入时间精力，长期来看，没有什么是我学不会的。</li>
<li>我学会的东西越多，我再学新的东西就只能越来越快。<a id="more"></a></li>
<li>学习不是目的，用起来才是真的，因为价值只能通过创造去实现。</li>
<li>我知道我现在看起来很笨拙，但刚开始谁都是这样的，实践多了，就自然了，就自然地好起来了。</li>
<li>在学习这件事儿上，他们不理解我是正常的，这方面我也不需要理解，因为我是一个独立的人。</li>
<li>我不应该与他们争辩，因为我不想伤害他们；我也不应该被他们影响，因为我不想伤害自己。</li>
<li>刻意练习永远是必要的，虽然它通常并不舒适，但它的复利效应确实巨大的。哪怕是为了下一代，我也要通过现在的努力成为学习专家，这样才有资格与我的孩子共同成长…</li>
<li>我的路还很长，我要健康，我要干净，尤其是我的脑子更要干净。</li>
<li>了解一个概念之后，一定要查找，总结成自己的方法,“用” 到自己的生活中，帮助自己成长,重复练习。</li>
</ol>
<h1 id="方法论"><a href="#方法论" class="headerlink" title="方法论"></a>方法论</h1><h2 id="学习技巧"><a href="#学习技巧" class="headerlink" title="学习技巧"></a>学习技巧</h2><blockquote>
<p>习得任何技能的最根本技巧，就是一句话而已：<code>马上开始像那些已经精通这个技能的人一样生活。</code><br>保持耐心，反复来过，直至成功。</p>
</blockquote>
<p>它会让你无视很多障碍，跨越很多障碍，甚至那些障碍对你来说就好像完全不存在一样。心理学家告诉我们，当你不开心的时候，假装开心，做出笑脸，过一会儿就没那么不开心了，甚至真的开心起来…… 这个原理其实可以用在很多地方，比如，某项技能你不会，但你想会，那就从假装会了这个技能开始，然后当真去做、去学，没多久就真的会了…… 我小时候学吉他也是这样，买来吉他其实是不会的啊，但也不知道为什么就是有欲望坐在那里乱弹一气，就好像会了一样 —— 可真的没多一会儿就开始渐渐调整自己，让手的拨动多少有点节奏…… 竟然比之前好听多了！</p>
<h2 id="思考模式（Mindset）和行为模式（Action-Pattern）："><a href="#思考模式（Mindset）和行为模式（Action-Pattern）：" class="headerlink" title="思考模式（Mindset）和行为模式（Action Pattern）："></a>思考模式（Mindset）和行为模式（Action Pattern）：</h2><blockquote>
<ul>
<li>随时准备深入了解某个小领域</li>
<li>借助地球上最强大的人工智能（Google）找到学习资源</li>
<li>给自己一小段时间刻意练习</li>
<li>不怕死记硬背，更要善于死记硬背，通过短时间内的大量重复，把那些别人看起来枯燥的东西迅速变成自己“内建的技能” —— 通过刻意练习将其熟练到“想都不用想就能用的地步”……</li>
<li>给自己定个“最后期限”，比如一小时之内一定做到把这些命令谙熟于心…… 绝对不能“过些天就想不起来了”，否则，那就是思考监管的“只因为学习习惯不好造成的永久性愚蠢”。</li>
</ul>
</blockquote>
<p>再提醒一遍，别忘了给自己洗脑：<strong><code>“只搜索、只阅读英文文档”</code></strong>，<strong><code>有中文的也不能看，就是不能看</code></strong>……</p>
<p>还有就是，<strong><code>每次脑子里闪出“呀，好麻烦！”这个念头的时候，就要知道自己脑子脏了，该洗了</code></strong>。 无论干什么都挺麻烦的，怕麻烦的人什么都做不成，躲避麻烦的唯一正确方式就是<strong><code>“不怕麻烦，逐一完成”</code></strong>，否则就会反复麻烦一辈子又一辈子（甚至会遗传，不耐心的父母必然养出不耐心的孩子）。凡事道理都是一样的，我有一句口头禅：<strong><code>“偷懒的唯一方式就是不偷懒……”</code></strong>也还是一样的道理。</p>
<h2 id="工程师思维"><a href="#工程师思维" class="headerlink" title="工程师思维"></a>工程师思维</h2><p>1)自动化<br>2 减少工作量  – <em><code>“ 怎么做才能将来不用做或者起码少做却可以实际上干更多呢？”</code></em></p>
<h2 id="冥想：（Meditation）"><a href="#冥想：（Meditation）" class="headerlink" title="冥想：（Meditation）"></a>冥想：（Meditation）</h2><p>坐享，也许是最简单的大脑锻炼方式，这也是人类莫名其妙地已经运用了两千五百年以上的大脑锻炼方式。已经有足够多的科学研究证明，它能使你的大脑皮层表面积加大，能使你的灰质变厚，它也能增强人们的免疫系统，它还能让人们摆脱抑郁症……<br>尽管简单，但也相当神奇。虽然神奇，却又非常简单。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>总而言之，要集中注意力、并且最终可以做到自如地控制注意力才算是坐享 —— 最终的目标是可以做到在越来越的时间里自如的注意力集中，并且还能控制集中的注意力。而胡思乱想、放空，甚至是睡着了，都算不上是坐享，对增加大脑皮层面<br>积，增厚灰质没有什么具体的帮助。<br><a href="http://www.wikihow.com/Do-Mindful-Meditation" target="_blank" rel="noopener">how</a></p>
]]></content>
      <tags>
        <tag>读书</tag>
      </tags>
  </entry>
  <entry>
    <title>shell 相关</title>
    <url>/2016/11/09/shell/</url>
    <content><![CDATA[<p>记录一些用shell编写的小脚本，等等。<br><a id="more"></a></p>
<h3 id="用shell脚本，实现多台服务器代码同步更新的东东（rsync）"><a href="#用shell脚本，实现多台服务器代码同步更新的东东（rsync）" class="headerlink" title="用shell脚本，实现多台服务器代码同步更新的东东（rsync）"></a>用shell脚本，实现多台服务器代码同步更新的东东（rsync）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 同步多台服务器文件代码</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> == <span class="string">"f"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	rsync -av ./ --exclude-from=<span class="string">'frontend_rsync_exclude.txt'</span> changyuan@172.21.0.86:/home/changyuan/frontend/</span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$1</span> == <span class="string">"b"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	rsync -av ./ --exclude-from=<span class="string">'backend_rsync_exclude.txt'</span> changyuan@172.21.0.86:/home/changyuan/backend/</span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$1</span> == <span class="string">"a"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	rsync -av ./ --exclude-from=<span class="string">'api_rsync_exclude.txt'</span> changyuan@172.21.0.86:/home/changyuan/api/</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	rsync -av ./ --exclude-from=<span class="string">'frontend_rsync_exclude.txt'</span> changyuan@172.21.0.86:/home/changyuan/frontend/</span><br><span class="line">	rsync -av ./ --exclude-from=<span class="string">'backend_rsync_exclude.txt'</span> changyuan@172.21.0.86:/home/changyuan/backend/</span><br><span class="line">	rsync -av ./ --exclude-from=<span class="string">'api_rsync_exclude.txt'</span> changyuan@172.21.0.86:/home/changyuan/api/</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其中.txt 文件是一些不需要的同步的目录文件</span></span><br></pre></td></tr></table></figure>
<p>rsync 是一个远程数据同步工具，可通过LAN,WAN快速同步多台主机间的文件。Rsync使用所谓的“Rsync算法”来使本地和远程两个主机之间的文件达到同步，这个算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。<code>rsync --help</code> 查看帮助，其中常使用的参数如下，有两种实现方式：</p>
<blockquote>
<ul>
<li>-a, –archive 归档模式，表示以递归方式传输文件，并保持所有文件属性，等于-rlptgoD</li>
<li>-v, –verbose 详细模式输出</li>
<li>-P 等同于 –partial</li>
<li>–progress 显示备份过程</li>
<li>-z, –compress 对备份的文件在传输时进行压缩处理</li>
<li>–exclude=PATTERN 指定排除不需要传输的文件模式</li>
<li>–include=PATTERN 指定不排除而需要传输的文件模式</li>
<li>–exclude-from=FILE 排除FILE中指定模式的文件，在一个文件中指定的目录或文件</li>
<li>–include-from=FILE 不排除FILE指定模式匹配的文件 必须包含的,在一个文件中指定的目录或文件</li>
<li>–delete 删除那些DST中SRC没有的文件</li>
<li>–delete-excluded 同样删除接收端那些被该选项指定排除的文件</li>
<li>–delete-after 传输结束以后再删除</li>
</ul>
</blockquote>
<h4 id="SSH方式"><a href="#SSH方式" class="headerlink" title="SSH方式(:)"></a>SSH方式(:)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service sshd start</span><br><span class="line">rsync -vzrtopg --progress -e ssh --delete work@172.16.78.192:/www/* /databack/experiment/rsync</span><br><span class="line"></span><br><span class="line"><span class="comment">#如何通过rsync只复制目录结构，忽略掉文件呢?</span></span><br><span class="line">rsync -av --include <span class="string">'*/'</span> --exclude <span class="string">'*'</span> <span class="built_in">source</span>-dir dest-dir</span><br></pre></td></tr></table></figure>
<h4 id="后台服务方式"><a href="#后台服务方式" class="headerlink" title="后台服务方式(::)"></a>后台服务方式(::)</h4><h5 id="启动rsync服务"><a href="#启动rsync服务" class="headerlink" title="启动rsync服务"></a>启动rsync服务</h5><p><code>vim /etc/xinetd.d/rsync</code> , 将其中的<code>disable=yes</code>改为<code>disable=no</code>,并重启<code>xinetd</code>服务</p>
<h5 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h5><p><code>vi /etc/rsyncd.conf</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">uid=root</span><br><span class="line">gid=root</span><br><span class="line">max connections=4</span><br><span class="line"><span class="built_in">log</span> file=/var/<span class="built_in">log</span>/rsyncd.log</span><br><span class="line">pid file=/var/run/rsyncd.pid</span><br><span class="line">lock file=/var/run/rsyncd.lock</span><br><span class="line">secrets file=/etc/rsyncd.passwd</span><br><span class="line">hosts deny=172.16.78.0/22</span><br><span class="line"></span><br><span class="line">[www]</span><br><span class="line">comment= backup web</span><br><span class="line">path=/www</span><br><span class="line"><span class="built_in">read</span> only = no</span><br><span class="line">exclude=<span class="built_in">test</span></span><br><span class="line">auth users=work</span><br></pre></td></tr></table></figure></p>
<h5 id="创建密码文件"><a href="#创建密码文件" class="headerlink" title="创建密码文件"></a>创建密码文件</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"work:abc123"</span> &gt; /etc/rsyncd.passwd</span><br><span class="line">chmod 600 /etc/rsyncd.passwd</span><br></pre></td></tr></table></figure>
<h5 id="备份-恢复"><a href="#备份-恢复" class="headerlink" title="备份,恢复"></a>备份,恢复</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rsync -avz --progress --delete work@172.16.78.192::www /databack/experiment/rsync</span><br><span class="line">rsync -avz --progress /databack/experiment/rsync/ work@172.16.78.192::www</span><br></pre></td></tr></table></figure>
<p><a href="https://rsync.samba.org/" target="_blank" rel="noopener">更多关于rsync参考</a> , <a href="https://rsync.samba.org/examples.html" target="_blank" rel="noopener">官方给出的样例</a></p>
<h3 id="crontab-相关参数"><a href="#crontab-相关参数" class="headerlink" title="crontab 相关参数"></a>crontab 相关参数</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> .---------------- minute (0 - 59)</span><br><span class="line"> |  .------------- hour (0 - 23)</span><br><span class="line"> |  |  .---------- day of month (1 - 31)</span><br><span class="line"> |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span><br><span class="line"> |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span><br><span class="line"> |  |  |  |  |</span><br><span class="line"> *  *  *  *  * user-name <span class="built_in">command</span> to be executed</span><br><span class="line"></span><br><span class="line">eg：</span><br><span class="line">0 3 * * * bash /home/demo.sh &gt;&gt; /home/sh.log  <span class="comment"># 三点开始执行</span></span><br><span class="line">8 12 * * 3 bash /data1/auto.sh  <span class="comment"># 每周3的12点8分开始执行</span></span><br><span class="line">0 21 * * 2 scp /data1/&#123;kid_kid_ask_set,kid_period_ask_set&#125; root@192.168.2.3:/data/ <span class="comment">#每周二晚上21点执行</span></span><br><span class="line">10 14 * * * bash /home/updataRedis.sh &gt;&gt;/home/<span class="built_in">log</span>/log.txt 2&gt;&amp;1 <span class="comment"># 14:10 开始</span></span><br><span class="line">*/1 * * * * curl http://www.xxx.com/test.php  <span class="comment">#每分钟开始执行</span></span><br></pre></td></tr></table></figure>
<h3 id="创建文件夹"><a href="#创建文件夹" class="headerlink" title="创建文件夹"></a>创建文件夹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line"><span class="built_in">cd</span> /home/changyuan/<span class="built_in">test</span>/</span><br><span class="line">str=`date <span class="string">'+%Y%m%d%H%M'</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="variable">$str</span> ] </span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"exist floder"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	mkdir <span class="variable">$str</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<h3 id="shell-基础"><a href="#shell-基础" class="headerlink" title="shell 基础"></a>shell 基础</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">touch online.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Hello World !"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#变成可执行文件</span></span><br><span class="line">chmod +x ./online.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者直接</span></span><br><span class="line">/bin/sh online.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#变量使用</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> `ls /etc`</span><br><span class="line"></span><br><span class="line">your_name=<span class="string">"qinjx"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$your_name</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;your_name&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#只读变量</span></span><br><span class="line">myUrl=<span class="string">"http://www.w3cschool.cc"</span></span><br><span class="line"><span class="built_in">readonly</span> myUrl</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除变量</span></span><br><span class="line"><span class="built_in">unset</span> variable_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#字符串</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"\"It is a test\""</span> <span class="comment"># 转义</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"OK! \n"</span> <span class="comment"># 转义换行</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'$name'</span>  <span class="comment"># 单引号为输出</span></span><br><span class="line">string=<span class="string">"runoob is a great site"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;#string&#125;</span> <span class="comment">#提取子字符串长度</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;string:1:4&#125;</span> <span class="comment"># 输出 unoo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$string</span> <span class="variable">$string1</span> <span class="comment">#连接字符串</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> `expr index <span class="string">"<span class="variable">$string</span>"</span> is` <span class="comment"># 查找is位置expr</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#数组</span></span><br><span class="line">array_name=(value0 value1 value2 value3) <span class="comment">#定义</span></span><br><span class="line">array_name[n]=valuen</span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;array_name[1]&#125;</span> <span class="comment">#取值</span></span><br><span class="line"><span class="variable">$&#123;array_name[@]&#125;</span> , <span class="variable">$&#123;array_name[*]&#125;</span>  <span class="comment">#全部</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;#array_name[0]&#125;</span> <span class="comment">#单个长度</span></span><br><span class="line"><span class="variable">$&#123;#array_name[@]&#125;</span> 或者 <span class="variable">$&#123;#array_name[*]&#125;</span> <span class="comment">#长度</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数传递</span></span><br><span class="line"><span class="variable">$0</span>,<span class="variable">$1</span>,<span class="variable">$2</span>... <span class="comment"># 分别为第一个，第二个参数等等</span></span><br><span class="line"><span class="variable">$#</span>	 <span class="comment">#为传递到脚本的参数个数</span></span><br><span class="line">$* , <span class="variable">$@</span>   <span class="comment">#所有向脚本传递的参数,只有放到双引号中，前者相当于一个参数"1 2 3"，后台还是多个(1,2,3)</span></span><br><span class="line">$$  <span class="comment">#脚本运行的当前进程ID号</span></span><br><span class="line">$!  <span class="comment">#后台运行的最后一个进程的ID号</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运算符 放到 `` 符号中</span></span><br><span class="line">val=`expr 2 + 2`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 布尔运算符  ! 非 -o 或运算(or) -a 与运算(and)</span></span><br><span class="line"><span class="comment"># 逻辑运算符 &amp;&amp; || </span></span><br><span class="line"><span class="comment"># 字符串运算符</span></span><br><span class="line">=:   <span class="comment">#两个字符串是否相等</span></span><br><span class="line">!=:  <span class="comment">#两个字符串是否相等</span></span><br><span class="line">-z:  <span class="comment">#字符串长度是否为0，为0返回 true(zero) [ -z $a ]</span></span><br><span class="line">-n:  <span class="comment">#字符串长度是否为0，不为0返回 true(no zero) </span></span><br><span class="line">str: <span class="comment">#[ $a ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#文件测试运算符</span></span><br><span class="line">-b,-c,-d,-f,-g,-k,-p,-u,-r,-w,-x,-s,-e</span><br><span class="line"><span class="comment">#其中-c：是字符设备文件，-d目录，-f文件，-r只读，-w可写，-x可执行，-s文件大小是否&gt;0,不为空返回true，-e（exist）文件是否存在</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 屏幕读取变量</span></span><br><span class="line"><span class="built_in">read</span> name</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$name</span> It is a test"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span> <span class="comment"># 格式化输出</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#test 检查某个条件是否成立</span></span><br><span class="line"><span class="comment"># 流程控制</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> $[num1] -eq $[num2]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'两个数相等！'</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'两个数不相等！'</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> condition1</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    command1</span><br><span class="line"><span class="keyword">elif</span> condition2 </span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line">    command2</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    commandN</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> item1 item2 ... itemN</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    command1</span><br><span class="line">    command2</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">int=1</span><br><span class="line"><span class="keyword">while</span>(( <span class="variable">$int</span>&lt;=5 ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$int</span></span><br><span class="line">        <span class="built_in">let</span> <span class="string">"int++"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">until condition</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">command</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> var <span class="keyword">in</span></span><br><span class="line">	1)</span><br><span class="line">    command1</span><br><span class="line">    ;;</span><br><span class="line">	2）</span><br><span class="line">    command2</span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">break</span></span><br><span class="line"><span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数</span></span><br><span class="line">[<span class="keyword">function</span>] <span class="function"><span class="title">demoFun</span></span>()&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"demo"</span></span><br><span class="line">    <span class="built_in">return</span> (<span class="variable">$#</span>,$*); <span class="comment"># 返回所有参数个数和全部参数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#Shell 输入/输出重定向</span></span><br><span class="line"></span><br><span class="line">cat test.txt &gt; test1.txt</span><br><span class="line">cat test.txt &gt;&gt; test1.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果希望执行某个命令，但又不希望在屏幕上显示输出结果，那么可以将输出重定向到 /dev/null：</span></span><br><span class="line"><span class="built_in">command</span> &gt; /dev/null <span class="comment">#会起到"禁止输出"的效果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果希望屏蔽 stdout 和 stderr,0 是标准输入（STDIN）,1 是标准输出（STDOUT）,2 是标准错误输出（STDERR）</span></span><br><span class="line"><span class="built_in">command</span> &gt; /dev/null 2&gt;&amp;1  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件包含</span></span><br><span class="line">. ./test1.sh 或者</span><br><span class="line"><span class="built_in">source</span> ./test1.sh</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>vagrant usage</title>
    <url>/2016/11/10/vagrant/</url>
    <content><![CDATA[<h3 id="VirtualBox，-Vagrant"><a href="#VirtualBox，-Vagrant" class="headerlink" title="VirtualBox， Vagrant"></a>VirtualBox， Vagrant</h3><p>安装<a href="https://www.virtualbox.org/wiki/Downloads" target="_blank" rel="noopener">VirtualBox</a>, 安装<a href="https://www.vagrantup.com/downloads.html" target="_blank" rel="noopener">vagrant</a></p>
<h3 id="安装Box"><a href="#安装Box" class="headerlink" title="安装Box"></a>安装Box</h3><p>你可以把它想成是一个箱子，里面装了一些东西。在用 Vagrant 创建虚拟机的时候，需要用到 Box ，它里面会包装操作系统的镜像，不同的 Box 带的操作系统可能是不一样的，比如 CentOS，Ubuntu 等等，你可以基于它们去创建自己版本的 Box，比如在虚拟机上安装一些软件，然后把它重新打包成 Box。</p>
<p>在 <code>vagrant添加 Box</code> ，Vagrant 提供的云服务 ,要把 Box 下载到本地的电脑上，交给 Vagrant 去管理，这样在创建虚拟机的时候，Vagrant 会复制一份你指定的 Box 到你的项目里面，这样你在这个虚拟机上的操作，就不会影响到其它的项目。</p>
<a id="more"></a>
<blockquote>
<p><a href="http://www.vagrantbox.es/" target="_blank" rel="noopener">http://www.vagrantbox.es/</a><br><a href="https://atlas.hashicorp.com/boxes/search" target="_blank" rel="noopener">https://atlas.hashicorp.com/boxes/search</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vagrant box add &#123;title&#125; &#123;box&#125;    <span class="comment"># title 为起的名字，box为在线URL地址，或者离线box路径</span></span><br></pre></td></tr></table></figure>
<p>这里<strong>可以安装很多个box，以服务不同的项目环境</strong>，可以随时通过<code>vagrant box remove {title}</code>,所有的命令可以通过vagrant -h 查看。</p>
<h3 id="查看已安装的box"><a href="#查看已安装的box" class="headerlink" title="查看已安装的box"></a>查看已安装的box</h3><p><code>vagrant box list</code></p>
<h3 id="初始化项目环境"><a href="#初始化项目环境" class="headerlink" title="初始化项目环境"></a>初始化项目环境</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 到项目目录</span></span><br><span class="line"><span class="built_in">cd</span> project</span><br><span class="line"><span class="comment"># 查看已经装的box</span></span><br><span class="line">vagrant box list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化项目，之后回生成Vagrantfile文件，这个是ruby写的配置文件有一些参数设置</span></span><br><span class="line"></span><br><span class="line">`vagrant init &#123;title&#125;`  ，title：为`config.vm.box`重命名，title可略则默认的`config.vm.box=”base”`</span><br><span class="line"></span><br><span class="line"><span class="comment"># demo</span></span><br><span class="line">vagrant box add centos6 https://github.com/tommy-muehle/puppet-vagrant-boxes/releases/download/1.0.0/centos-6.6-x86_64.box</span><br></pre></td></tr></table></figure>
<h3 id="启动-并查看状态"><a href="#启动-并查看状态" class="headerlink" title="启动 并查看状态"></a>启动 并查看状态</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vagrant up</span><br><span class="line"></span><br><span class="line">vagrant status</span><br></pre></td></tr></table></figure>
<h3 id="控制虚拟机"><a href="#控制虚拟机" class="headerlink" title="控制虚拟机"></a>控制虚拟机</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mac</span></span><br><span class="line">vagrant ssh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># windows 用其他ssh链接工具</span></span><br><span class="line"></span><br><span class="line"> Host：127.0.0.1</span><br><span class="line"> Port：2200</span><br><span class="line"> Username：vagrant</span><br><span class="line"> password：vagrant</span><br></pre></td></tr></table></figure>
<h3 id="打包分发，生成box供其他人使用"><a href="#打包分发，生成box供其他人使用" class="headerlink" title="打包分发，生成box供其他人使用"></a>打包分发，生成box供其他人使用</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vagrant package</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 之后别人拿到box，相当于安装了一个box又 ，之后就直接初始化这个</span></span><br><span class="line">vagrant box add hahaha ~/box/package.box  <span class="comment"># 添加 package.box 镜像并命名为 hahaha</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ~/dev  <span class="comment"># 切换到项目目录,之后初始化</span></span><br><span class="line">vagrant init hahaha</span><br></pre></td></tr></table></figure>
<h3 id="集成预安装"><a href="#集成预安装" class="headerlink" title="集成预安装"></a>集成预安装</h3><p>你会发现每次都修改了一点点内容，再打包分发给其他用户其实很麻烦，为此 Vagrant 还提供了更为便捷的预安装定制。打开 Vagrantfile 文件末尾处有下面被注释的代码：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">config.vm.provision <span class="string">"shell"</span>, inline: &lt;&lt;-SHELL</span><br><span class="line">   apt-get update</span><br><span class="line">   apt-get install -y apache2</span><br><span class="line">SHELL</span><br></pre></td></tr></table></figure></p>
<p>如果你不是初次运行，同时又修改了这里的命令，想让系统再次运行这里面的命令，你可以使用 <code>vagrant reload --provision</code> 进行重载。所以在这种情况下，你只要将 Vagrantfile 共享给团队的其他成员就可以了，其他成员运行相同的命令即可。更多<a href="https://www.vagrantup.com/docs/provisioning/" target="_blank" rel="noopener">参考</a></p>
<p>你还可以把要运行的命令单独写在一个文件里存放在相同的目录下，比如 bootstrap.sh：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y apache2</span><br><span class="line"><span class="keyword">if</span> ! [ -L /var/www ]; <span class="keyword">then</span></span><br><span class="line">  rm -rf /var/www</span><br><span class="line">  ln -fs /vagrant /var/www</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<p>然后在 Vagrantfile 里这样添加：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Vagrant.configure(<span class="string">"2"</span>) <span class="keyword">do</span> |config|</span><br><span class="line">  config.vm.box = <span class="string">"hashicorp/precise64"</span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  config.vm.provision <span class="string">"shell"</span>, path: <span class="string">"bootstrap.sh"</span>  <span class="comment"># 添加这行</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.vagrantup.com/docs/cli/index.html" target="_blank" rel="noopener">更多参考</a></p>
<h3 id="yii2-的vagrant-的-DEMO-配置"><a href="#yii2-的vagrant-的-DEMO-配置" class="headerlink" title="yii2 的vagrant 的 DEMO  配置"></a>yii2 的vagrant 的 DEMO  配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vagrant box add ubuntu/trusty64</span><br><span class="line"><span class="comment"># 如果已经有了vagrantfile文件就不用 vargrant init 了</span></span><br><span class="line"></span><br><span class="line">vagrant up</span><br></pre></td></tr></table></figure>
<p>Vagrantfile 配置文件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">require &apos;yaml&apos;</span><br><span class="line">require &apos;fileutils&apos;</span><br><span class="line"></span><br><span class="line">domains = &#123;</span><br><span class="line">  frontend: &apos;y2aa-frontend.dev&apos;,</span><br><span class="line">  backend:  &apos;y2aa-backend.dev&apos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config = &#123;</span><br><span class="line">  local: &apos;./vagrant/config/vagrant-local.yml&apos;,</span><br><span class="line">  example: &apos;./vagrant/config/vagrant-local.example.yml&apos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># copy config from example if local config not exists</span><br><span class="line">FileUtils.cp config[:example], config[:local] unless File.exist?(config[:local])</span><br><span class="line"># read config</span><br><span class="line">options = YAML.load_file config[:local]</span><br><span class="line"></span><br><span class="line"># check github token</span><br><span class="line">if options[&apos;github_token&apos;].nil? || options[&apos;github_token&apos;].to_s.length != 40</span><br><span class="line">  puts &quot;You must place REAL GitHub token into configuration:\n/yii2-app-advancded/vagrant/config/vagrant-local.yml&quot;</span><br><span class="line">  exit</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># vagrant configurate</span><br><span class="line">Vagrant.configure(2) do |config|</span><br><span class="line">  # select the box</span><br><span class="line">  config.vm.box = &apos;ubuntu/trusty64&apos;</span><br><span class="line"></span><br><span class="line">  # should we ask about box updates?</span><br><span class="line">  config.vm.box_check_update = options[&apos;box_check_update&apos;]</span><br><span class="line"></span><br><span class="line">  config.vm.provider &apos;virtualbox&apos; do |vb|</span><br><span class="line">    # machine cpus count</span><br><span class="line">    vb.cpus = options[&apos;cpus&apos;]</span><br><span class="line">    # machine memory size</span><br><span class="line">    vb.memory = options[&apos;memory&apos;]</span><br><span class="line">    # machine name (for VirtualBox UI)</span><br><span class="line">    vb.name = options[&apos;machine_name&apos;]</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  # machine name (for vagrant console)</span><br><span class="line">  config.vm.define options[&apos;machine_name&apos;]</span><br><span class="line"></span><br><span class="line">  # machine name (for guest machine console)</span><br><span class="line">  config.vm.hostname = options[&apos;machine_name&apos;]</span><br><span class="line"></span><br><span class="line">  # network settings</span><br><span class="line">  config.vm.network &apos;private_network&apos;, ip: options[&apos;ip&apos;]</span><br><span class="line"></span><br><span class="line">  # sync: folder &apos;yii2-app-advanced&apos; (host machine) -&gt; folder &apos;/app&apos; (guest machine)</span><br><span class="line">  config.vm.synced_folder &apos;./&apos;, &apos;/app&apos;, owner: &apos;vagrant&apos;, group: &apos;vagrant&apos;</span><br><span class="line"></span><br><span class="line">  # disable folder &apos;/vagrant&apos; (guest machine)</span><br><span class="line">  config.vm.synced_folder &apos;.&apos;, &apos;/vagrant&apos;, disabled: true</span><br><span class="line"></span><br><span class="line">  # hosts settings (host machine)</span><br><span class="line">  config.vm.provision :hostmanager</span><br><span class="line">  config.hostmanager.enabled            = true</span><br><span class="line">  config.hostmanager.manage_host        = true</span><br><span class="line">  config.hostmanager.ignore_private_ip  = false</span><br><span class="line">  config.hostmanager.include_offline    = true</span><br><span class="line">  config.hostmanager.aliases            = domains.values</span><br><span class="line"></span><br><span class="line">  # provisioners</span><br><span class="line">  config.vm.provision &apos;shell&apos;, path: &apos;./vagrant/provision/once-as-root.sh&apos;, args: [options[&apos;timezone&apos;]]</span><br><span class="line">  config.vm.provision &apos;shell&apos;, path: &apos;./vagrant/provision/once-as-vagrant.sh&apos;, args: [options[&apos;github_token&apos;]], privileged: false</span><br><span class="line">  config.vm.provision &apos;shell&apos;, path: &apos;./vagrant/provision/always-as-root.sh&apos;, run: &apos;always&apos;</span><br><span class="line"></span><br><span class="line">  # post-install message (vagrant console)</span><br><span class="line">  config.vm.post_up_message = &quot;Frontend URL: http://#&#123;domains[:frontend]&#125;\nBackend URL: http://#&#123;domains[:backend]&#125;&quot;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">#!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line">#== Import script args ==</span><br><span class="line"></span><br><span class="line">github_token=$(echo &quot;$1&quot;)</span><br><span class="line"></span><br><span class="line">#== Bash helpers ==</span><br><span class="line"></span><br><span class="line">function info &#123;</span><br><span class="line">  echo &quot; &quot;</span><br><span class="line">  echo &quot;--&gt; $1&quot;</span><br><span class="line">  echo &quot; &quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#== Provision script ==</span><br><span class="line"></span><br><span class="line">info &quot;Provision-script user: `whoami`&quot;</span><br><span class="line"></span><br><span class="line">info &quot;Configure composer&quot;</span><br><span class="line">composer config --global github-oauth.github.com $&#123;github_token&#125;</span><br><span class="line">echo &quot;Done!&quot;</span><br><span class="line"></span><br><span class="line">info &quot;Install plugins for composer&quot;</span><br><span class="line">composer global require &quot;fxp/composer-asset-plugin:~1.1.1&quot; --no-progress</span><br><span class="line"></span><br><span class="line">info &quot;Install codeception&quot;</span><br><span class="line">composer global require &quot;codeception/codeception=2.0.*&quot; &quot;codeception/specify=*&quot; &quot;codeception/verify=*&quot; --no-progress</span><br><span class="line">echo &apos;export PATH=/home/vagrant/.config/composer/vendor/bin:$PATH&apos; | tee -a /home/vagrant/.profile</span><br><span class="line"></span><br><span class="line">info &quot;Install project dependencies&quot;</span><br><span class="line">cd /app</span><br><span class="line">composer --no-progress --prefer-dist install</span><br><span class="line"></span><br><span class="line">info &quot;Init project&quot;</span><br><span class="line">./init --env=Development --overwrite=y</span><br><span class="line"></span><br><span class="line">info &quot;Apply migrations&quot;</span><br><span class="line">./yii migrate &lt;&lt;&lt; &quot;yes&quot;</span><br><span class="line"></span><br><span class="line">info &quot;Create bash-alias &apos;app&apos; for vagrant user&quot;</span><br><span class="line">echo &apos;alias app=&quot;cd /app&quot;&apos; | tee /home/vagrant/.bash_aliases</span><br><span class="line"></span><br><span class="line">info &quot;Enabling colorized prompt for guest console&quot;</span><br><span class="line">sed -i &quot;s/#force_color_prompt=yes/force_color_prompt=yes/&quot; /home/vagrant/.bashrc</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">	#!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line">#== Import script args ==</span><br><span class="line"></span><br><span class="line">timezone=$(echo &quot;$1&quot;)</span><br><span class="line"></span><br><span class="line">#== Bash helpers ==</span><br><span class="line"></span><br><span class="line">function info &#123;</span><br><span class="line">  echo &quot; &quot;</span><br><span class="line">  echo &quot;--&gt; $1&quot;</span><br><span class="line">  echo &quot; &quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#== Provision script ==</span><br><span class="line"></span><br><span class="line">info &quot;Provision-script user: `whoami`&quot;</span><br><span class="line"></span><br><span class="line">info &quot;Allocate swap for MySQL 5.6&quot;</span><br><span class="line">fallocate -l 2048M /swapfile</span><br><span class="line">chmod 600 /swapfile</span><br><span class="line">mkswap /swapfile</span><br><span class="line">swapon /swapfile</span><br><span class="line">echo &apos;/swapfile none swap defaults 0 0&apos; &gt;&gt; /etc/fstab</span><br><span class="line"></span><br><span class="line">info &quot;Configure locales&quot;</span><br><span class="line">update-locale LC_ALL=&quot;C&quot;</span><br><span class="line">dpkg-reconfigure locales</span><br><span class="line"></span><br><span class="line">info &quot;Configure timezone&quot;</span><br><span class="line">echo $&#123;timezone&#125; | tee /etc/timezone</span><br><span class="line">dpkg-reconfigure --frontend noninteractive tzdata</span><br><span class="line"></span><br><span class="line">info &quot;Prepare root password for MySQL&quot;</span><br><span class="line">debconf-set-selections &lt;&lt;&lt; &quot;mysql-server-5.6 mysql-server/root_password password \&quot;&apos;&apos;\&quot;&quot;</span><br><span class="line">debconf-set-selections &lt;&lt;&lt; &quot;mysql-server-5.6 mysql-server/root_password_again password \&quot;&apos;&apos;\&quot;&quot;</span><br><span class="line">echo &quot;Done!&quot;</span><br><span class="line"></span><br><span class="line">info &quot;Update OS software&quot;</span><br><span class="line">apt-get update</span><br><span class="line">apt-get upgrade -y</span><br><span class="line"></span><br><span class="line">info &quot;Install additional software&quot;</span><br><span class="line">apt-get install -y git php5-curl php5-cli php5-intl php5-mysqlnd php5-gd php5-fpm nginx mysql-server-5.6</span><br><span class="line"></span><br><span class="line">info &quot;Configure MySQL&quot;</span><br><span class="line">sed -i &quot;s/.*bind-address.*/bind-address = 0.0.0.0/&quot; /etc/mysql/my.cnf</span><br><span class="line">echo &quot;Done!&quot;</span><br><span class="line"></span><br><span class="line">info &quot;Configure PHP-FPM&quot;</span><br><span class="line">sed -i &apos;s/user = www-data/user = vagrant/g&apos; /etc/php5/fpm/pool.d/www.conf</span><br><span class="line">sed -i &apos;s/group = www-data/group = vagrant/g&apos; /etc/php5/fpm/pool.d/www.conf</span><br><span class="line">sed -i &apos;s/owner = www-data/owner = vagrant/g&apos; /etc/php5/fpm/pool.d/www.conf</span><br><span class="line">echo &quot;Done!&quot;</span><br><span class="line"></span><br><span class="line">info &quot;Configure NGINX&quot;</span><br><span class="line">sed -i &apos;s/user www-data/user vagrant/g&apos; /etc/nginx/nginx.conf</span><br><span class="line">echo &quot;Done!&quot;</span><br><span class="line"></span><br><span class="line">info &quot;Enabling site configuration&quot;</span><br><span class="line">ln -s /app/vagrant/nginx/app.conf /etc/nginx/sites-enabled/app.conf</span><br><span class="line">echo &quot;Done!&quot;</span><br><span class="line"></span><br><span class="line">info &quot;Initailize databases for MySQL&quot;</span><br><span class="line">mysql -uroot &lt;&lt;&lt; &quot;CREATE DATABASE yii2advanced&quot;</span><br><span class="line">mysql -uroot &lt;&lt;&lt; &quot;CREATE DATABASE yii2_advanced_tests&quot;</span><br><span class="line">echo &quot;Done!&quot;</span><br><span class="line"></span><br><span class="line">info &quot;Install composer&quot;</span><br><span class="line">curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer</span><br></pre></td></tr></table></figure>
<p><a href="http://www.yiichina.com/tutorial/979" target="_blank" rel="noopener">示例参考</a><br><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-installation.md" target="_blank" rel="noopener">示例参考</a></p>
]]></content>
  </entry>
  <entry>
    <title>怎么快速恢复数据？</title>
    <url>/2016/11/23/restore-db/</url>
    <content><![CDATA[<h3 id="高可用数据库架构"><a href="#高可用数据库架构" class="headerlink" title="高可用数据库架构"></a>高可用数据库架构</h3><p>一般来说数据库集群会是主从架构：<br><img src="/images/restore-db/master-slave.png" alt><br>或者主主架构：<br><img src="/images/restore-db/master-master.png" alt><br><a id="more"></a><br>如果此时主库宕机，可以：</p>
<blockquote>
<ol>
<li>一个从库顶上，重建集群</li>
<li>流量迁移到另一个主库</li>
</ol>
</blockquote>
<p>来保证数据的安全性与服务的可用性。</p>
<p>但是，如果人为不小心执行了“删全库”操作，命令会同步给其他从（主）库，导致所有库上的数据全部丢失，这下怎么办呢？<br>可以问问自己，当这种情况发生的时候：</p>
<blockquote>
<ol>
<li>能不能恢复数据？（应该没有公司不能）</li>
<li>多久能够恢复数据？<br>保证数据的安全性是DBA第一要务。</li>
</ol>
</blockquote>
<h3 id="全量备份-增量备份"><a href="#全量备份-增量备份" class="headerlink" title="全量备份+增量备份"></a>全量备份+增量备份</h3><p>常见的数据库安全性策略是：全量备份+增量备份。</p>
<p>全量备份：定期（例如一个月）将库文件全量备份<br> <img src="/images/restore-db/all_bak.png" alt></p>
<p>增量备份：定期（例如每天）将binlog增量备份<br> <img src="/images/restore-db/inc_bak.png" alt><br>如果不小心误删了全库，可以这么恢复：<br>（1）将最近一次全量备份的全库找到，拷贝回来（文件一般比较大），解压，应用<br>（2）将最近一次全量备份后，每一天的增量binlog找到，拷贝回来（文件较多），依次重放<br>（3）将最近一次增量备份后，到执行“删全库”之前的binlog找到，重放<br>恢复完毕。<br>为了保证方案的可靠性，建议定期进行恢复演练。</p>
<p>方案优点：能够找回数据<br>方案缺点：恢复时间非常长<br>有没有更优，更快恢复的方案呢？</p>
<h3 id="1小时延时从"><a href="#1小时延时从" class="headerlink" title="1小时延时从"></a>1小时延时从</h3><p>使用1小时延时从库，可大大加速“删全库”恢复时间。</p>
<p>什么是1小时延时从？<br>增加一个从库，这个从库不是实时与主库保持同步的，而是每隔1个小时同步一次主库，同步完之后立马断开1小时，这个从库会与主库保持1个小时的数据差距。<br>当“删全库”事故发生时，只需要：<br>（1）应用1小时延时从<br>（2）将1小时延时从最近一次同步时间到，将执行“删全库”之前的binlog找到，重放<br>快速恢复完毕。</p>
<p>方案优点：能够快速找回数据<br>潜在不足：万一，万一，万一，1小时延时从正在连上主库进行同步的一小段时间内，发生了“删全库”事故，那怎么办咧？</p>
<h3 id="双份1小时延时从"><a href="#双份1小时延时从" class="headerlink" title="双份1小时延时从"></a>双份1小时延时从</h3><p>使用双份1小时延时从库，可以避免上述“万一，万一，万一”的事故发生。</p>
<p>什么是双份1小时延时从？<br>如图所示，两个1小时延时从，他们连主库同步数据的时间“岔开半小时”。<br>这样，即使一个延时从连上主库进行同步的一小段时间内，发生了“删全库”事故，依然有另一个延时从保有半小时之前的数据，可以实施快速恢复。</p>
<p><img src="/images/restore-db/delay_bak.png" alt></p>
<p>方案<strong>优点</strong>：没有万一，都能快速恢复数据<br>潜在<strong>不足</strong>：资源利用率有点低，为了保证数据的安全性，多了2台延时从，降低了从库利用率</p>
<h3 id="提高从库效率"><a href="#提高从库效率" class="headerlink" title="提高从库效率"></a>提高从库效率</h3><p>1小时延时从也不是完全没有用，对于一些“允许延时”的业务，可以使用1小时延时从，例如：<br>（1）运营后台，产品后台<br>（2）BI进行数据同步<br>（3）研发进行数据抽样，调研<br>但需要注意的是，毕竟这是从库，只能够提供“只读”服务哟。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>保证数据的安全性是DBA第一要务，需要进行：<br>（1）全量备份+增量备份，并定期进行恢复演练，但该方案恢复时间较久，对系统可用性影响大<br>（2）1小时延时从，双份1小时延时从能极大加速数据库恢复时间<br>（3）个人建议1小时延时从足够，后台只读服务可以连1小时延时从，提高资源利用率</p>
]]></content>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>YAML 语言教程</title>
    <url>/2016/11/23/yaml/</url>
    <content><![CDATA[<p>配置文件是软件不可缺少的部分，怎么写配置也是一门学问。</p>
<p>YAML 语言专门用来写配置文件，非常简洁和强大，远比 JSON 格式方便和灵活。</p>
<p><img src="http://www.ruanyifeng.com/blogimg/asset/2016/bg2016070401.gif" alt></p>
<p>本文介绍 YAML 的语法，以 <a href="https://github.com/nodeca/js-yaml" target="_blank" rel="noopener">JS-YAML</a> 实现为例。它有一个<a href="http://nodeca.github.io/js-yaml/" target="_blank" rel="noopener">在线 Demo</a>，你可以去那里验证下面的例子。<br><a id="more"></a></p>
<h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>YAML 语言（发音 /ˈjæməl/ ）的设计目标，就是方便人类读写。它实质上是一种通用的数据串行化格式。</p>
<p>它的基本语法规则如下。</p>
<blockquote>
<ul>
<li>大小写敏感</li>
<li>使用缩进表示层级关系</li>
<li>缩进时不允许使用Tab键，只允许使用空格。</li>
<li>缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</li>
</ul>
</blockquote>
<p><code>#</code> 表示注释，从这个字符一直到行尾，都会被解析器忽略。</p>
<p>YAML 支持的数据结构有三种。</p>
<blockquote>
<ul>
<li>对象：键值对的集合，又称为映射（mapping）/ 哈希（hashes） / 字典（dictionary）</li>
<li>数组：一组值，又称为序列（sequence） / 列表（list）</li>
<li>纯量（scalars）：单个的、不可再分的值</li>
</ul>
</blockquote>
<p>以下分别介绍这三种数据结构。</p>
<h2 id="二、对象"><a href="#二、对象" class="headerlink" title="二、对象"></a>二、对象</h2><p>对象的一组键值对，使用冒号结构表示。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">animal:</span> <span class="string">pets</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">animal</span>: <span class="string">'pets'</span> &#125;</span><br></pre></td></tr></table></figure>
<p>Yaml 也允许另一种写法，将所有键值对写成一个行内对象。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">hash:</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">Steve,</span> <span class="attr">foo:</span> <span class="string">bar</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">hash</span>: &#123; <span class="attr">name</span>: <span class="string">'Steve'</span>, <span class="attr">foo</span>: <span class="string">'bar'</span> &#125; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="三、数组"><a href="#三、数组" class="headerlink" title="三、数组"></a>三、数组</h2><p>一组连词线开头的行，构成一个数组。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">Cat</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Dog</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Goldfish</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[ <span class="string">'Cat'</span>, <span class="string">'Dog'</span>, <span class="string">'Goldfish'</span> ]</span><br></pre></td></tr></table></figure>
<p>数据结构的子成员是一个数组，则可以在该项下面缩进一个空格。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">Cat</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">Dog</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">Goldfish</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[ [ <span class="string">'Cat'</span>, <span class="string">'Dog'</span>, <span class="string">'Goldfish'</span> ] ]</span><br></pre></td></tr></table></figure>
<p>数组也可以采用行内表示法。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">animal:</span> <span class="string">[Cat,</span> <span class="string">Dog]</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">animal</span>: [ <span class="string">'Cat'</span>, <span class="string">'Dog'</span> ] &#125;</span><br></pre></td></tr></table></figure>
<h2 id="四、复合结构"><a href="#四、复合结构" class="headerlink" title="四、复合结构"></a>四、复合结构</h2><p>对象和数组可以结合使用，形成复合结构。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">languages:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">Ruby</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">Perl</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">Python</span> </span><br><span class="line"><span class="attr">websites:</span></span><br><span class="line"> <span class="attr">YAML:</span> <span class="string">yaml.org</span> </span><br><span class="line"> <span class="attr">Ruby:</span> <span class="string">ruby-lang.org</span> </span><br><span class="line"> <span class="attr">Python:</span> <span class="string">python.org</span> </span><br><span class="line"> <span class="attr">Perl:</span> <span class="string">use.perl.org</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">languages</span>: [ <span class="string">'Ruby'</span>, <span class="string">'Perl'</span>, <span class="string">'Python'</span> ],</span><br><span class="line">  websites: </span><br><span class="line">   &#123; <span class="attr">YAML</span>: <span class="string">'yaml.org'</span>,</span><br><span class="line">     Ruby: <span class="string">'ruby-lang.org'</span>,</span><br><span class="line">     Python: <span class="string">'python.org'</span>,</span><br><span class="line">     Perl: <span class="string">'use.perl.org'</span> &#125; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="五、纯量"><a href="#五、纯量" class="headerlink" title="五、纯量"></a>五、纯量</h2><p>纯量是最基本的、不可再分的值。以下数据类型都属于 JavaScript 的纯量。</p>
<blockquote>
<ul>
<li>字符串</li>
<li>布尔值</li>
<li>整数</li>
<li>浮点数</li>
<li>Null</li>
<li>时间</li>
<li>日期</li>
</ul>
</blockquote>
<p>数值直接以字面量的形式表示。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">number:</span> <span class="number">12.30</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">number</span>: <span class="number">12.30</span> &#125;</span><br></pre></td></tr></table></figure>
<p>布尔值用<code>true</code>和<code>false</code>表示。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">isSet:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">isSet</span>: <span class="literal">true</span> &#125;</span><br></pre></td></tr></table></figure>
<p><code>null</code>用<code>~</code>表示。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">parent:</span> <span class="string">~</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">parent</span>: <span class="literal">null</span> &#125;</span><br></pre></td></tr></table></figure>
<p>时间采用 ISO8601 格式。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">iso8601:</span> <span class="number">2001</span><span class="number">-12</span><span class="string">-14t21:59:43.10-05:00</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">iso8601</span>: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'2001-12-14t21:59:43.10-05:00'</span>) &#125;</span><br></pre></td></tr></table></figure>
<p>日期采用复合 iso8601 格式的年、月、日表示。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">date:</span> <span class="number">1976</span><span class="number">-07</span><span class="number">-31</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">date</span>: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'1976-07-31'</span>) &#125;</span><br></pre></td></tr></table></figure>
<p>YAML 允许使用两个感叹号，强制转换数据类型。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">e:</span> <span class="type">!!str</span> <span class="number">123</span></span><br><span class="line"><span class="attr">f:</span> <span class="type">!!str</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">e</span>: <span class="string">'123'</span>, <span class="attr">f</span>: <span class="string">'true'</span> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="六、字符串"><a href="#六、字符串" class="headerlink" title="六、字符串"></a>六、字符串</h2><p>字符串是最常见，也是最复杂的一种数据类型。</p>
<p>字符串默认不使用引号表示。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">str:</span> <span class="string">这是一行字符串</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">str</span>: <span class="string">'这是一行字符串'</span> &#125;</span><br></pre></td></tr></table></figure>
<p>如果字符串之中包含空格或特殊字符，需要放在引号之中。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">str:</span> <span class="string">'内容： 字符串'</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">str: <span class="string">'内容: 字符串'</span></span><br></pre></td></tr></table></figure>
<p>单引号和双引号都可以使用，双引号不会对特殊字符转义。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">s1:</span> <span class="string">'内容\n字符串'</span></span><br><span class="line"><span class="attr">s2:</span> <span class="string">"内容\n字符串"</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">s1</span>: <span class="string">'内容\\n字符串'</span>, <span class="attr">s2</span>: <span class="string">'内容\n字符串'</span> &#125;</span><br></pre></td></tr></table></figure>
<p>单引号之中如果还有单引号，必须连续使用两个单引号转义。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">str: <span class="string">'labor'</span><span class="string">'s day'</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">str</span>: <span class="string">'labor\'s day'</span> &#125;</span><br></pre></td></tr></table></figure>
<p>字符串可以写成多行，从第二行开始，必须有一个单空格缩进。换行符会被转为空格。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">str:</span> <span class="string">这是一段</span></span><br><span class="line">  <span class="string">多行</span></span><br><span class="line">  <span class="string">字符串</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">str</span>: <span class="string">'这是一段 多行 字符串'</span> &#125;</span><br></pre></td></tr></table></figure>
<p>多行字符串可以使用<code>|</code>保留换行符，也可以使用<code>&gt;</code>折叠换行。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>: |</span><br><span class="line">  Foo</span><br><span class="line">  Bar</span><br><span class="line">that: &gt;</span><br><span class="line">  Foo</span><br><span class="line">  Bar</span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 代码如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">this</span>: <span class="string">'Foo\nBar\n'</span>, <span class="attr">that</span>: <span class="string">'Foo Bar\n'</span> &#125;</span><br></pre></td></tr></table></figure>
<p><code>+</code>表示保留文字块末尾的换行，<code>-</code>表示删除字符串末尾的换行。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">s1:</span> <span class="string">|</span></span><br><span class="line">  <span class="string">Foo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">s2:</span> <span class="string">|+</span></span><br><span class="line">  <span class="string">Foo</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">s3:</span> <span class="string">|-</span></span><br><span class="line">  <span class="string">Foo</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 代码如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">s1</span>: <span class="string">'Foo\n'</span>, <span class="attr">s2</span>: <span class="string">'Foo\n\n\n'</span>, <span class="attr">s3</span>: <span class="string">'Foo'</span> &#125;</span><br></pre></td></tr></table></figure>
<p>字符串之中可以插入 HTML 标记。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">message:</span> <span class="string">|</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&lt;p</span> <span class="string">style="color:</span> <span class="string">red"&gt;</span></span><br><span class="line">          <span class="string">段落</span></span><br><span class="line">        <span class="string">&lt;/p&gt;</span></span><br></pre></td></tr></table></figure>
<p>转为 JavaScript 如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123; <span class="attr">message</span>: <span class="string">'\n&lt;p style="color: red"&gt;\n  段落\n&lt;/p&gt;\n'</span> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="七、引用"><a href="#七、引用" class="headerlink" title="七、引用"></a>七、引用</h2><p>锚点<code>&amp;</code>和别名<code>*</code>，可以用来引用。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">defaults:</span> <span class="meta">&amp;defaults</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">development:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_development</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_test</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br></pre></td></tr></table></figure>
<p>等同于下面的代码。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">defaults:</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">development:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_development</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_test</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br></pre></td></tr></table></figure>
<p><code>&amp;</code>用来建立锚点（<code>defaults</code>），<code>&lt;&lt;</code>表示合并到当前数据，<code>*</code>用来引用锚点。类似于下面结构。</p>
<p>下面是另一个例子。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">&amp;showell</span> <span class="string">Steve</span> </span><br><span class="line"><span class="bullet">-</span> <span class="string">Clark</span> </span><br><span class="line"><span class="bullet">-</span> <span class="string">Brian</span> </span><br><span class="line"><span class="bullet">-</span> <span class="string">Oren</span> </span><br><span class="line"><span class="bullet">-</span> <span class="string">*showell</span> </span><br><span class="line"><span class="string">```</span> </span><br><span class="line"></span><br><span class="line"><span class="string">转为</span> <span class="string">JavaScript</span> <span class="string">代码如下。</span></span><br><span class="line"></span><br><span class="line"><span class="string">```javascript</span></span><br><span class="line"><span class="string">[</span> <span class="string">'Steve'</span><span class="string">,</span> <span class="string">'Clark'</span><span class="string">,</span> <span class="string">'Brian'</span><span class="string">,</span> <span class="string">'Oren'</span><span class="string">,</span> <span class="string">'Steve'</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<h2 id="八、转换函数和正则表达式"><a href="#八、转换函数和正则表达式" class="headerlink" title="八、转换函数和正则表达式"></a>八、转换函数和正则表达式</h2><p>这是 <a href="https://github.com/nodeca/js-yaml" target="_blank" rel="noopener">JS-YAML</a> 库特有的功能，可以把函数和正则表达式转为字符串。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># example.yml</span></span><br><span class="line"><span class="attr">fn:</span> <span class="string">function</span> <span class="string">()</span> <span class="string">&#123;</span> <span class="string">return</span> <span class="number">1</span> <span class="string">&#125;</span></span><br><span class="line"><span class="attr">reg:</span> <span class="string">/test/</span></span><br></pre></td></tr></table></figure>
<p>解析上面的 yml 文件的代码如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> yaml = <span class="built_in">require</span>(<span class="string">'js-yaml'</span>);</span><br><span class="line"><span class="keyword">var</span> fs   = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> doc = yaml.load(</span><br><span class="line">    fs.readFileSync(<span class="string">'./example.yml'</span>, <span class="string">'utf8'</span>)</span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从 JavaScript 对象还原到 yaml 文件的代码如下。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> yaml = <span class="built_in">require</span>(<span class="string">'js-yaml'</span>);</span><br><span class="line"><span class="keyword">var</span> fs   = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  fn: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="number">1</span> &#125;,</span><br><span class="line">  reg: <span class="regexp">/test/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  fs.writeFileSync(</span><br><span class="line">    <span class="string">'./example.yml'</span>,</span><br><span class="line">    yaml.dump(obj),</span><br><span class="line">    <span class="string">'utf8'</span></span><br><span class="line">  );</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="九、参考链接"><a href="#九、参考链接" class="headerlink" title="九、参考链接"></a>九、参考链接</h2><ul>
<li><a href="http://www.yaml.org/spec/1.2/spec.html" target="_blank" rel="noopener">YAML 1.2 规格</a></li>
<li><a href="https://en.wikipedia.org/wiki/YAML" target="_blank" rel="noopener">YAML from Wikipedia</a></li>
<li><a href="http://yaml.org/YAML_for_ruby.html" target="_blank" rel="noopener">YAML for Ruby</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>running</title>
    <url>/2016/06/20/running/</url>
    <content><![CDATA[<h1 id="几个跑步的TIPS"><a href="#几个跑步的TIPS" class="headerlink" title="几个跑步的TIPS"></a>几个跑步的TIPS</h1><h2 id="制定计划"><a href="#制定计划" class="headerlink" title="制定计划"></a>制定计划</h2><p>为了让你的身体更加习惯处于一种对运动需求的状态，你需要有计划的跑步。我们应该严格遵守每周至少3次或4次的跑步计划表，而不是等有时间或天气好的时候，随性的跑一下。跑步能强化你的下肢和核心肌肉，只要坚持下去你会发现越跑越轻松，同时，跑步能锻炼你的耐力。从短距离开始你的跑步计划，等感觉比较轻松时，再慢慢地在每周的锻炼中增加距离。<br><a id="more"></a></p>
<h2 id="放慢速度"><a href="#放慢速度" class="headerlink" title="放慢速度"></a>放慢速度</h2><p>没必要一开始就规定自己5分钟内要跑完一千米。放慢你的速度，让呼吸比走路时快上一点，而不是那种大口喘气到肺部都开始疼痛或上气不接下气。不要变速跑，即使这对腹部脂肪有很好的锻炼效果，但舒适的、连贯的步伐比快跑更加容易坚持。放慢速度可以让你将注意力集中到正确的跑步姿势上，这能减缓一些跑步带来的酸痛感，你也有空闲看看风景或与伙伴聊聊天，这些都会让你爱上户外跑步。当你的身体渐渐变得强壮，你的步伐也会自然增加，你也可以挑战一下变速跑。</p>
<h2 id="寻找乐趣"><a href="#寻找乐趣" class="headerlink" title="寻找乐趣"></a>寻找乐趣</h2><p>如果你讨厌跑步的每分每秒，那么也许你有什么地方做错了。可以带上你的狗或约上最好的朋友，开发一条新的线路，听听你最喜欢的音乐或电台，买一身新的装备，用app记录你的足迹，又或者在游泳池边跑步，跑完后就能马上跳下去降温。</p>
<h2 id="爬山和下蹲"><a href="#爬山和下蹲" class="headerlink" title="爬山和下蹲"></a>爬山和下蹲</h2><p>强健的腿部肌肉能使跑步变得更轻而易举。一种方法是将爬山增加到你的跑步运动中，以加强腿部锻炼。跑上坡路会让你感到出奇的困难，但当你跑的顶端转向平路时，你会惊讶的觉得跑步是多么轻松的一件事。另外，你也可以在家里通过下蹲、弓步、蹬台阶或试试这个针对跑步者的瑜伽组合动作来锻炼你的下肢肌肉。</p>
<h2 id="别只是跑步"><a href="#别只是跑步" class="headerlink" title="别只是跑步"></a>别只是跑步</h2><p>按计划跑步能有效锻炼你的身体，让跑步变得更加轻松，但是如果跑步是你唯一的运动方式，厌烦和机械性劳损会使你感到难以忍受。在跑步的同时，增加一些有氧的常规锻炼，如骑车、徒步、舞蹈或游泳。做不同的有氧运动能使你身体的其他部位得到锻炼，所以每当你穿上运动鞋准备出门跑步时，会感到更加轻松。暂停跑步进行其他运动的最大好处在于，你真的会想念它，当你兴奋的出门跑步时，你会体会到更多的快乐。</p>
<h2 id="找准跑步最佳时间"><a href="#找准跑步最佳时间" class="headerlink" title="找准跑步最佳时间"></a>找准跑步最佳时间</h2><p>在适合自己的时间跑步最好。喜欢早晨跑步的人可以在去公司上班前，而偏爱夜晚跑步的人则可以在回家之后。 比选择什么时候跑步更重要的问题是：既不要在空腹时也不要在满腹(吃饱饭)的时候跑步。空腹的话会使不上力气，满腹则会由于血液的消化管集中，剧烈运动会对健康不利。最佳时间是在饭后2到3小时。 在清晨等空腹状态跑步时，最好提前30分钟左右饮用一些帮助消化和补充体力的运动型饮料或者可以吃根香蕉。</p>
<h2 id="要先做拉伸运动"><a href="#要先做拉伸运动" class="headerlink" title="要先做拉伸运动"></a>要先做拉伸运动</h2><p>你减肥心切，所以穿上跑步鞋就直接开跑？这可不是最好的跑步瘦身方法。要知道，你体内的能源分为快速能源和储备能源两种。只有当快速能源消耗得差不多的时候，你体内的储备能源”脂肪”才会开始燃烧。就是说，如果体能不太好，伸直有可能你已经跑累了，脂肪还没开始消耗。所以，想要有效地跑步瘦身，应该在跑步前先做些拉伸运动或放松运动，一方面可以热身、防止受伤，另一方面可以先消耗一部分糖原，这样接下来再跑步，脂肪的燃烧效率能大大提高。</p>
<h2 id="不要天天跑"><a href="#不要天天跑" class="headerlink" title="不要天天跑"></a>不要天天跑</h2><p>虽然慢跑有益于保持健康和瘦身，但专家并不建议天天跑，最好隔一天跑一次。至于中间不跑步的那天，可以做做拉伸运动，增加全身的柔韧性，这样很重要，是保证全身新陈代谢顺畅的关键，尤其能防止脂肪和水液在四肢堆积。</p>
<hr>
<h1 id="正确的跑步姿势"><a href="#正确的跑步姿势" class="headerlink" title="正确的跑步姿势"></a>正确的跑步姿势</h1><h2 id="挺直腰板，保持上身一条线"><a href="#挺直腰板，保持上身一条线" class="headerlink" title="挺直腰板，保持上身一条线"></a>挺直腰板，保持上身一条线</h2><p>跑步过程中， 需要伸直你的躯干，让后背舒服地挺起来，在跑步过程中总保持”跑步身高”。头部、脖子和背部保持一条直线， 双眼平视前方，不要低头，也不要来回扫视，这决定了你跑步的效率。有的爱好者特别是青少年，在跑步时喜欢身体左右摇晃，觉得这样跑起来”带劲”，其实这样不仅会增加不必要的体力消耗，而且还会破坏跑步的直线性；还有一些健身房为吸引顾客，在跑步机前安装电视让健身者观看，俗话说”一心不能二用”，这样会让健身者抬头仰视，而且降低安全性。</p>
<h2 id="肩膀、手臂要放松"><a href="#肩膀、手臂要放松" class="headerlink" title="肩膀、手臂要放松"></a>肩膀、手臂要放松</h2><p>保持上半身姿势， 肩膀是关键。虽然说跑步是下半身的运动，但手臂的动作也不是可有可无的，手臂的来回摆动能给你前进的动力。最佳的姿势是双肩放松、自然下垂， 跑步时肩膀也要保持水平，胳膊自然微屈，双手半握拳，手臂应随步伐尽量前后摆动。跑累时，也注意不要耸肩， 可以晃晃肩膀，放松一下。</p>
<h2 id="臀部要紧张，抬腿要适度"><a href="#臀部要紧张，抬腿要适度" class="headerlink" title="臀部要紧张，抬腿要适度"></a>臀部要紧张，抬腿要适度</h2><p>臀部是身体力量的中心，而且是人体最强壮的肌肉，保持一个正确身体姿势，臀部可高度紧张，给身体一个持续向前的动力。如果跑步中向前弯腰或者过于前倾， 那骨盆也会前倾， 这会给后背下部造成压力。 对于健身跑爱好者来说，抬腿要适度，不能一味的追求步幅和频率，应选择合适的步幅，尽可能每脚都落在身体的正下方。人们在刚开始跑步健身时， 总喜欢增加步幅来提高锻炼效果， 其实增大步幅势必造成腾空时间长、重心起伏大、落地力量重，这样对人体的震动会增大，久而久之会带来不必要的伤害。</p>
<h2 id="脚的落地姿势要正确"><a href="#脚的落地姿势要正确" class="headerlink" title="脚的落地姿势要正确"></a>脚的落地姿势要正确</h2><p>跑步时，脚的落地尤为重要，应用脚后跟和脚中部落地，然后快速向前滚动脚掌，然后前脚掌蹬地离开地面。脚落地时声音不能太大，要轻而有弹性。 很多人在跑步时习惯全脚掌着地，其实这种落地方法并不科学，由于落地时没有缓冲，对身体带来很大的冲击，在柏油马路等硬地上跑步就更是如此；切忌内外八字，跑步时脚落地是”内八字”或”外八字”，那么膝盖和脚尖就不能保持在同一个方向上，就会加重膝关节的负担，长期下来容易造成膝关节等部位的损伤。</p>
<h2 id="跑起来，心肺更健康"><a href="#跑起来，心肺更健康" class="headerlink" title="跑起来，心肺更健康"></a>跑起来，心肺更健康</h2><p>跑步是非常好的锻炼方法，可以有效提高心肺耐力。心肺耐力是人体心血管系统和呼吸系统摄入、运送、吸收利用氧气， 进行新陈代谢， 产生能量的能力， 也可以理解为一个人持续进行身体活动的能力。通俗点讲就是你能长时间地跑、游泳、爬楼梯和工作的能力。 心肺功能越强，走、跑、学习和工作就会越轻松， 进行各种活动保持的时间也会越长。科学研究表明，无论男女，”心肺耐力差” 是导致人群死亡的首要危险因素，</p>
<hr>
<h1 id="其他的总结"><a href="#其他的总结" class="headerlink" title="其他的总结"></a>其他的总结</h1><h2 id="基本动作"><a href="#基本动作" class="headerlink" title="基本动作"></a>基本动作</h2><p>1. 一般人可以采取足中着地的方式，由足弓来缓冲震荡，减轻对膝关节的压力。但对于初级跑者，或者体重较大的跑者来说，可以由足尖慢跑开始。这样可以通过增加足弓缓冲，提高足弓支撑力，来降低对膝关节的冲击，预防膝关节受伤。以后可以逐步开始掌握正确的跑法，即”足跟–全足–拇趾”的方式。 2. 跑步时踝关节要有控制，不要刻意抬高脚趾和前脚掌，也无需用力蹬地，只要维持踝关节保持一定紧张度，避免踝关节扭伤。 3. 初跑者，步幅不要过大，防止膝关节在迈步时过伸，也会导致韧带的损伤。尽量选择直道或操场的外圈，可以减少膝关节内外侧受力不均，以及双腿负重不均而造成的关节损伤。 4. 绷紧臀部，髋关节前后摆动，避免骨盆过度前倾，使重心不过分向前，减轻地面对骨盆的作用力，保护骨盆及腰椎。确保髋关节前后摆动，减低地面反应力对骨盆的影响。 5. 微微收腹，感觉让腹肌靠住脊柱，尽可能采用规则的，有深度的腹式呼吸。 6. 腰部放松，上半身带动双臂向前后方向自然交替摆动，双臂靠近躯干，肘关节弯曲，半握拳，不要刻意把力量总在摆动双臂上。用力摆动双臂过抬臂过高会使心脏负担增加。 7. 颈部放松，头部直立，一直面朝前方，略低头收下颌，尽量闭嘴用鼻子呼吸。眼睛看向身前7~10米的距离。</p>
<h2 id="基本要求"><a href="#基本要求" class="headerlink" title="基本要求"></a>基本要求</h2><p>8. 呼吸时尽量采用鼻呼吸，若感觉呼吸局促可采用”鼻吸口呼”。鼻呼吸的好处是可以通过鼻腔湿润空气，防止干燥空气贸然进入肺部造成不适。还可以防止空气进入胃部，造成胀气。初跑者可以放慢跑步速度，用舌尖抵住门牙避免用口呼吸。同时，尽量采用腹式呼吸，胸式呼吸会增加肩胛带运动，造成肩关节紧张，更容易疲劳。 9. 刚进行跑步运动时，速度不重要，距离不重要，重要的是时间，只有能坚持一定时间，才能起到提高心肺功能和肌肉耐力的作用。初跑者需要根据自身情况选择跑步时间，可以先从五分钟开始，根据情况每周增加一两分钟，一年下来也能跑一个小时啦。控制跑步速度，理想状态是在跑步中顺畅讲话即可。如果上气不接下气的跑，会使肌肉无氧运动过多，带来乳酸堆积，造成身体酸痛疲劳，还可能导致岔气，得不偿失。</p>
<h2 id="运动装备"><a href="#运动装备" class="headerlink" title="运动装备"></a>运动装备</h2><p>10. 建议穿紧身衣，除了增加肌肉紧张度外，最重要的是可以避免因跑步带来的肌肉与骨分离。尤其是跑步初期，体重较大，长期不运动的人，小腿韧带强度不足，踝关节承受不住突然猛增的作用力，很容易造成胫腓骨近端关节错位。 11. 跑鞋选择非常重要，一定要选择可支撑足弓的跑鞋。当足底筋膜与肌腱韧性强度不足时，一双既有弹性又有支撑能力的跑鞋是足弓最重要的保护。跑鞋选择时，将足跟抵住鞋帮，拇趾距鞋尖保留一指距离。前掌宽度适宜。鞋平放于地面时，鞋尖应微微翘起约二横指（食指和中指两指并齐的宽度），保证足趾在运动中放松。 12. 手腕上建议戴毛巾式护腕，可随时擦汗，或头戴发带，同样能防止汗液流入眼睛引起不适。 13. 初期跑步尽量选择有节奏的跑步音乐，消除枯燥感。</p>
<h2 id="配合训练"><a href="#配合训练" class="headerlink" title="配合训练"></a>配合训练</h2><p>14. 跑步之后应做充分的拉伸，以消除肌肉运动产生的乳酸，还能使肌肉拉长，形成更好的线条。 15. 适宜的肌力训练，诸如深蹲，仰卧起坐，俯卧撑等等也要与跑步相结合。肌力训练不只是增加肌肉的力量，更能强化神经与肌肉联系，使机体更加协调，帮助跑者尽快找到适合自己的跑步方式。</p>
]]></content>
      <tags>
        <tag>运动</tag>
      </tags>
  </entry>
  <entry>
    <title>Elastic Search</title>
    <url>/2019/01/30/elasticSearch/</url>
    <content><![CDATA[<h1 id="ES-命令"><a href="#ES-命令" class="headerlink" title="ES 命令"></a>ES 命令</h1><p>delete index</p>
<blockquote>
<p>curl -X DELETE ‘<a href="http://localhost:9200/samples&#39;" target="_blank" rel="noopener">http://localhost:9200/samples&#39;</a></p>
</blockquote>
<p>list all indexes</p>
<blockquote>
<p>curl -X GET ‘<a href="http://localhost:9200/_cat/indices?v&#39;" target="_blank" rel="noopener">http://localhost:9200/_cat/indices?v&#39;</a></p>
</blockquote>
<p>list all docs in index</p>
<blockquote>
<p>curl -X GET ‘<a href="http://localhost:9200/sample/_search&#39;" target="_blank" rel="noopener">http://localhost:9200/sample/_search&#39;</a></p>
</blockquote>
<a id="more"></a>
<p>query using URL parameters</p>
<blockquote>
<p>curl -X GET <a href="http://localhost:9200/samples/_search?q=school:Harvard" target="_blank" rel="noopener">http://localhost:9200/samples/_search?q=school:Harvard</a></p>
</blockquote>
<blockquote>
<p>curl -XGET –header ‘Content-Type: application/json’ <a href="http://localhost:9200/samples/_search" target="_blank" rel="noopener">http://localhost:9200/samples/_search</a> -d ‘{<br>      “query” : {<br>        “match” : { “school”: “Harvard” }<br>    }<br>}’</p>
</blockquote>
<p>list index mapping</p>
<blockquote>
<p>curl -X GET <a href="http://localhost:9200/samples" target="_blank" rel="noopener">http://localhost:9200/samples</a></p>
</blockquote>
<blockquote>
<p><a href="http://10.16.73.100:12801/_mapping/" target="_blank" rel="noopener">http://10.16.73.100:12801/_mapping/</a></p>
</blockquote>
<p>Add Data</p>
<blockquote>
<p>curl -XPUT –header ‘Content-Type: application/json’ <a href="http://localhost:9200/samples/_doc/1" target="_blank" rel="noopener">http://localhost:9200/samples/_doc/1</a> -d ‘{<br>   “school” : “Harvard”<br>}’</p>
</blockquote>
<p>Update Doc</p>
<blockquote>
<p>curl -XPUT –header ‘Content-Type: application/json’ <a href="http://localhost:9200/samples/_doc/2" target="_blank" rel="noopener">http://localhost:9200/samples/_doc/2</a> -d ‘<br>{<br>    “school”: “Clemson”<br>}’</p>
</blockquote>
<blockquote>
<p>curl -XPOST –header ‘Content-Type: application/json’ <a href="http://localhost:9200/samples/_doc/2/_update" target="_blank" rel="noopener">http://localhost:9200/samples/_doc/2/_update</a> -d ‘{<br>“doc” : {<br>               “students”: 50000}<br>}’</p>
</blockquote>
<p>backup index</p>
<blockquote>
<p>curl -XPOST –header ‘Content-Type: application/json’ <a href="http://localhost:9200/_reindex" target="_blank" rel="noopener">http://localhost:9200/_reindex</a> -d ‘{<br>  “source”: {<br>    “index”: “samples”<br>  },<br>  “dest”: {<br>    “index”: “samples_backup”<br>  }<br>}’</p>
</blockquote>
<h1 id="ES-DSL查询"><a href="#ES-DSL查询" class="headerlink" title="ES DSL查询"></a>ES DSL查询</h1><p>query DSL ES中索引的数据都会存储一个_score分值，分值越高就代表越匹配</p>
<p>filter DSL 是或者不是,它不会去计算任何分值，也不会关心返回的排序问题，因此效率会高一点。</p>
<p><img src="http://images2015.cnblogs.com/blog/120296/201603/120296-20160318164439303-146810557.png" alt="查询DSL（query DSL）和过滤DSL（filter DSL"></p>
<h2 id="基本查询demo"><a href="#基本查询demo" class="headerlink" title="基本查询demo"></a>基本查询demo</h2><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"bool"</span>: &#123;</span><br><span class="line">			<span class="attr">"must"</span>: [&#123;</span><br><span class="line">				<span class="attr">"term"</span>: &#123;</span><br><span class="line">					<span class="attr">"jz_post-operate_label"</span>: <span class="string">"rpo"</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;, &#123;</span><br><span class="line">				<span class="attr">"range"</span>: &#123;</span><br><span class="line">					<span class="attr">"jz_post-id"</span>: &#123;</span><br><span class="line">						<span class="attr">"lt"</span>: <span class="number">5193035</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"sort"</span>: [&#123;</span><br><span class="line">			<span class="attr">"jz_post-id"</span>: &#123;</span><br><span class="line">				<span class="attr">"order"</span>: <span class="string">"desc"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;]</span><br><span class="line"></span><br><span class="line">		,</span><br><span class="line">	<span class="attr">"_source"</span>: [</span><br><span class="line">		<span class="string">"jz_post-id"</span></span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="geo-距离查询"><a href="#geo-距离查询" class="headerlink" title="geo 距离查询"></a><a href="http://www.dczou.com/viemall/740.html" target="_blank" rel="noopener">geo 距离查询</a></h2><h3 id="ES-版本实现"><a href="#ES-版本实现" class="headerlink" title="ES 版本实现"></a>ES 版本实现</h3><p>需要将经纬度设置字符串或者数据，对象类型。数据类型设置为geo_point才能查询，底层是<a href="https://en.wikipedia.org/wiki/Geohash" target="_blank" rel="noopener">Geohash</a> 实现</p>
<p>位置过滤：</p>
<ol>
<li>geo_distance 查找距离某个中心点距离在一定范围内的位置</li>
<li>geo_bounding_box 查找某个长方形区域内的位置</li>
<li>geo_distance_range 查找距离某个中心的距离在min和max之间的位置</li>
<li>geo_polygon 查找位于多边形内的地点</li>
</ol>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must_not"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"terms"</span>: &#123;</span><br><span class="line">            <span class="attr">"jz_post-id"</span>: [</span><br><span class="line">              <span class="number">5433682</span></span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"filter"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"jz_post-source"</span>: <span class="number">91</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"jz_post-listing_status"</span>: <span class="number">5</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"nested"</span>: &#123;</span><br><span class="line">            <span class="attr">"path"</span>: <span class="string">"jz_post_address"</span>,</span><br><span class="line">            <span class="attr">"query"</span>: &#123;</span><br><span class="line">              <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">                <span class="attr">"filter"</span>: &#123;</span><br><span class="line">                  <span class="attr">"geo_distance"</span>: &#123;</span><br><span class="line">                    <span class="attr">"distance"</span>: <span class="string">"2km"</span>,</span><br><span class="line">                    <span class="attr">"jz_post_address.location"</span>: &#123;</span><br><span class="line">                      <span class="attr">"lat"</span>: <span class="string">"30.26977011"</span>,</span><br><span class="line">                      <span class="attr">"lon"</span>: <span class="string">"120.15865222"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"boost"</span>: <span class="number">1</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"sort"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"_geo_distance"</span>: &#123;</span><br><span class="line">        <span class="attr">"jz_post_address.location"</span>: &#123;</span><br><span class="line">          <span class="attr">"lat"</span>: <span class="string">"30.26977011"</span>,</span><br><span class="line">          <span class="attr">"lon"</span>: <span class="string">"120.15865222"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"unit"</span>: <span class="string">"km"</span>,</span><br><span class="line">        <span class="attr">"order"</span>: <span class="string">"asc"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="php-mysql实现"><a href="#php-mysql实现" class="headerlink" title="php+mysql实现"></a>php+mysql实现</h3><ol>
<li>计算范围，可以做搜索用户</li>
</ol>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetRange</span><span class="params">($lat,$lon,$raidus)</span></span>&#123;</span><br><span class="line">  <span class="comment">//计算纬度</span></span><br><span class="line">  $degree = (<span class="number">24901</span> * <span class="number">1609</span>) / <span class="number">360.0</span>;</span><br><span class="line">  $dpmLat = <span class="number">1</span> / $degree;</span><br><span class="line">  $radiusLat = $dpmLat * $raidus;</span><br><span class="line">  $minLat = $lat - $radiusLat; <span class="comment">//得到最小纬度</span></span><br><span class="line">  $maxLat = $lat + $radiusLat; <span class="comment">//得到最大纬度</span></span><br><span class="line">  <span class="comment">//计算经度</span></span><br><span class="line">  $mpdLng = $degree * cos($lat * (PI / <span class="number">180</span>));</span><br><span class="line">  $dpmLng = <span class="number">1</span> / $mpdLng;</span><br><span class="line">  $radiusLng = $dpmLng * $raidus;</span><br><span class="line">  $minLng = $lon - $radiusLng; <span class="comment">//得到最小经度</span></span><br><span class="line">  $maxLng = $lon + $radiusLng; <span class="comment">//得到最大经度</span></span><br><span class="line">  <span class="comment">//范围</span></span><br><span class="line">  $range = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'minLat'</span> =&gt; $minLat,</span><br><span class="line">    <span class="string">'maxLat'</span> =&gt; $maxLat,</span><br><span class="line">    <span class="string">'minLon'</span> =&gt; $minLng,</span><br><span class="line">    <span class="string">'maxLon'</span> =&gt; $maxLng</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> $range;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>获取范围内的所有数据</li>
</ol>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$result = GetRange(<span class="number">110.325945</span>,<span class="number">20.031541</span>,<span class="number">5000</span>);</span><br><span class="line"> </span><br><span class="line">$where = <span class="string">" (`jingdu` between "</span>.$result[<span class="string">'minLat'</span>].<span class="string">" and "</span>.$result[<span class="string">'maxLat'</span>].<span class="string">") and ( `weidu` between "</span>.$result[<span class="string">'minLon'</span>].<span class="string">" and "</span>.$result[<span class="string">'maxLon'</span>].<span class="string">" ) "</span>;</span><br><span class="line">$query = $db-&gt;query(<span class="string">"select * from distance_table where $where order BY id DESC "</span>);</span><br><span class="line"><span class="keyword">while</span> ( $row = $db-&gt;fetch_array($query) ) &#123;</span><br><span class="line">    $list[] = $row[<span class="string">'all_name'</span>];</span><br><span class="line">&#125;</span><br><span class="line">print_r($list);</span><br></pre></td></tr></table></figure>
<h3 id="PHP计算经纬度坐标之间的距离"><a href="#PHP计算经纬度坐标之间的距离" class="headerlink" title="PHP计算经纬度坐标之间的距离"></a>PHP计算经纬度坐标之间的距离</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDistance</span><span class="params">($lat1, $lng1, $lat2, $lng2, $len_type = <span class="number">1</span>, $decimal = <span class="number">2</span>)</span> </span>&#123;</span><br><span class="line">    $radLat1 = $lat1 * PI / <span class="number">180.0</span>;</span><br><span class="line">    $radLat2 = $lat2 * PI / <span class="number">180.0</span>;</span><br><span class="line">    $a = $radLat1 - $radLat2;</span><br><span class="line">    $b = ($lng1 * PI / <span class="number">180.0</span>) - ($lng2 * PI / <span class="number">180.0</span>);</span><br><span class="line">    $s = <span class="number">2</span> * asin(sqrt(pow(sin($a/<span class="number">2</span>),<span class="number">2</span>) + cos($radLat1) * cos($radLat2) * pow(sin($b/<span class="number">2</span>),<span class="number">2</span>)));</span><br><span class="line">    $s = $s * EARTH_RADIUS;</span><br><span class="line">    $s = round($s * <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">if</span> ($len_type &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    $s /= <span class="number">1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> round($s, $decimal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="精确匹配查询-match-phrase"><a href="#精确匹配查询-match-phrase" class="headerlink" title="精确匹配查询(match_phrase)"></a>精确匹配查询(match_phrase)</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">          &quot;must&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;term&quot;: &#123;</span><br><span class="line">                &quot;jz_post-city_id&quot;: 289</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;term&quot;: &#123;</span><br><span class="line">                &quot;jz_post-job_date_type&quot;: 0</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;term&quot;: &#123;</span><br><span class="line">                &quot;jz_post-company_id&quot;: 1836671</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;terms&quot;: &#123;</span><br><span class="line">                &quot;jz_post-listing_status&quot;: [</span><br><span class="line">                  0,</span><br><span class="line">                  5</span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          &quot;should&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;match_phrase&quot;: &#123;</span><br><span class="line">                &quot;jz_post-title&quot;: &quot;诚心招聘业务员&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="短语前缀匹配"><a href="#短语前缀匹配" class="headerlink" title="短语前缀匹配"></a>短语前缀匹配</h2><p>它与短语匹配的区别为它能匹配的方位更广，它可以命中到短语+其他内容的内容</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_phrase_prefix"</span>: &#123;</span><br><span class="line">      <span class="attr">"FIELD"</span>: <span class="string">"PREFIX"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ES文档参考"><a href="#ES文档参考" class="headerlink" title="ES文档参考"></a>ES文档参考</h1><ul>
<li><a href="http://moliware.com/es-dsl-cheatsheet/" target="_blank" rel="noopener">es-dsl-cheatsheet</a></li>
<li><a href="https://blog.csdn.net/g1969119894/article/details/80111067#%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener">DSL语法查询文档</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.5/query-filter-context.html" target="_blank" rel="noopener">ES5.6文档</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>ETCD 服务注册和发现</title>
    <url>/2021/09/27/etcd-service-register-distory/</url>
    <content><![CDATA[<p>ETCD 服务发现</p>
<p>在微服务中各个服务都是无状态的，不会在配置中写死上下游的访问地址，所以需要有一个地方去维护各个节点的信息。</p>
<p>服务起来的时候会去注册中心拉取其他服务的节点信息，并且把自己的信息推送到注册中心。</p>
<p>当有运行的服务下线或者出现问题的时候，把自己从配置中心摘除，或者配置中心来检测服务状态（心跳、健康检查的协议）来摘除服务。</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"github.com/coreos/etcd/clientv3"</span></span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Discovery <span class="keyword">struct</span> &#123;</span><br><span class="line">    cli       *clientv3.Client</span><br><span class="line">    info      *NodeInfo</span><br><span class="line">    nodes     *NodesManager</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDiscovery</span><span class="params">(info *NodeInfo, conf clientv3.Config, mgr *NodesManager)</span> <span class="params">(dis *Discovery, err error)</span></span> &#123;</span><br><span class="line">    d := &amp;Discovery&#123;&#125;</span><br><span class="line">    d.info = info</span><br><span class="line">    <span class="keyword">if</span> mgr == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"[Discovery] mgr == nil"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    d.nodes = mgr</span><br><span class="line">    d.cli, err = clientv3.New(conf)</span><br><span class="line">    <span class="keyword">return</span> d, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Discovery)</span> <span class="title">pull</span><span class="params">()</span></span> &#123;</span><br><span class="line">    kv := clientv3.NewKV(d.cli)</span><br><span class="line">    resp, err := kv.Get(context.TODO(), <span class="string">"discovery/"</span>, clientv3.WithPrefix())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">"[Discovery] kv.Get err:%+v"</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> resp.Kvs&#123;</span><br><span class="line">        node := &amp;NodeInfo&#123;&#125;</span><br><span class="line">        err = json.Unmarshal(v.Value, node)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Fatalf(<span class="string">"[Discovery] json.Unmarshal err:%+v"</span>, err)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        d.nodes.AddNode(node)</span><br><span class="line">        log.Printf(<span class="string">"[Discovery] pull node:%+v"</span>, node)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Discovery)</span> <span class="title">watch</span><span class="params">()</span></span> &#123;</span><br><span class="line">    watcher := clientv3.NewWatcher(d.cli)</span><br><span class="line">    watchChan := watcher.Watch(context.TODO(), <span class="string">"discovery"</span>, clientv3.WithPrefix())</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> resp := &lt;-watchChan:</span><br><span class="line">            d.watchEvent(resp.Events)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Discovery)</span> <span class="title">watchEvent</span><span class="params">(evs []*clientv3.Event)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, ev := <span class="keyword">range</span> evs&#123;</span><br><span class="line">        <span class="keyword">switch</span> ev.Type&#123;</span><br><span class="line">        <span class="keyword">case</span> clientv3.EventTypePut:</span><br><span class="line">            node := &amp;NodeInfo&#123;&#125;</span><br><span class="line">            err := json.Unmarshal(ev.Kv.Value, node)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Fatalf(<span class="string">"[Discovery] json.Unmarshal err:%+v"</span>, err)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            d.nodes.AddNode(node)</span><br><span class="line">            log.Printf(fmt.Sprintf(<span class="string">"[Discovery] new node:%s"</span>,<span class="keyword">string</span>(ev.Kv.Value)))</span><br><span class="line">        <span class="keyword">case</span> clientv3.EventTypeDelete:</span><br><span class="line">            d.nodes.DelNode(<span class="keyword">string</span>(ev.Kv.Key))</span><br><span class="line">            log.Printf(fmt.Sprintf(<span class="string">"[Discovery] del node:%s data:%s"</span>,<span class="keyword">string</span>(ev.Kv.Key),<span class="keyword">string</span>(ev.Kv.Value)))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务注册</p>
<p>在etcd中服务的注册使用租约（lease）来实现，设置租约的时候按需求设置租约的时间（ttl），类似redis中的EXPIRE key，再把服务自身的节点等信息写到对应的key中。然后定时去调用KeepAliveOnce来保持租约，如果在期间KeepAliveOnce的消息丢失或者延迟大于这个租约的ttl则etcd中将会把这个节点的信息删除，恢复正常时重新发起租约流程。</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"github.com/coreos/etcd/clientv3"</span></span><br><span class="line">    <span class="string">"github.com/coreos/etcd/etcdserver/api/v3rpc/rpctypes"</span></span><br><span class="line">    <span class="string">"github.com/pkg/errors"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">    <span class="string">"context"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    _ttl = <span class="number">10</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Register <span class="keyword">struct</span> &#123;</span><br><span class="line">    cli       *clientv3.Client</span><br><span class="line">    leaseId   clientv3.LeaseID</span><br><span class="line">    lease     clientv3.Lease</span><br><span class="line">    info      *NodeInfo</span><br><span class="line">    closeChan <span class="keyword">chan</span> error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRegister</span><span class="params">(info *NodeInfo, conf clientv3.Config)</span> <span class="params">(reg *Register, err error)</span></span> &#123;</span><br><span class="line">    r := &amp;Register&#123;&#125;</span><br><span class="line">    r.closeChan = <span class="built_in">make</span>(<span class="keyword">chan</span> error)</span><br><span class="line">    r.info = info</span><br><span class="line">    r.cli, err = clientv3.New(conf)</span><br><span class="line">    <span class="keyword">return</span> r, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Register)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dur := time.Duration(time.Second)</span><br><span class="line">    timer := time.NewTicker(dur)</span><br><span class="line">    r.register()</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-timer.C:</span><br><span class="line">            r.keepAlive()</span><br><span class="line">        <span class="keyword">case</span> &lt;-r.closeChan:</span><br><span class="line">            <span class="keyword">goto</span> EXIT</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">EXIT:</span><br><span class="line">    log.Printf(<span class="string">"[Register] Run exit..."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Register)</span> <span class="title">Stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r.revoke()</span><br><span class="line">    <span class="built_in">close</span>(r.closeChan)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Register)</span> <span class="title">register</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    r.leaseId = <span class="number">0</span></span><br><span class="line">    kv := clientv3.NewKV(r.cli)</span><br><span class="line">    r.lease = clientv3.NewLease(r.cli)</span><br><span class="line">    leaseResp, err := r.lease.Grant(context.TODO(), _ttl)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        err = errors.Wrapf(err, <span class="string">"[Register] register Grant err"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    data, err := json.Marshal(r.info)</span><br><span class="line">    _, err = kv.Put(context.TODO(), r.info.UniqueId, <span class="keyword">string</span>(data), clientv3.WithLease(leaseResp.ID))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        err = errors.Wrapf(err, <span class="string">"[Register] register kv.Put err %s-%+v"</span>, r.info.Name, <span class="keyword">string</span>(data))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    r.leaseId = leaseResp.ID</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Register)</span> <span class="title">keepAlive</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    _, err = r.lease.KeepAliveOnce(context.TODO(), r.leaseId)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 租约丢失，重新注册</span></span><br><span class="line">        <span class="keyword">if</span> err == rpctypes.ErrLeaseNotFound &#123;</span><br><span class="line">            r.register()</span><br><span class="line">            err = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        err = errors.Wrapf(err, <span class="string">"[Register] keepAlive err"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    log.Printf(fmt.Sprintf(<span class="string">"[Register] keepalive... leaseId:%+v"</span>, r.leaseId))</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(r *Register)</span> <span class="title">revoke</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    _, err = r.cli.Revoke(context.TODO(), r.leaseId)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        err = errors.Wrapf(err, <span class="string">"[Register] revoke err"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    log.Printf(fmt.Sprintf(<span class="string">"[Register] revoke node:%+v"</span>, r.leaseId))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>节点管理</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"math/rand"</span></span><br><span class="line">    <span class="string">"strings"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> NodeInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">    Addr     <span class="keyword">string</span></span><br><span class="line">    Name     <span class="keyword">string</span></span><br><span class="line">    UniqueId <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> NodesManager <span class="keyword">struct</span> &#123;</span><br><span class="line">    sync.RWMutex</span><br><span class="line">    <span class="comment">// &lt;name,&lt;id,node&gt;&gt;</span></span><br><span class="line">    nodes <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]*NodeInfo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNodeManager</span><span class="params">()</span> <span class="params">(m *NodesManager)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;NodesManager&#123;</span><br><span class="line">        nodes: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]*NodeInfo&#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NodesManager)</span> <span class="title">AddNode</span><span class="params">(node *NodeInfo)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> node == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    n.Lock()</span><br><span class="line">    <span class="keyword">defer</span> n.Unlock()</span><br><span class="line">    <span class="keyword">if</span> _, exist := n.nodes[node.Name]; !exist &#123;</span><br><span class="line">        n.nodes[node.Name] = <span class="keyword">map</span>[<span class="keyword">string</span>]*NodeInfo&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    n.nodes[node.Name][node.UniqueId] = node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NodesManager)</span> <span class="title">DelNode</span><span class="params">(id <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    sli := strings.Split(id,<span class="string">"/"</span>)</span><br><span class="line">    name := sli[<span class="built_in">len</span>(sli)<span class="number">-2</span>]</span><br><span class="line">    n.Lock()</span><br><span class="line">    <span class="keyword">defer</span> n.Unlock()</span><br><span class="line">    <span class="keyword">if</span> _, exist := n.nodes[name]; exist &#123;</span><br><span class="line">        <span class="built_in">delete</span>(n.nodes[name], id)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NodesManager)</span> <span class="title">Pick</span><span class="params">(name <span class="keyword">string</span>)</span> *<span class="title">NodeInfo</span></span> &#123;</span><br><span class="line">    n.RLock()</span><br><span class="line">    <span class="keyword">defer</span> n.RUnlock()</span><br><span class="line">    <span class="keyword">if</span> nodes, exist := n.nodes[name]; !exist &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 纯随机取节点</span></span><br><span class="line">        idx := rand.Intn(<span class="built_in">len</span>(nodes))</span><br><span class="line">        <span class="keyword">for</span> _, v := <span class="keyword">range</span> nodes &#123;</span><br><span class="line">            <span class="keyword">if</span> idx == <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> v</span><br><span class="line">            &#125;</span><br><span class="line">            idx--</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NodesManager)</span> <span class="title">Dump</span> <span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> k, v := <span class="keyword">range</span> n.nodes &#123;</span><br><span class="line">        <span class="keyword">for</span> kk, vv := <span class="keyword">range</span> v &#123;</span><br><span class="line">            log.Printf(<span class="string">"[NodesManager] Name:%s Id:%s Node:%+v"</span>, k, kk, vv)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试效果</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/coreos/etcd/clientv3"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    nodes := NewNodeManager()</span><br><span class="line">    dis, _ := NewDiscovery(&amp;NodeInfo&#123;</span><br><span class="line">        Name: <span class="string">"server name/aaaa"</span>,</span><br><span class="line">        Addr: <span class="string">"127.0.0.1:8888"</span>,</span><br><span class="line">    &#125;, clientv3.Config&#123;</span><br><span class="line">        Endpoints:   []<span class="keyword">string</span>&#123;<span class="string">"tx.cxc233.com:8888"</span>&#125;,</span><br><span class="line">        DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">    &#125;, nodes)</span><br><span class="line"></span><br><span class="line">    reg, _ := NewRegister(&amp;NodeInfo&#123;</span><br><span class="line">        Name: <span class="string">"testsvr"</span>,</span><br><span class="line">        Addr: <span class="string">"127.0.0.1:8888"</span>,</span><br><span class="line">        UniqueId: <span class="string">"discovery/testsvr/instance_id/aaabbbccc"</span>,</span><br><span class="line">    &#125;, clientv3.Config&#123;</span><br><span class="line">        Endpoints:   []<span class="keyword">string</span>&#123;<span class="string">"tx.cxc233.com:8888"</span>&#125;,</span><br><span class="line">        DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    reg2, _ := NewRegister(&amp;NodeInfo&#123;</span><br><span class="line">        Name: <span class="string">"testsvr"</span>,</span><br><span class="line">        Addr: <span class="string">"127.0.0.1:8888"</span>,</span><br><span class="line">        UniqueId: <span class="string">"discovery/testsvr/instance_id/testqqqqq"</span>,</span><br><span class="line">    &#125;, clientv3.Config&#123;</span><br><span class="line">        Endpoints:   []<span class="keyword">string</span>&#123;<span class="string">"tx.cxc233.com:8888"</span>&#125;,</span><br><span class="line">        DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> reg.Run()</span><br><span class="line">    time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">    dis.pull()</span><br><span class="line">    <span class="keyword">go</span> dis.watch()</span><br><span class="line">    time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> reg2.Run()</span><br><span class="line">    time.Sleep(time.Second * <span class="number">1</span>)</span><br><span class="line">    nodes.Dump()</span><br><span class="line">    log.Printf(<span class="string">"[Main] nodes pick:%+v"</span>,nodes.Pick(<span class="string">"testsvr"</span>))</span><br><span class="line">    time.Sleep(time.Second * <span class="number">5</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2020-10-18 22:36:39.102233 I | [Register] keepalive... leaseId:7587849142468224212</span><br><span class="line">2020-10-18 22:36:40.100365 I | [Register] keepalive... leaseId:7587849142468224212</span><br><span class="line">2020-10-18 22:36:40.100365 I | [Discovery] pull node:&amp;&#123;Addr:127.0.0.1:8888 Name:testsvr UniqueId:discovery/testsvr/instance_id/aaabbbccc&#125;</span><br><span class="line">2020-10-18 22:36:41.100389 I | [Register] keepalive... leaseId:7587849142468224212</span><br><span class="line">2020-10-18 22:36:41.143304 I | [Discovery] new node:&#123;<span class="string">"Addr"</span>:<span class="string">"127.0.0.1:8888"</span>,<span class="string">"Name"</span>:<span class="string">"testsvr"</span>,<span class="string">"UniqueId"</span>:<span class="string">"discovery/testsvr/instance_id/testqqqqq"</span>&#125;</span><br><span class="line">2020-10-18 22:36:42.097662 I | [Register] keepalive... leaseId:7587849142468224212</span><br><span class="line">2020-10-18 22:36:42.100819 I | [NodesManager] Name:testsvr Id:discovery/testsvr/instance_id/aaabbbccc Node:&amp;&#123;Addr:127.0.0.1:8888 Name:testsvr UniqueId:discovery/testsvr/instance_id/aaabbbccc&#125;</span><br><span class="line">2020-10-18 22:36:42.100819 I | [NodesManager] Name:testsvr Id:discovery/testsvr/instance_id/testqqqqq Node:&amp;&#123;Addr:127.0.0.1:8888 Name:testsvr UniqueId:discovery/testsvr/instance_id/testqqqqq&#125;</span><br><span class="line">2020-10-18 22:36:42.100819 I | [Main] nodes pick:&amp;&#123;Addr:127.0.0.1:8888 Name:testsvr UniqueId:discovery/testsvr/instance_id/testqqqqq&#125;</span><br><span class="line">2020-10-18 22:36:42.107588 I | [Register] keepalive... leaseId:7587849142468224216</span><br><span class="line">2020-10-18 22:36:43.091650 I | [Register] keepalive... leaseId:7587849142468224212</span><br><span class="line">2020-10-18 22:36:43.109634 I | [Register] keepalive... leaseId:7587849142468224216</span><br><span class="line">2020-10-18 22:36:44.093966 I | [Register] keepalive... leaseId:7587849142468224212</span><br><span class="line">2020-10-18 22:36:44.108130 I | [Register] keepalive... leaseId:7587849142468224216</span><br><span class="line">2020-10-18 22:36:45.093075 I | [Register] keepalive... leaseId:7587849142468224212</span><br><span class="line">2020-10-18 22:36:45.114071 I | [Register] keepalive... leaseId:7587849142468224216</span><br><span class="line">2020-10-18 22:36:46.107634 I | [Register] keepalive... leaseId:7587849142468224212</span><br><span class="line">2020-10-18 22:36:46.114016 I | [Register] keepalive... leaseId:7587849142468224216</span><br><span class="line">2020-10-18 22:36:47.091863 I | [Register] keepalive... leaseId:7587849142468224212</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>微服务</tag>
      </tags>
  </entry>
  <entry>
    <title>golang项目部署(Dockerfile)</title>
    <url>/2021/09/27/go-dockerfile/</url>
    <content><![CDATA[<h2 id="Go-Dockerfile-构建"><a href="#Go-Dockerfile-构建" class="headerlink" title="Go Dockerfile 构建"></a>Go Dockerfile 构建</h2><blockquote>
<p>FROM golang:1.15</p>
</blockquote>
<p>docker有一个基本镜像叫做scratch，它是一个空的镜像，在临时基础镜像上运行的应用程序只能访问内核</p>
<p>由于需要依赖cgo，所以我们使用scratch无法满足需求，我们需要另外一个运行时基础镜像alpine，看下dockerhub官方的介绍，它也仅仅只有5MB大小。</p>
<p>生成镜像，使用当前文件构建一个镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t changcrazy/service.doumi.com:v1  .</span><br></pre></td></tr></table></figure>
<p>启动一个容器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d centos_nginx:v1 /usr/<span class="built_in">local</span>/nginx/sbin/nginx -g <span class="string">"daemon off;"</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>Dockerfile文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打包依赖阶段使用golang作为基础镜像</span></span><br><span class="line">FROM golang:1.15 as builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用go module</span></span><br><span class="line">ENV GO111MODULE=on \</span><br><span class="line">    GOPROXY=https://goproxy.cn,direct</span><br><span class="line"></span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line">COPY . .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定OS等，并go build</span></span><br><span class="line">RUN GOOS=linux GOARCH=amd64 go build .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于我不止依赖二进制文件，还依赖views文件夹下的html文件还有assets文件夹下的一些静态文件</span></span><br><span class="line"><span class="comment"># 所以我将这些文件放到了publish文件夹</span></span><br><span class="line">RUN mkdir publish &amp;&amp; cp toc-generator publish &amp;&amp; \</span><br><span class="line">    cp -r views publish &amp;&amp; cp -r assets publish</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行阶段指定scratch作为基础镜像</span></span><br><span class="line">FROM alpine</span><br><span class="line"></span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将上一个阶段publish文件夹下的所有文件复制进来</span></span><br><span class="line">COPY --from=builder /app/publish .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定运行时环境变量</span></span><br><span class="line">ENV GIN_MODE=release \</span><br><span class="line">    PORT=80</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">"./toc-generator"</span>]</span><br></pre></td></tr></table></figure>
<h2 id="docker-go-grpc"><a href="#docker-go-grpc" class="headerlink" title="docker go grpc"></a>docker go grpc</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 构建</span></span><br><span class="line"><span class="comment"># docker run --name=base.domain.com -itd -p 8080:8080 -v /d/keguan/go-base-framework:/home/www/base.domain.com changcrazy/go-base:v1.0  /bin/bash</span></span><br><span class="line"><span class="comment"># 打包依赖阶段使用golang作为基础镜像</span></span><br><span class="line">FROM golang:1.15.10 AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># www</span></span><br><span class="line">RUN groupadd --gid 5000 www \</span><br><span class="line">  &amp;&amp; useradd --home-dir /home/www --create-home --uid 5000 \</span><br><span class="line">    --gid 5000 --shell /bin/sh --skel /dev/null www</span><br><span class="line"></span><br><span class="line">ENV GO111MODULE=on  GOPROXY=https://goproxy.cn,direct</span><br><span class="line">ENV GOROOT=/usr/<span class="built_in">local</span>/go  PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/go/bin  GOPATH=<span class="variable">$HOME</span>/go  PATH=<span class="variable">$GOPATH</span>/bin/:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">WORKDIR /home/tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># install protoc</span></span><br><span class="line">RUN wget http://github.com/protocolbuffers/protobuf/releases/download/v3.14.0/protobuf-all-3.14.0.tar.gz \ </span><br><span class="line">    &amp;&amp; tar -zxvf protobuf-all-3.14.0.tar.gz &amp;&amp; <span class="built_in">cd</span> protobuf-3.14.0/ &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">ENV LD_LIBRARY_PATH=/usr/<span class="built_in">local</span>/lib</span><br><span class="line"></span><br><span class="line">WORKDIR /home/www/base.domain.com</span><br><span class="line"></span><br><span class="line">COPY go.mod .</span><br><span class="line">COPY go.sum .</span><br><span class="line">RUN go mod download</span><br><span class="line"><span class="comment"># github 的protoc 版本的新版本</span></span><br><span class="line"><span class="comment"># RUN go get github.com/golang/protobuf/protoc-gen-go</span></span><br><span class="line"><span class="comment"># github 的protoc 版本的旧版本,如果使用etcd集群需要使用老版本</span></span><br><span class="line"><span class="comment"># RUN go get github.com/golang/protobuf/protoc-gen-go@v1.3.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># google 的protoc 版本的 新版本</span></span><br><span class="line">RUN go get google.golang.org/protobuf/cmd/protoc-gen-go &amp;&amp; go get google.golang.org/grpc/cmd/protoc-gen-go-grpc</span><br><span class="line"></span><br><span class="line"><span class="comment"># grpc gateway v1 和 swagger 如结合 etcd集群需要使用此旧版本</span></span><br><span class="line"><span class="comment"># RUN go install github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway &amp;&amp; \</span></span><br><span class="line">    <span class="comment"># &amp;&amp; go install github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># grpc gateway v2 版本 和 swagger插件</span></span><br><span class="line">RUN go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway \</span><br><span class="line">    &amp;&amp; go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">COPY . .</span><br><span class="line"></span><br><span class="line"><span class="comment"># RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o web_serve main.go</span></span><br><span class="line">RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags=<span class="string">"-s -w"</span> -installsuffix cgo -o web_serve main.go</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [ <span class="string">"./web_serve"</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行阶段指定alpine作为基础镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FROM golang:1.15.10-alpine</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># WORKDIR /home/www/base.domain.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># COPY --from=build /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"><span class="comment"># COPY --from=builder /home/www/base.domain.com/web_serve .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RUN chown www:www web_serve</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># USER www:www</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ENV GIN_MODE=release</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EXPOSE 8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ENTRYPOINT [ "./web_serve" ]</span></span><br></pre></td></tr></table></figure>
<h2 id="一个简单的构建实例"><a href="#一个简单的构建实例" class="headerlink" title="一个简单的构建实例"></a>一个简单的构建实例</h2><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r := gin.Default()</span><br><span class="line">    r.GET(<span class="string">"/ping"</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.JSON(<span class="number">200</span>, gin.H&#123;</span><br><span class="line">            <span class="string">"message"</span>: <span class="string">"pong"</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    r.GET(<span class="string">"/demo"</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        addr := os.Getenv(<span class="string">"DOMAIN_ADDR"</span>)</span><br><span class="line">        version := c.DefaultQuery(<span class="string">"version"</span>, <span class="string">"0"</span>)</span><br><span class="line">        c.String(http.StatusOK, <span class="string">"这是一个demo示例。addr:"</span>+addr+<span class="string">", version:"</span>+version+<span class="string">", k8s container version: 2.1"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    r.GET(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.String(http.StatusOK, <span class="string">"Hello World~~, 这是第一个发版的k8s集群镜像。"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    r.Run(<span class="string">":9888"</span>) <span class="comment">// listen and serve on 0.0.0.0:8080</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的Dockfile</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 构建</span></span><br><span class="line"><span class="comment"># docker build -t changcrazy/demokaixin:v1 .</span></span><br><span class="line"><span class="comment"># docker run --name=demo.changkaixin.cn -itd -p 9888:9888 -v /e/p/demo.changkaixn.cn:/home/www/demo.changkaixn.cn changcrazy/kaixindemo:v1</span></span><br><span class="line"><span class="comment"># 打包依赖阶段使用golang作为基础镜像</span></span><br><span class="line">FROM golang:1.17.0 AS builder</span><br><span class="line"></span><br><span class="line">ENV GO111MODULE=on  GOPROXY=https://goproxy.cn,direct</span><br><span class="line"><span class="comment"># ENV GOROOT=/usr/local/go  PATH=$PATH:/usr/local/go/bin  GOPATH=$HOME/go  PATH=$GOPATH/bin/:$PATH</span></span><br><span class="line"></span><br><span class="line">WORKDIR /home/www/demo.changkaixin.cn</span><br><span class="line"></span><br><span class="line">COPY go.mod .</span><br><span class="line">COPY go.sum .</span><br><span class="line">RUN go mod download</span><br><span class="line">COPY . .</span><br><span class="line"></span><br><span class="line">RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o web_serve main.go</span><br><span class="line"><span class="comment"># RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -installsuffix cgo -o web_serve main.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EXPOSE 9888</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ENTRYPOINT [ "./web_serve" ]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只要上面即可，使用下面作为运行环境文件更小</span></span><br><span class="line"><span class="comment"># 运行阶段指定alpine作为基础镜像</span></span><br><span class="line"></span><br><span class="line">FROM golang:1.17.0-alpine</span><br><span class="line"></span><br><span class="line">WORKDIR /home/www/demo.changkaixin.cn</span><br><span class="line"></span><br><span class="line">COPY --from=builder /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line">COPY --from=builder /home/www/demo.changkaixin.cn/web_serve .</span><br><span class="line"></span><br><span class="line"><span class="comment"># RUN chown www:www web_serve</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># USER www:www</span></span><br><span class="line"></span><br><span class="line">ENV GIN_MODE=release</span><br><span class="line"></span><br><span class="line">EXPOSE 9888</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [ <span class="string">"./web_serve"</span> ]</span><br></pre></td></tr></table></figure>
<h3 id="推送到远程"><a href="#推送到远程" class="headerlink" title="推送到远程"></a>推送到远程</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 构建镜像</span></span><br><span class="line">docker build -t changcrazy/demokaixin:v1 .</span><br><span class="line"><span class="comment"># 查看构建出来的镜像</span></span><br><span class="line">docker images</span><br><span class="line"><span class="comment"># 使用 构建出来的镜像运行容器</span></span><br><span class="line">docker run --name=demo.changkaixin.cn -itd -p 9888:9888 -v /e/p/demo.changkaixn.cn:/home/www/demo.changkaixn.cn changcrazy/kaixindemo:v1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登陆的自己镜像仓库，如果官方的只需要 docker login</span></span><br><span class="line">docker login --username=changyuan@1995573026294914 registry.cn-hangzhou.aliyuncs.com</span><br><span class="line"><span class="comment"># tag 版本</span></span><br><span class="line">docker tag [ImageId] registry.cn-hangzhou.aliyuncs.com/kg_base/go-base:[镜像版本号]</span><br><span class="line"><span class="comment"># push</span></span><br><span class="line">docker push registry.cn-hangzhou.aliyuncs.com/kg_base/go-base:[镜像版本号]</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title>Go 并发</title>
    <url>/2020/05/02/go-concurrency/</url>
    <content><![CDATA[<h1 id="常见的并发模型"><a href="#常见的并发模型" class="headerlink" title="常见的并发模型:"></a>常见的并发模型:</h1><p>进程与线程（apache） C10K 问题</p>
<blockquote>
<ul>
<li>nginx,nodejs 异步非阻塞 复杂度高</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>golang ，lua，erlang 协程方式</li>
</ul>
</blockquote>
<p>golang 中使用goroutine 实现并发的，channels 在多个goroutine 间的数据同步和通信，select在多个channels中选择数据的读取和写入。</p>
<h1 id="并发与并行"><a href="#并发与并行" class="headerlink" title="并发与并行"></a>并发与并行</h1><p>并发： 指同一时刻，系统通过调度，来回切换交替的运行多个任务，“看起来”是同时进行</p>
<p>并行： 指同一个时刻，两个任务”真正的“同时进行</p>
<blockquote>
<p><a href="https://www.youtube.com/watch?v=cN_DpYBzKso" target="_blank" rel="noopener">讲解地址</a>  搬运废书问题</p>
</blockquote>
<p>将复杂的任务拆分，通过goroutine去并发执行。</p>
<blockquote>
<p>Coroutine </p>
</blockquote>
<ul>
<li>指针，&amp; 取地址。</li>
</ul>
<p>修改结构体的变量内容的时候，方法传入的结构体变量参数需要使用指针，也就是结构体的地址</p>
<a id="more"></a>]]></content>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title>分布式事务</title>
    <url>/2019/01/30/distributed-transaction/</url>
    <content><![CDATA[<p>为什么使用分布式事物？</p>
<ol>
<li>Service 产生多个节点，一个小的服务单元本事多节点部署 。</li>
<li>Resource 产生多个节点：数据库等不在一个地方，不同的服务如果保证一致</li>
<li>保证数据的可用性，一致性，完整性。（转账的例子）</li>
</ol>
<p>分布式事务指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。<br><strong>本质上来说，分布式事务就是为了保证不同数据库的数据一致性。</strong></p>
<a id="more"></a>
<h2 id="概念介绍"><a href="#概念介绍" class="headerlink" title="概念介绍"></a>概念介绍</h2><h3 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h3><p>分布式事物CAP理论：</p>
<ul>
<li>Consistency(一致性), 数据一致更新，所有数据变动都是同步的</li>
<li>Availability(可用性), 好的响应性能</li>
<li>Partition tolerance(分区容错性) 可靠性，部分节点出现问题，其他节点仍然可用。<blockquote>
<p>定理：任何分布式系统只可同时满足二点，没法三者兼顾。<br>忠告：架构师不要将精力浪费在如何设计能满足三者的完美分布式系统，而是应该进行取舍。</p>
</blockquote>
</li>
</ul>
<p>分布式事物保持最终一致性。</p>
<p>对于 CP 来说，放弃可用性，追求一致性和分区容错性，我们的 ZooKeeper 其实就是追求的强一致。<br>对于 AP 来说，放弃一致性(这里说的一致性是强一致性)，追求分区容错性和可用性，这是很多分布式系统设计时的选择，后面的 BASE 也是根据 AP 来扩展。</p>
<p>基于分布式领域BASE理论，它是在CAP理论（一致性、可用性、分区容忍性）的基础之上的延伸。</p>
<h3 id="BASE理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h3><p>BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写，是对 CAP 中 AP 的一个扩展。<br>同时 CAP 中选择两个，比如你选择了 CP，并不是叫你放弃 A。因为 P 出现的概率实在是太小了，大部分的时间你仍然需要保证 CA。</p>
<blockquote>
<p>基本可用：分布式系统出现故障的时候，允许损失一部分可用性,保证核心功能可用。</p>
</blockquote>
<blockquote>
<p>柔性状态：允许系统存在中间状态，这个中间状态又不会影响系统整体可用性。</p>
</blockquote>
<blockquote>
<p>最终一致性：数据经过重试等机制处理后，最终数据能达到一致。</p>
</blockquote>
<p>ACID是传统数据库常用的设计思想，它追求的是强一致性。BASE是大型分布式系统场景下的设计思想，通过牺牲强一致性获得高可用性。</p>
<h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><h3 id="2PC（全局事务型）"><a href="#2PC（全局事务型）" class="headerlink" title="2PC（全局事务型）"></a>2PC（全局事务型）</h3><p>数据库支持的 XA Transactions 事物机制，Mysql5.5以上是否支持。推荐mariadb<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &apos;%innodb_support_xa%&apos;;</span><br></pre></td></tr></table></figure></p>
<p>资源管理器（resource manager）：用来管理系统资源，是通向事务资源的途径。数据库就是一种资源管理器。资源管理还应该具有管理事务提交或回滚的能力。</p>
<p>事务管理器（transaction manager）：事务管理器是分布式事务的核心管理者。事务管理器与每个资源管理器（resource<br>manager）进行通信，协调并完成事务的处理。事务的各个分支由唯一命名进行标识。</p>
<p>XA 是一个两阶段提交协议:</p>
<ol>
<li>预处理阶段：事务协调器要求每个涉及到事务的数据库预提交(precommit)此操作，并反映是否可以提交</li>
<li>提交阶段：事务协调器要求每个数据库提交数据。</li>
</ol>
<p><img src="https://wx3.sinaimg.cn/mw690/6972aca8ly1fzimzin6ffj20lz0e8wg8.jpg" alt="image"></p>
<p>MYSQL对XA事物支持过程：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">XA &#123;START|BEGIN&#125; xid [JOIN|RESUME]   //开启XA事务，如果使用的是XA START而不是XA</span><br><span class="line"></span><br><span class="line">BEGIN，那么不支持[JOIN|RESUME]，xid是一个唯一值，表示事务分支标识符</span><br><span class="line"></span><br><span class="line">XA END xid [SUSPEND [FOR MIGRATE]]   //结束一个XA事务，不支持[SUSPEND [FOR MIGRATE]]</span><br><span class="line"></span><br><span class="line">XA PREPARE xid 准备提交</span><br><span class="line"></span><br><span class="line">XA COMMIT xid [ONE PHASE] //提交，如果使用了ONE PHASE，则表示使用一阶段提交。两阶段提交协议中，如果只有一个RM参与，那么可以优化为一阶段提交</span><br><span class="line"></span><br><span class="line">XA ROLLBACK xid  //回滚</span><br><span class="line"></span><br><span class="line">XA RECOVER [CONVERT XID]  //列出所有处于PREPARE阶段的XA事务</span><br></pre></td></tr></table></figure></p>
<p>缺点：</p>
<p>1、同步阻塞问题。执行过程中，所有参与节点都是事务阻塞型的。当参与者占有公共资源时，其他第三方节点访问公共资源不得不处于阻塞状态。</p>
<p>2、单点故障。由于协调者的重要性，一旦协调者发生故障。参与者会一直阻塞下去。尤其在第二阶段，协调者发生故障，那么所有的参与者还都处于锁定事务资源的状态中，而无法继续完成事务操作。（如果是协调者挂掉，可以重新选举一个协调者，但是无法解决因为协调者宕机导致的参与者处于阻塞状态的问题）</p>
<p>3、数据不一致。在二阶段提交的阶段二中，当协调者向参与者发送commit请求之后，发生了局部网络异常或者在发送commit请求过程中协调者发生了故障，这回导致只有一部分参与者接受到了commit请求。而在这部分参与者接到commit请求之后就会执行commit操作。但是其他部分未接到commit请求的机器则无法执行事务提交。于是整个分布式系统便出现了数据部一致性的现象。</p>
<p>4、二阶段无法解决的问题：协调者再发出commit消息之后宕机，而唯一接收到这条消息的参与者同时也宕机了。那么即使协调者通过选举协议产生了新的协调者，这条事务的状态也是不确定的，没人知道事务是否被已经提交。</p>
<p>XA 协议比较简单，成本较低，但是其单点问题，以及不能支持高并发(由于同步阻塞)依然是其最大的弱点。</p>
<p>DEMO：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$pdo1 = DB::connection()-&gt;getPdo();</span><br><span class="line">$pdo2 = DB::connection(<span class="string">'jianzhi_vip'</span>)-&gt;getPdo();</span><br><span class="line"></span><br><span class="line">$xid = uniqid();</span><br><span class="line">$xid2 = uniqid();</span><br><span class="line"><span class="keyword">$this</span>-&gt;info(<span class="string">'开启xa事物'</span>);</span><br><span class="line"></span><br><span class="line">$pdo1-&gt;exec(<span class="string">"XA START '$xid'"</span>);</span><br><span class="line">$pdo2-&gt;exec(<span class="string">"XA START '$xid2'"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;info(<span class="string">'准备xa事物'</span>);</span><br><span class="line">    $ret1 = $pdo1-&gt;exec(<span class="string">"UPDATE jz_abtest_record SET test_result=test_result+1 WHERE id=1"</span>);</span><br><span class="line"></span><br><span class="line">    $ret2 = $pdo2-&gt;exec(<span class="string">"UPDATE test SET age=7 WHERE id=1"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//阶段1：$dbtest1提交准备就绪</span></span><br><span class="line">    $pdo1-&gt;exec(<span class="string">"XA END '$xid'"</span>);</span><br><span class="line">    $pdo1-&gt;exec(<span class="string">"XA PREPARE '$xid'"</span>);</span><br><span class="line">    <span class="comment">//阶段1：$dbtest2提交准备就绪</span></span><br><span class="line">    $pdo2-&gt;exec(<span class="string">"XA END '$xid2'"</span>);</span><br><span class="line">    $pdo2-&gt;exec(<span class="string">"XA PREPARE '$xid2'"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//异常报告写在prepare之后</span></span><br><span class="line">    <span class="keyword">if</span> (!$ret1 || !$ret2) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"错误异常操作"</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;info(<span class="string">'提交xa事物'</span>);</span><br><span class="line">    <span class="comment">//阶段2：提交两个库</span></span><br><span class="line">    $pdo1-&gt;exec(<span class="string">"XA COMMIT '$xid'"</span>);</span><br><span class="line">    $pdo2-&gt;exec(<span class="string">"XA COMMIT '$xid2'"</span>);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;info(<span class="string">'回滚'</span>);</span><br><span class="line">    <span class="comment">//阶段2：回滚</span></span><br><span class="line">    $pdo1-&gt;exec(<span class="string">"XA ROLLBACK '$xid'"</span>);</span><br><span class="line">    $pdo2-&gt;exec(<span class="string">"XA ROLLBACK '$xid2'"</span>);</span><br><span class="line">    print_r($e-&gt;getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TCC（事务补偿型）"><a href="#TCC（事务补偿型）" class="headerlink" title="TCC（事务补偿型）"></a>TCC（事务补偿型）</h3><p><img src="https://wx4.sinaimg.cn/mw690/6972aca8ly1fz8gszyj0lj20ns0bldhs.jpg" alt="TCC"></p>
<p>TCC 其实就是采用的补偿机制，其核心思想是：<strong>针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作</strong></p>
<p>它分为三个阶段：</p>
<ul>
<li>Try 阶段主要是对业务系统做检测及资源预留</li>
<li>Confirm 阶段主要是对业务系统做确认提交，Try阶段执行成功并开始执行 Confirm阶段时，默认Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。</li>
<li>Cancel 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。</li>
</ul>
<blockquote>
<p>举个例子，假入 Bob 要向 Smith 转账，思路大概是：<br>我们有一个本地方法，里面依次调用<br>1、首先在 Try 阶段，要先调用远程接口把 Smith 和 Bob 的钱给冻结起来。<br>2、在 Confirm 阶段，执行远程调用的转账的操作，转账成功进行解冻。<br>3、如果第2步执行成功，那么转账成功，如果第二步执行失败，则调用远程冻结接口对应的解冻方法 (Cancel)。</p>
</blockquote>
<p>优点： 跟2PC比起来，实现以及流程相对简单了一些，但数据的一致性比2PC也要差一些,增加可用性</p>
<p>缺点： </p>
<ol>
<li>业务逻辑的每个分支都需要实现try、confirm、cancel三个操作，应用侵入性较强，改造成本高</li>
<li>实现难度较大。需要按照网络状态、系统故障等不同的失败原因实现不同的回滚策略。为了满足一致性的要求，confirm和cancel接口必须实现幂等</li>
</ol>
<p>TCC两阶段提交与XA两阶段提交的区别是：</p>
<ol>
<li>XA是资源层面的分布式事务，强一致性，在两阶段提交的整个过程中，一直会持有资源的锁。</li>
</ol>
<blockquote>
<p>XA事务中的两阶段提交内部过程是对开发者屏蔽的，回顾我们之前讲解JTA规范时，通过UserTransaction的commit方法来提交全局事务，这只是一次方法调用，其内部会委派给TransactionManager进行真正的两阶段提交，因此开发者从代码层面是感知不到这个过程的。而事务管理器在两阶段提交过程中，从prepare到commit/rollback过程中，资源实际上一直都是被加锁的。如果有其他人需要更新这两条记录，那么就必须等待锁释放。</p>
</blockquote>
<p>2.TCC是业务层面的分布式事务，最终一致性，不会一直持有资源的锁。</p>
<blockquote>
<p>TCC中的两阶段提交并没有对开发者完全屏蔽，也就是说从代码层面，开发者是可以感受到两阶段提交的存在。如上述航班预定案例：在第一阶段，航空公司需要提供try接口(机票资源预留)。在第二阶段，航空公司提需要提供confirm/cancel接口(确认购买机票/取消预留)。开发者明显的感知到了两阶段提交过程的存在。try、confirm/cancel在执行过程中，一般都会开启各自的本地事务，来保证方法内部业务逻辑的ACID特性。其中：try过程的本地事务，是保证资源预留的业务逻辑的正确性,confirm/cancel执行的本地事务逻辑确认/取消预留资源，以保证最终一致性.</p>
</blockquote>
<h3 id="异步确保最终一致型-柔性事务"><a href="#异步确保最终一致型-柔性事务" class="headerlink" title="异步确保最终一致型(柔性事务)"></a>异步确保最终一致型(柔性事务)</h3><p>它的核心思想是将需要分布式处理的<strong>任务通过消息</strong>或者<strong>日志的方式来异步执行</strong>，消息或日志可以存到本地文件、数据库或消息队列，再通过业务规则进行失败重试，它要求各服务的接口是幂等的。</p>
<ol>
<li>记录日志+补偿<br>记录事务的开始和结束状态。事务根据日志记录找回事务的当前执行状态，并根据状态决定重试异常步骤，也就是正向补偿，或者回滚上一次执行步骤，也就是反向补偿。</li>
<li>消息<br>多次重试，也就是发送多次消息，由于要多次重发，所以程序必须是<strong>幂等</strong>（同一操作反复执行多次结果不变）</li>
<li>无锁设计<br>放弃锁是一个解决问题的思路。比如通过乐观锁，大多数是基于版本号来实现。</li>
</ol>
<h4 id="本地消息表（异步确保型）"><a href="#本地消息表（异步确保型）" class="headerlink" title="本地消息表（异步确保型）"></a>本地消息表（异步确保型）</h4><p>其核心思想是将分布式事务拆分成本地事务进行处理:<br><img src="https://upload-images.jianshu.io/upload_images/11349666-abdeca2a04207329.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/603/format/webp" alt="消息表"></p>
<ol>
<li><p>消息生产方，需要额外建一个消息表，并记录消息发送状态。消息表和业务数据要在一个事务里提交，也就是说他们要在一个数据库里面。然后消息会经过MQ发送到消息的消费方。如果消息发送失败，会进行重试发送。</p>
</li>
<li><p>消息消费方，需要处理这个消息，并完成自己的业务逻辑。此时如果本地事务处理成功，表明已经处理成功了，如果处理失败，那么就会重试执行。如果是业务上面的失败，可以给生产方发送一个业务补偿消息，通知生产方进行回滚等操作。</p>
</li>
<li><p>生产方和消费方定时扫描本地消息表，把还没处理完成的消息或者失败的消息再发送一遍。如果有靠谱的自动对账补账逻辑，这种方案还是非常实用的。</p>
</li>
</ol>
<p>这种方案遵循BASE理论，采用的是最终一致性，笔者认为是这几种方案里面比较适合实际业务场景的，即不会出现像2PC那样复杂的实现(当调用链很长的时候，2PC的可用性是非常低的)，也不会像TCC那样可能出现确认或者回滚不了的情况。</p>
<p>举个经典的跨行转账的例子来描述。<br>第一步伪代码如下，扣款100，通过本地事务保证了凭证消息插入到消息表中：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">begin transaction:</span><br><span class="line">　　update User set account = account - 100 where userId = &apos;A&apos;</span><br><span class="line">　　insert into message(msgId, userId, amount, status) values(&apos;123&apos;,&apos;A&apos;, 100, 1)</span><br><span class="line">commit transaction</span><br></pre></td></tr></table></figure>
<p>第二步，通知对方银行账户上加100了。那问题来了，如何通知到对方呢？</p>
<p>通常采用两种方式：</p>
<ol>
<li>采用时效性高的MQ，由对方订阅消息并监听，有消息时自动触发事件。</li>
<li>采用定时轮询扫描的方式，去检查消息表的数据。<br>两种方式其实各有利弊，仅仅依靠MQ，可能会出现通知失败的问题。而过于频繁的定时轮询，效率也不是最佳的（90%是无用功）。所以，我们一般会把两种方式结合起来使用。</li>
</ol>
<p>解决了通知的问题，又有新的问题了。万一这消息有重复被消费，往用户帐号上多加了钱，那岂不是后果很严重？其实我们可以消息消费方也通过一个“消费状态表”来记录消费状态。在执行“加款”操作之前，检测下该消息（提供标识）是否已经消费过，消费完成后，通过本地事务控制来更新这个“消费状态表”。这样子就避免重复消费的问题：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">get msgId = &apos;123&apos;;</span><br><span class="line">check if mgsId is in message_applied(msgId);</span><br><span class="line">if not applied:</span><br><span class="line">    begin transaction:</span><br><span class="line">        update User set account = account + 100 where userId = &apos;B&apos;</span><br><span class="line">        insert into message_applied(msgId) values(&apos;123&apos;)</span><br><span class="line">    commit transaction</span><br></pre></td></tr></table></figure>
<p>上诉的方式是一种非常经典的实现，基本避免了分布式事务，实现了“最终一致性”。但是，关系型数据库的吞吐量和性能方面存在瓶颈，频繁的读写消息会给数据库造成压力。所以，在真正的高并发场景下，该方案也会有瓶颈和限制的。</p>
<p>缺点：<br>消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理</p>
<h4 id="MQ非事务类型"><a href="#MQ非事务类型" class="headerlink" title="MQ非事务类型"></a>MQ非事务类型</h4><p>在本地消息表基础之上，优化一个独立的消息服务改进:</p>
<p>基本思路是将本地操作和发送消息放在一个事务中，保证本地操作和消息发送要么两者都成功或者都失败。下游应用向消息系统订阅该消息，收到消息后执行相应操作。</p>
<ol>
<li>操作数据库成功，向 MQ 中投递消息也成功，皆大欢喜</li>
<li>操作数据库失败，不会向 MQ 中投递消息了</li>
<li>操作数据库成功，但是向 MQ 中投递消息时失败，向外抛出了异常，刚刚执行的更新数据库的操作将被回滚</li>
</ol>
<p>Q: 如何保证消息与业务操作一致，不丢失？ </p>
<p>A: 主流的 MQ 产品都具有持久化消息的功能 + 重试机制。</p>
<p>Q: 如何避免消息被重复消费造成的问题？</p>
<ol>
<li>保证消费者调用业务的服务接口的幂等性。</li>
<li>通过消费日志或者类似状态表来记录消费状态，便于判断（建议在业务上自行实现，而不依赖MQ产品提供该特性）。</li>
</ol>
<h4 id="MQ事务类型"><a href="#MQ事务类型" class="headerlink" title="MQ事务类型"></a>MQ事务类型</h4><p>举个例子，Bob向Smith转账，那我们到底是先发送消息，还是先执行扣款操作？</p>
<p>好像都可能会出问题。如果先发消息，扣款操作失败，那么Smith的账户里面会多出一笔钱。反过来，如果先执行扣款操作，后发送消息，那有可能扣款成功了但是消息没发出去，Smith收不到钱。除了上面介绍的通过异常捕获和回滚的方式外，还有没有其他的思路呢？</p>
<p>利用RocketMQ 的事务消息优化上面的接口,利用事物消息取代上面独立的消息服务，发送Prepared消息之后，消费端是不能直接消费的，需要本地事物完成之后，确认了之后才行。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/11349666-8211b5a685e7081e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/598/format/webp" alt="image"></p>
<ol>
<li>第一阶段 Prepared 消息，会拿到消息的地址。</li>
<li>第二阶段执行本地事务。</li>
<li>第三阶段通过第一阶段拿到的地址去访问消息，并修改状态。</li>
</ol>
<p>消息接受者就能使用这个消息。如果确认消息失败，在 RocketMQ Broker中提供了定时扫描没有更新状态的消息。</p>
<p>如果有消息没有得到确认，会向消息发送者发送消息，来判断是否提交，在 RocketMQ 中是以 Listener 的形式给发送者，用来处理。</p>
<p>如果减了是回滚还是继续发送确认消息呢？RocketMQ 会根据发送端设置的策略来决定是回滚还是继续发送确认消息。这样就保证了消息发送与本地事务同时成功或同时失败。</p>
<p>RocketMQ 事务设计结构(4.3以上)</p>
<p>事务消息作为一种异步确保型事务，  将两个事务分支通过 MQ 进行异步解耦，RocketMQ 2. 事务消息的设计流程同样借鉴了两阶段提交理论，整体交互流程如下图所示：<br><img src="https://wx4.sinaimg.cn/mw690/6972aca8ly1fz6d7kc4xej20u009974u.jpg" alt="image"></p>
<ol>
<li>事务发起方首先发送 prepare 消息到 MQ，RocketMQ将消息状态标记为Prepared，注意此时这条消息消费者是无法消费到的</li>
<li>在发送 prepare 消息成功后执行本地事务。</li>
<li>根据本地事务执行结果返回 commit 或者是 rollback。</li>
<li>如果消息是 rollback，MQ 将删除该 prepare 消息不进行下发，如果是 commit 消息，MQ 将会把这个消息发送给 consumer 端，RocketMQ将消息状态标记为可消费，这个时候消费者，才能真正的保证消费到这条数据。</li>
<li>如果执行本地事务过程中，执行端挂掉，或者超时，MQ 将会不停的询问其同组的其他 producer 来获取状态。</li>
<li><p>Consumer 端的消费成功机制有 MQ 保证。</p>
<p>如果确认消息发送失败了怎么办？</p>
<p>RocketMQ会定期扫描消息集群中的事务消息，如果发现了Prepared消息，它会向消息发送端(生产者)确认。RocketMQ会根据发送端设置的策略来决定是回滚还是继续发送确认消息。这样就保证了消息发送与本地事务同时成功或同时失败。</p>
<p>如果消费失败怎么办？</p>
<p>阿里提供给我们的解决方法是：人工解决。</p>
</li>
</ol>
<h3 id="开源GTS全局事务中间件"><a href="#开源GTS全局事务中间件" class="headerlink" title="开源GTS全局事务中间件"></a>开源GTS全局事务中间件</h3><p><img src="http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/pic/48726/cn_zh/1498619797175/GTS%20%E6%9E%B6%E6%9E%84.png" alt="image"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/xa-statements.html" target="_blank" rel="noopener">2pc XA 事务</a></li>
<li><a href="http://www.ywnds.com/?p=9049" target="_blank" rel="noopener">mysql XA 事务</a></li>
<li><a href="https://www.infoq.cn/article/solution-of-distributed-system-transaction-consistency" target="_blank" rel="noopener">分布式系统事务一致性</a></li>
<li><a href="https://www.jianshu.com/p/453c6e7ff81c" target="_blank" rel="noopener">RocketMQ 开放消息系统</a></li>
<li><a href="http://rocketmq.apache.org/docs/transaction-example/" target="_blank" rel="noopener">RocketMQ 分布式实现</a></li>
<li><a href="https://help.aliyun.com/document_detail/48726.html?spm=a2c4g.11174283.4.1.1cad735dnkjSxG" target="_blank" rel="noopener">GTS全局事务中间件</a></li>
<li><a href="http://www.tianshouzhi.com/api/tutorials/distributed_transaction/389" target="_blank" rel="noopener">事务消息可靠一致性</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Go Cheat Sheet</title>
    <url>/2020/05/02/go-cheatsheet/</url>
    <content><![CDATA[<h1 id="Go-Cheat-Sheet"><a href="#Go-Cheat-Sheet" class="headerlink" title="Go Cheat Sheet"></a>Go Cheat Sheet</h1><p><a href="https://devhints.io/" target="_blank" rel="noopener">一个整理了很多语言的cs</a></p>
<p><a href="https://devhints.io/go" target="_blank" rel="noopener">GO cheatsheet</a></p>
<p><a href="https://dev.to/devmount/a-cheatsheet-of-128-cheatsheets-for-developers-f4m" target="_blank" rel="noopener">GO cheatsheet</a></p>
<p><a href="https://github.com/golang/go/wiki/LearnServerProgramming" target="_blank" rel="noopener">类库和框架等</a></p>
<h1 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h1><ol>
<li><a href="#basic-syntax">Basic Syntax</a></li>
<li><a href="#operators">Operators</a><ul>
<li><a href="#arithmetic">Arithmetic</a></li>
<li><a href="#comparison">Comparison</a></li>
<li><a href="#logical">Logical</a></li>
<li><a href="#other">Other</a></li>
</ul>
</li>
<li><a href="#declarations">Declarations</a></li>
<li><a href="#functions">Functions</a><ul>
<li><a href="#functions-as-values-and-closures">Functions as values and closures</a></li>
<li><a href="#variadic-functions">Variadic Functions</a></li>
</ul>
</li>
<li><a href="#built-in-types">Built-in Types</a></li>
<li><a href="#type-conversions">Type Conversions</a></li>
<li><a href="#packages">Packages</a></li>
<li><a href="#control-structures">Control structures</a><ul>
<li><a href="#if">If</a></li>
<li><a href="#loops">Loops</a></li>
<li><a href="#switch">Switch</a></li>
</ul>
</li>
<li><a href="#arrays-slices-ranges">Arrays, Slices, Ranges</a><ul>
<li><a href="#arrays">Arrays</a></li>
<li><a href="#slices">Slices</a></li>
<li><a href="#operations-on-arrays-and-slices">Operations on Arrays and Slices</a></li>
</ul>
</li>
<li><a href="#maps">Maps</a></li>
<li><a href="#structs">Structs</a></li>
<li><a href="#pointers">Pointers</a></li>
<li><a href="#interfaces">Interfaces</a></li>
<li><a href="#embedding">Embedding</a></li>
<li><a href="#errors">Errors</a></li>
<li><a href="#concurrency">Concurrency</a><ul>
<li><a href="#goroutines">Goroutines</a></li>
<li><a href="#channels">Channels</a></li>
<li><a href="#channel-axioms">Channel Axioms</a></li>
</ul>
</li>
<li><a href="#printing">Printing</a></li>
<li><a href="#reflection">Reflection</a><ul>
<li><a href="#type-switch">Type Switch</a></li>
<li><a href="https://github.com/a8m/reflect-examples" target="_blank" rel="noopener">Examples</a></li>
</ul>
</li>
<li><a href="#snippets">Snippets</a><ul>
<li><a href="#http-server">Http-Server</a></li>
</ul>
</li>
</ol>
<a id="more"></a>
<h2 id="Credits"><a href="#Credits" class="headerlink" title="Credits"></a>Credits</h2><p>Most example code taken from <a href="http://tour.golang.org/" target="_blank" rel="noopener">A Tour of Go</a>, which is an excellent introduction to Go.<br>If you’re new to Go, do that tour. Seriously.</p>
<h2 id="Go-in-a-Nutshell"><a href="#Go-in-a-Nutshell" class="headerlink" title="Go in a Nutshell"></a>Go in a Nutshell</h2><ul>
<li>Imperative language</li>
<li>Statically typed</li>
<li>Syntax tokens similar to C (but less parentheses and no semicolons) and the structure to Oberon-2</li>
<li>Compiles to native code (no JVM)</li>
<li>No classes, but structs with methods</li>
<li>Interfaces</li>
<li>No implementation inheritance. There’s <a href="http://golang.org/doc/effective%5Fgo.html#embedding" target="_blank" rel="noopener">type embedding</a>, though.</li>
<li>Functions are first class citizens</li>
<li>Functions can return multiple values</li>
<li>Has closures</li>
<li>Pointers, but not pointer arithmetic</li>
<li>Built-in concurrency primitives: Goroutines and Channels</li>
</ul>
<h1 id="Basic-Syntax"><a href="#Basic-Syntax" class="headerlink" title="Basic Syntax"></a>Basic Syntax</h1><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>File <code>hello.go</code>:<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Hello Go"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>$ go run hello.go</code></p>
<h2 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h2><h3 id="Arithmetic"><a href="#Arithmetic" class="headerlink" title="Arithmetic"></a>Arithmetic</h3><table>
<thead>
<tr>
<th>Operator</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>+</code></td>
<td>addition</td>
</tr>
<tr>
<td><code>-</code></td>
<td>subtraction</td>
</tr>
<tr>
<td><code>*</code></td>
<td>multiplication</td>
</tr>
<tr>
<td><code>/</code></td>
<td>quotient</td>
</tr>
<tr>
<td><code>%</code></td>
<td>remainder</td>
</tr>
<tr>
<td><code>&amp;</code></td>
<td>bitwise and</td>
</tr>
<tr>
<td>`\</td>
<td>`</td>
<td>bitwise or</td>
</tr>
<tr>
<td><code>^</code></td>
<td>bitwise xor</td>
</tr>
<tr>
<td><code>&amp;^</code></td>
<td>bit clear (and not)</td>
</tr>
<tr>
<td><code>&lt;&lt;</code></td>
<td>left shift</td>
</tr>
<tr>
<td><code>&gt;&gt;</code></td>
<td>right shift</td>
</tr>
</tbody>
</table>
<h3 id="Comparison"><a href="#Comparison" class="headerlink" title="Comparison"></a>Comparison</h3><table>
<thead>
<tr>
<th>Operator</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>==</code></td>
<td>equal</td>
</tr>
<tr>
<td><code>!=</code></td>
<td>not equal</td>
</tr>
<tr>
<td><code>&lt;</code></td>
<td>less than</td>
</tr>
<tr>
<td><code>&lt;=</code></td>
<td>less than or equal</td>
</tr>
<tr>
<td><code>&gt;</code></td>
<td>greater than</td>
</tr>
<tr>
<td><code>&gt;=</code></td>
<td>greater than or equal</td>
</tr>
</tbody>
</table>
<h3 id="Logical"><a href="#Logical" class="headerlink" title="Logical"></a>Logical</h3><table>
<thead>
<tr>
<th>Operator</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&amp;&amp;</code></td>
<td>logical and</td>
</tr>
<tr>
<td>`\</td>
<td>\</td>
<td>`</td>
<td>logical or</td>
</tr>
<tr>
<td><code>!</code></td>
<td>logical not</td>
</tr>
</tbody>
</table>
<h3 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h3><table>
<thead>
<tr>
<th>Operator</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&amp;</code></td>
<td>address of / create pointer</td>
</tr>
<tr>
<td><code>*</code></td>
<td>dereference pointer</td>
</tr>
<tr>
<td><code>&lt;-</code></td>
<td>send / receive operator (see ‘Channels’ below)</td>
</tr>
</tbody>
</table>
<h2 id="Declarations"><a href="#Declarations" class="headerlink" title="Declarations"></a>Declarations</h2><p>Type goes after identifier!<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo <span class="keyword">int</span> <span class="comment">// declaration without initialization</span></span><br><span class="line"><span class="keyword">var</span> foo <span class="keyword">int</span> = <span class="number">42</span> <span class="comment">// declaration with initialization</span></span><br><span class="line"><span class="keyword">var</span> foo, bar <span class="keyword">int</span> = <span class="number">42</span>, <span class="number">1302</span> <span class="comment">// declare and init multiple vars at once</span></span><br><span class="line"><span class="keyword">var</span> foo = <span class="number">42</span> <span class="comment">// type omitted, will be inferred</span></span><br><span class="line">foo := <span class="number">42</span> <span class="comment">// shorthand, only in func bodies, omit var keyword, type is always implicit</span></span><br><span class="line"><span class="keyword">const</span> constant = <span class="string">"This is a constant"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// iota can be used for incrementing numbers, starting from 0</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    _ = <span class="literal">iota</span></span><br><span class="line">    a</span><br><span class="line">    b</span><br><span class="line">    c = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span></span><br><span class="line">    d</span><br><span class="line">)</span><br><span class="line">    fmt.Println(a, b) <span class="comment">// 1 2 (0 is skipped)</span></span><br><span class="line">    fmt.Println(c, d) <span class="comment">// 8 16 (2^3, 2^4)</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a>Functions</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// a simple function</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">functionName</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// function with parameters (again, types go after identifiers)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">functionName</span><span class="params">(param1 <span class="keyword">string</span>, param2 <span class="keyword">int</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// multiple parameters of the same type</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">functionName</span><span class="params">(param1, param2 <span class="keyword">int</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// return type declaration</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">functionName</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Can return multiple values at once</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">returnMulti</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span>, <span class="string">"foobar"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> x, str = returnMulti()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Return multiple named results simply by return</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">returnMulti2</span><span class="params">()</span> <span class="params">(n <span class="keyword">int</span>, s <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    n = <span class="number">42</span></span><br><span class="line">    s = <span class="string">"foobar"</span></span><br><span class="line">    <span class="comment">// n and s will be returned</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> x, str = returnMulti2()</span><br></pre></td></tr></table></figure>
<h3 id="Functions-As-Values-And-Closures"><a href="#Functions-As-Values-And-Closures" class="headerlink" title="Functions As Values And Closures"></a>Functions As Values And Closures</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// assign a function to a name</span></span><br><span class="line">    add := <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// use the name to call the function</span></span><br><span class="line">    fmt.Println(add(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Closures, lexically scoped: Functions can access values that were</span></span><br><span class="line"><span class="comment">// in scope when defining the function</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scope</span><span class="params">()</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span>&#123;</span><br><span class="line">    outer_var := <span class="number">2</span></span><br><span class="line">    foo := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> outer_var&#125;</span><br><span class="line">    <span class="keyword">return</span> foo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">another_scope</span><span class="params">()</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span>&#123;</span><br><span class="line">    <span class="comment">// won't compile because outer_var and foo not defined in this scope</span></span><br><span class="line">    outer_var = <span class="number">444</span></span><br><span class="line">    <span class="keyword">return</span> foo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Closures</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">outer</span><span class="params">()</span> <span class="params">(<span class="keyword">func</span>()</span> <span class="title">int</span>, <span class="title">int</span>)</span> &#123;</span><br><span class="line">    outer_var := <span class="number">2</span></span><br><span class="line">    inner := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">        outer_var += <span class="number">99</span> <span class="comment">// outer_var from outer scope is mutated.</span></span><br><span class="line">        <span class="keyword">return</span> outer_var</span><br><span class="line">    &#125;</span><br><span class="line">    inner()</span><br><span class="line">    <span class="keyword">return</span> inner, outer_var <span class="comment">// return inner func and mutated outer_var 101</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Variadic-Functions"><a href="#Variadic-Functions" class="headerlink" title="Variadic Functions"></a>Variadic Functions</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(adder(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)) 	<span class="comment">// 6</span></span><br><span class="line">	fmt.Println(adder(<span class="number">9</span>, <span class="number">9</span>))	<span class="comment">// 18</span></span><br><span class="line"></span><br><span class="line">	nums := []<span class="keyword">int</span>&#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>&#125;</span><br><span class="line">	fmt.Println(adder(nums...))	<span class="comment">// 60</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// By using ... before the type name of the last parameter you can indicate that it takes zero or more of those parameters.</span></span><br><span class="line"><span class="comment">// The function is invoked like any other function except we can pass as many arguments as we want.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">adder</span><span class="params">(args ...<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	total := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> args &#123; <span class="comment">// Iterates over the arguments whatever the number.</span></span><br><span class="line">		total += v</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> total</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Built-in-Types"><a href="#Built-in-Types" class="headerlink" title="Built-in Types"></a>Built-in Types</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bool</span><br><span class="line"></span><br><span class="line">string</span><br><span class="line"></span><br><span class="line">int  int8  int16  int32  int64</span><br><span class="line">uint uint8 uint16 uint32 uint64 uintptr</span><br><span class="line"></span><br><span class="line">byte // alias for uint8</span><br><span class="line"></span><br><span class="line">rune // alias for int32 ~= a character (Unicode code point) - very Viking</span><br><span class="line"></span><br><span class="line">float32 float64</span><br><span class="line"></span><br><span class="line">complex64 complex128</span><br></pre></td></tr></table></figure>
<h2 id="Type-Conversions"><a href="#Type-Conversions" class="headerlink" title="Type Conversions"></a>Type Conversions</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> i <span class="keyword">int</span> = <span class="number">42</span></span><br><span class="line"><span class="keyword">var</span> f <span class="keyword">float64</span> = <span class="keyword">float64</span>(i)</span><br><span class="line"><span class="keyword">var</span> u <span class="keyword">uint</span> = <span class="keyword">uint</span>(f)</span><br><span class="line"></span><br><span class="line"><span class="comment">// alternative syntax</span></span><br><span class="line">i := <span class="number">42</span></span><br><span class="line">f := <span class="keyword">float64</span>(i)</span><br><span class="line">u := <span class="keyword">uint</span>(f)</span><br></pre></td></tr></table></figure>
<h2 id="Packages"><a href="#Packages" class="headerlink" title="Packages"></a>Packages</h2><ul>
<li>Package declaration at top of every source file</li>
<li>Executables are in package <code>main</code></li>
<li>Convention: package name == last name of import path (import path <code>math/rand</code> =&gt; package <code>rand</code>)</li>
<li>Upper case identifier: exported (visible from other packages)</li>
<li>Lower case identifier: private (not visible from other packages)</li>
</ul>
<h2 id="Control-structures"><a href="#Control-structures" class="headerlink" title="Control structures"></a>Control structures</h2><h3 id="If"><a href="#If" class="headerlink" title="If"></a>If</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Basic one</span></span><br><span class="line">	<span class="keyword">if</span> x &gt; <span class="number">10</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> x</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> x == <span class="number">10</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">10</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> -x</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// You can put one statement before the condition</span></span><br><span class="line">	<span class="keyword">if</span> a := b + c; a &lt; <span class="number">42</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> a</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> a - <span class="number">42</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Type assertion inside if</span></span><br><span class="line">	<span class="keyword">var</span> val <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	val = <span class="string">"foo"</span></span><br><span class="line">	<span class="keyword">if</span> str, ok := val.(<span class="keyword">string</span>); ok &#123;</span><br><span class="line">		fmt.Println(str)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Loops"><a href="#Loops" class="headerlink" title="Loops"></a>Loops</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">    <span class="comment">// There's only `for`, no `while`, no `until`</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ; i &lt; <span class="number">10</span>;  &#123; <span class="comment">// while - loop</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i &lt; <span class="number">10</span>  &#123; <span class="comment">// you can omit semicolons if there is only a condition</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> &#123; <span class="comment">// you can omit the condition ~ while (true)</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// use break/continue on current loop</span></span><br><span class="line">    <span class="comment">// use break/continue with label on outer loop</span></span><br><span class="line">here:</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">for</span> j := i + <span class="number">1</span>; j &lt; <span class="number">3</span>; j++ &#123;</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span> here</span><br><span class="line">            &#125;</span><br><span class="line">            fmt.Println(j)</span><br><span class="line">            <span class="keyword">if</span> j == <span class="number">2</span> &#123;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">there:</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">for</span> j := i + <span class="number">1</span>; j &lt; <span class="number">3</span>; j++ &#123;</span><br><span class="line">            <span class="keyword">if</span> j == <span class="number">1</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            fmt.Println(j)</span><br><span class="line">            <span class="keyword">if</span> j == <span class="number">2</span> &#123;</span><br><span class="line">                <span class="keyword">break</span> there</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Switch"><a href="#Switch" class="headerlink" title="Switch"></a>Switch</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// switch statement</span></span><br><span class="line"><span class="keyword">switch</span> operatingSystem &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"darwin"</span>:</span><br><span class="line">    fmt.Println(<span class="string">"Mac OS Hipster"</span>)</span><br><span class="line">    <span class="comment">// cases break automatically, no fallthrough by default</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"linux"</span>:</span><br><span class="line">    fmt.Println(<span class="string">"Linux Geek"</span>)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// Windows, BSD, ...</span></span><br><span class="line">    fmt.Println(<span class="string">"Other"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// as with for and if, you can have an assignment statement before the switch value</span></span><br><span class="line"><span class="keyword">switch</span> os := runtime.GOOS; os &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"darwin"</span>: ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// you can also make comparisons in switch cases</span></span><br><span class="line">number := <span class="number">42</span></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> number &lt; <span class="number">42</span>:</span><br><span class="line">        fmt.Println(<span class="string">"Smaller"</span>)</span><br><span class="line">    <span class="keyword">case</span> number == <span class="number">42</span>:</span><br><span class="line">        fmt.Println(<span class="string">"Equal"</span>)</span><br><span class="line">    <span class="keyword">case</span> number &gt; <span class="number">42</span>:</span><br><span class="line">        fmt.Println(<span class="string">"Greater"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cases can be presented in comma-separated lists</span></span><br><span class="line"><span class="keyword">var</span> char <span class="keyword">byte</span> = <span class="string">'?'</span></span><br><span class="line"><span class="keyword">switch</span> char &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">' '</span>, <span class="string">'?'</span>, <span class="string">'&amp;'</span>, <span class="string">'='</span>, <span class="string">'#'</span>, <span class="string">'+'</span>, <span class="string">'%'</span>:</span><br><span class="line">        fmt.Println(<span class="string">"Should escape"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Arrays-Slices-Ranges"><a href="#Arrays-Slices-Ranges" class="headerlink" title="Arrays, Slices, Ranges"></a>Arrays, Slices, Ranges</h2><h3 id="Arrays"><a href="#Arrays" class="headerlink" title="Arrays"></a>Arrays</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a [<span class="number">10</span>]<span class="keyword">int</span> <span class="comment">// declare an int array with length 10. Array length is part of the type!</span></span><br><span class="line">a[<span class="number">3</span>] = <span class="number">42</span>     <span class="comment">// set elements</span></span><br><span class="line">i := a[<span class="number">3</span>]     <span class="comment">// read elements</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// declare and initialize</span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">2</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">a := [<span class="number">2</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>&#125; <span class="comment">//shorthand</span></span><br><span class="line">a := [...]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>&#125; <span class="comment">// elipsis -&gt; Compiler figures out array length</span></span><br></pre></td></tr></table></figure>
<h3 id="Slices"><a href="#Slices" class="headerlink" title="Slices"></a>Slices</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a []<span class="keyword">int</span>                              <span class="comment">// declare a slice - similar to an array, but length is unspecified</span></span><br><span class="line"><span class="keyword">var</span> a = []<span class="keyword">int</span> &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;               <span class="comment">// declare and initialize a slice (backed by the array given implicitly)</span></span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;                   <span class="comment">// shorthand</span></span><br><span class="line">chars := []<span class="keyword">string</span>&#123;<span class="number">0</span>:<span class="string">"a"</span>, <span class="number">2</span>:<span class="string">"c"</span>, <span class="number">1</span>: <span class="string">"b"</span>&#125;  <span class="comment">// ["a", "b", "c"]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = a[lo:hi]	<span class="comment">// creates a slice (view of the array) from index lo to hi-1</span></span><br><span class="line"><span class="keyword">var</span> b = a[<span class="number">1</span>:<span class="number">4</span>]		<span class="comment">// slice from index 1 to 3</span></span><br><span class="line"><span class="keyword">var</span> b = a[:<span class="number">3</span>]		<span class="comment">// missing low index implies 0</span></span><br><span class="line"><span class="keyword">var</span> b = a[<span class="number">3</span>:]		<span class="comment">// missing high index implies len(a)</span></span><br><span class="line">a =  <span class="built_in">append</span>(a,<span class="number">17</span>,<span class="number">3</span>)	<span class="comment">// append items to slice a</span></span><br><span class="line">c := <span class="built_in">append</span>(a,b...)	<span class="comment">// concatenate slices a and b</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// create a slice with make</span></span><br><span class="line">a = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">5</span>, <span class="number">5</span>)	<span class="comment">// first arg length, second capacity</span></span><br><span class="line">a = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">5</span>)	<span class="comment">// capacity is optional</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// create a slice from an array</span></span><br><span class="line">x := [<span class="number">3</span>]<span class="keyword">string</span>&#123;<span class="string">"Лайка"</span>, <span class="string">"Белка"</span>, <span class="string">"Стрелка"</span>&#125;</span><br><span class="line">s := x[:] <span class="comment">// a slice referencing the storage of x</span></span><br></pre></td></tr></table></figure>
<h3 id="Operations-on-Arrays-and-Slices"><a href="#Operations-on-Arrays-and-Slices" class="headerlink" title="Operations on Arrays and Slices"></a>Operations on Arrays and Slices</h3><p><code>len(a)</code> gives you the length of an array/a slice. It’s a built-in function, not a attribute/method on the array.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// loop over an array/a slice</span></span><br><span class="line"><span class="keyword">for</span> i, e := <span class="keyword">range</span> a &#123;</span><br><span class="line">    <span class="comment">// i is the index, e the element</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// if you only need e:</span></span><br><span class="line"><span class="keyword">for</span> _, e := <span class="keyword">range</span> a &#123;</span><br><span class="line">    <span class="comment">// e is the element</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...and if you only need the index</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> a &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// In Go pre-1.4, you'll get a compiler error if you're not using i and e.</span></span><br><span class="line"><span class="comment">// Go 1.4 introduced a variable-free form, so that you can do this</span></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">range</span> time.Tick(time.Second) &#123;</span><br><span class="line">    <span class="comment">// do it once a sec</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> m <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></span><br><span class="line">m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</span><br><span class="line">m[<span class="string">"key"</span>] = <span class="number">42</span></span><br><span class="line">fmt.Println(m[<span class="string">"key"</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">delete</span>(m, <span class="string">"key"</span>)</span><br><span class="line"></span><br><span class="line">elem, ok := m[<span class="string">"key"</span>] <span class="comment">// test if key "key" is present and retrieve it, if so</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// map literal</span></span><br><span class="line"><span class="keyword">var</span> m = <span class="keyword">map</span>[<span class="keyword">string</span>]Vertex&#123;</span><br><span class="line">    <span class="string">"Bell Labs"</span>: &#123;<span class="number">40.68433</span>, <span class="number">-74.39967</span>&#125;,</span><br><span class="line">    <span class="string">"Google"</span>:    &#123;<span class="number">37.42202</span>, <span class="number">-122.08408</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// iterate over map content</span></span><br><span class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> m &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Structs"><a href="#Structs" class="headerlink" title="Structs"></a>Structs</h2><p>There are no classes, only structs. Structs can have methods.<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A struct is a type. It's also a collection of fields</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Declaration</span></span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</span><br><span class="line">    X, Y <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creating</span></span><br><span class="line"><span class="keyword">var</span> v = Vertex&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line"><span class="keyword">var</span> v = Vertex&#123;X: <span class="number">1</span>, Y: <span class="number">2</span>&#125; <span class="comment">// Creates a struct by defining values with keys</span></span><br><span class="line"><span class="keyword">var</span> v = []Vertex&#123;&#123;<span class="number">1</span>,<span class="number">2</span>&#125;,&#123;<span class="number">5</span>,<span class="number">2</span>&#125;,&#123;<span class="number">5</span>,<span class="number">5</span>&#125;&#125; <span class="comment">// Initialize a slice of structs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Accessing members</span></span><br><span class="line">v.X = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You can declare methods on structs. The struct you want to declare the</span></span><br><span class="line"><span class="comment">// method on (the receiving type) comes between the the func keyword and</span></span><br><span class="line"><span class="comment">// the method name. The struct is copied on each method call(!)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v Vertex)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> math.Sqrt(v.X*v.X + v.Y*v.Y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Call method</span></span><br><span class="line">v.Abs()</span><br><span class="line"></span><br><span class="line"><span class="comment">// For mutating methods, you need to use a pointer (see below) to the Struct</span></span><br><span class="line"><span class="comment">// as the type. With this, the struct value is not copied for the method call.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">add</span><span class="params">(n <span class="keyword">float64</span>)</span></span> &#123;</span><br><span class="line">    v.X += n</span><br><span class="line">    v.Y += n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Anonymous structs:</strong><br>Cheaper and safer than using <code>map[string]interface{}</code>.<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">point := <span class="keyword">struct</span> &#123;</span><br><span class="line">	X, Y <span class="keyword">int</span></span><br><span class="line">&#125;&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Pointers"><a href="#Pointers" class="headerlink" title="Pointers"></a>Pointers</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">p := Vertex&#123;<span class="number">1</span>, <span class="number">2</span>&#125;  <span class="comment">// p is a Vertex</span></span><br><span class="line">q := &amp;p            <span class="comment">// q is a pointer to a Vertex</span></span><br><span class="line">r := &amp;Vertex&#123;<span class="number">1</span>, <span class="number">2</span>&#125; <span class="comment">// r is also a pointer to a Vertex</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The type of a pointer to a Vertex is *Vertex</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s *Vertex = <span class="built_in">new</span>(Vertex) <span class="comment">// new creates a pointer to a new struct instance</span></span><br></pre></td></tr></table></figure>
<h2 id="Interfaces"><a href="#Interfaces" class="headerlink" title="Interfaces"></a>Interfaces</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// interface declaration</span></span><br><span class="line"><span class="keyword">type</span> Awesomizer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Awesomize() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// types do *not* declare to implement interfaces</span></span><br><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// instead, types implicitly satisfy an interface if they implement all required methods</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(foo Foo)</span> <span class="title">Awesomize</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Awesome!"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Embedding"><a href="#Embedding" class="headerlink" title="Embedding"></a>Embedding</h2><p>There is no subclassing in Go. Instead, there is interface and struct embedding.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ReadWriter implementations must satisfy both Reader and Writer</span></span><br><span class="line"><span class="keyword">type</span> ReadWriter <span class="keyword">interface</span> &#123;</span><br><span class="line">    Reader</span><br><span class="line">    Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Server exposes all the methods that Logger has</span></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">    Host <span class="keyword">string</span></span><br><span class="line">    Port <span class="keyword">int</span></span><br><span class="line">    *log.Logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// initialize the embedded type the usual way</span></span><br><span class="line">server := &amp;Server&#123;<span class="string">"localhost"</span>, <span class="number">80</span>, log.New(...)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// methods implemented on the embedded struct are passed through</span></span><br><span class="line">server.Log(...) <span class="comment">// calls server.Logger.Log(...)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// the field name of the embedded type is its type name (in this case Logger)</span></span><br><span class="line"><span class="keyword">var</span> logger *log.Logger = server.Logger</span><br></pre></td></tr></table></figure>
<h2 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h2><p>There is no exception handling. Functions that might produce an error just declare an additional return value of type <code>Error</code>. This is the <code>Error</code> interface:<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</span><br><span class="line">    Error() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>A function that might return an error:<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doStuff</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    result, err := doStuff()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// handle error</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// all is good, use result</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Concurrency"><a href="#Concurrency" class="headerlink" title="Concurrency"></a>Concurrency</h1><h2 id="Goroutines"><a href="#Goroutines" class="headerlink" title="Goroutines"></a>Goroutines</h2><p>Goroutines are lightweight threads (managed by Go, not OS threads). <code>go f(a, b)</code> starts a new goroutine which runs <code>f</code> (given <code>f</code> is a function).</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// just a function (which can be later started as a goroutine)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doStuff</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// using a named function in a goroutine</span></span><br><span class="line">    <span class="keyword">go</span> doStuff(<span class="string">"foobar"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// using an anonymous inner function in a goroutine</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span> <span class="params">(x <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// function body goes here</span></span><br><span class="line">    &#125;(<span class="number">42</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">// create a channel of type int</span></span><br><span class="line">ch &lt;- <span class="number">42</span>             <span class="comment">// Send a value to the channel ch.</span></span><br><span class="line">v := &lt;-ch            <span class="comment">// Receive a value from ch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Non-buffered channels block. Read blocks when no value is available, write blocks until there is a read.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a buffered channel. Writing to a buffered channels does not block if less than &lt;buffer size&gt; unread values have been written.</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">close</span>(ch) <span class="comment">// closes the channel (only sender should close)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// read from channel and test if it has been closed</span></span><br><span class="line">v, ok := &lt;-ch</span><br><span class="line"></span><br><span class="line"><span class="comment">// if ok is false, channel has been closed</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Read from channel until it is closed</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> ch &#123;</span><br><span class="line">    fmt.Println(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// select blocks on multiple channel operations, if one unblocks, the corresponding case is executed</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doStuff</span><span class="params">(channelOut, channelIn <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> channelOut &lt;- <span class="number">42</span>:</span><br><span class="line">        fmt.Println(<span class="string">"We could write to channelOut!"</span>)</span><br><span class="line">    <span class="keyword">case</span> x := &lt;- channelIn:</span><br><span class="line">        fmt.Println(<span class="string">"We could read from channelIn"</span>)</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(time.Second * <span class="number">1</span>):</span><br><span class="line">        fmt.Println(<span class="string">"timeout"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Channel-Axioms"><a href="#Channel-Axioms" class="headerlink" title="Channel Axioms"></a>Channel Axioms</h3><ul>
<li><p>A send to a nil channel blocks forever</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> c <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line">c &lt;- <span class="string">"Hello, World!"</span></span><br><span class="line"><span class="comment">// fatal error: all goroutines are asleep - deadlock!</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>A receive from a nil channel blocks forever</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> c <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line">fmt.Println(&lt;-c)</span><br><span class="line"><span class="comment">// fatal error: all goroutines are asleep - deadlock!</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>A send to a closed channel panics</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> c = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, <span class="number">1</span>)</span><br><span class="line">c &lt;- <span class="string">"Hello, World!"</span></span><br><span class="line"><span class="built_in">close</span>(c)</span><br><span class="line">c &lt;- <span class="string">"Hello, Panic!"</span></span><br><span class="line"><span class="comment">// panic: send on closed channel</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>A receive from a closed channel returns the zero value immediately</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> c = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">2</span>)</span><br><span class="line">c &lt;- <span class="number">1</span></span><br><span class="line">c &lt;- <span class="number">2</span></span><br><span class="line"><span class="built_in">close</span>(c)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"%d "</span>, &lt;-c)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1 2 0</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Printing"><a href="#Printing" class="headerlink" title="Printing"></a>Printing</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">fmt.Println(<span class="string">"Hello, 你好, नमस्ते, Привет, ᎣᏏᏲ"</span>) <span class="comment">// basic print, plus newline</span></span><br><span class="line">p := <span class="keyword">struct</span> &#123; X, Y <span class="keyword">int</span> &#125;&#123; <span class="number">17</span>, <span class="number">2</span> &#125;</span><br><span class="line">fmt.Println( <span class="string">"My point:"</span>, p, <span class="string">"x coord="</span>, p.X ) <span class="comment">// print structs, ints, etc</span></span><br><span class="line">s := fmt.Sprintln( <span class="string">"My point:"</span>, p, <span class="string">"x coord="</span>, p.X ) <span class="comment">// print to string variable</span></span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"%d hex:%x bin:%b fp:%f sci:%e"</span>,<span class="number">17</span>,<span class="number">17</span>,<span class="number">17</span>,<span class="number">17.0</span>,<span class="number">17.0</span>) <span class="comment">// c-ish format</span></span><br><span class="line">s2 := fmt.Sprintf( <span class="string">"%d %f"</span>, <span class="number">17</span>, <span class="number">17.0</span> ) <span class="comment">// formatted print to string variable</span></span><br><span class="line"></span><br><span class="line">hellomsg := <span class="string">`</span></span><br><span class="line"><span class="string"> "Hello" in Chinese is 你好 ('Ni Hao')</span></span><br><span class="line"><span class="string"> "Hello" in Hindi is नमस्ते ('Namaste')</span></span><br><span class="line"><span class="string">`</span> <span class="comment">// multi-line string literal, using back-tick at beginning and end</span></span><br></pre></td></tr></table></figure>
<h2 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h2><h3 id="Type-Switch"><a href="#Type-Switch" class="headerlink" title="Type Switch"></a>Type Switch</h3><p>A type switch is like a regular switch statement, but the cases in a type switch specify types (not values), and those values are compared against the type of the value held by the given interface value.<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">do</span><span class="params">(i <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> v := i.(<span class="keyword">type</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">int</span>:</span><br><span class="line">		fmt.Printf(<span class="string">"Twice %v is %v\n"</span>, v, v*<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">string</span>:</span><br><span class="line">		fmt.Printf(<span class="string">"%q is %v bytes long\n"</span>, v, <span class="built_in">len</span>(v))</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		fmt.Printf(<span class="string">"I don't know about type %T!\n"</span>, v)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	do(<span class="number">21</span>)</span><br><span class="line">	do(<span class="string">"hello"</span>)</span><br><span class="line">	do(<span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Snippets"><a href="#Snippets" class="headerlink" title="Snippets"></a>Snippets</h1><h2 id="HTTP-Server"><a href="#HTTP-Server" class="headerlink" title="HTTP Server"></a>HTTP Server</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// define a type for the response</span></span><br><span class="line"><span class="keyword">type</span> Hello <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// let that type implement the ServeHTTP method (defined in interface http.Handler)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h Hello)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    fmt.Fprint(w, <span class="string">"Hello!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> h Hello</span><br><span class="line">    http.ListenAndServe(<span class="string">"localhost:4000"</span>, h)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Here's the method signature of http.ServeHTTP:</span></span><br><span class="line"><span class="comment">// type Handler interface &#123;</span></span><br><span class="line"><span class="comment">//     ServeHTTP(w http.ResponseWriter, r *http.Request)</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title>Go Install</title>
    <url>/2020/05/02/go-install/</url>
    <content><![CDATA[<h2 id="快速安装："><a href="#快速安装：" class="headerlink" title="快速安装："></a>快速安装：</h2><blockquote>
<p>yum install go</p>
</blockquote>
<p>源码安装最新版</p>
<blockquote>
<p>git clone <a href="https://github.com/golang/go.gitcd" target="_blank" rel="noopener">https://github.com/golang/go.gitcd</a> go/git checkout 1.13版本cd srcall.bash</p>
</blockquote>
<p>成功后就将go/bin/go 添加到环境变量即可。<br>环境变量</p>
<blockquote>
<p>goexport GOPATH=$HOME/www/go:$HOME/www/baxian/baxian_sea/doc/data/tokumxexport GOBIN=$HOME/www/bin</p>
</blockquote>
<a id="more"></a>
<p>并在GOPATH下创建如下目录:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yangyu@bw-dev-yangyu-01[go] <span class="variable">$tree</span> .</span><br><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">├── pkg</span><br><span class="line">└── src</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src</span><br><span class="line">go get github.com/nsf/gocode</span><br><span class="line"><span class="built_in">cd</span> github.com/nsf/gocode/</span><br><span class="line">go build</span><br><span class="line">go install</span><br></pre></td></tr></table></figure>
<h2 id="国内镜像"><a href="#国内镜像" class="headerlink" title="国内镜像"></a>国内镜像</h2><ol>
<li>使用go1.11以上版本并开启go module机制</li>
<li>导出GOPROXY环境变量</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> GO111MODULE=onexport GOPROXY=https://goproxy.cn或者<span class="built_in">export</span> GOPROXY=https://mirrors.aliyun.com/goproxy/vim8:</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /yangyu/.vim/pack/plugins/startgit <span class="built_in">clone</span> https://github.com/fatih/vim-go.gitvi main.go:GoInstallBinaries</span><br><span class="line"></span><br><span class="line">代码提示：</span><br><span class="line"><span class="built_in">cd</span> /yangyu/.vim/pack/plugins/startgit <span class="built_in">clone</span> https://github.com/fatih/vim-go.gitvi main.go:GoInstallBinaries</span><br><span class="line">go工具</span><br><span class="line">go get golang.org/x/tools/cmd/godoc</span><br></pre></td></tr></table></figure>
<p>submit text3 插件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">Read the extension example and make sure you understand its contents. File an issue <span class="keyword">if</span> you have any concerns.</span><br><span class="line">Uninstall GoSublime</span><br><span class="line">Run the <span class="built_in">command</span> git <span class="built_in">clone</span> https://margo.sh/GoSublime to install GoSublime from the development branch.</span><br><span class="line">Restart Sublime Text. The status bar should instruct you to press ctrl+.,ctrl+x or cmd+.,cmd+x <span class="built_in">which</span> creates the margo extension file. Please <span class="built_in">read</span> all comments <span class="keyword">in</span> the file.</span><br><span class="line">If you<span class="string">'ve already switched to the new margo implementation, it might help to check the extension example for changes as there are some API breakages.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"gscomplete_enabled": true,</span></span><br><span class="line"><span class="string"> // Whether or not gsfmt is enabled</span></span><br><span class="line"><span class="string">"fmt_enabled": true,</span></span><br></pre></td></tr></table></figure>
<p>vs code 插件安装</p>
<blockquote>
<p><a href="https://www.cnblogs.com/yangxiaoyi/p/9692369.html" target="_blank" rel="noopener">https://www.cnblogs.com/yangxiaoyi/p/9692369.html</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">vscode setting.json</span><br><span class="line"><span class="string">"go.formatTool"</span>: <span class="string">"goimports"</span>,</span><br><span class="line"><span class="string">"go.goroot"</span>: <span class="string">"/usr/local/Cellar/go/1.13.5/libexec"</span>,</span><br><span class="line"><span class="string">"go.gopath"</span>: <span class="string">"/Users/change/go"</span>,</span><br><span class="line"><span class="string">"go.useLanguageServer"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"go.autocompleteUnimportedPackages"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">"go.docsTool"</span>: <span class="string">"gogetdoc"</span>,</span><br></pre></td></tr></table></figure>
<p>镜像，是否使用1.11以上mod模式</p>
<blockquote>
<p>go env -w GO111MODULE=on</p>
</blockquote>
<blockquote>
<p>go env -w GOPROXY=<a href="https://goproxy.cn,direct" target="_blank" rel="noopener">https://goproxy.cn,direct</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GOROOT：就是go的安装环境</span><br><span class="line">GOPATH：作为编译后二进制的存放目的地和import包时的搜索路径。其实说通俗点就是你的go项目工作目录。通常情况下GOPATH包含三个目录：bin、pkg、src。</span><br><span class="line">src目录下主要存放go的源文件</span><br><span class="line">pkg目录存放编译好的库文件，主要是*.a文件;</span><br><span class="line">bin目录主要存放可执行文件</span><br><span class="line"></span><br><span class="line">go run 运行当个.go文件</span><br><span class="line">go install 在编译源代码之后还安装到指定的目录</span><br><span class="line">go build 加上可编译的go源文件可以得到一个可执行文件</span><br><span class="line">go get = git <span class="built_in">clone</span> + go install 从指定源上面下载或者更新指定的代码和依赖，并对他们进行编译和安装</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title>Google 搜索技巧</title>
    <url>/2020/05/02/google-use-skill/</url>
    <content><![CDATA[<h1 id="Google-搜索技巧"><a href="#Google-搜索技巧" class="headerlink" title="Google 搜索技巧"></a>Google 搜索技巧</h1><ol>
<li>使用“本尊”</li>
</ol>
<p>最好使用 <a href="http://www.google.com/ncr" target="_blank" rel="noopener">http://www.google.com/ncr</a> NCR: No Country Redirection，而不是<a href="http://www.google.com.hk；有时，直接输入http://www.google.com也会被自动转到“本地Google”，比如，我用日本的" target="_blank" rel="noopener">http://www.google.com.hk；有时，直接输入http://www.google.com也会被自动转到“本地Google”，比如，我用日本的</a> VPN，浏览器就会把我转到<a href="http://www.google.co.jp……" target="_blank" rel="noopener">http://www.google.co.jp……</a></p>
<ol start="2">
<li>优先使用英文关键字搜索</li>
</ol>
<p>这是个好习惯。别说不会英文，不会就学，没那么难。</p>
<ol start="3">
<li>基本技巧</li>
</ol>
<p>Google 搜索引擎也许是世界上最简单的应用界面，只有一个输入框和一个按钮。然而，用好它还是需要花点时间去学习的。Google 有帮助文档，还专门设计了个学习网站 A Google A Day</p>
<p>a）加号</p>
<p>在 Google 的输入框里，所有的空格都被 Google 理解为加号+。如果你输入的是 purpose of education那么 Google 返回的文章里既有“purpose”存在，也有“education”存在，但不一定有“purpose of education”存在。另外，过分常用的、单独存在没有意义的词汇往往被忽略掉，比如冠词“a”、“the”；介词“of”、“in”、“on”、“at”、“to”；连词“and”、“or”、“but”；从属连词“that”、“which”、“when”；代词“my”、“his”、“them”等等。</p>
<a id="more"></a>
<p>b）引号</p>
<p>如果你想要找含有“purpose of education”这个词组的文章，那么你必须输入”purpose of education”。现在的 Google 已经可以处理 utf-8 大字符集了，所以，即便你在输入的时候使用的是全角字符（不是半角字符的”而是“或者”）Google也照样能够正确处理。比较一下两种输入返回的结果：purpose of education vs.“purpose of education”。再试试 the most important benefit of education 和 “the most important benefit of education”。这就是引号（“……”）的作用——返回“完整匹配”的结果。</p>
<p>c）减号</p>
<p>为了进一步筛选搜索结果，还需要学会另外一个符号——减号-。比如，“the most important benefit of education” – “united states”要求Google返回含有“the most important benefit of education”但不存在“united states”的文章。</p>
<p>d）星号</p>
<p>另外一个威力无穷的符号是星号<em>。Google 支持通配符搜索，即搜索字符串中可以包含星号</em>，用来替代任意字符串。比如，“the most * examples of censorship”将会返回含有类似“the most outrageous examples of censorship”、“the most brazen examples of censorship”、“the most heinous examples of censorship”、“the most stupidest examples of censorship”、“the most dangerous examples of censorship”、“the most egregious examples of censorship”、“the most prolific examples of censorship”、“the most absurd examples of censorship”……</p>
<p>e）波浪号</p>
<p>还有一个运用相当灵活、经常带来意外收获的符号是波浪号~。把波浪号~加在某个单词前面，是在告诉 Google：除了给出的关键字之外，还要搜索与波浪号~后面的那个单词相关的词汇。比如，搜索the importance of ~censorship的结果中包含着“the importance of censorship”，也包含着与censorship相关的另外一个词汇“propaganda”——“the importance of propaganda”。</p>
<ol start="4">
<li>高级技巧</li>
</ol>
<p>a）站内搜索</p>
<p>再学一个在指定网站中搜索的语法“site:”。比如，“the purpose of education” site:<a href="http://www.time.com/就是要求" target="_blank" rel="noopener">http://www.time.com/就是要求</a> Google 只返回 <a href="http://www.time.com" target="_blank" rel="noopener">http://www.time.com</a> 这个网站里的含有“the purpose of education”的文章。</p>
<p>b）定制搜索</p>
<p>2006年，Google 推出了“co-op”服务（自定义搜索引擎）。其中最常用的功能之一就是可以指定 Google 搜索一个或者若干个指定的网站——相当于前面提到的 Google 语法“site:”的扩展。比如，我就曾经为我的学生定制了一个 Google cse（Custom Search Engine）——Search News Media。不妨看看在这个自定义搜索引擎上搜索censorship返回的结果（GRE/SAT 的作文考试中，都有很多关于“censorship”的作文题）。这个 cse 只搜索以下10个网站：</p>
<blockquote>
<ul>
<li><a href="http://www.economist.com/" target="_blank" rel="noopener">http://www.economist.com/</a></li>
<li><a href="http://www.cnn.com/" target="_blank" rel="noopener">http://www.cnn.com/</a></li>
<li><a href="http://www.time.com/" target="_blank" rel="noopener">http://www.time.com/</a></li>
<li><a href="http://nytimes.com/" target="_blank" rel="noopener">http://nytimes.com/</a></li>
<li><a href="http://www.washingtonpost.com/" target="_blank" rel="noopener">http://www.washingtonpost.com/</a></li>
<li><a href="http://www.usnews.com/" target="_blank" rel="noopener">http://www.usnews.com/</a></li>
<li><a href="http://usatoday.com/" target="_blank" rel="noopener">http://usatoday.com/</a></li>
<li><a href="http://www.reuters.com/" target="_blank" rel="noopener">http://www.reuters.com/</a></li>
<li><a href="http://www.bbc.co.uk/" target="_blank" rel="noopener">http://www.bbc.co.uk/</a></li>
<li><a href="http://en.wikinews.org/" target="_blank" rel="noopener">http://en.wikinews.org/</a></li>
</ul>
</blockquote>
]]></content>
      <tags>
        <tag>google</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql 5.7 以上版本对JSON字段的操作</title>
    <url>/2020/05/02/mysql57-json/</url>
    <content><![CDATA[<p><a href="https://dev.mysql.com/doc/refman/5.7/en/json.html" target="_blank" rel="noopener">官方文档mysql 5.7 json</a><br><a href="https://dev.mysql.com/doc/refman/5.7/en/json-functions.html" target="_blank" rel="noopener">官方文档mysql 5.7 json functions</a></p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/json.html" target="_blank" rel="noopener">官方文档mysql 8.0 json</a></p>
<a id="more"></a>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>-&gt;</td>
<td>Return value from JSON column after evaluating path; equivalent to JSON_EXTRACT().</td>
</tr>
<tr>
<td>-&gt;&gt;?(introduced 5.7.13)</td>
<td>Return value from JSON column after evaluating path and unquoting the result; equivalent to JSON_UNQUOTE(JSON_EXTRACT()).</td>
</tr>
<tr>
<td>JSON_APPEND()?(deprecated)</td>
<td>Append data to JSON document</td>
</tr>
<tr>
<td>JSON_ARRAY()</td>
<td>Create JSON array</td>
</tr>
<tr>
<td>JSON_ARRAY_APPEND()</td>
<td>Append data to JSON document</td>
</tr>
<tr>
<td>JSON_ARRAY_INSERT()</td>
<td>Insert into JSON array</td>
</tr>
<tr>
<td>JSON_CONTAINS()</td>
<td>Whether JSON document contains specific object at path</td>
</tr>
<tr>
<td>JSON_CONTAINS_PATH()</td>
<td>Whether JSON document contains any data at path</td>
</tr>
<tr>
<td>JSON_DEPTH()</td>
<td>Maximum depth of JSON document</td>
</tr>
<tr>
<td>JSON_EXTRACT()</td>
<td>Return data from JSON document</td>
</tr>
<tr>
<td>JSON_INSERT()</td>
<td>Insert data into JSON document</td>
</tr>
<tr>
<td>JSON_KEYS()</td>
<td>Array of keys from JSON document</td>
</tr>
<tr>
<td>JSON_LENGTH()</td>
<td>Number of elements in JSON document</td>
</tr>
<tr>
<td>JSON_MERGE()?(deprecated 5.7.22)</td>
<td>“Merge JSON documents</td>
<td>preserving duplicate keys. Deprecated synonym for JSON_MERGE_PRESERVE()”</td>
</tr>
<tr>
<td>JSON_MERGE_PATCH()?(introduced 5.7.22)</td>
<td>“Merge JSON documents</td>
<td>replacing values of duplicate keys”</td>
</tr>
<tr>
<td>JSON_MERGE_PRESERVE()?(introduced 5.7.22)</td>
<td>“Merge JSON documents</td>
<td>preserving duplicate keys”</td>
</tr>
<tr>
<td>JSON_OBJECT()</td>
<td>Create JSON object</td>
</tr>
<tr>
<td>JSON_PRETTY()?(introduced 5.7.22)</td>
<td>Print a JSON document in human-readable format</td>
</tr>
<tr>
<td>JSON_QUOTE()</td>
<td>Quote JSON document</td>
</tr>
<tr>
<td>JSON_REMOVE()</td>
<td>Remove data from JSON document</td>
</tr>
<tr>
<td>JSON_REPLACE()</td>
<td>Replace values in JSON document</td>
</tr>
<tr>
<td>JSON_SEARCH()</td>
<td>Path to value within JSON document</td>
</tr>
<tr>
<td>JSON_SET()</td>
<td>Insert data into JSON document</td>
</tr>
<tr>
<td>JSON_STORAGE_SIZE()?(introduced 5.7.22)</td>
<td>Space used for storage of binary representation of a JSON document</td>
</tr>
<tr>
<td>JSON_TYPE()</td>
<td>Type of JSON value</td>
</tr>
<tr>
<td>JSON_UNQUOTE()</td>
<td>Unquote JSON value</td>
</tr>
<tr>
<td>JSON_VALID()</td>
<td>Whether JSON value is valid</td>
</tr>
</tbody>
</table>
<p>JSON_ARRAY  json数组</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT JSON_ARRAY(1, "abc", NULL, TRUE, CURTIME());</span><br><span class="line">+<span class="comment">---------------------------------------------+</span></span><br><span class="line">| JSON_ARRAY(1, "abc", NULL, TRUE, CURTIME()) |</span><br><span class="line">+<span class="comment">---------------------------------------------+</span></span><br><span class="line">| [1, "abc", null, true, "11:30:24.000000"]   |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- write table</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1(jdoc <span class="keyword">json</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1(jdoc) <span class="keyword">values</span>(json_array(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="keyword">now</span>()));</span><br></pre></td></tr></table></figure>
<p>JSON_OBJECT</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT JSON_OBJECT('key1', 1, 'key2', 'abc');</span><br><span class="line">+<span class="comment">---------------------------------------+</span></span><br><span class="line">| JSON_OBJECT('key1', 1, 'key2', 'abc') |</span><br><span class="line">+<span class="comment">---------------------------------------+</span></span><br><span class="line">| &#123;"key1": 1, "key2": "abc"&#125;            |</span><br><span class="line">+<span class="comment">---------------------------------------+</span></span><br></pre></td></tr></table></figure>
<p>JSON_EXTRACT 查询json列  同 column-&gt;path</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT JSON_EXTRACT('&#123;"id": 14, "name": "Aztalan"&#125;', '$.name');</span><br><span class="line">+<span class="comment">---------------------------------------------------------+</span></span><br><span class="line">| JSON_EXTRACT('&#123;"id": 14, "name": "Aztalan"&#125;', '$.name') |</span><br><span class="line">+<span class="comment">---------------------------------------------------------+</span></span><br><span class="line">| "Aztalan"                                               |</span><br><span class="line">+<span class="comment">---------------------------------------------------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- demo</span></span><br><span class="line"><span class="comment">-- 对于某一列是json而言，需要使用内置的函数 json_extract(列名,'$.key') --这个函数有2个参数，第一个参数是json列的列名，第二个参数$.key 其中key为json字符串中某一个key。</span></span><br><span class="line"></span><br><span class="line">&gt; SELECT uid,json_extract(info,'$.mail') AS 'mail',json_extract(info,'$.name') AS 'name' FROM USER;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT c, JSON_EXTRACT(c, "$.id"), g</span><br><span class="line">     &gt; FROM jemp</span><br><span class="line">     &gt; WHERE JSON_EXTRACT(c, "$.id") &gt; 1</span><br><span class="line">     &gt; ORDER BY JSON_EXTRACT(c, "$.name");</span><br><span class="line">+<span class="comment">-------------------------------+-----------+------+</span></span><br><span class="line">| c                             | c-&gt;"$.id" | g    |</span><br><span class="line">+<span class="comment">-------------------------------+-----------+------+</span></span><br><span class="line">| &#123;"id": "3", "name": "Barney"&#125; | "3"       |    3 |</span><br><span class="line">| &#123;"id": "4", "name": "Betty"&#125;  | "4"       |    4 |</span><br><span class="line">| &#123;"id": "2", "name": "Wilma"&#125;  | "2"       |    2 |</span><br><span class="line">+<span class="comment">-------------------------------+-----------+------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SELECT</span> c, c-&gt;<span class="string">"$.id"</span>, g</span><br><span class="line">     &gt; <span class="keyword">FROM</span> jemp</span><br><span class="line">     &gt; <span class="keyword">WHERE</span> c-&gt;<span class="string">"$.id"</span> &gt; <span class="number">1</span></span><br><span class="line">     &gt; <span class="keyword">ORDER</span> <span class="keyword">BY</span> c-&gt;<span class="string">"$.name"</span>;</span><br><span class="line">+<span class="comment">-------------------------------+-----------+------+</span></span><br><span class="line">| c                             | c-&gt;"$.id" | g    |</span><br><span class="line">+<span class="comment">-------------------------------+-----------+------+</span></span><br><span class="line">| &#123;"id": "3", "name": "Barney"&#125; | "3"       |    3 |</span><br><span class="line">| &#123;"id": "4", "name": "Betty"&#125;  | "4"       |    4 |</span><br><span class="line">| &#123;"id": "2", "name": "Wilma"&#125;  | "2"       |    2 |</span><br><span class="line">+<span class="comment">-------------------------------+-----------+------+</span></span><br></pre></td></tr></table></figure>
<p>column-&gt;&gt;path</p>
<p>等价于</p>
<blockquote>
<p>JSON_UNQUOTE( JSON_EXTRACT(column, path) )</p>
</blockquote>
<blockquote>
<p>JSON_UNQUOTE(column -&gt; path)</p>
</blockquote>
<blockquote>
<p>column-&gt;&gt;path</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM jemp WHERE g &gt; 2;</span><br><span class="line">+-------------------------------+------+</span><br><span class="line">| c                             | g    |</span><br><span class="line">+-------------------------------+------+</span><br><span class="line">| &#123;&quot;id&quot;: &quot;3&quot;, &quot;name&quot;: &quot;Barney&quot;&#125; |    3 |</span><br><span class="line">| &#123;&quot;id&quot;: &quot;4&quot;, &quot;name&quot;: &quot;Betty&quot;&#125;  |    4 |</span><br><span class="line">+-------------------------------+------+</span><br><span class="line">2 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT c-&gt;&apos;$.name&apos; AS name</span><br><span class="line">    -&gt;     FROM jemp WHERE g &gt; 2;</span><br><span class="line">+----------+</span><br><span class="line">| name     |</span><br><span class="line">+----------+</span><br><span class="line">| &quot;Barney&quot; |</span><br><span class="line">| &quot;Betty&quot;  |</span><br><span class="line">+----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT JSON_UNQUOTE(c-&gt;&apos;$.name&apos;) AS name</span><br><span class="line">    -&gt;     FROM jemp WHERE g &gt; 2;</span><br><span class="line">+--------+</span><br><span class="line">| name   |</span><br><span class="line">+--------+</span><br><span class="line">| Barney |</span><br><span class="line">| Betty  |</span><br><span class="line">+--------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT c-&gt;&gt;&apos;$.name&apos; AS name</span><br><span class="line">    -&gt;     FROM jemp WHERE g &gt; 2;</span><br><span class="line">+--------+</span><br><span class="line">| name   |</span><br><span class="line">+--------+</span><br><span class="line">| Barney |</span><br><span class="line">| Betty  |</span><br><span class="line">+--------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>JSON_TYPE</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT JSON_TYPE('["a", "b", 1]');</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| JSON_TYPE('["a", "b", 1]') |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| ARRAY                      |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT JSON_TYPE('"hello"');</span><br><span class="line">+<span class="comment">----------------------+</span></span><br><span class="line">| JSON_TYPE('"hello"') |</span><br><span class="line">+<span class="comment">----------------------+</span></span><br><span class="line">| STRING               |</span><br><span class="line">+<span class="comment">----------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- error</span></span><br><span class="line">mysql&gt; SELECT JSON_TYPE('hello');</span><br><span class="line">ERROR 3146 (22032): Invalid data type for JSON data in argument 1</span><br><span class="line">to function json_type; a JSON string or JSON type is required.</span><br></pre></td></tr></table></figure>
<p>JSON_MERGE</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT JSON_MERGE('["a", 1]', '&#123;"key": "value"&#125;');</span><br><span class="line">+<span class="comment">--------------------------------------------+</span></span><br><span class="line">| JSON_MERGE('["a", 1]', '&#123;"key": "value"&#125;') |</span><br><span class="line">+<span class="comment">--------------------------------------------+</span></span><br><span class="line">| ["a", 1, &#123;"key": "value"&#125;]                 |</span><br><span class="line">+<span class="comment">--------------------------------------------+</span></span><br></pre></td></tr></table></figure>
<p>JSON_SEARCH(json_doc, one_or_all, search_str[, escape_char[, path] …])</p>
<p>如果json_doc，search_str或path参数中的任何一个为NULL，则返回NULL；否则返回NULL。文档内没有路径；或找不到search_str。<br>如果json_doc参数不是有效的JSON文档，任何路径参数不是有效的路径表达式，one_or_all不是’one’或’all’或escape_char不是常量表达式，则会发生错误。</p>
<p>要在搜索字符串中指定文字％或_字符，请在其前面加上转义字符。如果escape_char参数丢失或为NULL，则默认值为\。否则，scape_char必须为空或一个字符的常量。<br>search_str:  % 匹配任意的字符（含0）, _  完全匹配一个字符</p>
<p>如果在准备好的语句中使用了JSON_SEARCH（），并且使用？提供了escape_char参数？参数，参数值在执行时可能是恒定的，但在编译时却不是。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SET @j = '["abc", [&#123;"k": "10"&#125;, "def"], &#123;"x":"abc"&#125;, &#123;"y":"bcd"&#125;]';</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT JSON_SEARCH(@j, 'one', 'abc');</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| JSON_SEARCH(@j, 'one', 'abc') |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| "$[0]"                        |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT JSON_SEARCH(@j, 'all', 'abc');</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| JSON_SEARCH(@j, 'all', 'abc') |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| ["$[0]", "$[2].x"]            |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT JSON_SEARCH(@j, 'all', 'ghi');</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| JSON_SEARCH(@j, 'all', 'ghi') |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| NULL                          |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br></pre></td></tr></table></figure>
<p>JSON_CONTAINS(target, candidate[, path])</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SET @j = '&#123;"a": 1, "b": 2, "c": &#123;"d": 4&#125;&#125;';</span><br><span class="line">mysql&gt; SET @j2 = '1';</span><br><span class="line">mysql&gt; SELECT JSON_CONTAINS(@j, @j2, '$.a');</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| JSON_CONTAINS(@j, @j2, '$.a') |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">|                             1 |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">mysql&gt; SELECT JSON_CONTAINS(@j, @j2, '$.b');</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| JSON_CONTAINS(@j, @j2, '$.b') |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">|                             0 |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line"></span><br><span class="line">mysql&gt; SET @j2 = '&#123;"d": 4&#125;';</span><br><span class="line">mysql&gt; SELECT JSON_CONTAINS(@j, @j2, '$.a');</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| JSON_CONTAINS(@j, @j2, '$.a') |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">|                             0 |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">mysql&gt; SELECT JSON_CONTAINS(@j, @j2, '$.c');</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| JSON_CONTAINS(@j, @j2, '$.c') |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">|                             1 |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br></pre></td></tr></table></figure>
<p>JSON_CONTAINS_PATH(json_doc, one_or_all, path[, path] …)</p>
<p>one’: 1 if at least one path exists within the document, 0 otherwise.<br>‘all’: 1 if all paths exist within the document, 0 otherwise.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SET @j = '&#123;"a": 1, "b": 2, "c": &#123;"d": 4&#125;&#125;';</span><br><span class="line">mysql&gt; SELECT JSON_CONTAINS_PATH(@j, 'one', '$.a', '$.e');</span><br><span class="line">+<span class="comment">---------------------------------------------+</span></span><br><span class="line">| JSON_CONTAINS_PATH(@j, 'one', '$.a', '$.e') |</span><br><span class="line">+<span class="comment">---------------------------------------------+</span></span><br><span class="line">|                                           1 |</span><br><span class="line">+<span class="comment">---------------------------------------------+</span></span><br><span class="line">mysql&gt; SELECT JSON_CONTAINS_PATH(@j, 'all', '$.a', '$.e');</span><br><span class="line">+<span class="comment">---------------------------------------------+</span></span><br><span class="line">| JSON_CONTAINS_PATH(@j, 'all', '$.a', '$.e') |</span><br><span class="line">+<span class="comment">---------------------------------------------+</span></span><br><span class="line">|                                           0 |</span><br><span class="line">+<span class="comment">---------------------------------------------+</span></span><br><span class="line">mysql&gt; SELECT JSON_CONTAINS_PATH(@j, 'one', '$.c.d');</span><br><span class="line">+<span class="comment">----------------------------------------+</span></span><br><span class="line">| JSON_CONTAINS_PATH(@j, 'one', '$.c.d') |</span><br><span class="line">+<span class="comment">----------------------------------------+</span></span><br><span class="line">|                                      1 |</span><br><span class="line">+<span class="comment">----------------------------------------+</span></span><br><span class="line">mysql&gt; SELECT JSON_CONTAINS_PATH(@j, 'one', '$.a.d');</span><br><span class="line">+<span class="comment">----------------------------------------+</span></span><br><span class="line">| JSON_CONTAINS_PATH(@j, 'one', '$.a.d') |</span><br><span class="line">+<span class="comment">----------------------------------------+</span></span><br><span class="line">|                                      0 |</span><br><span class="line">+<span class="comment">----------------------------------------+</span></span><br></pre></td></tr></table></figure>
<p>JSON_SET() replaces existing values and adds nonexisting values.</p>
<p>JSON_INSERT() inserts values without replacing existing values.</p>
<p>JSON_REPLACE() replaces only existing values.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SET @j = '&#123; "a": 1, "b": [2, 3]&#125;';</span><br><span class="line">mysql&gt; SELECT JSON_SET(@j, '$.a', 10, '$.c', '[true, false]');</span><br><span class="line">+<span class="comment">-------------------------------------------------+</span></span><br><span class="line">| JSON_SET(@j, '$.a', 10, '$.c', '[true, false]') |</span><br><span class="line">+<span class="comment">-------------------------------------------------+</span></span><br><span class="line">| &#123;"a": 10, "b": [2, 3], "c": "[true, false]"&#125;    |</span><br><span class="line">+<span class="comment">-------------------------------------------------+</span></span><br><span class="line">mysql&gt; SELECT JSON_INSERT(@j, '$.a', 10, '$.c', '[true, false]');</span><br><span class="line">+<span class="comment">----------------------------------------------------+</span></span><br><span class="line">| JSON_INSERT(@j, '$.a', 10, '$.c', '[true, false]') |</span><br><span class="line">+<span class="comment">----------------------------------------------------+</span></span><br><span class="line">| &#123;"a": 1, "b": [2, 3], "c": "[true, false]"&#125;        |</span><br><span class="line">+<span class="comment">----------------------------------------------------+</span></span><br><span class="line">mysql&gt; SELECT JSON_REPLACE(@j, '$.a', 10, '$.c', '[true, false]');</span><br><span class="line">+<span class="comment">-----------------------------------------------------+</span></span><br><span class="line">| JSON_REPLACE(@j, '$.a', 10, '$.c', '[true, false]') |</span><br><span class="line">+<span class="comment">-----------------------------------------------------+</span></span><br><span class="line">| &#123;"a": 10, "b": [2, 3]&#125;                              |</span><br><span class="line">+<span class="comment">-----------------------------------------------------+</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>site</title>
    <url>/2023/12/15/site/</url>
    <content><![CDATA[<h1 id="website"><a href="#website" class="headerlink" title="website"></a>website</h1><ul>
<li><a href="http://www.google.com.hk/ncr" target="_blank" rel="noopener">google</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Yaf Yar使用</title>
    <url>/2020/05/10/yaf/</url>
    <content><![CDATA[<h1 id="Yar-Yet-Another-RPC-Framework-一个rpc框架"><a href="#Yar-Yet-Another-RPC-Framework-一个rpc框架" class="headerlink" title="Yar (Yet Another RPC Framework) 一个rpc框架"></a>Yar (Yet Another RPC Framework) 一个rpc框架</h1><p>Yar 是一个轻量级, 高效的RPC框架, 它提供了一种简单方法来让PHP项目之间可以互相远程调用对方的本地方法. 并且Yar也提供了并行调用的能力. 可以支持同时调用多个远程服务的方法.</p>
<a id="more"></a>
<h3 id="范例"><a href="#范例" class="headerlink" title="范例"></a>范例</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//服务端</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 假设这个页面的访问路径是: http://example.com/operator.php */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Operator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add two operands</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interge </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> interge</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_add($a, $b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sub </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sub</span><span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $a - $b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mul</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mul</span><span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $a * $b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Protected methods will not be exposed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interge </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> interge</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_add</span><span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $a + $b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$server = <span class="keyword">new</span> Yar_Server(<span class="keyword">new</span> Operator());</span><br><span class="line">$server-&gt;handle();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$client = <span class="keyword">new</span> yar_client(<span class="string">"http://example.com/operator.php"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* call directly */</span></span><br><span class="line">var_dump($client-&gt;add(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* call via call */</span></span><br><span class="line">var_dump($client-&gt;call(<span class="string">"add"</span>, <span class="keyword">array</span>(<span class="number">3</span>, <span class="number">2</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* __add can not be called */</span></span><br><span class="line">var_dump($client-&gt;_add(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="多个客户端异步调用"><a href="#多个客户端异步调用" class="headerlink" title="多个客户端异步调用"></a>多个客户端异步调用</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">($ret, $callinfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $callinfo[<span class="string">'method'</span>] , <span class="string">" result: "</span>, $ret , <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 注册一个异步调用 */</span></span><br><span class="line">Yar_Concurrent_Client::call(<span class="string">"http://example.com/operator.php"</span>, <span class="string">"add"</span>, <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>), <span class="string">"callback"</span>);</span><br><span class="line">Yar_Concurrent_Client::call(<span class="string">"http://example.com/operator.php"</span>, <span class="string">"sub"</span>, <span class="keyword">array</span>(<span class="number">2</span>, <span class="number">1</span>), <span class="string">"callback"</span>);</span><br><span class="line">Yar_Concurrent_Client::call(<span class="string">"http://example.com/operator.php"</span>, <span class="string">"mul"</span>, <span class="keyword">array</span>(<span class="number">2</span>, <span class="number">2</span>), <span class="string">"callback"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 发送所有注册的调用, 等待返回, 返回后Yar会调用callback回掉函数 */</span></span><br><span class="line">Yar_Concurrent_Client::loop();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">($ret, $callinfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $callinfo[<span class="string">'method'</span>] , <span class="string">" result: "</span>, $ret , <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 注册一个异步调用 */</span></span><br><span class="line">Yar_Concurrent_Client::call(<span class="string">"http://example.com/operator.php"</span>, <span class="string">"add"</span>, <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>), <span class="string">"callback"</span>);</span><br><span class="line"><span class="comment">/* 发送所有注册的调用, 等待返回, 返回后Yar会调用callback回掉函数 */</span></span><br><span class="line">Yar_Concurrent_Client::loop();</span><br><span class="line"><span class="comment">/* 重置call ,否则上面的call会调用*/</span></span><br><span class="line">Yar_Concurrent_Client::reset();</span><br><span class="line">Yar_Concurrent_Client::call(<span class="string">"http://example.com/operator.php"</span>, <span class="string">"sub"</span>, <span class="keyword">array</span>(<span class="number">2</span>, <span class="number">1</span>), <span class="string">"callback"</span>);</span><br><span class="line">Yar_Concurrent_Client::loop();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="Yaf官方文档"><a href="#Yaf官方文档" class="headerlink" title="Yaf官方文档"></a>Yaf官方文档</h1><p><a href="https://www.php.net/manual/zh/book.yaf.php" target="_blank" rel="noopener">php net yaf官网</a><br><a href="https://www.laruence.com/manual/index.html" target="_blank" rel="noopener">中文文档</a></p>
<h3 id="Yaf的优点"><a href="#Yaf的优点" class="headerlink" title="Yaf的优点"></a>Yaf的优点</h3><ul>
<li>用C语言开发的PHP框架, 相比原生的PHP, 几乎不会带来额外的性能开销.</li>
<li>所有的框架类, 不需要编译, 在PHP启动的时候加载, 并常驻内存.</li>
<li>更短的内存周转周期, 提高内存利用率, 降低内存占用率.</li>
<li>灵巧的自动加载. 支持全局和局部两种加载规则, 方便类库共享.</li>
<li>高性能的视图引擎.</li>
<li>高度灵活可扩展的框架, 支持自定义视图引擎, 支持插件, 支持自定义路由等等.</li>
<li>内建多种路由, 可以兼容目前常见的各种路由协议.</li>
<li>强大而又高度灵活的配置文件支持. 并支持缓存配置文件, 避免复杂的配置结构带来的性能损失.</li>
<li>在框架本身,对危险的操作习惯做了禁止.</li>
<li>更快的执行速度, 更少的内存占用.</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">Yaf can be installed from source code by:</span><br><span class="line"></span><br><span class="line">cd /path/to/yaf-src/</span><br><span class="line">phpize</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h2 id="路由改写，伪静态"><a href="#路由改写，伪静态" class="headerlink" title="路由改写，伪静态"></a>路由改写，伪静态</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">http:<span class="comment">//dev-all.ekeguan.com/test/1/1.html</span></span><br><span class="line"></span><br><span class="line">在 Bootstrap.php 中 _initRoute 增加：</span><br><span class="line"><span class="comment">//http://dev-all.ekeguan.com/product/list/1/2</span></span><br><span class="line"> $router = $dispatcher-&gt;getRouter();</span><br><span class="line">$route  = <span class="keyword">new</span> Yaf_Route_Rewrite(</span><br><span class="line">        <span class="string">"/product/list/:id/:name"</span>,</span><br><span class="line">        <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">"controller"</span> =&gt; <span class="string">"index"</span>,</span><br><span class="line">            <span class="string">"action"</span>     =&gt; <span class="string">"index"</span>,</span><br><span class="line">        )</span><br><span class="line">    ); </span><br><span class="line">    </span><br><span class="line">    $router-&gt;addRoute(<span class="string">'dummy'</span>, $route);</span><br><span class="line"><span class="comment">// http://dev-all.ekeguan.com/user-list/1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// http://dev-all.ekeguan.com/test/1/1.html</span></span><br><span class="line"></span><br><span class="line">    $config = <span class="keyword">array</span>(</span><br><span class="line">     <span class="string">"user-list"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">"type"</span>  =&gt; <span class="string">"rewrite"</span>,        <span class="comment">//Yaf_Route_Rewrite route</span></span><br><span class="line">        <span class="string">"match"</span> =&gt; <span class="string">"/user-list/:id"</span>, <span class="comment">//match only /user/list/?/</span></span><br><span class="line">        <span class="string">"route"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'controller'</span> =&gt; <span class="string">"index"</span>,  <span class="comment">//route to user controller,</span></span><br><span class="line">            <span class="string">'action'</span>     =&gt; <span class="string">"index"</span>,  <span class="comment">//route to list action</span></span><br><span class="line">        ),</span><br><span class="line">     ),</span><br><span class="line">     <span class="string">"test"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">"type"</span>  =&gt; <span class="string">"regex"</span>,          <span class="comment">//Yaf_Route_Regex route</span></span><br><span class="line">        <span class="string">"match"</span> =&gt; <span class="string">"#^/test/([^/]+)/([^/])(.*)\.html+#"</span>,         <span class="comment">//match arbitrary request uri</span></span><br><span class="line">        <span class="string">"route"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'controller'</span> =&gt; <span class="string">"index"</span>,  <span class="comment">//route to product controller,</span></span><br><span class="line">            <span class="string">'action'</span>     =&gt; <span class="string">"index"</span>,    <span class="comment">//route to dummy action</span></span><br><span class="line">        ),</span><br><span class="line">        <span class="string">"map"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">           <span class="number">1</span> =&gt; <span class="string">"uri"</span>,   <span class="comment">// now you can call $request-&gt;getParam("uri")</span></span><br><span class="line">        ),</span><br><span class="line">     ),</span><br><span class="line"> );</span><br><span class="line"></span><br><span class="line"> $router-&gt;addConfig(<span class="keyword">new</span> Yaf_Config_Simple($config));</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="comment">//分页</span></span><br><span class="line"> $router = $dispatcher-&gt;getRouter();</span><br><span class="line">$config = <span class="keyword">array</span>(</span><br><span class="line">   <span class="string">"detail"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">      <span class="string">"type"</span>  =&gt; <span class="string">"regex"</span>,          <span class="comment">//Yaf_Route_Regex route</span></span><br><span class="line">      <span class="string">"match"</span> =&gt; <span class="string">"#^/details/(\d+)\/?(\d?)(\.html)?#"</span>,         <span class="comment">//match arbitrary request uri</span></span><br><span class="line">      <span class="string">"route"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">          <span class="string">'controller'</span> =&gt; <span class="string">"index"</span>,  <span class="comment">//route to product controller,</span></span><br><span class="line">          <span class="string">'action'</span>     =&gt; <span class="string">"index"</span>,    <span class="comment">//route to dummy action</span></span><br><span class="line">      ),</span><br><span class="line">      <span class="string">"map"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">         <span class="number">1</span> =&gt; <span class="string">"id"</span>,   <span class="comment">// now you can call $request-&gt;getParam("uri")</span></span><br><span class="line">         <span class="number">2</span> =&gt; <span class="string">"page"</span>,   <span class="comment">// now you can call $request-&gt;getParam("uri")</span></span><br><span class="line">      ),</span><br><span class="line">   ),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$router-&gt;addConfig(<span class="keyword">new</span> Yaf_Config_Simple($config));</span><br></pre></td></tr></table></figure>
<h2 id="CLI模式"><a href="#CLI模式" class="headerlink" title="CLI模式"></a>CLI模式</h2><h3 id="第一种方式"><a href="#第一种方式" class="headerlink" title="第一种方式"></a>第一种方式</h3><p>在<code>public</code>目录下新建<code>cli.php</code>文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span>(php_sapi_name()!=<span class="string">'cli'</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'No authority'</span>;<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$application = <span class="keyword">new</span> Yaf_Application(GLOBAL_CONFIG_PATH.<span class="string">'application.ini'</span>);</span><br><span class="line">$application-&gt;execute(<span class="string">"main1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"hello\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行 <code>php cli.php</code> 直接执行，运行函数</p>
<h3 id="第二种方式"><a href="#第二种方式" class="headerlink" title="第二种方式"></a>第二种方式</h3><p>在<code>public</code>目录下新建<code>cli.php</code>文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * cli命令行</span></span><br><span class="line"><span class="comment"> * 此文件不允许http方式访问</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (php_sapi_name() != <span class="string">'cli'</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'No authority'</span>;<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">define(<span class="string">'ENVIRONMENT'</span>, <span class="string">'develop'</span>); <span class="comment">//生成环境请修改为product</span></span><br><span class="line">define(<span class="string">'ROOT_PATH'</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">define(<span class="string">'APP_PATH'</span>, realpath(ROOT_PATH . <span class="string">'/../'</span>)); <span class="comment">//指向上一级</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">'GLOBAL_CONFIG_PATH'</span>, <span class="string">'/home/www/config/'</span>);</span><br><span class="line">defined(<span class="string">'REFERER'</span>) ? REFERER : define(<span class="string">'REFERER'</span>, <span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_REFERER'</span>]) ? $_SERVER[<span class="string">'HTTP_REFERER'</span>] : <span class="string">'/'</span>); <span class="comment">//上一页</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (ENVIRONMENT) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'develop'</span>:</span><br><span class="line">        error_reporting(E_ALL &amp; ~E_NOTICE); <span class="comment">//报告所有的错误，但除了E_NOTICE这一种</span></span><br><span class="line">        ini_set(<span class="string">'display_errors'</span>, <span class="number">1</span>);</span><br><span class="line">        ini_set(<span class="string">'yaf.environ'</span>, <span class="string">'develop'</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'product'</span>:</span><br><span class="line">        ini_set(<span class="string">'display_errors'</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        header(<span class="string">'HTTP/1.1 503 Service Unavailable.'</span>, <span class="keyword">true</span>, <span class="number">503</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'The application environment is not set correctly.'</span>;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">1</span>); <span class="comment">// EXIT_ERROR</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$application = <span class="keyword">new</span> Yaf_Application(GLOBAL_CONFIG_PATH . <span class="string">'application.ini'</span>);</span><br><span class="line"><span class="comment">//加载cli的bootstrap配置内容</span></span><br><span class="line">$application-&gt;bootstrap();</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取argv参数</span></span><br><span class="line">$uri_r = explode(<span class="string">'/'</span>, $argv[<span class="number">1</span>]);</span><br><span class="line">$count = count($uri_r);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($count &gt; <span class="number">3</span> &amp;&amp; $count &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'uri error!'</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span> ($count == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="comment">// 默认模块为空</span></span><br><span class="line">    array_unshift($uri_r, <span class="string">''</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span>($module, $controller, $action) = $uri_r;</span><br><span class="line"></span><br><span class="line">$params = [];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($argv[<span class="number">2</span>]) &amp;&amp; !<span class="keyword">empty</span>($argv[<span class="number">2</span>])) &#123;</span><br><span class="line">    parse_str($argv[<span class="number">2</span>], $params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$request = <span class="keyword">new</span> Yaf_Request_Simple(<span class="string">'CLI'</span>, $module, $controller, $action, $params);</span><br><span class="line">$application-&gt;getDispatcher()-&gt;returnResponse(<span class="keyword">true</span>)-&gt;dispatch($request);</span><br></pre></td></tr></table></figure>
<p>使用方法运行<code>php cli2.php  account/account/login &quot;name=Bill&amp;age=60&quot;</code>,分别为模块，控制器，方法  参数一定加上引号 , 其中参数在 <code>controller</code> 中 使用 <code>$this-&gt;getRequest()-&gt;getParams()</code> 控制器里使用这个方法接受参数。</p>
]]></content>
      <tags>
        <tag>yaf</tag>
        <tag>rewrite</tag>
      </tags>
  </entry>
</search>
